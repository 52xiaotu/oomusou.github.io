<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[點燈坊]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="http://oomusou.io/"/>
  <updated>2018-02-03T05:32:03.697Z</updated>
  <id>http://oomusou.io/</id>
  
  <author>
    <name><![CDATA[真 OO無双]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[如何使用 Angular 實現 Pub/Sub Pattern ?]]></title>
    <link href="http://oomusou.io/angular/pubsub/"/>
    <id>http://oomusou.io/angular/pubsub/</id>
    <published>2018-02-04T12:23:43.000Z</published>
    <updated>2018-02-03T05:32:03.697Z</updated>
    <content type="html"><![CDATA[<p>Pub/Sub Pattern 是 OOP 中著名的 Design Pattern，尤其應付 <code>多對多</code> 的場景特別有效。在本文中，我們將以 Angular 與 TypeScript 實現。</p>
<p>Pub/Sub Pattern 與 Observer Pattern 非常接近，將特別探討與 Observer Pattern 之間的差異。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.4<br>Angular CLI 1.6.2<br>Angular 5.2.2</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/angular/pubsub/pub000.png" alt="pub000"></p>
<p>畫面上有兩個 <code>數字鐘</code>，上面的是 <code>每秒鐘</code> 更新一次，下面的是 <code>每 3 秒</code> 更新一次。</p>
<h2 id="Task">Task</h2><hr>
<p>程式碼希望分成兩部分，一個部分送出 <code>目前時間</code>，另一個部分負責 <code>顯示時間</code>。</p>
<p>但因為目前分成 <code>每秒鐘</code> 與 <code>每 3 秒</code>，因此會有 2 個 class <code>分別</code> 負責產生時間。</p>
<h2 id="Definition">Definition</h2><hr>
<blockquote>
<p>Pub/Sub Pattern</p>
<p>當物件之間有 <code>多對多</code> 的依賴關係，且當 <code>多</code> 的 <code>發行者</code> (publisher) 改變時，<code>多</code> 的 <code>訂閱者</code> (subscriber) 也必須跟著改變，就特別適合使用 <code>Pub/Sub Pattern</code></p>
</blockquote>
<p><img src="/images/angular/pubsub/pub008.svg" alt="pub008"></p>
<p>此為 Pub/Sub Pattern 最原始的 UML class diagram，實務上會有多個 <code>publisher</code> 與多個 <code>subscriber</code>，且 <code>publisher</code> 與 <code>subscriber</code> 彼此互相依賴，<code>broker</code> 的介入讓 <code>publisher</code> 與 <code>subscriber</code> 的關係簡單化。</p>
<p><code>subscriber</code> 不用知道有哪些 <code>publisher</code>，只要知道 <code>broker</code> 即可；<code>publisher</code> 也不用知道有哪些 <code>subscriber</code>，只要知道 <code>broker</code> 即可，如此 <code>subscriber</code> 與 <code>publisher</code> 就徹底解耦合，且將來無論新增多少 <code>subscriber</code> 與 <code>publisher</code>，唯一需要修改的只有 <code>broker</code>，符合 <code>開放封閉原則</code> 的要求。</p>
<h2 id="Architecture">Architecture</h2><hr>
<p><img src="/images/angular/pubsub/pub001.svg" alt="pub001"></p>
<ul>
<li><code>Clock1sPublisher</code> 負責 <code>每秒鐘</code> 送出目前時間；<code>Clock3sPublisher</code> 負責 <code>每 3 秒</code> 送出目前時間</li>
<li><code>Digital1sComponent</code> 負責 <code>每秒鐘</code> 顯示目前時間； <code>Digital3sComponent</code> 負責 <code>每 3 秒</code> 顯示目前時間</li>
<li><code>DigitalComponent</code> 必須能向 <code>ClockBroker</code> <code>subscribe</code> 資料；<code>ClockPublisher</code> 必須能向 <code>ClockBroker</code> <code>publish</code> 資料，根據 <code>DigitalComponent</code> 與 <code>ClockPublisher</code> 需求，訂出 <code>BrokerInterface</code>，期望 <code>ClockBroker</code> 能遵守</li>
<li><code>ClockBroker</code> 必須能向 <code>DigitalComponent</code> 送出目前時間，根據 <code>ClockBroker</code> 需求，訂出 <code>SubscriberInterface</code>，期望 <code>DigitalComponent</code> 能遵守</li>
<li><code>ClockBroker</code> 必須能向 <code>ClockPublisher</code> 設定 broker，根據 <code>ClockBroker</code> 需求，訂出 <code>PublisherInterface</code>，期望 <code>ClockPublisher</code> 能遵守</li>
</ul>
<h2 id="Implementation">Implementation</h2><hr>
<h3 id="DigitalClock1sComponent">DigitalClock1sComponent</h3><p><img src="/images/angular/pubsub/pub002.svg" alt="pub002"></p>
<p><strong>digital-clock1s.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; now | date:'HH:mm:ss'&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>HTML 負責顯示 <code>目前時間</code>，至於 <code>時:分:秒</code> 部分就不用自己寫程式處理了，靠 pipe 即可。</p>
<p><strong>digital-clock1s.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Inject, OnDestroy, OnInit &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ClockBroker &#125; from <span class="string">'../../broker/clock.broker'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubscriberInterface &#125; from <span class="string">'../../interface/subscriber.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectEnum &#125; from <span class="string">'../../enum/subject.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrokerInterface &#125; from <span class="string">'../../interface/broker.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrokerInterfaceToken &#125; from <span class="string">'../../interface/injection.token'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-digital-clock1s'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./digital-clock1s.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./digital-clock1s.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DigitalClock1sComponent <span class="keyword">implements</span> SubscriberInterface, OnInit, OnDestroy &#123;</span><br><span class="line">  now: <span class="built_in">Date</span> = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(</span><br><span class="line">    @Inject(BrokerInterfaceToken)</span><br><span class="line">    private clockBroker: BrokerInterface) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockBroker.subscribe(SubjectEnum.Clock1s, <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnDestroy(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockBroker.unsubscribe(SubjectEnum.Clock3s, <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  update(date: <span class="built_in">Date</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.now = date;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DigitalClock1sComponent <span class="keyword">implements</span> SubscriberInterface</span><br></pre></td></tr></table></figure>
<p>先不考慮 <code>DigitalClock1sComponent</code> 所使用的 <code>SubscriberInterface</code> ，稍後會討論。</p>
<p>也因為是實現 <code>SubscriberInterface</code>，因此 <code>DigitalClock1sComponent</code> 本質上就是一個 <code>Subscriber</code>，只是藉由 component 實作。</p>
<blockquote>
<p><code>subscriber</code>  在觀念上很類似 Observer Pattern 的 <code>observer</code></p>
</blockquote>
<p>20 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.clockBroker.subscribe(SubjectEnum.Clock1s, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回想 <code>subscriber</code> 的初衷，除了顯示 <code>目前時間</code> 外，另外一個目的就是能對 <code>broker</code> 加以 <code>訂閱</code> 與 <code>取消訂閱</code>。</p>
<p>既然要訂閱，該在什麼時候執行呢 ?</p>
<p>最好是在 <code>subscriber</code> 開始 <code>初始化</code> 時就對 <code>broker</code> 加以訂閱，因此選擇使用 <code>ngOnInit()</code> lifecycle hook。</p>
<p>並且希望 <code>broker</code> 有 <code>subscribe()</code>，提供 <code>訂閱</code>功能。</p>
<p><code>subscribe()</code> 第 1 個參數為 <code>SubjectEnum</code>，設定要 subscribe 什麼 subject；第 2 個參數則是將 <code>this</code> 傳進去，準備將來 callback 使用。</p>
<blockquote>
<p>Sub/Pub Pattern 與 Observer Pattern 一個主要的差異是 observer 會直接對 subject 加以訂閱，但 Sub/Pub Pattern 則會透過 broker 加以訂閱</p>
</blockquote>
<p>24 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngOnDestroy(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.clockBroker.unsubscribe(SubjectEnum.Clock1s, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然有 <code>訂閱</code>，就應該有 <code>取消訂閱</code>，該在什麼時候取消呢 ?</p>
<p>最好是在 <code>subscriber</code> 最後 <code>被消滅</code> 時對 <code>broker</code> 加以 <code>取消註冊</code>，因此選擇 <code>ngOnDestroy()</code> lifecycle hook。</p>
<p>並且希望 <code>broker</code> 有 <code>unsubscribe()</code> ，提供 <code>取消訂閱</code> 功能。</p>
<blockquote>
<p>綜合 <code>ngOnInit()</code> 與 <code>ngOnDestroy()</code>，根據 <code>介面隔離原則</code>，已經大概可猜到 broker 的 interface 該提供 <code>subscribe()</code> 與 <code>unsubscribe()</code> </p>
</blockquote>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(</span><br><span class="line">  @Inject(BrokerInterfaceToken)</span><br><span class="line">  private clockBroker: BrokerInterface) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然 <code>subscriber</code> 需要 <code>ClockBroker</code>，因此必須在 constructor 將 <code>ClockBroker</code> DI 注入進來。</p>
<p>根據 <code>依賴反轉原則</code> : <code>subscriber</code> 不應該依賴底層的 <code>broker</code>，兩者應該依賴於 interface。</p>
<p>根據 <code>介面隔離原則</code> : <code>subscriber</code> 應該只相依於他所需要的 interface，目前看來只需要 <code>subscribe()</code> 與 <code>unsubscribe()</code>，因此由 <code>subscriber</code> 需求角度訂出的 broker 的 interface。</p>
<p>因此 DI 注入的 <code>ClockBroker</code> ，其型別為 <code>BrokerInterface</code>，這樣就符合 <code>依賴反轉原則</code> 與 <code>介面隔離原則</code>。</p>
<blockquote>
<p><code>subscribe()</code> 在觀念上類似於 Observer Pattern 的 <code>addObserver()</code> ；而 <code>unsubscribe()</code> 類似於 <code>removeObserver()</code></p>
</blockquote>
<h3 id="Clock1sPublisher">Clock1sPublisher</h3><p><img src="/images/angular/pubsub/pub003.svg" alt="pub003"></p>
<p><strong>clock1s.publisher.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PublisherInterface &#125; from <span class="string">'../../interface/publisher.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrokerInterface &#125; from <span class="string">'../../interface/broker.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Clock1sPublisher <span class="keyword">implements</span> PublisherInterface &#123;</span><br><span class="line">  <span class="keyword">private</span> interval = <span class="number">1000</span>;</span><br><span class="line">  <span class="keyword">private</span> clockBroker: BrokerInterface;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">    setInterval(() =&gt; <span class="keyword">this</span>.tick(), <span class="keyword">this</span>.interval);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setBroker(broker: BrokerInterface): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockBroker = broker;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> tick(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockBroker.publish(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 6 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Clock1sPublisher <span class="keyword">implements</span> PublisherInterface</span><br></pre></td></tr></table></figure>
<p>先不考慮 <code>Clock1sPublisher</code> 所使用的 <code>PublisherInterface</code> ，稍後會討論。</p>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">  setInterval(() =&gt; <span class="keyword">this</span>.tick(), <span class="keyword">this</span>.interval);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據需求，<code>publisher</code> 要能夠每秒送出 <code>目前時間</code>，所以使用 JavaScript 原生的 <code>setInterval()</code>，每 1 秒鐘呼叫 <code>tick()</code> 一次。</p>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> tick(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.clockBroker.publish(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每一秒執行 <code>tick()</code> 時，會將 <code>目前時間</code> 透過 <code>publish()</code> 發佈至 broker。</p>
<blockquote>
<p>根據 <code>介面隔離原則</code>，已經大概可猜到 <code>broker</code> 的 interface 該提供 <code>publish()</code> </p>
</blockquote>
<h3 id="BrokerInterface">BrokerInterface</h3><p><img src="/images/angular/pubsub/pub004.svg" alt="pub004"></p>
<p><strong>broker.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; SubjectEnum &#125; from <span class="string">'../enum/subject.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubscriberInterface &#125; from <span class="string">'./subscriber.interface'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> BrokerInterface </span>&#123;</span><br><span class="line">  publish(date: <span class="built_in">Date</span>): <span class="built_in">void</span>;</span><br><span class="line">  subscribe(subject: SubjectEnum, subscriber: SubscriberInterface): <span class="built_in">void</span>;</span><br><span class="line">  unsubscribe(subject: SubjectEnum, subscriber: SubscriberInterface): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，<code>subscriber</code> 與 <code>publisher</code> 應該只相依於他所需要的 interface，目前看來共需要  <code>publish()</code>、<code>subscribe()</code> 與 <code>unsubscribe()</code>，因此訂出 <code>BrokerInterface</code>，而 <code>broker</code> 必須實作此 interface。</p>
<h3 id="ClockBroker">ClockBroker</h3><p><img src="/images/angular/pubsub/pub005.svg" alt="pub005"></p>
<p><strong>clock.broker.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Clock1sPublisher &#125; from <span class="string">'../publisher/clock1s/clock1s.publisher'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrokerInterface &#125; from <span class="string">'../interface/broker.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubscriberInterface &#125; from <span class="string">'../interface/subscriber.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Clock3sPublisher &#125; from <span class="string">'../publisher/clock3s/clock3s.publisher'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectEnum &#125; from <span class="string">'../enum/subject.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectSubscriber &#125; from <span class="string">'../model/subject-subscriber.model'</span>;</span><br><span class="line"><span class="keyword">import</span> * as _ from <span class="string">'lodash'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ClockBroker <span class="keyword">implements</span> BrokerInterface &#123;</span><br><span class="line">  <span class="keyword">private</span> subscribers: SubjectSubscriber[] = [];</span><br><span class="line">  <span class="keyword">private</span> counter = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">private</span> maxCounter = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private clock1sPublisher: Clock1sPublisher,</span><br><span class="line">              private clock3sPublisher: Clock3sPublisher) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.clock1sPublisher.setBroker(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.clock3sPublisher.setBroker(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  publish(date: <span class="built_in">Date</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.counter === <span class="keyword">this</span>.maxCounter) &#123;</span><br><span class="line">      <span class="keyword">this</span>.publishToClock3sSubscriber(date);</span><br><span class="line">      <span class="keyword">this</span>.counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.publishToClock1sSubscriber(date);</span><br><span class="line">    <span class="keyword">this</span>.counter++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  subscribe(subject: SubjectEnum, subscriber: SubscriberInterface): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> subjectSubscriber: SubjectSubscriber = &#123;</span><br><span class="line">      subject: subject,</span><br><span class="line">      subscriber: subscriber</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">this</span>.subscribers.push(subjectSubscriber);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unsubscribe(subject: SubjectEnum, subscriber: SubscriberInterface): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> subjectSubscriber: SubjectSubscriber = &#123;</span><br><span class="line">      subject: subject,</span><br><span class="line">      subscriber: subscriber</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    _.remove(<span class="keyword">this</span>.subscribers, subjectSubscriber);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> publishToClock3sSubscriber(date: <span class="built_in">Date</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.subscribers</span><br><span class="line">      .filter(item =&gt; item.subject === SubjectEnum.Clock3s)</span><br><span class="line">      .forEach(item =&gt; item.subscriber.update(date));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> publishToClock1sSubscriber(date: <span class="built_in">Date</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.subscribers</span><br><span class="line">      .filter(item =&gt; item.subject === SubjectEnum.Clock1s)</span><br><span class="line">      .forEach(item =&gt; item.subscriber.update(date));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ClockBroker <span class="keyword">implements</span> BrokerInterface</span><br></pre></td></tr></table></figure>
<p>根據 <code>依賴反轉原則</code>，<code>broker</code> 應該相依於 <code>subscriber</code> 與 <code>publisher</code> 所訂出的 interface，因此必須實現 <code>BrokerInterface</code>。</p>
<p>16 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private clock1sPublisher: Clock1sPublisher,</span><br><span class="line">            private clock3sPublisher: Clock3sPublisher) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.clock1sPublisher.setBroker(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>.clock3sPublisher.setBroker(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ClockBroker</code> 的角色就是做 <code>publisher</code> 與 <code>subscriber</code> 的中介角色，除了 <code>被</code> <code>subscriber</code> 注入外，還必須自己注入多個 <code>publisher</code>。</p>
<p>因為 <code>publisher</code> 將來會對 <code>broker</code> 加以 callback，因此使用 <code>setBroker()</code> 將 <code>broker</code> 的 reference 傳進去，讓 <code>publisher</code> 可對 <code>broker</code> 做 callback。</p>
<blockquote>
<p>根據 <code>介面隔離原則</code>，已經大概可猜到 <code>publisher</code> 的 interface 該提供 <code>setBroker()</code> </p>
</blockquote>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> subscribers: SubjectSubscriber[] = [];</span><br></pre></td></tr></table></figure>
<p><code>subscribers</code> 陣列儲存所有訂閱的 <code>subscriber</code>，每個物件型別為 <code>SubjectSubscriber</code>。</p>
<p>至於什麼是 <code>SubjectSubscriber</code>，稍後會討論。</p>
<p>34 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">subscribe(subject: SubjectEnum, subscriber: SubscriberInterface): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> subjectSubscriber: SubjectSubscriber = &#123;</span><br><span class="line">    subject: subject,</span><br><span class="line">    subscriber: subscriber</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">this</span>.subscribers.push(subjectSubscriber);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然 <code>BlockerInterface</code> 已經定義了 <code>subscribe()</code>，<code>broker</code> 就必須加以實作。</p>
<p><code>SubjectSubscriber</code> 物件提供了 <code>subject</code> 與 <code>subscriber</code> 兩個 field，<code>subject</code> 儲存所訂閱的主題，其型別為 <code>SubjectEnum</code>，<code>subscriber</code> 儲存有訂閱的 <code>subscriber</code>，其型別為 <code>SubscriberInterface</code>。</p>
<p><code>subscribers</code> 為陣列，使用 <code>push()</code> 新增資料進陣列。</p>
<p>22 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">publish(date: <span class="built_in">Date</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.counter === <span class="keyword">this</span>.maxCounter) &#123;</span><br><span class="line">    <span class="keyword">this</span>.publishToClock3sSubscriber(date);</span><br><span class="line">    <span class="keyword">this</span>.counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.publishToClock1sSubscriber(date);</span><br><span class="line">  <span class="keyword">this</span>.counter++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然 <code>BlockerInterface</code> 已經定義了 <code>publish()</code>，<code>broker</code> 就必須加以實作。</p>
<p>目前 <code>broker</code> 主要應付兩種 <code>publisher</code>，一種是 <code>每秒</code>，另一種是 <code>每三秒</code>。</p>
<p>每一秒 <code>counter</code> 會 <code>+1</code>，當 <code>counter</code> 為 <code>3</code> 會 reset 為 <code>0</code>。</p>
<p>每 <code>3</code> 秒會執行 <code>publishToClock3sSubscriber()</code>，而每 <code>1</code> 秒會執行 <code>publishToClock1sSubscriber()</code>，並將 <code>目前時間</code> 送出。</p>
<p>42 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> publishToClock3sSubscriber(date: <span class="built_in">Date</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.subscribers</span><br><span class="line">    .filter(item =&gt; item.subject === SubjectEnum.Clock3s)</span><br><span class="line">    .forEach(item =&gt; item.subscriber.update(date));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每 <code>3</code> 秒執行 <code>publishToClock3sSubscriber()</code> 一次，先 filter 只訂閱 <code>3 秒更新</code> 的 <code>subscriber</code>，然後 foreach 執行每個 <code>subscriber</code> 的 <code>update()</code>，並送出 <code>目前時間</code>。</p>
<p>51 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> publishToClock1sSubscriber(date: <span class="built_in">Date</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.subscribers</span><br><span class="line">    .filter(item =&gt; item.subject === SubjectEnum.Clock1s)</span><br><span class="line">    .forEach(item =&gt; item.subscriber.update(date));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每 <code>1</code> 秒執行 <code>publishToClock1sSubscriber()</code> 一次，先 filter 只訂閱 <code>1 秒更新</code> 的 <code>subscriber</code>，然後 foreach 執行每個 <code>subscriber</code> 的 <code>update()</code>，並送出 <code>目前時間</code>。</p>
<blockquote>
<p>根據 <code>介面隔離原則</code>，已經大概可猜到 <code>subscriber</code> 的 interface 該提供 <code>update()</code> </p>
</blockquote>
<p>40 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">unsubscribe(subject: SubjectEnum, subscriber: SubscriberInterface): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> subjectSubscriber: SubjectSubscriber = &#123;</span><br><span class="line">      subject: subject,</span><br><span class="line">      subscriber: subscriber</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    _.remove(<span class="keyword">this</span>.subscribers, subjectSubscriber);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>既然 <code>BlockerInterface</code> 已經定義了 <code>subscribe()</code>，<code>broker</code> 就必須加以實作。</p>
<blockquote>
<p>使用 Lodash 的 <code>remove()</code> 對陣列刪除物件</p>
</blockquote>
<h3 id="PublisherInterface">PublisherInterface</h3><p><img src="/images/angular/pubsub/pub006.svg" alt="pub006"></p>
<p><strong>publisher.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrokerInterface &#125; from <span class="string">'./broker.interface'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> PublisherInterface </span>&#123;</span><br><span class="line">  setBroker(broker: BrokerInterface): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，<code>publisher</code> 應該只相依於他所需要的 interface，目前看來需要  <code>setBroker()</code>，因此訂出 <code>PublisherInterface</code>，而 <code>publisher</code> 必須實作此 interface。</p>
<h3 id="Clock1sPublisher-1">Clock1sPublisher</h3><p><img src="images/pub003.svg" alt="pub003"></p>
<p><strong>clock1s.publisher.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PublisherInterface &#125; from <span class="string">'../../interface/publisher.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrokerInterface &#125; from <span class="string">'../../interface/broker.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Clock1sPublisher <span class="keyword">implements</span> PublisherInterface &#123;</span><br><span class="line">  <span class="keyword">private</span> interval = <span class="number">1000</span>;</span><br><span class="line">  <span class="keyword">private</span> clockBroker: BrokerInterface;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">    setInterval(() =&gt; <span class="keyword">this</span>.tick(), <span class="keyword">this</span>.interval);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setBroker(broker: BrokerInterface): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockBroker = broker;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> tick(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockBroker.publish(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 6 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Clock1sPublisher <span class="keyword">implements</span> PublisherInterface</span><br></pre></td></tr></table></figure>
<p>根據 <code>依賴反轉原則</code>，<code>publisher</code> 應該相依於 <code>broker</code> 所訂出的 interface，因此必須實現 <code>PublisherInterface</code>。</p>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setBroker(broker: BrokerInterface): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.clockBroker = broker;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然 <code>PublisherInterface</code> 已經定義了 <code>setBroker()</code>，<code>publisher</code> 就必須加以實作。</p>
<h3 id="SubscriberInterface">SubscriberInterface</h3><p><img src="/images/angular/pubsub/pub007.svg" alt="pub007"></p>
<p><strong>subscriber.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> SubscriberInterface </span>&#123;</span><br><span class="line">  update(date: <span class="built_in">Date</span>): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，<code>broker</code> 應該只相依於他所需要的 interface，目前看來需要  <code>update()</code>，因此訂出 <code>SubscriberInterface</code>，而 <code>subscriber</code> 必須實作此 interface。</p>
<h3 id="DigitalClock1sComponent-1">DigitalClock1sComponent</h3><p><img src="images/pub002.svg" alt="pub002"></p>
<p><strong>digital-clock1s.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Inject, OnDestroy, OnInit &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ClockBroker &#125; from <span class="string">'../../broker/clock.broker'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubscriberInterface &#125; from <span class="string">'../../interface/subscriber.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectEnum &#125; from <span class="string">'../../enum/subject.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrokerInterface &#125; from <span class="string">'../../interface/broker.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrokerInterfaceToken &#125; from <span class="string">'../../interface/injection.token'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-digital-clock1s'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./digital-clock1s.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./digital-clock1s.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DigitalClock1sComponent <span class="keyword">implements</span> SubscriberInterface, OnInit, OnDestroy &#123;</span><br><span class="line">  now: <span class="built_in">Date</span> = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(</span><br><span class="line">    @Inject(BrokerInterfaceToken)</span><br><span class="line">    private clockBroker: BrokerInterface) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockBroker.subscribe(SubjectEnum.Clock1s, <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnDestroy(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockBroker.unsubscribe(SubjectEnum.Clock3s, <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  update(date: <span class="built_in">Date</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.now = date;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DigitalClock1sComponent <span class="keyword">implements</span> SubscriberInterface, OnInit, OnDestroy</span><br></pre></td></tr></table></figure>
<p>根據 <code>依賴反轉原則</code>，<code>subscriber</code> 應該相依於 <code>broker</code> 所訂出的 interface，因此必須實現 <code>SubscriberInterface</code>。</p>
<p>25 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">update(date: <span class="built_in">Date</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.now = date;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然 <code>SubscriberInterface</code> 已經定義了 <code>update()</code>，<code>subscriber</code> 就必須加以實作。</p>
<h3 id="AppModule">AppModule</h3><p><strong>app.module.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ClockBroker &#125; from <span class="string">'./broker/clock.broker'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Clock1sPublisher &#125; from <span class="string">'./publisher/clock1s/clock1s.publisher'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DigitalClock1sComponent &#125; from <span class="string">'./component/digital-clock1s/digital-clock1s.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DigitalClock3sComponent &#125; from <span class="string">'./component/digital-clock3s/digital-clock3s.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Clock3sPublisher &#125; from <span class="string">'./publisher/clock3s/clock3s.publisher'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrokerInterfaceToken &#125; from <span class="string">'./interface/injection.token'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    DigitalClock1sComponent,</span><br><span class="line">    DigitalClock3sComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    &#123;provide: BrokerInterfaceToken, useClass: ClockBroker&#125;,</span><br><span class="line">    Clock1sPublisher,</span><br><span class="line">    Clock3sPublisher</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>20 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  &#123; provide: BrokerInterfaceToken, useClass: ClockBroker &#125;,</span><br><span class="line">  Clock1sPublisher,</span><br><span class="line">  Clock3sPublisher</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p><code>broker</code> 採用 interface 方式注入，要特別使用 token。</p>
<p>兩個 <code>publisher</code> 直接對 class 注入即可。</p>
<h2 id="Summary">Summary</h2><blockquote>
<p>Pub/Sub Pattern vs. Observer Pattern</p>
</blockquote>
<p>Observer Pattern 是原始 GoF 23 個 Design Pattern 之一，Pub/Sub Pattern 與 Observer Pattern 理念上非常接近，廣義上來說，Pub/Sub Pattern 算是 Observer Pattern 的變形，有些書甚至也認為 Pub/Sub Pattern 就是 Observer Pattern，但嚴格來說，兩者還是有些微差異：</p>
<p><strong>相同點</strong></p>
<ul>
<li>Observer Pattern 的 <code>observer</code> 相當於 Pub/Sub Pattern 的 <code>subscriber</code></li>
<li>Observer Pattern 的 <code>subject</code> 相當於 Pub/Sub Pattern 的 <code>publisher</code></li>
<li>Observer Pattern 的 <code>SubjectInterface</code> 有 <code>addObserver()</code> 與 <code>removeObserver()</code> ； Pub/Sub Pattern 的 <code>BrokerInterface</code> 也有 <code>subscribe()</code> 與  <code>unsubscribe()</code></li>
<li>Observer Pattern 的 <code>ObserverInterface</code> 有 <code>update()</code>；Pub/Sub Pattern 的 <code>SubscriberInterface</code> 也有 <code>update()</code></li>
</ul>
<p><strong>相異點</strong></p>
<ul>
<li>Pub/Sub Pattern 多了 <code>broker</code> 介入</li>
<li>對於 <code>publisher</code> 而言，<code>broker</code> 是 <code>publisher</code> 的 <code>subscriber</code>；對於 <code>subscriber</code> 而言，<code>broker</code> 是 <code>subscriber</code> 的 <code>publisher</code>，所以 <code>broker</code> 兼具 <code>subscriber</code> 與 <code>publisher</code> 的角色</li>
<li>Observer Pattern 只有一個 <code>subject</code>，但 Pub/Sub Pattern 有多個 <code>publisher</code></li>
</ul>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Observer Pattern 適合 <code>一對多</code> 場景；而 Pub/Sub Pattern 適合 <code>多對多</code> 場景</li>
<li><code>一對一</code> 當然也可以使用 Pub/Sub Pattern 實現，只是 Design Pattern 強調的是 intention，應該依照使用場景選擇適合的 pattern</li>
<li>Pub/Sub Pattern 與 Observer Pattern 的最大差異在於 <code>broker</code> 的介入，讓 <code>publisher</code> 與 <code>subscriber</code> 都只相依於 <code>broker</code> 即可，將來有任何修改，都集中在 <code>broker</code>，符合 <code>開放封閉原則</code></li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG52PubSubPattern" target="_blank" rel="external">GitHub</a> 上找到</p>
]]></content>
    <summary type="html">
    <![CDATA[與 Observer Pattern 很接近的 Pub/Sub Pattern]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="Design Pattern" scheme="http://oomusou.io/tags/Design-Pattern/"/>
    
      <category term="TypeScript" scheme="http://oomusou.io/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何以 Command 方式執行 VS Code 並開啟專案 ?]]></title>
    <link href="http://oomusou.io/vscode/run-by-command/"/>
    <id>http://oomusou.io/vscode/run-by-command/</id>
    <published>2018-02-04T12:23:43.000Z</published>
    <updated>2018-02-03T12:22:28.535Z</updated>
    <content type="html"><![CDATA[<p>Windows 版的 VS Code 在安裝時就會自動建立 <code>code</code>  指令，讓我們可以在 terminal 以 command 方式執行 VS Code 並開啟專案，不過在 macOS 版本預設並沒有建立 symbolic link，必須自行另外透過 Command Pallette 建立。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>macOS High Sierra 10.13.3<br>VS Code 1.19.3</p>
<h2 id="建立_Symbolic_Link">建立 Symbolic Link</h2><hr>
<p><img src="/images/vscode/run-by-command/code000.png" alt="code000"></p>
<p>熱鍵執行 Command Pallette </p>
<ol>
<li>輸入 <code>shell</code></li>
<li>選擇 <code>Shell Command : Install &#39;code&#39; command in PATH</code></li>
</ol>
<blockquote>
<p>Command Pallete 熱鍵 </p>
<p>Windows : Ctrl + Shift + P</p>
<p>macOS : ⌘ + ⇧ + P</p>
</blockquote>
<p><img src="/images/vscode/run-by-command/code001.png" alt="code001"></p>
<p>VS Code 會自動在 <code>usr/local/bin</code> 下建立 <code>code</code> ，自動指向實際的 VS Code。</p>
<h2 id="在_Terminal_執行_VS_Code">在 Terminal 執行 VS Code</h2><hr>
<p><img src="/images/vscode/run-by-command/code002.png" alt="code002"></p>
<p>在 terminal 下進入專案目錄，輸入 <code>code .</code> ，VS Code 會自動執行，並且開啟 <code>NG52MergeMap</code> 專案。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>除了在 VS Code 內開啟專案外，也可以使用 command 方式直接開啟</li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[macOS 版的 VS Code 需手動另外建立 Symbolic Link]]>
    
    </summary>
    
      <category term="VS Code" scheme="http://oomusou.io/tags/VS-Code/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何刪除陣列中的物件 ?]]></title>
    <link href="http://oomusou.io/javascript/remove-object-array/"/>
    <id>http://oomusou.io/javascript/remove-object-array/</id>
    <published>2018-02-03T12:23:43.000Z</published>
    <updated>2018-02-01T15:46:43.864Z</updated>
    <content type="html"><![CDATA[<p>JavaScript 並沒有內建刪除陣列元素的 operator，必須使用一些技巧才能刪除，若陣列內放的是 object，則狀況將更加詭異，這也是 JavaScript 初學者一定會踩到的雷。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.4<br>Angular CLI 1.6.7<br>Angular 5.2.3</p>
<h2 id="splice()">splice()</h2><hr>
<h3 id="典型錯誤寫法">典型錯誤寫法</h3><p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectSubscriber &#125; from <span class="string">'../model/subject-subscriber.model'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectEnum &#125; from <span class="string">'../enum/subject.enum'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubscriberInterface &#125; from <span class="string">'../interface/SubscriberInterface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> SubscriberInterface &#123;</span><br><span class="line">  message: <span class="built_in">string</span>;</span><br><span class="line">  <span class="keyword">private</span> subscribers: SubjectSubscriber[] = [];</span><br><span class="line"></span><br><span class="line">  update(message: <span class="built_in">string</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.message = message;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onSubscribeClick() &#123;</span><br><span class="line">    <span class="keyword">const</span> subjectSubscriber: SubjectSubscriber = &#123;</span><br><span class="line">      subject: SubjectEnum.FrontEnd,</span><br><span class="line">      subscriber: <span class="keyword">this</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.subscribers.push(subjectSubscriber);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.subscribers.length);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onUnSubscribeClick() &#123;</span><br><span class="line">    <span class="keyword">const</span> subjectSubscriber: SubjectSubscriber = &#123;</span><br><span class="line">      subject: SubjectEnum.FrontEnd,</span><br><span class="line">      subscriber: <span class="keyword">this</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> index = <span class="keyword">this</span>.subscribers.indexOf(subjectSubscriber);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index === -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.subscribers.splice(index, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.subscribers.length);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> subscribers: SubjectSubscriber[] = [];</span><br></pre></td></tr></table></figure>
<p>宣告一個陣列，注意其型別為 <code>SubjectSubscriber</code>，也就是 <code>subscribers</code> 為一個物件陣列。</p>
<p>19 行</p>
 <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">onSubscribeClick() &#123;</span><br><span class="line">  <span class="keyword">const</span> subjectSubscriber: SubjectSubscriber = &#123;</span><br><span class="line">    subject: SubjectEnum.FrontEnd,</span><br><span class="line">    subscriber: <span class="keyword">this</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.subscribers.push(subjectSubscriber);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.subscribers.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>準備好一個物件，使用 JavaScript array 原生的 <code>push()</code> 將物件新增至陣列。</p>
<p>30 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">onUnSubscribeClick() &#123;</span><br><span class="line">  <span class="keyword">const</span> subjectSubscriber: SubjectSubscriber = &#123;</span><br><span class="line">    subject: SubjectEnum.FrontEnd,</span><br><span class="line">    subscriber: <span class="keyword">this</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> index = <span class="keyword">this</span>.subscribers.indexOf(subjectSubscriber);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (index === -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.subscribers.splice(index, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.subscribers.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直覺會使用 <code>onSubscribeClick()</code> 方法，準備好一個物件，使用 JavaScript 原生的 <code>indexOf()</code> 去尋找該物件的 <code>index</code>，然後再加以 <code>splice()</code>。</p>
<p>問題在於 <code>subjectSubscriber</code> 是一個全新的物件，有新的 reference， 因此 <code>indexOf()</code> 會找不到物件而傳回 <code>-1</code>。</p>
<h3 id="正確寫法">正確寫法</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">onUnSubscribeClick() &#123;</span><br><span class="line">  <span class="keyword">const</span> index = <span class="keyword">this</span>.subscribers.findIndex(</span><br><span class="line">    item =&gt; item.subject === SubjectEnum.FrontEnd &amp;&amp; item.subscriber === <span class="keyword">this</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (index === -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.subscribers.splice(index, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.subscribers.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>改用  <code>findIndex()</code>，需要傳入 arrow function，直接用物件內的 field 做判斷，這樣就可以抓到正確的 <code>index</code>。</p>
<h2 id="filter()">filter()</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">onUnSubscribeClick() &#123;</span><br><span class="line">  <span class="keyword">this</span>.subscribers = <span class="keyword">this</span>.subscribers.filter(</span><br><span class="line">    item =&gt; !(item.subject === SubjectEnum.FrontEnd &amp;&amp; item.subscriber === <span class="keyword">this</span>)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.subscribers.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外一個方法是改用 JavaScript 原生的 <code>filter()</code> ，傳入 arrow function 找出所有 <code>不符合條件</code> 的陣列，重新指定給 <code>subscribers</code>。</p>
<p>由於 <code>filter()</code> 會產生一個新的陣列，所以效率會較差一點，不過符合 FP 的 pure function 要求。</p>
<h2 id="_-remove()">_.remove()</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">onUnSubscribeClick() &#123;</span><br><span class="line">  <span class="keyword">const</span> subjectSubscriber: SubjectSubscriber = &#123;</span><br><span class="line">    subject: SubjectEnum.FrontEnd,</span><br><span class="line">    subscriber: <span class="keyword">this</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  _.remove(<span class="keyword">this</span>.subscribers, subjectSubscriber);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.subscribers.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若使用 Lodash 的 <code>remove()</code>，則有更直覺的寫法，一樣準備好物件，傳進 <code>remove()</code> 即可，雖然物件是 reference type，但 Lodash 的 <code>remove()</code> 會自己比較每個物件的 field 值是否相等。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li><code>indexOf()</code> 找不到物件，並不是 <code>indexOf()</code> 不能使用在物件，而是常常因為新建立物件的 reference 已經改變，導致 <code>indexOf()</code> 找不到</li>
<li>Lodash 的  <code>remove()</code> 提供更直覺的方式刪除物件陣列中的元素，無論是 value type 或 reference type 都適用</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG52RemoveItemInObjectArray" target="_blank" rel="external">GitHub</a> 上找到</p>
]]></content>
    <summary type="html">
    <![CDATA[使用 3 種方式刪除陣列中的物件]]>
    
    </summary>
    
      <category term="JavaScript" scheme="http://oomusou.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何以 Command 方式執行 WebStorm 並開啟專案 ?]]></title>
    <link href="http://oomusou.io/webstorm/run-by-command/"/>
    <id>http://oomusou.io/webstorm/run-by-command/</id>
    <published>2018-02-03T12:23:43.000Z</published>
    <updated>2018-02-03T12:19:01.941Z</updated>
    <content type="html"><![CDATA[<p>我們看到 Visual Studio Code 可以在 terminal 下 command 開啟目前目錄的專案，WebStorm 是否也能以這種方式啟動呢 ?</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>macOS High Sierra 10.13.3<br>WebStorm 2017.3.4</p>
<h2 id="建立啟動_Script">建立啟動 Script</h2><hr>
<p><img src="/images/webstorm/run-by-command/cmd000.png" alt="cmd000"></p>
<p><strong><em>Tools -&gt; Create Command-line Launcher…</em></strong></p>
<p><img src="/images/webstorm/run-by-command/cmd002.png" alt="cmd002"></p>
<p>WebStorm 預設會將 script 建立在 <code>/usr/local/bin/</code>，將來將以 <code>webstorm</code> command 啟動。</p>
<blockquote>
<p>為了少打點字，你也可以自行命名，如 <code>/usr/local/bin/ws</code></p>
</blockquote>
<h2 id="在_Terminal_執行_WebStorm">在 Terminal 執行 WebStorm</h2><hr>
<p><img src="/images/webstorm/run-by-command/cmd001.png" alt="cmd001"></p>
<p>在 terminal 下進入專案目錄，輸入 <code>webstorm .</code> ，WebStorm 會自動執行，並且開啟 <code>NG52MergeMap</code> 專案。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>WebStorm 除了使用 <code>JetBrains ToolBox</code> 開啟專案外，也可以使用 command 方式在直接開啟</li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[更快速的啟動方式]]>
    
    </summary>
    
      <category term="WebStorm" scheme="http://oomusou.io/tags/WebStorm/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何對 Route 單元測試 ?]]></title>
    <link href="http://oomusou.io/angular/route-unit-test/"/>
    <id>http://oomusou.io/angular/route-unit-test/</id>
    <published>2018-02-02T12:23:43.000Z</published>
    <updated>2018-02-01T15:57:24.500Z</updated>
    <content type="html"><![CDATA[<p>前後端分離後，Angular 有自己的 route，在 component 也必須處理 route。由於 component 是 DI 注入 <code>Router</code>，因此若要對 route 單元測試，首先必須要解決的就是 <code>Router</code> 注入問題 。</p>
<a id="more"></a>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/angular/route-unit-test/router000.png" alt="router000"></p>
<p>首頁使用的是 <code>PostComponent</code>，按下 <code>Redirect to comment</code> 將會導到 <code>/comment</code>。</p>
<p><img src="/images/angular/route-unit-test/router001.png" alt="router001"></p>
<p>導到 <code>/comment</code> 之後，將顯示 <code>CommentComponent</code> 。</p>
<h2 id="Task">Task</h2><hr>
<p>對 <code>PostComponent</code> 單元測試，確定有正確導到 <code>/comment</code>。</p>
<h2 id="Implementation">Implementation</h2><hr>
<p><strong>app-routing.module.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RouterModule, Routes &#125; from <span class="string">'@angular/router'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostComponent &#125; from <span class="string">'./post/post.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CommentComponent &#125; from <span class="string">'./comment/comment.component'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123; path: <span class="string">''</span>, component: PostComponent &#125;,</span><br><span class="line">  &#123; path: <span class="string">'comment'</span>, component: CommentComponent &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  imports: [RouterModule.forRoot(routes)],</span><br><span class="line">  exports: [RouterModule]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppRoutingModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>第 6 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123; path: <span class="string">''</span>, component: PostComponent &#125;,</span><br><span class="line">  &#123; path: <span class="string">'comment'</span>, component: CommentComponent &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>實際的 route 設定，為了單元測試也能使用，所以特別使用 <code>export</code> 。</p>
<p><strong>post.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span>post works!<span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onRedirectClick()"</span>&gt;</span>Redirect to comment<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>當按下 <code>Redirect to comment</code> 時，會執行  <code>onRedirectClick()</code>。</p>
<p><strong>post.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Router &#125; from <span class="string">'@angular/router'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-post'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./post.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./post.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> PostComponent &#123;</span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private router: Router) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onRedirectClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.router.navigateByUrl(<span class="string">'comment'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private router: Router) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要使用 <code>Router</code> 去切換 route，因此 DI 注入 <code>Router</code>。</p>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onRedirectClick() &#123;</span><br><span class="line">  <span class="keyword">this</span>.router.navigateByUrl(<span class="string">'comment'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>Router.navigateByUrl()</code> 切換到 <code>comment</code>。</p>
<p><strong>post.component.spec.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ComponentFixture, fakeAsync, TestBed, tick &#125; from <span class="string">'@angular/core/testing'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostComponent &#125; from <span class="string">'./post.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RouterTestingModule &#125; from <span class="string">'@angular/router/testing'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; routes &#125; from <span class="string">'../app-routing.module'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CommentComponent &#125; from <span class="string">'../comment/comment.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Router &#125; from <span class="string">'@angular/router'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'PostComponent'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> fixture: ComponentFixture&lt;PostComponent&gt;;</span><br><span class="line">  <span class="keyword">let</span> postComponent: PostComponent;</span><br><span class="line">  <span class="keyword">let</span> router: Router;</span><br><span class="line"></span><br><span class="line">  beforeEach(() =&gt; &#123;</span><br><span class="line">    TestBed.configureTestingModule(&#123;</span><br><span class="line">      imports: [</span><br><span class="line">        RouterTestingModule.withRoutes(routes)</span><br><span class="line">      ],</span><br><span class="line">      declarations: [</span><br><span class="line">        PostComponent,</span><br><span class="line">        CommentComponent</span><br><span class="line">      ]</span><br><span class="line">    &#125;);</span><br><span class="line">    fixture = TestBed.createComponent(PostComponent);</span><br><span class="line">    postComponent = fixture.componentInstance;</span><br><span class="line">    fixture.detectChanges();</span><br><span class="line"></span><br><span class="line">    router = TestBed.get(Router);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should create'</span>, () =&gt; &#123;</span><br><span class="line">    expect(postComponent).toBeTruthy();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`should navigate to comment`, fakeAsync(() =&gt; &#123;</span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    postComponent.onRedirectClick();</span><br><span class="line">    tick();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    expect(router.url).toEqual(<span class="string">'/comment'</span>);</span><br><span class="line">  &#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">imports: [</span><br><span class="line">  RouterTestingModule.withRoutes(routes)</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>Angular 對於 route 單元測試，另外提供了 <code>RouterTestingModule</code>，使用 <code>withRoutes()</code> 將原本的 route 帶入。</p>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">declarations: [</span><br><span class="line">  PostComponent,</span><br><span class="line">  CommentComponent</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>由於我們由 <code>RouterTestingModule.withRoutes()</code> 所載入的 route 包含 <code>PostComponent</code> 與 <code>CommentComponent</code>，因此需要特別在 <code>declarations</code> 宣告。</p>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> router: Router;</span><br></pre></td></tr></table></figure>
<p>宣告要測試的 <code>router</code>。</p>
<blockquote>
<p>由於其型別仍然是 <code>Router</code>，而不是如 <code>HttpClient</code> 的 <code>HttpTestingController</code>，所以不算 mock，<code>RouterTestingModule</code> 只是幫我們解決了 DI 的問題</p>
</blockquote>
<p>27 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router = TestBed.get(Router);</span><br></pre></td></tr></table></figure>
<p>由 DI 幫我們建立 <code>router</code> 物件。</p>
<p>34 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">it(`should navigate to comment`, fakeAsync(() =&gt; &#123;</span><br><span class="line">  <span class="comment">/** act */</span></span><br><span class="line">  postComponent.onRedirectClick();</span><br><span class="line">  tick();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** assert */</span></span><br><span class="line">  expect(router.url).toEqual(<span class="string">'/comment'</span>);</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>這裡使用了 <code>fackAsync()</code> 與 <code>tick()</code>，這是 Angular 提供的非同步測試機制。</p>
<p>主要的原因是 <code>Router.navigateByUrl()</code> 回傳的是 <code>Promise&lt;boolean&gt;</code>，也就是非同步，因此必須使用 <code>fackAsync()</code> 與  <code>tick()</code>，</p>
<p>簡單的說，由於在 <code>onRedirectClick()</code> 的 <code>Router.navigateByUrl()</code> 為非同步，我們必須使用 <code>tick()</code> 等待非同步執行完畢後，才能繼續執行 <code>expect()</code>，<code>tick()</code> 讓我們不用寫 callback，以更同步的寫法來測試非同步行為。</p>
<p>最後直接 <code>expect()</code> <code>router.url</code>，測試目前 url 有沒有如預期。</p>
<p><img src="/images/angular/route-unit-test/router002.png" alt="router002"></p>
<p>使用 Wallaby.js 通過所有 route 單元測試。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Route 單元測試的可貴在於不用執行 <code>ng serve</code>，就可以測試 route 是否正確</li>
<li>Route 單元測試的難點在於該如何解決 <code>Router</code> DI 注入，所幸搭配 <code>RouterTestingModule</code>，就可以幫我們解決</li>
<li><code>RouterTestingModule</code> 所提供的方式不算 mock <code>Router</code>，只是幫我們解決了 <code>Router</code> DI 注入問題，不管如何，能夠在不執行 <code>ng serve</code> 就可執行測試，就非常難得</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG52RouteUnitTest" target="_blank" rel="external">GitHub</a> 上找到</p>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://angular.io" target="_blank" rel="external">Angular</a>, <a href="https://angular.io/guide/testing" target="_blank" rel="external">Testing</a><br><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fcodecraft.tv%2Fcourses%2Fangular%2Funit-testing%2Frouting%2F&amp;ref_src=twsrc%5Etfw&amp;screen_name=jawache&amp;tw_p=followbutton" target="_blank" rel="external">Asim</a>, <a href="https://codecraft.tv/courses/angular/unit-testing/routing/" target="_blank" rel="external">Testing Routing</a><br><a href="https://medium.com/@buraktasci" target="_blank" rel="external">Burak Tasci</a>, <a href="https://medium.com/burak-tasci/using-jasmine-framework-to-test-angular-router-b568a232efed" target="_blank" rel="external">Using Jasmine framework to test Angular Router</a></p>
]]></content>
    <summary type="html">
    <![CDATA[不執行 ng serve 下就可以測試 route]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="Angular Testing" scheme="http://oomusou.io/tags/Angular-Testing/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何在 Angular 使用傳統 JavaScript 套件 ?]]></title>
    <link href="http://oomusou.io/angular/javascript-package/"/>
    <id>http://oomusou.io/angular/javascript-package/</id>
    <published>2018-02-01T12:23:43.000Z</published>
    <updated>2018-02-02T03:13:38.327Z</updated>
    <content type="html"><![CDATA[<p>Lodash 是 JavaScript 很有名的 package，尤其對於處理 array 很有一套，Angular 該如何使用 <code>lodash</code> 呢 ? 這也可以視為在 Angular 使用傳統 JavaScript package 的 SOP。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.4<br>Angular CLI 1.6.2<br>Angular 5.2.2<br>Lodash 4.17.4</p>
<h2 id="安裝_Lodash">安裝 Lodash</h2><hr>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject $ npm <span class="operator"><span class="keyword">install</span> lodash <span class="comment">--save</span></span></span><br></pre></td></tr></table></figure>
<p>使用  npm 安裝 <code>lodash</code>。</p>
<h2 id="安裝_Lodash_Type_定義檔">安裝 Lodash Type 定義檔</h2><hr>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject $ <span class="built_in">npm</span> install <span class="property">@types</span>/lodash --save-dev</span><br></pre></td></tr></table></figure>
<p>傳統 JavaScript 並沒有型別，但 TypeScript 是個強型別語言，除了型別外還有泛型，這該怎麼與傳統 JavaScript 搭配呢 ?</p>
<p>TypeScript 的解決方案是另外使用 <code>*.d.ts</code>，此為 type 定義檔。</p>
<p>一般來說，若是知名的 JavaScript library，都已經有人維護 type 定義檔，其 package 的規則是 <code>@types/package</code>。</p>
<p>由於 type 定義檔只是 TypeScript 編譯使用，以此加上 <code>--save-dev</code>。</p>
<h2 id="Import_Lodash">Import Lodash</h2><hr>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component, OnInit&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> * as _ from <span class="string">'lodash'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  title = <span class="string">'app'</span>;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> scores: <span class="built_in">number</span>[] = [<span class="number">100</span>, <span class="number">99</span>, <span class="number">98</span>];</span><br><span class="line"></span><br><span class="line">    _.remove(scores, <span class="number">2</span>);</span><br><span class="line">    scores.forEach((score) =&gt; <span class="built_in">console</span>.log(score));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 2 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * as _ from <span class="string">'lodash'</span>;</span><br></pre></td></tr></table></figure>
<p>載入 <code>lodash</code> 。</p>
<blockquote>
<p>因為 lodash 習慣以 <code>_</code> 使用，因此 import 時特別取別名為 <code>_</code></p>
<p>WebStorm 對於 Angular 內建的 API，都可以自動 import，但對於 JavaScript 的 package，目前 WebStorm 還沒有辦法自動 import，需手動載入</p>
</blockquote>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_.remove(scores, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>移除陣列元素一直是 JavaScript 比較麻煩的部分，透過 lodash 的 <code>remove()</code>，可以很簡單的使用。</p>
<blockquote>
<p>目前 WebStorm 在輸入 <code>_.</code> 之後的 intellisense 速度較慢，需要等 1s  之後才會顯示，這應該是 WebStorm 本身的問題</p>
</blockquote>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>實務上若有 Angular 版本的 package，當然優先使用；若遇到必須使用 JavaScript package 不可的場合，除了安裝 package 外，還要安裝 type 定義檔，如此才可以在 Angular 正確使用並通過編譯</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG52Lodash" target="_blank" rel="external">GitHub</a> 上找到</p>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://blog.kevinyang.net" target="_blank" rel="external">CK’s Notepad</a>,  <a href="https://blog.kevinyang.net/2016/11/17/ng2-3rdLibrary/" target="_blank" rel="external">Angular 3rd Library 的安裝筆記</a></p>
]]></content>
    <summary type="html">
    <![CDATA[在 Angular 內使用 JavaScript Package]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何對 Service 單元測試 ?]]></title>
    <link href="http://oomusou.io/angular/service-unit-test/"/>
    <id>http://oomusou.io/angular/service-unit-test/</id>
    <published>2018-01-28T12:23:43.000Z</published>
    <updated>2018-02-01T02:20:30.191Z</updated>
    <content type="html"><![CDATA[<p>凡與顯示相關邏輯，我們會寫在 component；凡與資料相關邏輯，我們會寫在 service。而 service 最常見的應用，就是透過 <code>HttpClient</code> 存取 API。</p>
<p>對於 service 單元測試而言，我們必須對 <code>HttpClient</code> 加以隔離；而對 component 單元測試而言，我們必須對 <code>service</code> 加以隔離，我們該如何對 service 與 component 進行單元測試呢 ?</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Angular CLI 1.6.2<br>Node.js 8.9.4<br>Angular 5.2.2</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/angular/service-unit-test/service000.png" alt="service000"></p>
<ul>
<li>Header 會顯示 <code>Welcome to app!</code></li>
<li>程式一開始會顯示 <code>所有 post</code></li>
<li>按 <code>Add Post</code> 會呼叫 <code>POST</code> API <code>新增 post</code></li>
<li>按 <code>List Posts</code> 會呼叫 <code>GET</code> API 回傳 <code>所有 post</code>    </li>
</ul>
<h2 id="Task">Task</h2><hr>
<ul>
<li>目前有 <code>PostService</code> 使用 <code>HttpClient</code> 存取 API，為了對 <code>PostService</code> 做 <code>單元測試</code>，必須對 <code>HttpClient</code> 加以隔離</li>
<li>目前有 <code>AppComponent</code> 使用 <code>PostService</code>， 為了對 <code>AppComponent</code> 做 <code>單元測試</code>，必須對 <code>PostService</code> 加以隔離</li>
</ul>
<h2 id="Architecture">Architecture</h2><hr>
<p><img src="/images/angular/service-unit-test/service001.svg" alt="service001"></p>
<ul>
<li><code>AppComponent</code> 負責 <code>新增 post</code> 與 <code>顯示 post</code> 的介面顯示；而 <code>PostService</code> 負責 API 的串接</li>
<li>根據 <code>依賴反轉原則</code>，<code>AppComponent</code> 不應該直接相依於 <code>PostService</code>，而是兩者相依於 interface</li>
<li>根據 <code>介面隔離原則</code>，<code>AppComponent</code> 只相依於它所需要的 interface，因此以 <code>AppComponent</code> 的角度訂出 <code>PostInterface</code>，且 <code>PostService</code> 必須實作此 interface</li>
<li>因為 <code>AppComponent</code> 與 <code>PostService</code> 都相依於 <code>PostInterface</code>，兩者都只知道 <code>PostInterface</code> 而已，而不知道彼此，因此 <code>AppComponent</code> 與  <code>PostService</code> 徹底解耦合</li>
<li>透過 DI 將實作 <code>PostInterface</code> 的 <code>PostService</code> 注入到 <code>AppComponent</code> ，且將 <code>HttpClient</code> 注入到 <code>PostService</code></li>
</ul>
<h2 id="Implementation">Implementation</h2><hr>
<p><code>AppComponent</code> 與 <code>PostService</code> 的實作並非本文的重點，本文的重點在於實作 <code>AppComponent</code> 與 <code>PostService</code> 的 <code>單元測試</code> 部分。</p>
<h3 id="PostService">PostService</h3><p><img src="/images/angular/service-unit-test/service002.svg" alt="service002"></p>
<p><strong>post.service.spec.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; TestBed &#125; from <span class="string">'@angular/core/testing'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostService &#125; from <span class="string">'./post.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpClientTestingModule, HttpTestingController &#125; from <span class="string">'@angular/common/http/testing'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostInterfaceToken &#125; from <span class="string">'../interface/injection.token'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Post &#125; from <span class="string">'../../model/post.model'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; environment &#125; from <span class="string">'../../environments/environment'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostInterface &#125; from <span class="string">'../interface/post.interface'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'PostService'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> postService: PostInterface;</span><br><span class="line">  <span class="keyword">let</span> mockHttpClient: HttpTestingController;</span><br><span class="line"></span><br><span class="line">  beforeEach(() =&gt; &#123;</span><br><span class="line">    TestBed.configureTestingModule(&#123;</span><br><span class="line">      imports: [</span><br><span class="line">        HttpClientTestingModule</span><br><span class="line">      ],</span><br><span class="line">      providers: [</span><br><span class="line">        &#123;provide: PostInterfaceToken, useClass: PostService&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    postService = TestBed.get(PostInterfaceToken, PostService);</span><br><span class="line">    mockHttpClient = TestBed.get(HttpTestingController);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should be created'</span>, () =&gt; &#123;</span><br><span class="line">    expect(PostService).toBeTruthy();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`should list all posts`, () =&gt; &#123;</span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="keyword">const</span> expected: Post[] = [</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="number">1</span>,</span><br><span class="line">        title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">        author: <span class="string">'Dr. Eric Gamma'</span></span><br><span class="line">      &#125;</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    postService.listPosts$().subscribe(posts =&gt; &#123;</span><br><span class="line">      <span class="comment">/** assert */</span></span><br><span class="line">      expect(posts).toEqual(expected);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line">    <span class="keyword">const</span> mockResponse: Post[] = [</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="number">1</span>,</span><br><span class="line">        title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">        author: <span class="string">'Eric Gamma'</span></span><br><span class="line">      &#125;</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    mockHttpClient.expectOne(&#123;</span><br><span class="line">      url: `$&#123;environment.apiServer&#125;/posts`,</span><br><span class="line">      method: <span class="string">'GET'</span></span><br><span class="line">    &#125;).flush(mockResponse);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`should add post`, () =&gt; &#123;</span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="keyword">const</span> expected: Post = &#123;</span><br><span class="line">      id: <span class="number">1</span>,</span><br><span class="line">      title: <span class="string">'OOP'</span>,</span><br><span class="line">      author: <span class="string">'Sam'</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    postService.addPost(expected).subscribe(post =&gt; &#123;</span><br><span class="line">      <span class="comment">/** assert */</span></span><br><span class="line">      expect(post).toBe(expected);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line">    mockHttpClient.expectOne(&#123;</span><br><span class="line">      url: `$&#123;environment.apiServer&#125;/posts`,</span><br><span class="line">      method: <span class="string">'POST'</span></span><br><span class="line">    &#125;).flush(expected);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  afterEach(() =&gt; &#123;</span><br><span class="line">    mockHttpClient.verify();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TestBed.configureTestingModule(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    HttpClientTestingModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    &#123;provide: PostInterfaceToken, useClass: PostService&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Angular 有 module 觀念，若使用到了其他 module，必須在 <code>imports</code> 設定；若使用到 DI，則必須在 <code>providers</code> 設定。</p>
<p>若只有一個 module，則在 <code>AppModule</code> 設定。</p>
<p>但是單元測試時，並沒有使用 <code>AppModule</code> 的設定，因為我們可能在測試時使用其他替代 module，也可能自己實作 fake 另外 DI。</p>
<p>Angular 提供了 <code>TestBed.configureTestingModule()</code>，讓我們另外設定跑測試時的 <code>imports</code> 與 <code>providers</code> 部分。</p>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">imports: [</span><br><span class="line">  HttpClientTestingModule</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>原本 <code>HttpClient</code> 使用的是 <code>HttpClientModule</code>，這會使得 <code>HttpClient</code> 真的透過網路去打 API，這就不符合單元測試 <code>隔離</code> 的要求，因此 Angular 另外提供 <code>HttpClientTestingModule</code> 取代 <code>HttpClientModule</code>。</p>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  &#123;provide: PostInterfaceToken, useClass: PostService&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>由於我們要測試的就是 <code>PostService</code>，因此 <code>PostService</code> 也必須由 DI 幫我們建立。</p>
<p>但因爲 <code>PostService</code> 是基於 <code>PostInterface</code> 建立，因此必須透過 <code>PostInterfaceToken</code> mapping 到 <code>PostService</code>。</p>
<p>23 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postService = TestBed.get(PostInterfaceToken, PostService);</span><br><span class="line">mockHttpClient = TestBed.get(HttpTestingController);</span><br></pre></td></tr></table></figure>
<p>由 <code>providers</code> 設定好 interface 與 class 的 mapping 關係後，我們必須透過 DI 建立 <code>postService</code> 與 <code>mockHttpClient</code>。</p>
<p>其中 <code>HttpTestingController</code> 相當於 mock 版的 <code>HttpClient</code>，因此取名為 <code>mockHttpClient</code>。</p>
<blockquote>
<p>TestBed.get() 其實相當於 <code>new</code>，只是這是藉由 DI 幫我們 <code>new</code> 而已</p>
</blockquote>
<p>31 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">it(`should list all posts`, () =&gt; &#123;</span><br><span class="line">  <span class="comment">/** act */</span></span><br><span class="line">  <span class="keyword">const</span> expected: Post[] = [</span><br><span class="line">    &#123;</span><br><span class="line">      id: <span class="number">1</span>,</span><br><span class="line">      title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">      author: <span class="string">'Dr. Eric Gamma'</span></span><br><span class="line">    &#125;</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  postService.listPosts$().subscribe(posts =&gt; &#123;</span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    expect(posts).toEqual(expected);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** arrange */</span></span><br><span class="line">  <span class="keyword">const</span> mockResponse: Post[] = [</span><br><span class="line">    &#123;</span><br><span class="line">      id: <span class="number">1</span>,</span><br><span class="line">      title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">      author: <span class="string">'Eric Gamma'</span></span><br><span class="line">    &#125;</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  mockHttpClient.expectOne(&#123;</span><br><span class="line">    url: `$&#123;environment.apiServer&#125;/posts`,</span><br><span class="line">    method: <span class="string">'GET'</span></span><br><span class="line">  &#125;).flush(mockResponse);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>先談談如何測試 <code>GET</code>。</p>
<p>3A 原則的 <code>arrange</code> 習慣都會寫在最前面，但在 service 的單元測試時，<code>arrange</code> 必須寫在最後面，否則會執行錯誤，稍後會解釋原因。</p>
<p>32 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line"><span class="keyword">const</span> expected: Post[] = [</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="number">1</span>,</span><br><span class="line">    title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">    author: <span class="string">'Dr. Eric Gamma'</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">postService.listPosts$().subscribe(posts =&gt; &#123;</span><br><span class="line">  <span class="comment">/** assert */</span></span><br><span class="line">  expect(posts).toEqual(expected);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>直接對 <code>PostService.listPost$()</code> 測試，由於 <code>listPost$()</code> 回傳 <code>Observable</code>，因此 <code>expect()</code> 必須寫在 <code>subscribe()</code> 內。</p>
<p>將預期的測試結果寫在 <code>expected</code> 內。</p>
<blockquote>
<p>一般 <code>Observable</code> 會在 <code>subscribe()</code> 後執行，不過在 <code>HttpTestingController</code> 的設計裡，<code>subscribe()</code> 會在 <code>flush()</code> 才執行，稍後會看到 <code>flush()</code>，所以此時並還沒有執行 <code>expect()</code> 測試</p>
</blockquote>
<p>46 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** arrange */</span></span><br><span class="line"><span class="keyword">const</span> mockResponse: Post[] = [</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="number">1</span>,</span><br><span class="line">    title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">    author: <span class="string">'Eric Gamma'</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">mockHttpClient.expectOne(&#123;</span><br><span class="line">  url: `$&#123;environment.apiServer&#125;/posts`,</span><br><span class="line">  method: <span class="string">'GET'</span></span><br><span class="line">&#125;).flush(mockResponse);</span><br></pre></td></tr></table></figure>
<p>之前已經使用 <code>HttpClientTestingModule</code> 取代 <code>HttpClient</code>，<code>HttpTestingController</code> 取代 <code>HttpClient</code>，這只能確保呼叫 API 時不用透過網路。</p>
<p>還要透過 <code>expectOne()</code> 設定要 mock 的 URI 與 action，之所以取名為 <code>expectOne()</code>，就是期望有人真的呼叫這個 URI <code>一次</code>，且必須為 <code>GET</code>，若沒有呼叫這個 URI 或者不是 <code>GET</code>，將造成單元測試 <code>紅燈</code>。</p>
<p>這也是為什麼 <code>HttpTestingController</code> 的設計是 <code>act</code> 與 <code>assert</code> 要先寫，最後再寫 <code>arrange</code>，因為 <code>HttpTestingController</code> 本身也有 <code>assert</code> 功能，必須有 <code>act</code>，才能知道 <code>assert</code> URI 與 GET 有沒有錯誤。</p>
<p>最後使用 <code>flush()</code> 設定 mock 的回傳值，<code>flush</code> 英文就是 <code>沖水</code>，當 <code>HttpTestingController</code> 將 <code>mockResponse</code> 沖出去後，才會執行 <code>subscribe()</code> 內的 <code>expect()</code> 測試。</p>
<blockquote>
<p>也就是說若你忘了寫 <code>flush()</code>，其實單元測試也會 <code>綠燈</code>，但此時的綠燈並不是真的測試通過，而是根本沒有執行到 <code>subscribe()</code> 內的 <code>expect()</code>。</p>
</blockquote>
<p>81 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">afterEach(() =&gt; &#123;</span><br><span class="line">  mockHttpClient.verify();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>實務上可能真的忘了寫 <code>expectOne()</code> 與  <code>flush()</code>，導致 <code>subscribe()</code> 內的 <code>expect()</code> 根本沒跑到而造成單元測試 <code>綠燈</code>，因此必須在每個單元測試跑完補上 <code>mockHttpClient.verify()</code>，若有任何 API request 卻沒有經過 <code>expectOne()</code> 與 <code>flush()</code> 測試，則 <code>verify()</code> 會造成單元測試 <code>紅燈</code>，藉以彌補忘了寫 <code>expectOne()</code> 與 <code>flush()</code> 的人為錯誤。</p>
<blockquote>
<p>Q : 我們在 <code>listPosts$()</code> 的單元測試到底測試了什麼 ?</p>
</blockquote>
<ul>
<li>若 service 的 API 與 mock 不同，會出現單元測試 <code>紅燈</code>，可能是 service 的 API 錯誤</li>
<li>若 service 的 action 與 mock 不同，會出現單元測試 <code>紅燈</code>，可能是 service 的 action 錯誤</li>
<li>若 service 的 response 與 expected 不同，可能是 service 的邏輯錯誤</li>
</ul>
<p>61 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">it(`should add post`, () =&gt; &#123;</span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    <span class="keyword">const</span> expected: Post = &#123;</span><br><span class="line">      id: <span class="number">1</span>,</span><br><span class="line">      title: <span class="string">'OOP'</span>,</span><br><span class="line">      author: <span class="string">'Sam'</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    postService.addPost(expected).subscribe(post =&gt; &#123;</span><br><span class="line">      <span class="comment">/** assert */</span></span><br><span class="line">      expect(post).toBe(expected);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line">    mockHttpClient.expectOne(&#123;</span><br><span class="line">      url: `$&#123;environment.apiServer&#125;/posts`,</span><br><span class="line">      method: <span class="string">'POST'</span></span><br><span class="line">    &#125;).flush(expected);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>再來談談如何測試 <code>POST</code>。</p>
<p>62 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line"><span class="keyword">const</span> expected: Post = &#123;</span><br><span class="line">  id: <span class="number">1</span>,</span><br><span class="line">  title: <span class="string">'OOP'</span>,</span><br><span class="line">  author: <span class="string">'Sam'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">postService.addPost(expected).subscribe(post =&gt; &#123;</span><br><span class="line">  <span class="comment">/** assert */</span></span><br><span class="line">  expect(post).toBe(expected);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>直接對 <code>PostService.addPost()</code> 測試，由於 <code>addPost()</code> 回傳 <code>Observable</code>，因此 <code>expect()</code> 必須寫在 <code>subscribe()</code> 內。</p>
<p>將預期的測試結果寫在 <code>expected</code> 內。</p>
<p>74 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** arrange */</span></span><br><span class="line">mockHttpClient.expectOne(&#123;</span><br><span class="line">  url: `$&#123;environment.apiServer&#125;/posts`,</span><br><span class="line">  method: <span class="string">'POST'</span></span><br><span class="line">&#125;).flush(expected);</span><br></pre></td></tr></table></figure>
<p>因為要 mock <code>POST</code>，因此 <code>method</code> 部分改為 <code>POST</code>，其他部分與 <code>GET</code> 部分完全相同。</p>
<blockquote>
<p>Q : 我們在 <code>addPost()</code> 到底測試了什麼 ?</p>
</blockquote>
<ul>
<li>若 service 的 API 與 mock 不同，會出現單元測試 <code>紅燈</code>，可能是 service 的 API 錯誤</li>
<li>若 service 的 action 與 mock 不同，會出現單元測試 <code>紅燈</code>，可能是 service 的 action 錯誤</li>
<li>若 service 的 response 與 expected 不同，可能是 service 的邏輯錯誤</li>
</ul>
<p><img src="/images/angular/service-unit-test/service004.png" alt="service004"></p>
<p>使用 Wallaby.js 通過所有 service 單元測試。</p>
<h3 id="AppComponent">AppComponent</h3><p><img src="/images/angular/service-unit-test/service003.svg" alt="service003"></p>
<p><strong>app.component.spec.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; async, ComponentFixture, TestBed &#125; from <span class="string">'@angular/core/testing'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FormsModule &#125; from <span class="string">'@angular/forms'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpClientTestingModule &#125; from <span class="string">'@angular/common/http/testing'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostService &#125; from <span class="string">'./service/post.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostInterfaceToken &#125; from <span class="string">'./interface/injection.token'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DebugElement &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'rxjs/add/observable/of'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostInterface &#125; from <span class="string">'./interface/post.interface'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'AppComponent'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> fixture: ComponentFixture&lt;AppComponent&gt;;</span><br><span class="line">  <span class="keyword">let</span> appComponent: AppComponent;</span><br><span class="line">  <span class="keyword">let</span> debugElement: DebugElement;</span><br><span class="line">  <span class="keyword">let</span> htmlElement: HTMLElement;</span><br><span class="line">  <span class="keyword">let</span> postService: PostInterface;</span><br><span class="line"></span><br><span class="line">  beforeEach(async(() =&gt; &#123;</span><br><span class="line">    TestBed.configureTestingModule(&#123;</span><br><span class="line">      declarations: [</span><br><span class="line">        AppComponent</span><br><span class="line">      ],</span><br><span class="line">      imports: [</span><br><span class="line">        FormsModule,</span><br><span class="line">        HttpClientTestingModule</span><br><span class="line">      ],</span><br><span class="line">      providers: [</span><br><span class="line">        &#123;provide: PostInterfaceToken, useClass: PostService&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;).compileComponents();</span><br><span class="line"></span><br><span class="line">    fixture = TestBed.createComponent(AppComponent);</span><br><span class="line">    appComponent = fixture.componentInstance;</span><br><span class="line">    debugElement = fixture.debugElement;</span><br><span class="line">    htmlElement = debugElement.nativeElement;</span><br><span class="line">    fixture.detectChanges();</span><br><span class="line"></span><br><span class="line">    postService = TestBed.get(PostInterfaceToken, PostService);</span><br><span class="line">  &#125;));</span><br><span class="line">  </span><br><span class="line">  it(<span class="string">'should create the app'</span>, async(() =&gt; &#123;</span><br><span class="line">    expect(appComponent).toBeTruthy();</span><br><span class="line">  &#125;));</span><br><span class="line"></span><br><span class="line">  it(`should have as title <span class="string">'app'</span>`, async(() =&gt; &#123;</span><br><span class="line">    expect(appComponent.title).toEqual(<span class="string">'app'</span>);</span><br><span class="line">  &#125;));</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should render title in a h1 tag'</span>, async(() =&gt; &#123;</span><br><span class="line">    expect(htmlElement.querySelector(<span class="string">'h1'</span>).textContent).toContain(<span class="string">'Welcome to app!'</span>);</span><br><span class="line">  &#125;));</span><br><span class="line"></span><br><span class="line">  it(`should list posts`, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> expected$ = Observable.of([</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="number">1</span>,</span><br><span class="line">        title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">        author: <span class="string">'Dr. Eric Gamma'</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line">    spyOn(postService, <span class="string">'listPosts$'</span>).and.returnValue(expected$);</span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    appComponent.onListPostsClick();</span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    expect(appComponent.posts$).toEqual(expected$);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(`should add post`, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> expected$ = Observable.of(</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="number">1</span>,</span><br><span class="line">        title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">        author: <span class="string">'Dr. Eric Gamma'</span></span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** arrange */</span></span><br><span class="line">    <span class="keyword">const</span> spy = spyOn(postService, <span class="string">'addPost'</span>).and.returnValue(expected$);</span><br><span class="line">    <span class="comment">/** act */</span></span><br><span class="line">    appComponent.onAddPostClick();</span><br><span class="line">    <span class="comment">/** assert */</span></span><br><span class="line">    expect(spy).toHaveBeenCalled();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>20 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">TestBed.configureTestingModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    FormsModule,</span><br><span class="line">    HttpClientTestingModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    &#123;provide: PostInterfaceToken, useClass: PostService&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;).compileComponents();</span><br></pre></td></tr></table></figure>
<p>跑 component 單元測試時，一樣沒有使用 <code>AppModule</code> 的設定，因為我們可能在測試時使用其他替代 module，也可能自己實作 fake 另外 DI。</p>
<p>因此一樣使用 <code>TestBed.configureTestingModule()</code>，讓我們另外設定跑測試時的 <code>imports</code> 與 <code>providers</code> 部分。</p>
<p>24 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">imports: [</span><br><span class="line">  FormsModule,</span><br><span class="line">  HttpClientTestingModule</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>因為在 component 使用了 two-way binding，因此要加上 <code>FormsModule</code>。</p>
<blockquote>
<p>Q : 為什麼要 import <code>HttpClientTestingModule</code> 呢 ?</p>
</blockquote>
<p><code>AppComponent</code> 依賴的是 <code>PostService</code>，看起來與 <code>HttpClient</code> 無關，應該不需要注入 <code>HttpClientTestingModule</code>。</p>
<p>但其實 DI 並不是這樣運作，雖然 <code>AppComponent</code> 只用到了 <code>PostService</code>，但 DI 會將 <code>PostService</code> 下所有的 dependency 都一起注入，所以也要 import <code>HttpClientTestingModule</code>。</p>
<p>28 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  &#123;provide: PostInterfaceToken, useClass: PostService&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>由於我們要測試的就是 <code>PostService</code>，因此 <code>PostService</code> 也必須由 DI 幫我們建立。</p>
<p>但因爲 <code>PostService</code> 是基於 <code>PostInterface</code> 建立，因此必須透過 <code>PostInterfaceToken</code> mapping 到 <code>PostService</code>。</p>
<p>39 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postService = TestBed.get(PostInterfaceToken, PostService);</span><br></pre></td></tr></table></figure>
<p>由 <code>providers</code> 設定好 interface 與 class 的 mapping 關係後，我們必須透過 DI 建立 <code>postService</code> 與。</p>
<p>53 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">it(`should list posts`, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> expected$ = Observable.of([</span><br><span class="line">    &#123;</span><br><span class="line">      id: <span class="number">1</span>,</span><br><span class="line">      title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">      author: <span class="string">'Dr. Eric Gamma'</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** arrange */</span></span><br><span class="line">  spyOn(postService, <span class="string">'listPosts$'</span>).and.returnValue(expected$);</span><br><span class="line">  <span class="comment">/** act */</span></span><br><span class="line">  appComponent.onListPostsClick();</span><br><span class="line">  <span class="comment">/** assert */</span></span><br><span class="line">  expect(appComponent.posts$).toEqual(expected$);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>55 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> expected$ = Observable.of([</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="number">1</span>,</span><br><span class="line">    title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">    author: <span class="string">'Dr. Eric Gamma'</span></span><br><span class="line">  &#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<p>透過 <code>Observable.of()</code> 將 <code>Post[]</code> 轉成 <code>Observable&lt;Post[]&gt;</code>。</p>
<p>63 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** arrange */</span></span><br><span class="line">spyOn(postService, <span class="string">'listPosts$'</span>).and.returnValue(expected$);</span><br></pre></td></tr></table></figure>
<p>由於我們要隔離 <code>PostService</code>，因此使用 <code>spyOn()</code> 對 <code>PostService</code> 的 <code>listPost$()</code> 加以 mock，並設定其假的回傳值。</p>
<p>65 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line">appComponent.onListPostsClick();</span><br></pre></td></tr></table></figure>
<p>實際測試 <code>onListPostClick()</code>。</p>
<p>67 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** assert */</span></span><br><span class="line">expect(appComponent.posts$).toEqual(expected$);</span><br></pre></td></tr></table></figure>
<p>測試 <code>AppComponent.post$</code> 是否如預期。</p>
<blockquote>
<p>Q : 我們在 <code>onListPostsClick()</code> 到底測試了什麼 ?</p>
</blockquote>
<ul>
<li>若 component 的 return 與 expected 不同，可能是 component 的邏輯錯誤</li>
</ul>
<p>70 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">it(`should add post`, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> expected$ = Observable.of(</span><br><span class="line">    &#123;</span><br><span class="line">      id: <span class="number">1</span>,</span><br><span class="line">      title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">      author: <span class="string">'Dr. Eric Gamma'</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** arrange */</span></span><br><span class="line">  <span class="keyword">const</span> spy = spyOn(postService, <span class="string">'addPost'</span>).and.returnValue(expected$);</span><br><span class="line">  <span class="comment">/** act */</span></span><br><span class="line">  appComponent.onAddPostClick();</span><br><span class="line">  <span class="comment">/** assert */</span></span><br><span class="line">  expect(spy).toHaveBeenCalled();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>72 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> expected$ = Observable.of(</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="number">1</span>,</span><br><span class="line">    title: <span class="string">'Design Pattern'</span>,</span><br><span class="line">    author: <span class="string">'Dr. Eric Gamma'</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>透過 <code>Observable.of()</code> 將 <code>Post</code> 轉成 <code>Observable&lt;Post&gt;</code>。</p>
<p>80 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** arrange */</span></span><br><span class="line"><span class="keyword">const</span> spy = spyOn(postService, <span class="string">'addPost'</span>).and.returnValue(expected$);</span><br></pre></td></tr></table></figure>
<p>由於我們要隔離 <code>PostService</code>，因此使用 <code>spyOn()</code> 對 <code>PostService</code> 的 <code>addPost</code> 加以 mock，並設定其假的回傳值。</p>
<p>82 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line">appComponent.onAddPostClick();</span><br></pre></td></tr></table></figure>
<p>實際測試 <code>onAddPostClick()</code>。</p>
<p>84 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** assert */</span></span><br><span class="line">expect(spy).toHaveBeenCalled();</span><br></pre></td></tr></table></figure>
<p>由於 <code>onAddPostClick()</code> 回傳值為 <code>void</code>，且 <code>PostService.addPost()</code> 已經有單元測試保護，因此只要測試 <code>PostService.addPost()</code> 曾經被呼叫過即可。</p>
<p><img src="/images/angular/service-unit-test/service005.png" alt="service005"></p>
<p>使用 Wallaby.js 通過所有 component 單元測試。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>當 component 使用了 service，若要單元測試就牽涉到 DI 與 <code>spyOn()</code></li>
<li>Service 單元測試可透過 <code>HttpTestingController</code> 加以隔離 <code>HttpClient</code></li>
<li>Component 單元測試可透過 <code>spyOn()</code> 加以隔離 service</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG52ServiceUnitTest" target="_blank" rel="external">GitHub</a> 上找到</p>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://angular.io" target="_blank" rel="external">Angular</a>, <a href="https://angular.io/guide/testing" target="_blank" rel="external">Testing</a><br><a href="https://angular.io" target="_blank" rel="external">Angular</a>, <a href="https://angular.io/guide/http" target="_blank" rel="external">HttpClient</a><br><a href="https://offering.solutions/blog/author/" target="_blank" rel="external">Fabian Gosebrink</a>, <a href="https://offering.solutions/blog/articles/2017/10/02/testing-angular-2-http-service/" target="_blank" rel="external">Testing Angular Http Service</a><br><a href="https://medium.com/@paynoattn?source=post_header_lockup" target="_blank" rel="external">Chris Pawlukiewicz</a>, <a href="https://medium.com/@paynoattn/simple-observable-unit-testing-in-angular2-43c4f4a0bfe2" target="_blank" rel="external">Simple Observable Unit Testing in Angular 2</a><br>Jesse Palmer, <a href="https://www.manning.com/books/testing-angular-applications" target="_blank" rel="external">Testing Angular Applications</a></p>
]]></content>
    <summary type="html">
    <![CDATA[使用 HttpTestingController 將大幅簡化單元測試]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="Angular Testing" scheme="http://oomusou.io/tags/Angular-Testing/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何以 JSON Server 模擬 Query String API ?]]></title>
    <link href="http://oomusou.io/json-server/querystring/"/>
    <id>http://oomusou.io/json-server/querystring/</id>
    <published>2018-01-22T12:23:43.000Z</published>
    <updated>2018-01-22T15:51:43.000Z</updated>
    <content type="html"><![CDATA[<p>雖然我們都盡量希望  API 以 URI 的方式表示，但實務上仍有一些 API 使用老式的 query string，我們該如何使用 JSON Server 模擬這類的  API 呢 ?</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>JSON Server 0.12.0</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/json-server/querystring/qs000.png" alt="qs000"></p>
<p>Server 端並沒有提供類似 <code>http://localhost/posts/1</code> 使用 URI 的 API，而是提供 <code>http://localhost:3000/api/posts?id=1</code> 使用 query string 的 API</p>
<h2 id="Task">Task</h2><hr>
<p>希望能夠使用 JSON Server 模擬出 query string 風格的 API，讓前端與後端可以同時開發。</p>
<h2 id="Implementation">Implementation</h2><hr>
<h3 id="新增_routes-json">新增 <code>routes.json</code></h3><p><strong>routes.json</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">/api/posts</span>": <span class="value"><span class="string">"/posts"</span></span>,</span><br><span class="line">  "<span class="attribute">/api/posts?id=:id</span>": <span class="value"><span class="string">"/posts/:id"</span></span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>JSON Server 本身只提供 URI 風格的 API，必須靠自訂 route，將 <code>posts?id=:id</code> 轉成 <code>/posts/:id</code>， 其中 <code>:id</code> 為變數。</p>
<p><img src="/images/json-server/querystring/qs001.png" alt="qs001"></p>
<ol>
<li>新增 <code>routes.json</code> </li>
<li>新增 <code>&quot;/api/posts?id=:id&quot;: &quot;/posts/:id&quot;</code>，將 query string 對應到 URI，其中 <code>:id</code> 為變數</li>
</ol>
<h3 id="啟動_JSON_Sever">啟動 JSON Sever</h3><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject <span class="variable">$json-server</span> ./json/db.json --routes ./json/routes.json</span><br></pre></td></tr></table></figure>
<p>啟動 JSON Server，除了 <code>db.json</code> 外，另外加上 <code>--routes</code> 參數與 <code>routes.json</code>。</p>
<p><img src="/images/json-server/querystring/qs002.png" alt="qs002"></p>
<h3 id="使用_Postman_測試">使用 Postman 測試</h3><p><img src="/images/json-server/querystring/qs000.png" alt="qs000"></p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>只要透過簡單的 route 設定，JSON Server 也能模擬出 query string 風格的 API</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在 <a href="https://github.com/oomusou/JsonServerQueryString" target="_blank" rel="external">GitHub</a> 上找到</p>
]]></content>
    <summary type="html">
    <![CDATA[讓 JSON Server 的應用更全面]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="JSON Server" scheme="http://oomusou.io/tags/JSON-Server/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ViewChild() Decorator 的使用方法]]></title>
    <link href="http://oomusou.io/angular/viewchild/"/>
    <id>http://oomusou.io/angular/viewchild/</id>
    <published>2018-01-18T12:23:43.000Z</published>
    <updated>2018-01-19T02:24:54.000Z</updated>
    <content type="html"><![CDATA[<p><code>@ViewChild()</code> decorator 一開始是在存取 child component 時學到的，事實上 <code>@ViewChild()</code> 還有其他使用方法。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.3<br>Angular CLI 1.6.2<br>Angular 5.2</p>
<h2 id="Component">Component</h2><hr>
<p>使用 <code>@ViewChild()</code> 存取 child component。</p>
<p><img src="/images/angular/viewchild/viewchild000.png" alt="viewchild000"></p>
<ul>
<li><code>counter</code> 初始值為 <code>2</code></li>
<li>按 <code>+</code> 則 <code>counter</code> + 1，按 <code>-</code> 則 <code>counter</code> -1</li>
</ul>
<h3 id="Architecture">Architecture</h3><p><img src="/images/angular/viewchild/viewchild001.svg" alt="viewchild001"></p>
<ul>
<li><code>AppComponent</code> 負責處理 <code>&lt;button/&gt;</code>；<code>CounterComponent</code> 負責顯示 <code>counter</code></li>
<li><code>AppComponent</code> 相當於 parent component，<code>CounterComponent</code> 相當於 child component</li>
<li><code>AppComponent</code> 直接呼叫 <code>CounterComponent</code> 的 method 改變 <code>counter</code>；<code>AppComponent</code> 也可直接讀取 <code>CounterComponent</code> 的 property</li>
</ul>
<h3 id="Implementation">Implementation</h3><p><strong>AppComponent</strong></p>
<p><img src="/images/angular/viewchild/viewchild002.svg" alt="viewchild002"></p>
<p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onAddOneClick()"</span>&gt;</span>+<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onMinusOneClick()"</span>&gt;</span>-<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-counter</span>&gt;</span><span class="tag">&lt;/<span class="title">app-counter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>將 2 個 <code>&lt;button/&gt;</code> 留在 <code>AppComponent</code> 內。</p>
<p><code>counter</code> 的顯示由 <code>&lt;app-counter/&gt;</code> 負責。</p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AfterViewInit, Component, ViewChild &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterComponent &#125; from <span class="string">'./counter/counter.component'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> AfterViewInit &#123;</span><br><span class="line">  @ViewChild(CounterComponent)</span><br><span class="line">  <span class="keyword">private</span> counterComponent: CounterComponent;</span><br><span class="line"></span><br><span class="line">  ngAfterViewInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.counterComponent.counter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onAddOneClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterComponent.addOne();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onMinusOneClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterComponent.minusOne();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@ViewChild(CounterComponent)</span><br><span class="line"><span class="keyword">private</span> counterComponent: CounterComponent;</span><br></pre></td></tr></table></figure>
<p>Angular 允許我們在 parent component 透過 <code>@ViewChild()</code> decorator 宣告 child component，藉此存取 child component 的 public field 與 method。</p>
<p><code>@ViewChild()</code> 第一個參數傳入 child component 的型別。</p>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> AfterViewInit &#123;</span><br><span class="line">  ngAfterViewInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.counterComponent.counter);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若要透過 <code>@ViewChild()</code> 存取 child component 的 public field，則必須在 <code>ngAfterViewInit()</code> lifecycle hook 才可抓的到，不可以在 <code>ngOnInit()</code>。</p>
<p>17 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onAddOneClick() &#123;</span><br><span class="line">  <span class="keyword">this</span>.counterComponent.addOne();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若要透過 <code>@ViewChild()</code> 存取 child component 的 public method，則無此限制。</p>
<p><strong>CounterComponent</strong></p>
<p><img src="/images/angular/viewchild/viewchild003.svg" alt="viewchild003"></p>
<p><strong>counter.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; counter &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>負責顯示 <code>counter</code>。</p>
<p><strong>counter.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-counter'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./counter.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./counter.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CounterComponent &#123;</span><br><span class="line">  counter = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  addOne() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counter++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  minusOne() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counter--;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>沒有特別的部分需要講解。</p>
<p><img src="/images/angular/viewchild/viewchild004.svg" alt="viewchild004"></p>
<p>當 parent component 要存取 child component 時，使用 <code>@ViewChild()</code> 宣告 child decorator，public field 可在 <code>ngAfterViewInit()</code> 存取，public method 則無此限制</p>
<h2 id="Directive">Directive</h2><p>當使用 directive 套用在 HTML 上時，可以藉由 <code>@ViewChild()</code> 取得 directive 的物件實體，藉此控制 directive。</p>
<h3 id="Implementation-1">Implementation</h3><p><strong>ChangeColorDirective</strong></p>
<p><strong>change-color.directive.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AfterViewInit, Directive, ElementRef &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Directive(&#123;</span><br><span class="line">  selector: <span class="string">'[appChangeColor]'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ChangeColorDirective <span class="keyword">implements</span> AfterViewInit &#123;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private elementRef: ElementRef) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngAfterViewInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.elementRef.nativeElement.style.color = <span class="string">'red'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  change(changedColor: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.elementRef.nativeElement.style.color = changedColor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 Angular CLI 的 <code>ng g d ChangeColor</code> 建立 <code>ChangeColor</code> directive。</p>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">change(changedColor: <span class="built_in">string</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.elementRef.nativeElement.style.color = changedColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ChangeColor</code> directive 提供了 <code>change()</code> 修改 <code>color</code>。</p>
<p><strong>AppComponent</strong></p>
<p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">p</span> <span class="attribute">appChangeColor</span>&gt;</span>&#123;&#123; title &#125;&#125;<span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onChangeColorClick()"</span>&gt;</span>Change Color<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>&lt;p&gt;</code> 套用了 <code>ChangeColor</code> directive。</p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, ViewChild &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ChangeColorDirective &#125; from <span class="string">'./change-color.directive'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  @ViewChild(ChangeColorDirective)</span><br><span class="line">  <span class="keyword">private</span> changeColorDirective: ChangeColorDirective;</span><br><span class="line">  title = <span class="string">'app'</span>;</span><br><span class="line"></span><br><span class="line">  onChangeColorClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.changeColorDirective.change(<span class="string">'green'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@ViewChild(ChangeColorDirective)</span><br><span class="line"><span class="keyword">private</span> changeColorDirective: ChangeColorDirective;</span><br></pre></td></tr></table></figure>
<p>為了使用 <code>ChangeColor</code> directive 的 <code>change()</code>，特別使用 <code>@ViewChild()</code> 取得 <code>ChangeColor</code> directive 的物件實體，如此就能使用 <code>change()</code>。</p>
<h2 id="DOM_Element">DOM Element</h2><hr>
<p>最後一個常用的 <code>@ViewChild()</code> 方式，是藉由 template reference varibale 存取 DOM element。</p>
<h3 id="Implementation-2">Implementation</h3><p><strong>AppComponent</strong></p>
<p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Name: <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> #<span class="attribute">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onSubmitClick()"</span>&gt;</span>Submit<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line">&#123;&#123; yourName &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>若要在 JavaScript 存取 HTML，傳統會使用 <code>id</code> 或 CSS selector，在 Angular 提出新的方法，我們可以為 HTML 加上 <code>#</code> 開頭的 template reference variable。</p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, ElementRef, ViewChild &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  yourName: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  @ViewChild(<span class="string">'name'</span>)</span><br><span class="line">  <span class="keyword">private</span> name: ElementRef;</span><br><span class="line"></span><br><span class="line">  onSubmitClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.yourName = <span class="keyword">this</span>.name.nativeElement.value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@ViewChild(<span class="string">'name'</span>)</span><br><span class="line"><span class="keyword">private</span> name: ElementRef;</span><br></pre></td></tr></table></figure>
<p>使用 <code>@ViewChild()</code> 取得 DOM element 的物件實體，參數以字串傳入 template reference variable 的字串名稱。</p>
<p>注意其型別為 <code>ElementRef</code>。</p>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onSubmitClick() &#123;</span><br><span class="line">  <span class="keyword">this</span>.yourName = <span class="keyword">this</span>.name.nativeElement.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如此就能在 TypeScript 藉由 <code>@ViewChild()</code> 所宣告的變數，存取 DOM element 物件。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>傳統都只將 <code>@ViewChild()</code> 用在存取 child component，事實上 <code>@ViewChild()</code> 還可以用在存取 directive 與 DOM element。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/" target="_blank" rel="external">GitHub</a> 上找到</p>
<ul>
<li><a href="https://github.com/oomusou/NG52ViewChildComponent" target="_blank" rel="external">@ViewChild with Componet</a></li>
<li><a href="https://github.com/oomusou/NG52ViewChildDirective" target="_blank" rel="external">@ViewChild with Directive</a></li>
<li><a href="https://github.com/oomusou/NG52ViewChildDOMElement" target="_blank" rel="external">@ViewChild() with DOM Element</a></li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://www.facebook.com/concretepage" target="_blank" rel="external">Arvind Rai</a>, <a href="https://www.concretepage.com/angular-2/angular-2-viewchild-example" target="_blank" rel="external">Angular 2 @ViewChild() Example</a> </p>
]]></content>
    <summary type="html">
    <![CDATA[ViewChild 共 3 種使用方式]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 Angular 實現 Observer Pattern ?]]></title>
    <link href="http://oomusou.io/angular/observer/"/>
    <id>http://oomusou.io/angular/observer/</id>
    <published>2018-01-17T12:23:43.000Z</published>
    <updated>2018-02-03T05:29:31.722Z</updated>
    <content type="html"><![CDATA[<p>Observer Pattern 是 OOP 中著名的 Design Pattern，尤其在應付 <code>一對多</code> 的場景特別有效，在本文中，我們將以 Angular 與  TypeScript 實現。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.3<br>Angular CLI 1.6.2<br>Angular 5.2</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/angular/observer/observer000.png" alt="observer000"></p>
<p>畫面上有兩個 <code>數字鐘</code>，每秒更新一次，不斷的顯示目前的時間。</p>
<h2 id="Task">Task</h2><hr>
<p>程式碼希望分成兩部分，一個部分是每秒送出 <code>目前時間</code>，另一個部分負責 <code>顯示時間</code>。</p>
<blockquote>
<p>也就是一個 class 負責<code>產生資料</code>；另一 class 負責 <code>顯示資料</code></p>
</blockquote>
<h2 id="Definition">Definition</h2><hr>
<blockquote>
<p>Observer Pattern</p>
<p>當物件之間有 <code>一對多</code> 的依賴關係，且當 <code>一</code> 的 <code>主題</code> (subject) 改變時，<code>多</code> 的 <code>觀察者</code> (observer) 也必須跟著改變，此時就適合使用 <code>Observer Pattern</code></p>
</blockquote>
<p><img src="/images/angular/observer/observer007.svg" alt="observer007"></p>
<p>此為 Observer Pattern 最原始的 UML class diagram，<code>主題</code> (subject) 與 <code>觀察者</code> (observer) 彼此互相依賴，為了不讓 subject 與 object 之間強耦合，採用了 <code>依賴反轉原則</code> 與 <code>介面隔離原則</code>，分別訂出 <code>SubjectInterface</code> 與 <code>ObserverInterface</code>，讓 subject 與 object 彼此僅相依於對方訂出的 interface，如此 <code>主題</code> 就不須知道有多少 <code>觀察者</code> 正在觀察，且 <code>觀察者</code>也不須知道實際的 <code>主題</code> 為何，<code>觀察者</code> 只關心 <code>主題</code> 能不能被 <code>註冊</code>，<code>主題</code> 只關心 <code>觀察者</code> 能不能被 <code>通知</code>，如此 <code>主題</code> 與 <code>觀察者</code> 就徹底 <code>解耦合</code>了，且將來無論新增多少 <code>觀察者</code>，<code>主題</code> 與 <code>觀察者</code> 的程式碼都不用修改，符合 <code>開放封閉原則</code> 的要求。</p>
<h2 id="Architecture">Architecture</h2><hr>
<p><img src="/images/angular/observer/observer001.svg" alt="observer001"></p>
<ul>
<li><code>ClockService</code> 負責 <code>產生資料</code>，也就是每秒送出 <code>目前時間</code></li>
<li><code>DigitalClockComponent</code> 負責 <code>顯示資料</code>，也就是顯示 <code>目前時間</code></li>
<li><code>DigitalClockComponent</code> 必須能向 <code>ClockService</code> <code>註冊為觀察者</code>，根據 <code>DigitalClockComponent</code> 的需求，訂出 <code>SubjectInterface</code>，期望 <code>ClockService</code> 能遵守</li>
<li><code>ClockService</code> 必須能向 <code>DigitalClockComponent</code> 每秒送出 <code>目前時間</code>，根據 <code>ClockService</code> 的需求，訂出 <code>ObserverInterface</code>，期望 <code>DigitalClockComponent</code> 能遵守</li>
</ul>
<h2 id="Implementation">Implementation</h2><hr>
<h3 id="DigitalClockComponent">DigitalClockComponent</h3><p><img src="/images/angular/observer/observer002.svg" alt="observer002"></p>
<p><code>DigitalClockComponent</code> 負責 <code>顯示資料</code>，既然是 <code>顯示資料</code>，在 Angular 最適合的並不是 service，而是 component，而且 Angular 的 component 已經 class 化，表示所有 OOP 能用的技巧都能使用，因此決定使用 component 實作 。</p>
<p><strong>digital-clock.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; now | date:'HH:mm:ss'&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>HTML 負責顯示 <code>目前時間</code>，至於 <code>時:分:秒</code> 部分就不用自己寫程式處理了，靠 pipe 即可。</p>
<p><strong>digital-clock.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Inject, OnDestroy, OnInit &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ObserverInterface &#125; from <span class="string">'../../interface/observer.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectInterfaceToken &#125; from <span class="string">'../../interface/InjectionToken'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectInterface &#125; from <span class="string">'../../interface/subject.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-digital-clock'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./digital-clock.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./digital-clock.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DigitalClockComponent <span class="keyword">implements</span> ObserverInterface, OnInit, OnDestroy &#123;</span><br><span class="line">  now: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(</span><br><span class="line">    @Inject(SubjectInterfaceToken)</span><br><span class="line">    private clockService: SubjectInterface) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockService.addObserver(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnDestroy(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockService.removeObserver(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  update(date: <span class="built_in">Date</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.now = date;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DigitalClockComponent <span class="keyword">implements</span> ObserverInterface, OnInit, OnDestroy</span><br></pre></td></tr></table></figure>
<p>先不考慮 <code>DigitalClockComponent</code> 所使用的 <code>ObserverInterface</code> ，最後會討論。</p>
<p>19 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.clockService.addObserver(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回想 <code>DigitalClockComponent</code> 的初衷，除了顯示 <code>目前時間</code> 外，另外一個目的就是能對 <code>ClockService</code> 加以 <code>註冊為觀察者</code> 與 <code>取消註冊</code> 。</p>
<p>既然要 <code>註冊為觀察者</code>，要在什麼時候註冊呢 ?</p>
<p>最好是在 <code>DigitalClockComponent</code> 開始 <code>初始化</code> 時就對 <code>ClockService</code> 加以 <code>註冊為觀察者</code>，因此選擇使用 <code>ngOnInit()</code> lifecycle hook。</p>
<p>希望 <code>ClockService</code> 有 <code>addObserver()</code>，提供 <code>註冊為觀察者</code> 功能。</p>
<p>23 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngOnDestroy(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.clockService.removeObserver(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然有 <code>註冊為觀察者</code>，就應該有 <code>取消註冊</code>，該在什麼時候取消註冊呢 ?</p>
<p>最好是在 <code>DigitalClockComponent</code> 最後 <code>被消滅</code> 時對 <code>ClockService</code> 加以 <code>取消註冊</code>，因此選擇 <code>ngOnDestroy()</code> lifecycle hook。</p>
<p>希望 <code>ClockService</code> 有 <code>removeObserver()</code> ，提供 <code>取消註冊</code> 功能。</p>
<blockquote>
<p>綜合 <code>ngOnInit()</code> 與 <code>ngOnDestroy()</code>，根據 <code>介面隔離原則</code>，已經大概可猜到 interface 該提供 <code>addObserver()</code> 與 <code>removeObserver()</code> </p>
</blockquote>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(</span><br><span class="line">  @Inject(SubjectInterfaceToken)</span><br><span class="line">  private clockService: SubjectInterface) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然 <code>DigiClockComponent</code> 需要 <code>ClockService</code>，因此必須在 constructor 將 <code>ClockService</code> DI 注入進來。</p>
<p>根據 <code>依賴反轉原則</code> : <code>DigitalClockComponent</code> 不應該依賴底層的 <code>ClockService</code>，兩者應該依賴於 interface。</p>
<p>根據 <code>介面隔離原則</code> : <code>DigitalClockComponent</code> 應該只相依於他所需要的 interface，目前看來 <code>DigitalClockComponent</code> 需要 <code>addObserver()</code> 與 <code>removeObserver()</code>，因此由 <code>DigitalClockComponent</code> 需求角度訂出的 <code>SubjectInterface</code>。</p>
<p>因此 DI 注入的 <code>ClockService</code> ，其型別為 <code>SubjectInterface</code>，這樣就符合 <code>依賴反轉原則</code> 與 <code>介面隔離原則</code>。</p>
<h3 id="SubjectInterface">SubjectInterface</h3><p><img src="/images/angular/observer/observer003.svg" alt="observer002"></p>
<p><strong>subject.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ObserverInterface &#125; from <span class="string">'./observer.interface'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> SubjectInterface </span>&#123;</span><br><span class="line">  addObserver(observer: ObserverInterface): <span class="built_in">void</span>;</span><br><span class="line">  removeObserver(observer: ObserverInterface): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code> : <code>DigitalClock</code> 應該只相依於他所需要的 interface，目前看來 <code>DigitalClock</code> 需要 <code>addObserver()</code> 與 <code>removeObserver()</code>，因此由 <code>DigitalClock</code> 需求訂出的 <code>SubjectInterface</code>，應該要有 <code>addObserver()</code> 與 <code>removeObserver()</code>。</p>
<h3 id="ClockService">ClockService</h3><p><img src="/images/angular/observer/observer005.svg" alt="observer005"></p>
<p><strong>clock.service.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectInterface &#125; from <span class="string">'../../interface/subject.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ClockInterface &#125; from <span class="string">'../../interface/clock.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ObserverInterface &#125; from <span class="string">'../../interface/observer.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ClockService <span class="keyword">implements</span> SubjectInterface &#123;</span><br><span class="line">  <span class="keyword">private</span> observers: ObserverInterface[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">    setInterval(() =&gt; <span class="keyword">this</span>.tick(), <span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addObserver(observer: ObserverInterface): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.observers.push(observer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removeObserver(observer: ObserverInterface): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> index = <span class="keyword">this</span>.observers.indexOf(observer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index === -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.observers.splice(index, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> tick(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.observers.forEach(observer =&gt; observer.update(<span class="keyword">new</span> <span class="built_in">Date</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 7  行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ClockService <span class="keyword">implements</span> SubjectInterface</span><br></pre></td></tr></table></figure>
<p>根據 <code>依賴反轉原則</code>，<code>ClockService</code> 應該相依於 <code>DigitalClockComponent</code> 所訂出的 interface，因此必須實現 <code>SubjectInterface</code>。</p>
<p>第 8 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> observers: ObserverInterface[] = [];</span><br></pre></td></tr></table></figure>
<p> <code>observers</code> 陣列儲存所有註冊為 <code>觀察者</code> 的物件，每個物件型別為 <code>ObserverInterface</code>。</p>
<blockquote>
<p>也就是只要有實作 <code>ObserverInterface</code> 的物件，都算是 <code>觀察者</code>，至於 <code>ObserverInterface</code> 是什麼 ? 稍後會討論</p>
</blockquote>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">addObserver(observer: ObserverInterface): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.observers.push(observer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">removeObserver(observer: ObserverInterface): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> index = <span class="keyword">this</span>.observers.indexOf(observer);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (index === -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.observers.splice(index, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然 <code>SubjectInterface</code> 已經定義了 <code>addObserver()</code> 與 <code>removeObserver()</code> ，<code>ClockService</code> 就應該時做出 <code>addObserver()</code> 與 <code>removeObserver()</code>。</p>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">  setInterval(() =&gt; <span class="keyword">this</span>.tick(), <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據需求，<code>ClockService</code> 要能夠每秒送出 <code>目前時間</code>，所以使用 JavaScript 原生的 <code>setInterval()</code>，每 1 秒鐘呼叫 <code>tick()</code> 一次。</p>
<p>28 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> tick(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.observers.forEach(observer =&gt; observer.update(<span class="keyword">new</span> <span class="built_in">Date</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每一秒執行 <code>tick()</code> 時，會將 <code>observers</code> 陣列全部跑一遍，執行陣列內每個 <code>觀察者</code>  <code>update()</code>。</p>
<p>根據 <code>介面隔離原則</code>， <code>ClockService</code> 訂出 <code>ObserverInterface</code>，且必須要有 <code>update()</code>。</p>
<h3 id="ObserverInterface">ObserverInterface</h3><p><img src="/images/angular/observer/observer006.svg" alt="observer006"></p>
<p><strong>observer.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> ObserverInterface </span>&#123;</span><br><span class="line">  update(date: <span class="built_in">Date</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code> : <code>ClockService</code> 應該只相依於他所需要的 interface，目前看來 <code>ClockService</code> 需要 <code>update()</code>，因此由 <code>ClockService</code> 需求訂出的 <code>ObserverInterface</code>，所有 <code>觀察者</code> 都應該具備 <code>ObserverInterface</code>。</p>
<h3 id="DigitalClockComponent-1">DigitalClockComponent</h3><p><img src="/images/angular/observer/observer002.svg" alt="observer002"></p>
<p><strong>digital-clock.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Inject, OnDestroy, OnInit &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ObserverInterface &#125; from <span class="string">'../../interface/observer.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectInterfaceToken &#125; from <span class="string">'../../interface/InjectionToken'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectInterface &#125; from <span class="string">'../../interface/subject.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-digital-clock'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./digital-clock.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./digital-clock.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DigitalClockComponent <span class="keyword">implements</span> ObserverInterface, OnInit, OnDestroy &#123;</span><br><span class="line">  now: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(</span><br><span class="line">    @Inject(SubjectInterfaceToken)</span><br><span class="line">    private clockService: SubjectInterface) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockService.addObserver(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnDestroy(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.clockService.removeObserver(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  update(date: <span class="built_in">Date</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.now = date;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到一開始還沒討論完的 <code>DigitalClockComponent</code>。</p>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DigitalClockComponent <span class="keyword">implements</span> ObserverInterface</span><br></pre></td></tr></table></figure>
<p><code>DigitalClockComponent</code> 因為要對 <code>ClockService</code> 加以 <code>註冊為觀察者</code>，所以是個典型的 <code>觀察者</code>，因此要實現 <code>ObserverInterface</code>。</p>
<p>27 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">update(date: <span class="built_in">Date</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.now = date;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>ObserverInterface</code> 有定義 <code>update()</code>，因此要實作出 <code>update()</code>，也就是將 <code>ClockService</code> 送出的目前時間 <code>date</code>，指定給 <code>now</code>，準備 data binding 顯示。</p>
<h3 id="AppModule">AppModule</h3><p><strong>app.module.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SubjectInterfaceToken &#125; from <span class="string">'./interface/InjectionToken'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ClockService &#125; from <span class="string">'./service/clock/clock.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DigitalClockComponent &#125; from <span class="string">'./component/digital-clock/digital-clock.component'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    DigitalClockComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    ClockService,</span><br><span class="line">    &#123;provide: SubjectInterfaceToken, useExisting: ClockService&#125;</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>既然在 <code>DigitalClockComponent</code> 使用 DI 注入了 <code>ClockService</code>，就必須在 <code>provider</code> 交代 interface 與 service 的關係。</p>
<p>16 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  ClockService,</span><br><span class="line">  &#123;provide: SubjectInterfaceToken, useExisting: ClockService&#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>當使用 <code>SubjectInterfaceToken</code>，注入 <code>ClockService</code>。</p>
<p>由於我們希望無論有幾個 <code>觀察者</code>，都顯示 <code>相同時間</code>，因此 <code>ClockService</code> 將採用 Singleton 方式，所以使用 <code>useExisting</code>。</p>
<h3 id="AppComponent">AppComponent</h3><p>折騰了這麼久，到底使用 Observer Pattern 的威力在哪裡 ?</p>
<p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">app-digital-clock</span>&gt;</span><span class="tag">&lt;/<span class="title">app-digital-clock</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-digital-clock</span>&gt;</span><span class="tag">&lt;/<span class="title">app-digital-clock</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 <code>AppComponent</code> 使用了 2 個 <code>DigitalClockComponent</code>，都會自己去註冊 <code>ClockService</code>，且無論使用 n 的 <code>DigitalClockComponent</code>，都不用改程式碼，達到 <code>開放封閉原則</code> 的要求。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>傳統後端 MVC 架構，Design pattern 大都用在 service，少部分機會可以用在 repository，但 controller 與 view 就很難用上，尤其是 view 幾乎與 Design Pattern 絕緣；但 Angular 將 component 給 class 化之後，又能使用 interface，使的 view 也有使用 Design Pattern 的可能。本文就是使用 component 直接當 <code>Observer</code> 使用，這使的 Design Pattern 在 Angular 應用上有全新的可能，不再只限於 service，連 component 也可以使用</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG52ObserverPattern" target="_blank" rel="external">GitHub</a> 上找到</p>
]]></content>
    <summary type="html">
    <![CDATA[Design Pattern 在 Angular 將有全新的使用方式]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="Design Pattern" scheme="http://oomusou.io/tags/Design-Pattern/"/>
    
      <category term="TypeScript" scheme="http://oomusou.io/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何在本機執行 ng build 後的結果 ?]]></title>
    <link href="http://oomusou.io/angular/lite-server/"/>
    <id>http://oomusou.io/angular/lite-server/</id>
    <published>2018-01-16T12:23:43.000Z</published>
    <updated>2018-01-22T14:05:50.000Z</updated>
    <content type="html"><![CDATA[<p>Angular CLI 雖然可以直接 <code>ng serve</code> 執行 Angular，不過畢竟不是  <code>ng build --prod</code> 的最終結果，你曾懷疑 <code>ng build --prod</code> 後的結果真的能跑嗎 ? 可以先在本機測試過嗎 ?</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.3<br>Angular CLI 1.6.2<br>Angular 5.2</p>
<h2 id="安裝_lite-server">安裝 lite-server</h2><hr>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm <span class="operator"><span class="keyword">install</span> -<span class="keyword">g</span> lite-<span class="keyword">server</span></span></span><br></pre></td></tr></table></figure>
<p>另外安裝 <code>lite-server</code> 執行 <code>ng build --prod</code> 結果，不透過 Angular CLI。</p>
<ul>
<li><strong>-g</strong> : 安裝 <code>lite-server</code> 在 global</li>
</ul>
<h2 id="使用_ng_build_-prod_編譯">使用 <code>ng build --prod</code> 編譯</h2><hr>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject $ ng build <span class="comment">--prod</span></span><br></pre></td></tr></table></figure>
<p>在專案目錄下執行 <code>ng build --prod</code>。</p>
<p><img src="/images/angular/lite-server/http000.png" alt="http000"></p>
<ol>
<li>執行 <code>ng build --prod</code></li>
<li>編譯後的檔案會放在 <code>dist</code> 目錄下</li>
</ol>
<h2 id="啟動_lite-server">啟動 lite-server</h2><hr>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~<span class="regexp">/MyProject/dist</span> <span class="variable">$ </span>lite-server</span><br></pre></td></tr></table></figure>
<p><code>ng build --prod</code> 會將編譯後的檔案放到 <code>dist</code> 目錄下，在 <code>dist</code> 目錄下執行 <code>lite-server</code>。</p>
<p><img src="/images/angular/lite-server/http001.png" alt="http001"></p>
<ol>
<li><code>lite-server</code> 預設啟動在 <code>http://localhost:3000</code> 或其他 ip 的 port 3000</li>
</ol>
<blockquote>
<p>IP 並不固定，請以實際的 IP 為準</p>
</blockquote>
<h2 id="使用瀏覽器測試">使用瀏覽器測試</h2><hr>
<p><img src="/images/angular/lite-server/http002.png" alt="http002"></p>
<p>Angular 不再跑在 <code>localhost:4200</code>，而是跑在 <code>localhost:3000</code></p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>只要安裝了 <code>lite-server</code> 之後，就可以在本機測試 <code>ng build --prod</code> 編譯後的結果，不必再額外安裝其他 server</li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[不用等佈署到 lab 後，就可在本機測試 ng build 編譯後的結果]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="Angular CLI" scheme="http://oomusou.io/tags/Angular-CLI/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何設定 Angular 環境變數 ?]]></title>
    <link href="http://oomusou.io/angular/environment/"/>
    <id>http://oomusou.io/angular/environment/</id>
    <published>2018-01-15T12:23:43.000Z</published>
    <updated>2018-01-15T13:49:32.000Z</updated>
    <content type="html"><![CDATA[<p>實務上會有不同 Angular 執行環境，如開發用的 <code>dev</code> 環境，測試用的 <code>lab</code> 與 <code>stg</code> 環境，正式上線用的 <code>prod</code> 環境，不同的環境會有不同的 <code>環境變數</code>，如 API server 、S3 server 的設定 … 等，Angular CLI 提供了很方便的機制處理環境變數問題，讓我們切換不同環境時，完全不用改 code，只要在 Angular CLI 編譯時使用不同的參數切換即可。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.3<br>Angular CLI 1.6.2<br>Angular 5.2</p>
<h2 id="Angular_CLI_預設_Environments">Angular CLI 預設 Environments</h2><hr>
<p>一個乾淨的 Angular 專案，已經提供了預設的 environment 設定。</p>
<p><img src="/images/angular/environment/env001.png" alt="env001"></p>
<ol>
<li>選擇專案根目錄的 <code>.angular-cli.json</code></li>
<li>在 <code>environments</code> property 下，已經有 <code>dev</code> 與 <code>prod</code> 兩個設定，分別對應到 <code>environments</code> 目錄下的 <code>environment.ts</code> 與  <code>environment.prod.ts</code></li>
</ol>
<p><img src="/images/angular/environment/env000.png" alt="env000"></p>
<ol>
<li><p><code>environment.prod.ts</code> 為 <code>prod</code> 環境所使用的設定檔；而 <code>environment.ts</code> 為 <code>dev</code> 環境所使用的設定檔</p>
</li>
<li><p>以 <code>environment.prod.ts</code> 為例，設定了 <code>production: true</code>；而 <code>environment.ts</code> 則設定了 <code>production: false</code></p>
</li>
</ol>
<blockquote>
<p>Q : <code>production</code> property 設定為 <code>true</code> 或 <code>false</code> 有什麼影響 ?</p>
</blockquote>
<ul>
<li><strong>production: true</strong>  : JavaScript 與 CSS 都會壓縮，且不提供 source  map，因此最後的 JavaScript 與 CSS 會較小，適合 <code>stg</code> 與 <code>prod</code> 環境使用，但不利於 debug</li>
<li><strong>production: false</strong> : JavaScript 與 CSS 不會壓縮，會提供 source map，因此最後的 JavaScript 與 CSS 會較大，適合 <code>dev</code> 與 <code>lab</code> 環境使用，方便 debug</li>
</ul>
<h2 id="新增_Lab_與_Stage_環境設定">新增 Lab 與 Stage 環境設定</h2><hr>
<p>Angular CLI 預設只提供了 <code>dev</code> 與 <code>prod</code> 兩個環境變數，但實務上最少還有 <code>lab</code> 與 <code>stage</code> 兩個環境，這必須手動建立。</p>
<h3 id="Lab_環境">Lab 環境</h3><p><img src="/images/angular/environment/env002.png" alt="env002"></p>
<ol>
<li>在 <code>src/app/environments</code> 目錄下新增 <code>environment.lab.ts</code></li>
<li>將 <code>environment.ts</code> 內容複製到 <code>environment.lab.ts</code></li>
</ol>
<blockquote>
<p>目前 Angular CLI 尚未提供指令建立 environment，必須手動建立，Angular CLI 的 naming convention 是 <code>environment.</code> + <code>環境名稱</code> + <code>.ts</code></p>
</blockquote>
<p><strong>environment.lab.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">expot <span class="keyword">const</span> environment = &#123;</span><br><span class="line">  production: <span class="literal">false</span>,</span><br><span class="line">  envName: <span class="string">'lab'</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>production: false</strong> : <code>lab</code> 環境不提供 JavaScript 壓縮與最佳化，方便 debug</li>
<li><strong>envName: <code>lab</code></strong> : 可自行設定自己的變數</li>
</ul>
<h3 id="Stage_環境">Stage 環境</h3><p><img src="/images/angular/environment/env003.png" alt="env003"></p>
<ol>
<li>在 <code>src/app/environments</code> 目錄下新增 <code>environment.stg.ts</code></li>
<li>將 <code>environment.prod.ts</code> 內容複製到 <code>environment.stg.ts</code></li>
</ol>
<p><strong>environment.stg.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> environment = &#123;</span><br><span class="line">  production: <span class="literal">true</span>,</span><br><span class="line">  envName: <span class="string">'stg'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>production: true</strong> : <code>stg</code> 環境提供 JavaScript 壓縮與最佳化，與 <code>prod</code> 環境相同</li>
<li><strong>envName: <code>stg</code></strong> : 可自行設定自己的變數</li>
</ul>
<blockquote>
<p>為了測試方便，請在 <code>environment.ts</code> 加上 <code>envName: &#39;dev&#39;</code>，<code>environment.prod.ts</code> 加上 <code>envName: &#39;prod&#39;</code></p>
</blockquote>
<h3 id="修改_-angular-cli-json">修改 .angular-cli.json</h3><p><img src="/images/angular/environment/env004.png" alt="env004"></p>
<ol>
<li>選擇專案根目錄的 <code>.angular-cli.jsonv</code></li>
<li>新增 <code>lab</code> 與 <code>stg</code> 設定</li>
</ol>
<p><strong>.angular-cli.json</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">$schema</span>": <span class="value"><span class="string">"./node_modules/@angular/cli/lib/config/schema.json"</span></span>,</span><br><span class="line">  "<span class="attribute">project</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">name</span>": <span class="value"><span class="string">"ng52-environment"</span></span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">apps</span>": <span class="value">[</span><br><span class="line">    &#123;</span><br><span class="line">      "<span class="attribute">root</span>": <span class="value"><span class="string">"src"</span></span>,</span><br><span class="line">      "<span class="attribute">outDir</span>": <span class="value"><span class="string">"dist"</span></span>,</span><br><span class="line">      "<span class="attribute">assets</span>": <span class="value">[</span><br><span class="line">        <span class="string">"assets"</span>,</span><br><span class="line">        <span class="string">"favicon.ico"</span></span><br><span class="line">      ]</span>,</span><br><span class="line">      "<span class="attribute">index</span>": <span class="value"><span class="string">"index.html"</span></span>,</span><br><span class="line">      "<span class="attribute">main</span>": <span class="value"><span class="string">"main.ts"</span></span>,</span><br><span class="line">      "<span class="attribute">polyfills</span>": <span class="value"><span class="string">"polyfills.ts"</span></span>,</span><br><span class="line">      "<span class="attribute">test</span>": <span class="value"><span class="string">"test.ts"</span></span>,</span><br><span class="line">      "<span class="attribute">tsconfig</span>": <span class="value"><span class="string">"tsconfig.app.json"</span></span>,</span><br><span class="line">      "<span class="attribute">testTsconfig</span>": <span class="value"><span class="string">"tsconfig.spec.json"</span></span>,</span><br><span class="line">      "<span class="attribute">prefix</span>": <span class="value"><span class="string">"app"</span></span>,</span><br><span class="line">      "<span class="attribute">styles</span>": <span class="value">[</span><br><span class="line">        <span class="string">"styles.css"</span></span><br><span class="line">      ]</span>,</span><br><span class="line">      "<span class="attribute">scripts</span>": <span class="value">[]</span>,</span><br><span class="line">      "<span class="attribute">environmentSource</span>": <span class="value"><span class="string">"environments/environment.ts"</span></span>,</span><br><span class="line">      "<span class="attribute">environments</span>": <span class="value">&#123;</span><br><span class="line">        "<span class="attribute">dev</span>": <span class="value"><span class="string">"environments/environment.ts"</span></span>,</span><br><span class="line">        "<span class="attribute">lab</span>": <span class="value"><span class="string">"environments/environment.lab.ts"</span></span>,</span><br><span class="line">        "<span class="attribute">stg</span>": <span class="value"><span class="string">"environments/environment.stg.ts"</span></span>,</span><br><span class="line">        "<span class="attribute">prod</span>": <span class="value"><span class="string">"environments/environment.prod.ts"</span></span><br><span class="line">      </span>&#125;</span><br><span class="line">    </span>&#125;</span><br><span class="line">  ]</span>,</span><br><span class="line">  "<span class="attribute">e2e</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">protractor</span>": <span class="value">&#123;</span><br><span class="line">      "<span class="attribute">config</span>": <span class="value"><span class="string">"./protractor.conf.js"</span></span><br><span class="line">    </span>&#125;</span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">lint</span>": <span class="value">[</span><br><span class="line">    &#123;</span><br><span class="line">      "<span class="attribute">project</span>": <span class="value"><span class="string">"src/tsconfig.app.json"</span></span>,</span><br><span class="line">      "<span class="attribute">exclude</span>": <span class="value"><span class="string">"**/node_modules/**"</span></span><br><span class="line">    </span>&#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "<span class="attribute">project</span>": <span class="value"><span class="string">"src/tsconfig.spec.json"</span></span>,</span><br><span class="line">      "<span class="attribute">exclude</span>": <span class="value"><span class="string">"**/node_modules/**"</span></span><br><span class="line">    </span>&#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "<span class="attribute">project</span>": <span class="value"><span class="string">"e2e/tsconfig.e2e.json"</span></span>,</span><br><span class="line">      "<span class="attribute">exclude</span>": <span class="value"><span class="string">"**/node_modules/**"</span></span><br><span class="line">    </span>&#125;</span><br><span class="line">  ]</span>,</span><br><span class="line">  "<span class="attribute">test</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">karma</span>": <span class="value">&#123;</span><br><span class="line">      "<span class="attribute">config</span>": <span class="value"><span class="string">"./karma.conf.js"</span></span><br><span class="line">    </span>&#125;</span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">defaults</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">styleExt</span>": <span class="value"><span class="string">"css"</span></span>,</span><br><span class="line">    "<span class="attribute">component</span>": <span class="value">&#123;&#125;</span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>26 行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">"environments": &#123;</span><br><span class="line">  "dev": "environments/environment.ts",</span><br><span class="line">  "lab": "environments/environment.lab.ts",</span><br><span class="line">  "stg": "environments/environment.stg.ts",</span><br><span class="line">  "prod": "environments/environment.prod.ts"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新增 <code>lab</code> 與 <code>stg</code>，與其對應的 <code>environments/environment.lab.ts</code> 與 <code>environments/environment.stg.ts</code>。</p>
<h2 id="使用環境變數">使用環境變數</h2><hr>
<p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--The content below is only a placeholder and can be replaced.--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">style</span>=<span class="value">"text-align:center"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">h1</span>&gt;</span></span><br><span class="line">    Welcome to &#123;&#123; title &#125;&#125;!</span><br><span class="line">  <span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">h1</span>&gt;</span></span><br><span class="line">    &#123;&#123; environmentName &#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">img</span> <span class="attribute">width</span>=<span class="value">"300"</span> <span class="attribute">alt</span>=<span class="value">"Angular Logo"</span></span><br><span class="line">       <span class="attribute">src</span>=<span class="value">"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNTAgMjUwIj4KICAgIDxwYXRoIGZpbGw9IiNERDAwMzEiIGQ9Ik0xMjUgMzBMMzEuOSA2My4ybDE0LjIgMTIzLjFMMTI1IDIzMGw3OC45LTQzLjcgMTQuMi0xMjMuMXoiIC8+CiAgICA8cGF0aCBmaWxsPSIjQzMwMDJGIiBkPSJNMTI1IDMwdjIyLjItLjFWMjMwbDc4LjktNDMuNyAxNC4yLTEyMy4xTDEyNSAzMHoiIC8+CiAgICA8cGF0aCAgZmlsbD0iI0ZGRkZGRiIgZD0iTTEyNSA1Mi4xTDY2LjggMTgyLjZoMjEuN2wxMS43LTI5LjJoNDkuNGwxMS43IDI5LjJIMTgzTDEyNSA1Mi4xem0xNyA4My4zaC0zNGwxNy00MC45IDE3IDQwLjl6IiAvPgogIDwvc3ZnPg=="</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">h2</span>&gt;</span>Here are some links to help you start: <span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">h2</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">target</span>=<span class="value">"_blank"</span> <span class="attribute">rel</span>=<span class="value">"noopener"</span> <span class="attribute">href</span>=<span class="value">"https://angular.io/tutorial"</span>&gt;</span>Tour of Heroes<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">h2</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">target</span>=<span class="value">"_blank"</span> <span class="attribute">rel</span>=<span class="value">"noopener"</span> <span class="attribute">href</span>=<span class="value">"https://github.com/angular/angular-cli/wiki"</span>&gt;</span>CLI Documentation<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">h2</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">target</span>=<span class="value">"_blank"</span> <span class="attribute">rel</span>=<span class="value">"noopener"</span> <span class="attribute">href</span>=<span class="value">"https://blog.angular.io/"</span>&gt;</span>Angular blog<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>第 6 行</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">h1</span>&gt;</span></span><br><span class="line">  &#123;&#123; environmentName &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 Angular 專案預設的 <code>app.component.html</code> 加上 <code></code>，用來讀取 <code>環境變數</code>。</p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; environment &#125; from <span class="string">'../environments/environment'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  title = <span class="string">'app'</span>;</span><br><span class="line">  environmentName = environment.envName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">environmentName = environment.envName;</span><br></pre></td></tr></table></figure>
<p>直接讀取剛剛 export 的 <code>environment.envName</code>。</p>
<h2 id="切換環境變數">切換環境變數</h2><hr>
<p>理想上，無論我們怎麼切換環境，都不應該去改 code，這才符合 <code>開放封閉原則</code> 的要求。</p>
<p><strong>package.json</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">name</span>": <span class="value"><span class="string">"ng52-environment"</span></span>,</span><br><span class="line">  "<span class="attribute">version</span>": <span class="value"><span class="string">"0.0.0"</span></span>,</span><br><span class="line">  "<span class="attribute">license</span>": <span class="value"><span class="string">"MIT"</span></span>,</span><br><span class="line">  "<span class="attribute">scripts</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">ng</span>": <span class="value"><span class="string">"ng"</span></span>,</span><br><span class="line">    "<span class="attribute">start</span>": <span class="value"><span class="string">"ng serve"</span></span>,</span><br><span class="line">    "<span class="attribute">start-lab</span>": <span class="value"><span class="string">"ng serve --environment=lab"</span></span>,</span><br><span class="line">    "<span class="attribute">start-stg</span>": <span class="value"><span class="string">"ng serve --environment=stg"</span></span>,</span><br><span class="line">    "<span class="attribute">start-prod</span>": <span class="value"><span class="string">"ng serve --environment=prod"</span></span>,</span><br><span class="line">    "<span class="attribute">build</span>": <span class="value"><span class="string">"ng build --prod"</span></span>,</span><br><span class="line">    "<span class="attribute">build-stg</span>": <span class="value"><span class="string">"ng build --environment=stg"</span></span>,</span><br><span class="line">    "<span class="attribute">test</span>": <span class="value"><span class="string">"ng test"</span></span>,</span><br><span class="line">    "<span class="attribute">lint</span>": <span class="value"><span class="string">"ng lint"</span></span>,</span><br><span class="line">    "<span class="attribute">e2e</span>": <span class="value"><span class="string">"ng e2e"</span></span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">private</span>": <span class="value"><span class="literal">true</span></span>,</span><br><span class="line">  "<span class="attribute">dependencies</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">@angular/animations</span>": <span class="value"><span class="string">"^5.0.0"</span></span>,</span><br><span class="line">    "<span class="attribute">@angular/common</span>": <span class="value"><span class="string">"^5.0.0"</span></span>,</span><br><span class="line">    "<span class="attribute">@angular/compiler</span>": <span class="value"><span class="string">"^5.0.0"</span></span>,</span><br><span class="line">    "<span class="attribute">@angular/core</span>": <span class="value"><span class="string">"^5.0.0"</span></span>,</span><br><span class="line">    "<span class="attribute">@angular/forms</span>": <span class="value"><span class="string">"^5.0.0"</span></span>,</span><br><span class="line">    "<span class="attribute">@angular/http</span>": <span class="value"><span class="string">"^5.0.0"</span></span>,</span><br><span class="line">    "<span class="attribute">@angular/platform-browser</span>": <span class="value"><span class="string">"^5.0.0"</span></span>,</span><br><span class="line">    "<span class="attribute">@angular/platform-browser-dynamic</span>": <span class="value"><span class="string">"^5.0.0"</span></span>,</span><br><span class="line">    "<span class="attribute">@angular/router</span>": <span class="value"><span class="string">"^5.0.0"</span></span>,</span><br><span class="line">    "<span class="attribute">core-js</span>": <span class="value"><span class="string">"^2.4.1"</span></span>,</span><br><span class="line">    "<span class="attribute">rxjs</span>": <span class="value"><span class="string">"^5.5.2"</span></span>,</span><br><span class="line">    "<span class="attribute">zone.js</span>": <span class="value"><span class="string">"^0.8.14"</span></span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">devDependencies</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">@angular/cli</span>": <span class="value"><span class="string">"1.6.2"</span></span>,</span><br><span class="line">    "<span class="attribute">@angular/compiler-cli</span>": <span class="value"><span class="string">"^5.0.0"</span></span>,</span><br><span class="line">    "<span class="attribute">@angular/language-service</span>": <span class="value"><span class="string">"^5.0.0"</span></span>,</span><br><span class="line">    "<span class="attribute">@types/jasmine</span>": <span class="value"><span class="string">"~2.5.53"</span></span>,</span><br><span class="line">    "<span class="attribute">@types/jasminewd2</span>": <span class="value"><span class="string">"~2.0.2"</span></span>,</span><br><span class="line">    "<span class="attribute">@types/node</span>": <span class="value"><span class="string">"~6.0.60"</span></span>,</span><br><span class="line">    "<span class="attribute">codelyzer</span>": <span class="value"><span class="string">"^4.0.1"</span></span>,</span><br><span class="line">    "<span class="attribute">jasmine-core</span>": <span class="value"><span class="string">"~2.6.2"</span></span>,</span><br><span class="line">    "<span class="attribute">jasmine-spec-reporter</span>": <span class="value"><span class="string">"~4.1.0"</span></span>,</span><br><span class="line">    "<span class="attribute">karma</span>": <span class="value"><span class="string">"~1.7.0"</span></span>,</span><br><span class="line">    "<span class="attribute">karma-chrome-launcher</span>": <span class="value"><span class="string">"~2.1.1"</span></span>,</span><br><span class="line">    "<span class="attribute">karma-cli</span>": <span class="value"><span class="string">"~1.0.1"</span></span>,</span><br><span class="line">    "<span class="attribute">karma-coverage-istanbul-reporter</span>": <span class="value"><span class="string">"^1.2.1"</span></span>,</span><br><span class="line">    "<span class="attribute">karma-jasmine</span>": <span class="value"><span class="string">"~1.1.0"</span></span>,</span><br><span class="line">    "<span class="attribute">karma-jasmine-html-reporter</span>": <span class="value"><span class="string">"^0.2.2"</span></span>,</span><br><span class="line">    "<span class="attribute">protractor</span>": <span class="value"><span class="string">"~5.1.2"</span></span>,</span><br><span class="line">    "<span class="attribute">ts-node</span>": <span class="value"><span class="string">"~3.2.0"</span></span>,</span><br><span class="line">    "<span class="attribute">tslint</span>": <span class="value"><span class="string">"~5.7.0"</span></span>,</span><br><span class="line">    "<span class="attribute">typescript</span>": <span class="value"><span class="string">"~2.4.2"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>第 5 行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "ng": "ng",</span><br><span class="line">  "start": "ng serve",</span><br><span class="line">  "start-lab": "ng serve --environment=lab",</span><br><span class="line">  "start-stg": "ng serve --environment=stg",</span><br><span class="line">  "start-prod": "ng serve --environment=prod",</span><br><span class="line">  "build": "ng build --prod",</span><br><span class="line">  "build-stg": "ng build --prod --environment=stg",</span><br><span class="line">  "test": "ng test",</span><br><span class="line">  "lint": "ng lint",</span><br><span class="line">  "e2e": "ng e2e"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>原本的 <code>scripts</code> 加上 <code>start-lab</code>、<code>start-stg</code>、<code>start-prod</code> 與 <code>build-stg</code>。</p>
<p>第 7 行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"start": "ng serve",</span><br></pre></td></tr></table></figure>
<p>Angular CLI 原本內建的 <code>start</code>，不加任何參數，預設就是跑 <code>dev</code> 環境變數。</p>
<p>第 8 行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"start-lab": "ng serve --environment=lab",</span><br></pre></td></tr></table></figure>
<p>新增 <code>starrt-lab</code>，<code>ng serve</code> 時執行 <code>lab</code> 環境變數。</p>
<p>第  9 行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"start-stg": "ng serve --environment=stg",</span><br></pre></td></tr></table></figure>
<p>新增 <code>starrt-stg</code>，<code>ng serve</code> 時執行 <code>stg</code> 環境變數。</p>
<p>10 行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"start-prod": "ng serve --environment=prod",</span><br></pre></td></tr></table></figure>
<p>新增 <code>starrt-prod</code>，<code>ng serve</code> 時執行 <code>prod</code> 環境變數。</p>
<p>11 行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"build": "ng build --prod",</span><br></pre></td></tr></table></figure>
<p>Angular CLI 原本內建的 <code>build</code>，不加任何參數，預設就是跑 <code>prod</code> 環境變數。</p>
<p>12 行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"build-stg": "ng build --prod --environment=stg",</span><br></pre></td></tr></table></figure>
<p>新增 <code>build-stg</code>，<code>ng build</code> 除了如同 <code>prod</code> 編譯 JavaScript 外，同時跑 <code>stg</code> 環境變數。</p>
<h2 id="以_Angular_CLI_執行">以 Angular CLI 執行</h2><hr>
<p>執行 <code>ng serve</code> 時，跑的是 Angular CLI 內建的 web server。</p>
<h3 id="使用_dev_執行">使用 <code>dev</code> 執行</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject $ npm <span class="command">run</span> start</span><br></pre></td></tr></table></figure>
<p>在專案目錄下執行 <code>npm run start</code>。</p>
<p><img src="/images/angular/environment/env011.png" alt="env011"></p>
<p><img src="/images/angular/environment/env005.png" alt="env005"></p>
<p>Angular 首頁顯示 <code>dev</code> 環境。</p>
<h3 id="使用_lab_執行">使用 <code>lab</code> 執行</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject $ npm <span class="keyword">run</span> start-<span class="keyword">lab</span></span><br></pre></td></tr></table></figure>
<p>在專案目錄下執行 <code>npm run start-lab</code>。</p>
<p><img src="/images/angular/environment/env012.png" alt="env012"></p>
<p><img src="/images/angular/environment/env006.png" alt="env006"></p>
<p>Angular 首頁顯示 <code>lab</code> 環境。</p>
<h3 id="使用_stg_執行">使用 <code>stg</code> 執行</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject $ npm <span class="command">run</span> start-stg</span><br></pre></td></tr></table></figure>
<p>在專案目錄下執行 <code>npm run start-stg</code>。</p>
<p><img src="/images/angular/environment/env013.png" alt="env013"></p>
<p><img src="/images/angular/environment/env007.png" alt="env007"></p>
<p>Angular 首頁顯示 <code>stg</code> 環境。</p>
<h3 id="使用_prod_執行">使用 <code>prod</code> 執行</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject$ npm <span class="command">run</span> start-prod</span><br></pre></td></tr></table></figure>
<p>在專案目錄下執行 <code>npm run start-prod</code>。</p>
<p><img src="/images/angular/environment/env014.png" alt="env014"></p>
<p><img src="/images/angular/environment/env008.png" alt="env008"></p>
<p>Angular 首頁顯示 <code>prod</code> 環境。</p>
<h2 id="以實際_Web_Server_執行">以實際 Web Server 執行</h2><hr>
<p>Angular CLI 雖然內建 web server，但你或許覺得要實際跑過 <code>ng build</code> 的結果，較接近 <code>stg</code> 與 <code>prod</code> 環境。</p>
<h3 id="安裝_http-server">安裝 http-server</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm <span class="operator"><span class="keyword">install</span> -<span class="keyword">g</span> <span class="keyword">http</span>-<span class="keyword">server</span></span></span><br></pre></td></tr></table></figure>
<p>另外安裝 <code>http-server</code> 執行 <code>ng build</code> 結果，不透過 Angular CLI。</p>
<ul>
<li><strong>-g</strong> : 安裝 <code>http-server</code> 在 global</li>
</ul>
<h3 id="使用_stg_編譯">使用 <code>stg</code> 編譯</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject $ npm <span class="command">run</span> build-stg</span><br></pre></td></tr></table></figure>
<p>在專案目錄下執行 npm run build-stg。</p>
<p><img src="/images/angular/environment/env015.png" alt="env015"></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~<span class="regexp">/MyProject/dist</span> <span class="variable">$ </span>http-server</span><br></pre></td></tr></table></figure>
<p><code>ng build</code> 會將編譯後的檔案放到 <code>dist</code> 目錄下，在 <code>dist</code> 目錄下執行 <code>http-server</code>。</p>
<p><img src="/images/angular/environment/env016.png" alt="env016"></p>
<p><code>http-server</code> 會啟動在 <code>http://172.20.10.12:8080</code>。</p>
<p><img src="/images/angular/environment/env010.png" alt="env010"></p>
<p>Angular 首頁顯示 <code>stg</code> 環境。</p>
<h3 id="使用_prod_編譯">使用 <code>prod</code> 編譯</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject $ npm <span class="command">run</span> build</span><br></pre></td></tr></table></figure>
<p>在專案目錄下執行 npm run build。<br><img src="/images/angular/environment/env017.png" alt="env017"></p>
<p><code>ng build</code> 會將編譯後的檔案放到 <code>dist</code> 目錄下，在 <code>dist</code> 目錄下執行 <code>http-server</code>。</p>
<p><img src="/images/angular/environment/env016.png" alt="env016"></p>
<p><code>http-server</code> 會啟動在 <code>http://172.20.10.12:8080</code>。</p>
<p><img src="/images/angular/environment/env009.png" alt="env009"></p>
<p>Angular 首頁顯示 <code>prod</code> 環境。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Angular CLI 已經幫我們設計好完整的 <code>環境變數</code> 機制，只要配合 Angular CLI 的架構，可以在完全不用修改任何一行 code 的狀態下，透過指令切換環境變數</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG52Environment" target="_blank" rel="external">GitHub</a> 上找到</p>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://tattoocoder.com/me/" target="_blank" rel="external">Shayne Boyer</a>, <a href="http://tattoocoder.com/angular-cli-using-the-environment-option/" target="_blank" rel="external">Angular 2: Application Settings using the CLI Environment Option</a></p>
]]></content>
    <summary type="html">
    <![CDATA[使用 Angualr CLI 內建的機制使用環境變數]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="Angular CLI" scheme="http://oomusou.io/tags/Angular-CLI/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何在 Component 間交換資料 ?]]></title>
    <link href="http://oomusou.io/angular/component-interaction/"/>
    <id>http://oomusou.io/angular/component-interaction/</id>
    <published>2018-01-14T12:23:43.000Z</published>
    <updated>2018-01-15T01:58:34.000Z</updated>
    <content type="html"><![CDATA[<p>若只有一個 component，就沒有交換資料的問題，反正資料都在 class 的 field；但一旦切成多 component 之後，parent component 與 child component 要怎麼交換資料就成為不可避免的課題，本文介紹 3 種方法。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.3<br>Angular CLI 1.6.2<br>Angular 5.2</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/angular/component-interaction/counter000.png" alt="counter000"></p>
<ul>
<li><code>counter</code> 初始值為 <code>3</code></li>
<li>按 <code>+</code> 則 <code>counter</code> + 1，按 <code>-</code> 則 <code>counter</code> -1</li>
</ul>
<h2 id="Task">Task</h2><hr>
<p>有以下面 3 種實作方式</p>
<ul>
<li><code>@Input()</code> + <code>@Output()</code> decorator</li>
<li><code>@ViewChild()</code> decorator</li>
<li>Observable Data Service</li>
</ul>
<h2 id="@Input()_&amp;_@Output()_Decorator">@Input() &amp; @Output() Decorator</h2><hr>
<h3 id="Architecture">Architecture</h3><p><img src="/images/angular/component-interaction/counter001.svg" alt="counter001"></p>
<ul>
<li><code>AppComponent</code> 負責顯示 <code>counter</code>；<code>CounterComponent</code> 負責處理 <code>&lt;button/&gt;</code></li>
<li><code>AppComponent</code> 相當於 parent component，<code>CounterComponent</code> 相當於 child component</li>
<li><code>AppComponent</code> 須向 <code>CounterComponent</code> 傳入 counter 初始值；<code>CounterComponent</code> 須向 <code>AppComponent</code> 傳出最新 counter 結果</li>
</ul>
<h3 id="Implementation">Implementation</h3><p><strong>AppComponent</strong></p>
<p><img src="/images/angular/component-interaction/counter008.svg" alt="counter008"></p>
<p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">app-counter</span> (<span class="attribute">counterChange</span>)=<span class="value">"onCounterChange($event)"</span> [<span class="attribute">initialCounter</span>]=<span class="value">"initialCounter"</span>&gt;</span><span class="tag">&lt;/<span class="title">app-counter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line">&#123;&#123; counter &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><code>AppComponent</code> 透過 <code>InitialCounter</code> 將 <code>counter</code> 的初始值傳進 <code>CounterComponent</code>，另外由 <code>onCounterChange()</code> 接受 <code>CounterComponent</code> 傳出的 <code>counterChange</code> event。</p>
<p>由 <code>AppComponent</code> 顯示實際的 <code>counter</code>。</p>
<blockquote>
<p><code>onCounterChange($event)</code> 的參數一定要用 <code>$event</code>，Angular 底層另有處理</p>
</blockquote>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  initialCounter = <span class="number">3</span>;</span><br><span class="line">  counter: <span class="built_in">number</span> = <span class="keyword">this</span>.initialCounter;</span><br><span class="line"></span><br><span class="line">  onCounterChange(counter: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.counter = counter;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">counter: <span class="built_in">number</span> = <span class="keyword">this</span>.initialCounter;</span><br></pre></td></tr></table></figure>
<p><code>counter</code> 的初始值，除了顯示外，也傳進 <code>CounterComponent</code>。</p>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onCounterChange(counter: <span class="built_in">number</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.counter = counter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由 <code>onCounterChange()</code> 接受 <code>counterChange</code> event，雖然傳進的是 <code>$event</code>，但在 method 內可使用自己容易閱讀的參數。</p>
<p><strong>CounterComponent</strong></p>
<p><img src="/images/angular/component-interaction/counter009.svg" alt="counter009"></p>
<p><strong>counter.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onAdd1Click()"</span>&gt;</span>+<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onMinus1Click()"</span>&gt;</span>-<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>將 2 個 <code>&lt;button/&gt;</code> 封裝在 <code>CounterComponent</code> 內。</p>
<p><strong>counter.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, EventEmitter, Input, OnInit, Output &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-counter'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./counter.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./counter.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CounterComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  @Input() initialCounter;</span><br><span class="line">  @Output() counterChange: EventEmitter&lt;<span class="built_in">number</span>&gt; = <span class="keyword">new</span> EventEmitter&lt;<span class="built_in">number</span>&gt;();</span><br><span class="line">  <span class="keyword">private</span> counter: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.counter = <span class="keyword">this</span>.initialCounter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onAdd1Click() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counter++;</span><br><span class="line">    <span class="keyword">this</span>.counterChange.emit(<span class="keyword">this</span>.counter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onMinus1Click() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counter--;</span><br><span class="line">    <span class="keyword">this</span>.counterChange.emit(<span class="keyword">this</span>.counter);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Input() initialCounter;</span><br></pre></td></tr></table></figure>
<p>將 field 加上 <code>@Input()</code> decorator 後，parent component 就可以透過 <code>@Input()</code> 將資料傳進 child component。</p>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Output() counterChange: EventEmitter&lt;<span class="built_in">number</span>&gt; = <span class="keyword">new</span> EventEmitter&lt;<span class="built_in">number</span>&gt;();</span><br></pre></td></tr></table></figure>
<p>將 field 加上 <code>@Output()</code> decorator 後，child component 就可透過 event 方式將資料傳到 parent component。</p>
<p><code>EventEmitter</code> 可接受泛型，將要傳出的資料型別以泛型表示。</p>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.counter = <span class="keyword">this</span>.initialCounter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>凡透過 <code>@Input()</code> 傳進的資料，必須在 <code>ngOnInit()</code> lifecycle hook 才可抓到資料。</p>
<p>17 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">onAdd1Click() &#123;</span><br><span class="line">  <span class="keyword">this</span>.counter++;</span><br><span class="line">  <span class="keyword">this</span>.counterChange.emit(<span class="keyword">this</span>.counter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>onAdd1Click()</code> 接受 DOM 原生的 <code>click</code> event。</p>
<p>透過 <code>EventEmitter.emit()</code> 將資料由 child component 傳到上層的 parent component。</p>
<h3 id="Summary">Summary</h3><p><img src="/images/angular/component-interaction/counter005.svg" alt="counter005"></p>
<ul>
<li>當 parent component 要將資料傳給 child component 時，使用 <code>@Input()</code> decorator</li>
<li>當 child component 要將資料傳給 parent component 時，使用 <code>@Output()</code> decorator</li>
</ul>
<h2 id="@ViewChild()_Decorator">@ViewChild() Decorator</h2><hr>
<h3 id="Architecture-1">Architecture</h3><p>同樣是 <code>AppComponent</code> 與 <code>CounterComponent</code>，但這次是反過來，將 <code>counter</code> 包進 <code>CounterComponent</code>，卻將 <code>&lt;button/&gt;</code> 留在 <code>AppComponent</code>。</p>
<p><img src="/images/angular/component-interaction/counter002.svg" alt="counter002"></p>
<ul>
<li><code>AppComponent</code> 負責處理 <code>&lt;button/&gt;</code>；<code>CounterComponent</code> 負責顯示 <code>counter</code></li>
<li><code>AppComponent</code> 相當於 parent component，<code>CounterComponent</code> 相當於 child component</li>
<li><code>AppComponent</code> 直接呼叫 <code>CounterComponent</code> 的 method 改變 <code>counter</code>；<code>AppComponent</code> 也可直接讀取 <code>CounterComponent</code> 的 property</li>
</ul>
<h3 id="Implementation-1">Implementation</h3><p><strong>AppComponent</strong></p>
<p><img src="/images/angular/component-interaction/counter010.svg" alt="counter010"></p>
<p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onAdd1Click()"</span>&gt;</span>+<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onMinus1Click()"</span>&gt;</span>-<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-counter</span> [<span class="attribute">initialCounter</span>]=<span class="value">"initialCounter"</span>&gt;</span><span class="tag">&lt;/<span class="title">app-counter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>將 2 個 <code>&lt;button/&gt;</code> 留在 <code>AppComponent</code> 內。</p>
<p><code>AppComponent</code> 透過 <code>InitialCounter</code> 將 <code>counter</code> 的初始值傳進 <code>CounterComponent</code>，實際的 <code>counter</code> 值將由 <code>CounterComponent</code> 顯示。</p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AfterViewInit, Component, ViewChild &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterComponent &#125; from <span class="string">'./component/counter/counter.component'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> AfterViewInit &#123;</span><br><span class="line">  @ViewChild(CounterComponent) counterComponent: CounterComponent;</span><br><span class="line">  initialCounter = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">  ngAfterViewInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.counterComponent.counter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onAdd1Click() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterComponent.add1();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onMinus1Click() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterComponent.minus1();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@ViewChild(CounterComponent) counterComponent: CounterComponent;</span><br></pre></td></tr></table></figure>
<p>Angular 允許我們在 parent component 透過 <code>@ViewChild()</code> decorator 宣告 child component，藉此存取 child component 的 public field 與 method。</p>
<p><code>@ViewChild()</code> 第一個參數傳入 child component 的型別。</p>
<p>第 9 行</p>
 <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> AfterViewInit &#123;</span><br><span class="line">  ngAfterViewInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.counterComponent.counter);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若要透過 <code>@ViewChild()</code> 存取 child component 的 public field，則必須在 <code>ngAfterViewInit()</code> lifecycle hook 才可抓的到，不可以在 <code>ngOnInit()</code>。</p>
<p>17 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onAdd1Click() &#123;</span><br><span class="line">  <span class="keyword">this</span>.counterComponent.add1();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若要透過 <code>@ViewChild()</code> 存取 child component 的 public method，則無此限制。</p>
<p><strong>CounterComponent</strong></p>
<p><img src="/images/angular/component-interaction/counter011.svg" alt="counter011"></p>
<p><strong>counter.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; counter &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>負責顯示 <code>counter</code>。</p>
<p><strong>counter.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Input, OnInit &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-counter'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./counter.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./counter.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CounterComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  @Input() initialCounter;</span><br><span class="line">  counter: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.counter = <span class="keyword">this</span>.initialCounter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  add1() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counter++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  minus1() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counter--;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Input() initialCounter;</span><br></pre></td></tr></table></figure>
<p>將 field 加上 <code>@Input()</code> decorator 後，parent component 就可以透過 <code>@Input()</code> 將資料傳進 child component。</p>
<h3 id="Summary-1">Summary</h3><p><img src="/images/angular/component-interaction/counter006.svg" alt="counter006"></p>
<ul>
<li>當 parent component 要存取 child component 時，使用 <code>@ViewChild()</code> 宣告 child decorator，public field 可在 <code>ngAfterViewInit()</code> 存取，public method 則無此限制</li>
</ul>
<h2 id="Observable_Data_Service">Observable Data Service</h2><hr>
<p>一樣維持 <code>AppComponent</code> 包含 <code>&lt;button/&gt;</code>，而 <code>CounterComponent</code> 顯示 <code>counter</code>，但這次將 <code>counter</code> 獨立放在 <code>CounterService</code> 內。</p>
<h3 id="Architecture-2">Architecture</h3><p><img src="/images/angular/component-interaction/counter003.svg" alt="counter003"></p>
<ul>
<li><code>AppComponent</code> 負責處理 <code>&lt;button/&gt;</code>；<code>CounterComponent</code> 負責顯示 <code>counter</code></li>
<li><code>AppComponent</code> 相當於 parent component，<code>CounterComponent</code> 相當於 child component</li>
<li>將 <code>counter</code> 變數改放在 <code>CounterService</code> 的 <code>BehaviorSubject</code>，再以 <code>Observable</code> 型態給其他 component 訂閱<br><img src="/images/angular/component-interaction/counter004.svg" alt="counter004"></li>
</ul>
<ul>
<li>根據 <code>依賴反轉原則</code>，component 不直接相依於 <code>CounterService</code>，而是兩者相依於 interface</li>
<li>根據 <code>介面隔離原則</code>，component 只相依於它所需要的 interface，因此 <code>AppComponent</code> 訂出 <code>InitialCounterInterface</code>，而 <code>CounterComponent</code> 訂出 <code>ChangeCounterInterface</code>， <code>CounterService</code> 必須實踐此 2 個 interface</li>
<li><code>AppComponent</code> 、 <code>CounterComponent</code> 與 <code>CounterService</code> 都只相依於 <code>InitialCounterInterface</code> 與 <code>ChangeCounterInterface</code>，如此 component 與 service 將徹底解耦合</li>
<li><code>CounterComponent</code> 只負責訂閱 <code>CounterService</code>；當資料改變時，<code>CounterService</code> 會自動更新 <code>CounterComponent</code></li>
</ul>
<h3 id="Implementation-2">Implementation</h3><p><strong>AppComponent</strong></p>
<p><img src="/images/angular/component-interaction/counter012.svg" alt="counter012"></p>
<p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onAdd1Click()"</span>&gt;</span>+<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onMinus1Click()"</span>&gt;</span>-<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-counter</span> [<span class="attribute">initialCounter</span>]=<span class="value">"initialCounter"</span>&gt;</span><span class="tag">&lt;/<span class="title">app-counter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>將 2 個 <code>&lt;button/&gt;</code> 留在 <code>AppComponent</code> 內。</p>
<p><code>AppComponent</code> 透過 <code>InitialCounter</code> 將 <code>counter</code> 的初始值傳進 <code>CounterComponent</code>，實際的 <code>counter</code> 值將由 <code>CounterComponent</code> 顯示</p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ChangeCounterInterface &#125; from <span class="string">'./interface/change-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  initialCounter = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private counterService: ChangeCounterInterface) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onAdd1Click() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterService.add1();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onMinus1Click() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterService.minus1();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onAdd1Click() &#123;</span><br><span class="line">  <span class="keyword">this</span>.counterService.add1();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>CounterService</code> 提供的 <code>add1()</code> 將 <code>counter</code> + 1。</p>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private counterService: ChangeCounterInterface) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>onAdd1Click()</code> 與 <code>onMinus1Click()</code> 都使用了 <code>CounterService</code>，因此需要 DI 注入 <code>CounterService</code>。</p>
<p>根據 <code>依賴反轉原則</code>，我們不應該直接相依於 <code>CounterService</code>，而應該相依於根據 <code>ApppComponent</code> 需求所定義出的 <code>ChangeCounterInterface</code>。</p>
<p><strong>change.counter.interface</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> ChangeCounterInterface &#123;</span><br><span class="line">  abstract add1(): <span class="built_in">void</span>;</span><br><span class="line">  abstract minus1(): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，因為 <code>AppComponent</code> 只使用了 <code>add1()</code> 與 <code>minus1()</code>，因此 <code>ChangeCounterInterface</code> 也應該只有 <code>add1()</code> 與 <code>minus1()</code>。</p>
<p><strong>CounterComponent</strong></p>
<p><img src="/images/angular/component-interaction/counter013.svg" alt="counter013"></p>
<p><strong>counter.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; counter$ | async &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>只負責顯示 <code>counter$</code> 的 component。</p>
<p><strong>counter.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Input, OnInit &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InitialCounterInterface &#125; from <span class="string">'../../interface/initial-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-counter'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./counter.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./counter.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CounterComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  @Input() initialCounter;</span><br><span class="line">  counter$: Observable&lt;<span class="built_in">number</span>&gt; = <span class="keyword">this</span>.counterService.counter$;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private counterService: InitialCounterInterface) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterService.setInitialCounter(<span class="keyword">this</span>.initialCounter);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">counter$: Observable&lt;<span class="built_in">number</span>&gt; = <span class="keyword">this</span>.counterService.counter$;</span><br></pre></td></tr></table></figure>
<p><code>counter$</code> 為 <code>Observable</code>，直接使用 <code>CounterService.counter$</code> property。</p>
<p>17 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.counterService.setInitialCounter(<span class="keyword">this</span>.initialCounter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由 <code>CounterService.setInitialCounter()</code> 設定 <code>counter</code> 的初始值。</p>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private counterService: InitialCounterInterface) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>ngOnInit()</code> 使用了 <code>CounterService</code>，因此需要 DI 注入 <code>CounterService</code>。</p>
<p>根據 <code>依賴反轉原則</code>，我們不應該直接相依於 <code>CounterService</code>，而應該相依於根據 <code>CounterComponent</code> 需求所定義出的 <code>InitialCounterInterface</code>。</p>
<p><strong>initial-counter.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> InitialCounterInterface &#123;</span><br><span class="line">  abstract counter$: Observable&lt;<span class="built_in">number</span>&gt;;</span><br><span class="line">  abstract setInitialCounter(initialCounter: <span class="built_in">any</span>): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，因為 <code>CounterComponent</code> 只使用了 <code>counter$</code> 與 <code>setInitialCounter()</code>，因此 <code>ShowCounterInterface</code> 也應該只有 <code>counter$</code> 與 <code>setInitialCounter()</code>。</p>
<p><strong>CounterService</strong></p>
<p><img src="/images/angular/component-interaction/counter014.svg" alt="counter014"></p>
<p><strong>counter.service.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BehaviorSubject &#125; from <span class="string">'rxjs/BehaviorSubject'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InitialCounterInterface &#125; from <span class="string">'../interface/initial-counter.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ChangeCounterInterface &#125; from <span class="string">'../interface/change-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CounterService <span class="keyword">implements</span> InitialCounterInterface, ChangeCounterInterface &#123;</span><br><span class="line">  <span class="keyword">private</span> counterStore$: BehaviorSubject&lt;<span class="built_in">number</span>&gt; = <span class="keyword">new</span> BehaviorSubject&lt;<span class="built_in">number</span>&gt;(<span class="number">0</span>);</span><br><span class="line">  counter$: Observable&lt;<span class="built_in">number</span>&gt; = <span class="keyword">this</span>.counterStore$;</span><br><span class="line"></span><br><span class="line">  setInitialCounter(initialCounter: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterStore$.next(initialCounter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  add1() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterStore$.next(<span class="keyword">this</span>.counterStore$.getValue() + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  minus1() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterStore$.next(<span class="keyword">this</span>.counterStore$.getValue() - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 8 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CounterService <span class="keyword">implements</span> InitialCounterInterface, ChangeCounterInterface</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，我們依照 component 需求訂出 <code>InitialCounterInterface</code> 與 <code>ChangeCounterInterface</code>，因此 <code>CounterService</code> 必須概括承受實現這些 interface。</p>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> counterStore$: BehaviorSubject&lt;<span class="built_in">number</span>&gt; = <span class="keyword">new</span> BehaviorSubject&lt;<span class="built_in">number</span>&gt;(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>使用 <code>BehaviorSubject</code> 當作 <code>CounterService</code> 內部的資料庫，儲存共用的 <code>counter</code>。</p>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setInitialCounter(initialCounter: <span class="built_in">number</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.counterStore$.next(initialCounter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>BehaviorSubject.next()</code> 儲存 <code>counter</code> 的初始值。</p>
<p>16 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add1() &#123;</span><br><span class="line">  <span class="keyword">this</span>.counterStore$.next(<span class="keyword">this</span>.counterStore$.getValue() + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>this.counterStore$.getValue()</code> 獲得目前 <code>counterStore$</code> 最新一筆資料，也就是目前的 counter 值，然後 <code>+1</code>。</p>
<p>最後使用 <code>this.counterStore$.next()</code> 將最新的 counter 寫入 <code>BehaviorSubject</code>。</p>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">counter$: Observable&lt;<span class="built_in">number</span>&gt; = <span class="keyword">this</span>.counterStore$;</span><br></pre></td></tr></table></figure>
<p>已經都自己維護一份 <code>BehaviorSubject</code> 的 <code>counterStore$</code>，我們希望當 <code>BehaviorSubject</code> 使用 <code>next()</code> 改變資料時，能通知所有 <code>subscribe()</code> 的 component 都能自動更新，這也是我們使用 Observable Data Service 的初衷。</p>
<p>既然 <code>BehaviorSubject</code> 繼承於 <code>Observable</code>，理論上我們也可直接將 <code>store$</code> 設定為 <code>public</code>，直接被 component <code>subscribe()</code>，但因為 <code>BehaviorSubject</code> 提供 <code>next()</code>，因此也可能被 component 誤用 <code>next()</code> 而新增資料，因此我們改用真的 <code>Observable</code> 給 component 訂閱，確保 <code>store$</code> 不會被 component 新增資料。</p>
<p>由於 <code>store$</code> 也是一種 <code>Observable</code>，根據 <code>里式替換原則</code>，父類別可被子類別取代，因此不需要特別傳型。</p>
<p><strong>AppModule</strong></p>
<p><strong>app.module.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterComponent &#125; from <span class="string">'./component/counter/counter.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterService &#125; from <span class="string">'./service/counter.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InitialCounterInterface &#125; from <span class="string">'./interface/initial-counter.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ChangeCounterInterface &#125; from <span class="string">'./interface/change-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    CounterComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    CounterService,</span><br><span class="line">    &#123;provide: InitialCounterInterface, useExisting: CounterService&#125;,</span><br><span class="line">    &#123;provide: ChangeCounterInterface, useExisting: CounterService&#125;</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由於我們 component 與 service 都是基於 <code>依賴反轉原則</code> 與 <code>介面隔離原則</code> 所設計，因此必須藉由 DI container 幫我們將相對應的 service 注入。</p>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CounterService,</span><br><span class="line">&#123;provide: InitialCounterInterface, useExisting: CounterService&#125;,</span><br><span class="line">&#123;provide: ChangeCounterInterface, useExisting: CounterService&#125;</span><br></pre></td></tr></table></figure>
<p>一般我們使用普通 service 時，都是每個 component 注入新的 service，但使用 Observable Data Service 時不可如此，因為我們就是希望各 component 共用一份資料，只要在 provider 使用 <code>useExisting</code>，Angular DI container 就會以 Singleton 方式建立 service，各 component 才能共用同一份 <code>counterStore$</code> 。</p>
<h3 id="Summary-2">Summary</h3><p><img src="/images/angular/component-interaction/counter007.svg" alt="counter007"></p>
<ul>
<li>當 component 之間有 parent / child 架構時，尚有 <code>@Input()</code>、<code>@Output()</code>、<code>@ViewChild()</code> 等方法可用；但當 component 之間為 sibling 架構時，就只剩下 Observable Data Service 可用</li>
<li>Parent / child 架構算 sibling 架構的特例，當然也可以使用 Observable Data Service</li>
<li>當 sibling component 越多，越適合 Observable Data Service</li>
</ul>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li><strong>@Input() &amp; @Output()</strong> : component 之間的資料是靠傳遞的，透過 <code>@Input()</code> 傳入，透過 <code>@Output()</code> 傳出；若 child component 的改變必須及時通知 parent component，則適合 <code>@Output()</code> </li>
<li><strong>@ViewChild()</strong> : 由 parent component 直接存取 child component 的資料；若 child component 不會改變，則適合 <code>@ViewChild()</code></li>
<li><strong>Observable Data Service</strong> : 將 component 相關的資料獨立成 service，DI 注入到 component，透過 RxJS，只要訂閱 component，將來資料若異動會自動更新；若 component 之間的互動與資料關係複雜，則適合 Observable Data Service</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG52ComponentInteraction" target="_blank" rel="external">GitHub</a>上找到</p>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://angular.io/" target="_blank" rel="external">Angular</a>, <a href="https://angular.io/guide/component-interaction" target="_blank" rel="external">Component Interaction</a></p>
]]></content>
    <summary type="html">
    <![CDATA[3 種 component 交換資料的方法]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 Angular CLI 建立 Route ?]]></title>
    <link href="http://oomusou.io/angular/route101/"/>
    <id>http://oomusou.io/angular/route101/</id>
    <published>2018-01-12T12:23:43.000Z</published>
    <updated>2018-01-15T13:25:16.000Z</updated>
    <content type="html"><![CDATA[<p>傳統以後端為主的 MVC 寫法，route 會寫在後端；前後端分離的 SPA 寫法，前後端 有各自的 route，前端的 route 負責切換 component，而後端的 route 則負責 API。</p>
<p>Angular CLI 無法單獨建立 route，而是將 route 視為 module，透過建立 module 來建立 route。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.3<br>Angular CLI 1.6.2<br>Angular 5.1.2</p>
<h2 id="建立專案時一併建立_Route">建立專案時一併建立 Route</h2><hr>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ng <span class="built_in">new</span> MyProject <span class="comment">--routing</span></span><br></pre></td></tr></table></figure>
<p>新建專案時，加上 <code>--routing</code> 參數。</p>
<p><img src="/images/angular/route101/route000.png" alt="route000"></p>
<ol>
<li>Angular CLI 會替我們在 <code>src/app</code> 目錄下新增 <code>app-routing.module.ts</code> 檔案</li>
<li>class 名稱為 <code>AppRoutingModule</code></li>
<li><code>routes</code> 陣列即位自訂 route 之處</li>
</ol>
<p>第 7 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imports: [RouterModule.forRoot(routes)],</span><br></pre></td></tr></table></figure>
<p>一般來說，<code>imports</code> 要的都是單純 module，如 <code>BrowserModule</code>，但這裡用的卻是 <code>RouterModule.forRoot()</code>。</p>
<ul>
<li><code>forRoot()</code> 為 <code>RouterModule</code> 的 factory method，為 <code>static</code>， 傳入 <code>routes</code> 後，回傳給 <code>AppModule</code> 所使用的 <code>RouterModule</code></li>
<li><code>forChild()</code> 亦為 <code>RouterModule</code> 的 factory method，為 <code>static</code>，傳入 <code>routes</code> 後，回傳其他 module 所使用的 <code>RouterModule</code></li>
</ul>
<p><img src="/images/angular/route101/route001.png" alt="route001"></p>
<ol>
<li>Angular CLI 還替我們修改了 <code>app.module.ts</code></li>
<li>自動將 <code>AppRoutingModule</code> import 進來</li>
</ol>
<blockquote>
<p>Route 在 Angular 是以 module 的型態存在，也就是 <code>AppRoutingModule</code> 是個獨立 module，且 <code>AppModule</code> 必須將 <code>AppRoutingModule</code> 給 <code>import</code> 進來才能使用</p>
</blockquote>
<h2 id="建立專案後事後加上_Route">建立專案後事後加上 Route</h2><hr>
<p>假如一開始建立專案時沒加上 <code>--routing</code> ，也可事後再建立 route。</p>
<blockquote>
<p>Angular CLI 並沒有提供單獨建立 route 的指令，只能在建立 module 時，順便加上 <code>--routing</code> 參數建立 route</p>
</blockquote>
<h3 id="將_app-module-ts_暫時改名">將 app.module.ts 暫時改名</h3><p><img src="/images/angular/route101/route002.png" alt="route002"></p>
<ol>
<li>將 <code>app.module.ts</code> 暫時改名為 <code>app.module.ts.bak</code></li>
</ol>
<blockquote>
<p>因為我們即將重建 <code>app.module.ts</code>，所以先將目前的 <code>app.module.ts</code> 改名避開</p>
</blockquote>
<h3 id="重新建立有_Route_的_AppModule">重新建立有 Route 的 AppModule</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject $ ng <span class="keyword">g</span> <span class="keyword">m</span> <span class="keyword">App</span> --flat --routing</span><br></pre></td></tr></table></figure>
<p><code>m</code> : module 的縮寫</p>
<p><code>--flat</code> : 不要將 <code>AppRouting</code> 建立在目前目錄下，而是建立在 <code>src/app</code> 目錄下</p>
<p><code>--routing</code> : 一併建立 <code>AppRoutingModule</code></p>
<p><img src="/images/angular/route101/route003.png" alt="route003"></p>
<ol>
<li>在專案目錄下重新建立 <code>AppModule</code>，一併建立 <code>AppRoutingModule</code></li>
<li>Angular CLI 會替我們建立 <code>app.module.ts</code> 與 <code>app-routing.module.ts</code> 兩個檔案</li>
<li>在 <code>AppModule</code> 中，會自動幫我們 <code>import</code> <code>AppRoutingModule</code></li>
</ol>
<h3 id="刪除_app-module-ts">刪除 app.module.ts</h3><p>Angular CLI 剛剛幫我們建立了全新的 <code>app.module.ts</code>，手動將此檔刪除</p>
<blockquote>
<p>因為我們目的是要 Angular CLI 幫我們建立 <code>app-routing.module.ts</code>，<code>app.module.ts</code> 沒有利用價值需刪除</p>
</blockquote>
<h3 id="將_app-module-ts-bak_改為_app-module-ts">將 app.module.ts.bak 改為 app.module.ts</h3><p><img src="/images/angular/route101/route004.png" alt="route004"></p>
<ol>
<li>將 <code>app.module.ts</code> 刪除，再將 <code>app.module.ts.bak</code> 重新命名為 <code>app.module.ts</code></li>
</ol>
<blockquote>
<p><code>app.module.ts.bak</code> 才是我們原本的 <code>app.module.ts</code></p>
</blockquote>
<h3 id="修改_AppModule">修改 AppModule</h3><p><img src="/images/angular/route101/route005.png" alt="route005"></p>
<ol>
<li>選擇 <code>app.module.ts</code></li>
<li>在 <code>imports</code> 加上剛剛建立的 <code>AppRoutingModule</code></li>
</ol>
<h3 id="修改_AppRoutingModule">修改 AppRoutingModule</h3><p><img src="/images/angular/route101/route006.png" alt="route006"></p>
<ol>
<li>選擇 <code>app-routing.module.ts</code></li>
<li>將 <code>forChild()</code> 改成 <code>forRoot()</code><blockquote>
<p>如此無論是一開始建立專案就加上 <code>--routing</code> 參數，或者先建立專案，事後再補建立 route，目前 <code>AppModule</code> 都有相同的 <code>AppRoutingModule</code></p>
</blockquote>
</li>
</ol>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Angular 也有自己的 route，傳統頁面跳轉的 route 必須改設定在 Angular</li>
<li>Angular CLI 無法單獨建立 route，必須透過建立 module 來建立 route</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在 <a href="https://github.com/oomusou/NG51Clean" target="_blank" rel="external">GitHub</a> 上找到</p>
]]></content>
    <summary type="html">
    <![CDATA[以最基本的方式建立 Route]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="Angular CLI" scheme="http://oomusou.io/tags/Angular-CLI/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何在 Angular 由 Interface 注入 Object ?]]></title>
    <link href="http://oomusou.io/angular/diways/"/>
    <id>http://oomusou.io/angular/diways/</id>
    <published>2018-01-09T12:23:43.000Z</published>
    <updated>2018-01-09T15:35:42.000Z</updated>
    <content type="html"><![CDATA[<p>根據 <code>依賴反轉原則</code> ，component 與 service，或 service 與 service 的相依，引僅限於 interface，而不該直接相依於另一個 service。但真正在 Angular 使用 interface 解耦合後，又會發現因為 JavaScript 天生沒有 interface，因此 TypeScript 與 Angular DI 必須在實務上妥協，本文整理出 3 種 Angular 官方認可 interface 注入 Object 方式。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.3<br>Angular CLI 1.6.2<br>Angular 5.1.2</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/angular/diways/di001.png" alt="di001"></p>
<ul>
<li><code>counter</code> 初始值為 <code>2</code></li>
<li>按 <code>+</code> 則 <code>counter</code> + 1，按 <code>-</code> 則 <code>counter</code> -1</li>
</ul>
<h2 id="Task">Task</h2><hr>
<p><img src="/images/angular/diways/di002.png" alt="di002"></p>
<ul>
<li>將 <code>+</code> 與 <code>-</code> 放在 <code>CounterComponent</code></li>
<li><code>counter</code> 顯示仍在 <code>AppComponent</code></li>
</ul>
<h2 id="Architecture">Architecture</h2><hr>
<p><img src="/images/angular/diways/di000.svg" alt="di000"></p>
<ul>
<li><code>CounterComponent</code> 負責 <code>+</code> 與 <code>-</code> 的 button；而 <code>CounterService</code> 負責計算 <code>counter</code> 與保存共用的 counter，為一 <code>BehaviorSubject</code></li>
<li>根據 <code>依賴反轉原則</code>，<code>CounterComponent</code> 不應該直接相依於 <code>CounterService</code>，而是兩者相依於 interface</li>
<li>根據 <code>介面隔離原則</code>，<code>ConterComponent</code> 只相依於它所需要的 interface，因此以 <code>CounterComponent</code> 的角度訂出 <code>ChangeCounterInterface</code>，且 <code>CounterSerive</code> 必須實踐此 interface</li>
<li>因為 <code>CounterComponent</code> 與 <code>CounterService</code> 都相依於 <code>ChangeCounterInterface</code>，兩者都只知道 <code>ChangeCounterInterface</code> 而已，而不知道彼此，因此 <code>CounterComponent</code> 與 <code>CounterService</code> 徹底解耦合</li>
<li>透過 DI container 將實作 <code>ChangeCounterInterface</code> 的 <code>CounterService</code> 注入進 <code>CounterComponent</code></li>
</ul>
<h2 id="Implementation">Implementation</h2><hr>
<p><strong>change-counter.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> ChangeCounterInterface </span>&#123;</span><br><span class="line">  counter$: Observable&lt;<span class="built_in">number</span>&gt;;</span><br><span class="line">  setInitialCount(initialValue: <span class="built_in">number</span>);</span><br><span class="line">  addOne(): <span class="built_in">void</span>;</span><br><span class="line">  minusOne(): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>依賴反轉原則</code> 與 <code>介面隔離原則</code>，我們訂出了 <code>ChangeCounterInterface</code>。</p>
<p><strong>app.module.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterComponent &#125; from <span class="string">'./component/counter/counter.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterService &#125; from <span class="string">'./service/count/counter.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ChangeCounterInterface &#125; from <span class="string">'./interface/change-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    CounterComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    CounterService,</span><br><span class="line">    &#123;provide: ChangeCounterInterface, useExisting: CounterService&#125;</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>AppModule</code> 需定義 interface 與 class 的對應關係。</p>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;provide: ChangeCounterInterface, useExisting: CounterService&#125;</span><br></pre></td></tr></table></figure>
<p>當使用 <code>ChangeCounterInterface</code> 時，請 DI container 幫我們注入 <code>CounterService</code>。</p>
<p>其中 <code>provide</code> 為 token，DI container 會以此 token 為識別。</p>
<p><img src="/images/angular/diways/di003.png" alt="di003"></p>
<p>以一般使用 DI 的經驗，如此的設定完全合乎邏輯，但 Language Service 已經提出警告。</p>
<ol>
<li>開啟 <code>app.module.ts</code></li>
<li><code>provide</code> 使用的是 <code>ChangeCounterInterface</code></li>
<li>Language Service 已經提出警告，表示 <code>ChangeCounterInterface</code> 是個 value，而不是 type 型別</li>
</ol>
<p><code>interface</code> 在 TypeScript 的認知與傳統強型別語言不同，因為 JavaScript 沒有 interface，因此 TypeScript 的 interface 只拿來當 <code>編譯檢查</code> 用，不算是一個 type，而 <code>provide</code> 要求的是一個 type，如 class，interface 在此只當成 value 看待。</p>
<blockquote>
<p>我們無法在 Angular DI 直接使用 interface 當 token，觀念上仍是 interface，但作法上必須有所妥協</p>
</blockquote>
<h3 id="String_Token">String Token</h3><p>Angular DI 雖然不允許我們用 interface 當 token，卻允許我們使用 string 當 token。</p>
<p><strong>app.module.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterComponent &#125; from <span class="string">'./component/counter/counter.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterService &#125; from <span class="string">'./service/count/counter.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ChangeCounterInterface &#125; from <span class="string">'./interface/change-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    CounterComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    CounterService,</span><br><span class="line">    &#123;provide: <span class="string">'ChangeCounterInterface'</span>, useExisting: CounterService&#125;</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;provide: <span class="string">'ChangeCounterInterface'</span>, useExisting: CounterService&#125;</span><br></pre></td></tr></table></figure>
<p>將 <code>provide</code> 的 token 改成 <code>ChangeCounterInterface</code> 字串。</p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Inject &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ChangeCounterInterface &#125; from <span class="string">'./interface/change-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  initialCount = <span class="number">2</span>;</span><br><span class="line">  counter$: Observable&lt;<span class="built_in">number</span>&gt; = <span class="keyword">this</span>.counterService.counter$;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(@Inject('ChangeCounterInterface') private counterService: ChangeCounterInterface) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(@Inject('ChangeCounterInterface') private counterService: ChangeCounterInterface) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原本的 <code>private counterService: ChangeCounterInterface</code> 前面加上 <code>@Inject()</code> decorator，並傳入剛剛定義的 <code>ChangeCounterInterface</code> 字串。</p>
<p>原本 DI container 是以 constructor 參數的型別作為 DI 注入的依歸，但若加上 <code>@Inject()</code> decorator 後，會接管所有的 DI 型別，也就是改用 <code>@Inject()</code> 的參數作為 token。</p>
<p>剛剛在 <code>AppModule</code> 定義 <code>ChangeCounterInterface</code> string token，其對應的 class 為 <code>CounterService</code>，因此在 <code>CounterComponent</code> 會將 <code>CounterService</code> 注入。</p>
<p><strong>優點</strong></p>
<ol>
<li>仍然可使用 <code>interface</code></li>
</ol>
<p><strong>缺點</strong></p>
<ol>
<li>String token 可能重複，尤其若跟 Angular 或 3rd Party 使用相同 string token 時，將會後蓋前</li>
<li>在 constructor 內必須加上 <code>@Inject()</code> decorator，程式碼比較冗長</li>
</ol>
<h3 id="Injection_Token">Injection Token</h3><p><code>change-counter.interface.ts</code> 仍然保持不變，也就是仍然使用 interface。</p>
<p><strong>injection-token.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; InjectionToken &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterInterface &#125; from <span class="string">'./change-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> CounterInterfaceToken = <span class="keyword">new</span> InjectionToken&lt;CounterInterface&gt;(<span class="string">''</span>);</span><br></pre></td></tr></table></figure>
<p>第 4 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> CounterInterfaceToken = <span class="keyword">new</span> InjectionToken&lt;CounterInterface&gt;(<span class="string">''</span>);</span><br></pre></td></tr></table></figure>
<p>有鑑於 string token 可能重複，因此 Angular 4 提出 <code>InjectToken</code>，簡單的說，就是由 <code>string</code> 換成 <code>InjectionToken</code> 物件，由於每次 <code>new</code> 的物件都不會重複，因此儘管 token 名稱相同，但實質上仍然是不同的物件。</p>
<p><code>InjectionToken</code> 可帶泛型，也就是我們原本的 interface，初始值可帶一字串當 description，傳入空字串即可。</p>
<p><strong>app.module.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterComponent &#125; from <span class="string">'./component/counter/counter.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterService &#125; from <span class="string">'./service/count/counter.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterInterfaceToken &#125; from <span class="string">'./interface/interface-token'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    CounterComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    CounterService,</span><br><span class="line">    &#123;provide: CounterInterfaceToken, useExisting: CounterService&#125;</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;provide: CounterInterfaceToken, useExisting: CounterService&#125;</span><br></pre></td></tr></table></figure>
<p><code>provide</code> 由 string token 改成剛剛所建立的 <code>InjectionToken</code>。</p>
<p><strong>counter.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Inject, Input, OnInit &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterInterface &#125; from <span class="string">'../../interface/change-counter.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterInterfaceToken &#125; from <span class="string">'../../interface/interface-token'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-counter'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./counter.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./counter.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CounterComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  @Input() initialCount;</span><br><span class="line">  counter$: Observable&lt;<span class="built_in">number</span>&gt; = <span class="keyword">this</span>.counterService.counter$;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(@Inject(CounterInterfaceToken) private counterService: CounterInterface) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterService.setInitialCount(<span class="keyword">this</span>.initialCount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onIncrementClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterService.addOne();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onDecrementClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterService.minusOne();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(@Inject(CounterInterfaceToken) private counterService: CounterInterface) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一樣使用 <code>@Inject()</code> decorator，只是帶入改換成 <code>CounterInterfaceToken</code>，不再是字串，而是個 <code>InjectionToken</code> 物件。</p>
<p><strong>優點</strong></p>
<ol>
<li>仍然可使用 <code>interface</code></li>
<li>每個 <code>InjectionToken</code> 都獨一無二，不再會有後蓋前的問題</li>
</ol>
<p><strong>缺點</strong></p>
<ol>
<li>在 constructor 內必須加上 <code>@Inject()</code> decorator，程式碼比較冗長</li>
</ol>
<h3 id="Abstract_Class">Abstract Class</h3><p><strong>change-counter.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> CounterInterface &#123;</span><br><span class="line">  abstract counter$: Observable&lt;<span class="built_in">number</span>&gt;;</span><br><span class="line">  abstract setInitialCount(initialValue: <span class="built_in">number</span>);</span><br><span class="line">  abstract addOne(): <span class="built_in">void</span>;</span><br><span class="line">  abstract minusOne(): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將原本的 interface 寫法，全部改用 abstract class 寫法。</p>
<p>Interface 與 abstract class，在 OOP 的觀念上，皆屬於 <code>抽象</code>，兩者地位幾乎一樣；但在 TypeScript，interface 僅用於 <code>編譯檢查</code> 用，並不會實際編譯成 JavaScript，而 <code>abstract class</code> 卻會編譯成對應的 JavaScript。</p>
<p>另外在 TypeScript，class 也可以被 <code>implement</code> ，稱為 <code>class interface</code>，這也是 TypeScript 與傳統 OOP 語言不同之處，因此我們可以借用 <code>abstract class</code> 當成 interface 被 service 拿去 <code>implement</code>。</p>
<blockquote>
<p>可自行到 TypeScript Playground 實際貼上 interface 與 abstract class 寫法，就會發現兩者的 JavaScript 是不一樣的</p>
</blockquote>
<p><strong>app.module.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterComponent &#125; from <span class="string">'./component/counter/counter.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterService &#125; from <span class="string">'./service/count/counter.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterInterface &#125; from <span class="string">'./interface/change-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    CounterComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    CounterService,</span><br><span class="line">    &#123;provide: CounterInterface, useExisting: CounterService&#125;</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>20 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;provide: CounterInterface, useExisting: CounterService&#125;</span><br></pre></td></tr></table></figure>
<p>因為改用 <code>abstract class</code> 後，此時已是個 type，可光明正大在 <code>provide</code> 當 token 使用。</p>
<p><strong>counter.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Input, OnInit &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterInterface &#125; from <span class="string">'../../interface/change-counter.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-counter'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./counter.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./counter.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CounterComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  @Input() initialCount;</span><br><span class="line">  counter$: Observable&lt;<span class="built_in">number</span>&gt; = <span class="keyword">this</span>.counterService.counter$;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private counterService: CounterInterface) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterService.setInitialCount(<span class="keyword">this</span>.initialCount);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onIncrementClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterService.addOne();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onDecrementClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterService.minusOne();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private counterService: CounterInterface) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不必使用 <code>@Inject()</code> decorator，DI container 會自動使用參數的型別作為 DI 注入的依據，這也於其他 OOP 語言的經驗一樣。</p>
<p><strong>優點</strong></p>
<ol>
<li>不必使用 <code>InjectionToken</code></li>
<li>不必使用 <code>@Inject()</code> decorator，用法與一般 OOP 寫法一樣</li>
</ol>
<p><strong>缺點</strong></p>
<ol>
<li>必須由 <code>interface</code> 改用 <code>abstract class</code></li>
<li><code>abstract class</code> 可以被 <code>implement</code>，與一般 OOP 的觀念不一樣</li>
</ol>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>3 種寫法都在 Angular 官網出現過，都屬官方寫法</li>
<li>基於程式碼的精簡，個人偏好第三種寫法，也就是將 <code>interface</code> 改成 <code>abstract class</code>，而不必使用 string token 或 <code>InjectionToken</code></li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在 <a href="https://github.com/oomusou/NG51InputOutputDecorator" target="_blank" rel="external">GitHub</a>上找到</p>
]]></content>
    <summary type="html">
    <![CDATA[3 種方式都屬 Angular 官方作法]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[使用 Observable Data Service 儲存 Component 間共用變數]]></title>
    <link href="http://oomusou.io/angular/observable-data-service-counter/"/>
    <id>http://oomusou.io/angular/observable-data-service-counter/</id>
    <published>2018-01-07T12:23:43.000Z</published>
    <updated>2018-01-14T07:16:30.000Z</updated>
    <content type="html"><![CDATA[<p>Component 間共用的資料有兩類，一類是來自 API 的資料，將來還會寫回 server，另一類是 component 間自己的狀態資料，不必寫回 server；事實上這種不必寫回 server 的共用資料，也可以使用 Observable Data Service 實作。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.3<br>Angular CLI 1.6.2<br>Angular 5.1.2<br>RxJS 5.5.2</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/angular/observable-data-service-counter/counter000.png" alt="counter000"></p>
<ul>
<li>共用 counter 初始值為 <code>0</code></li>
<li>無論按哪個 <code>+</code>，或哪個 <code>-</code>，最後都是同一個 counter 作用</li>
</ul>
<h2 id="Task">Task</h2><hr>
<p><img src="/images/angular/observable-data-service-counter/counter001.png" alt="counter001"></p>
<ul>
<li>原來該有的功能必須保留，但拆成 2 個 component</li>
<li>但 2 個 component 會共用一份資料，且互相影響</li>
</ul>
<h2 id="Architecture">Architecture</h2><hr>
<p><img src="/images/angular/observable-data-service-counter/counter003.svg" alt="counter003"></p>
<blockquote>
<p>Observable Data Service vs. 普通 Service</p>
</blockquote>
<p>相同點 :</p>
<ul>
<li>兩者本質上都是 service</li>
<li>都使用 <code>@Injectable</code> decorator</li>
<li>都是回傳 <code>Observable</code></li>
</ul>
<p>相異點 :</p>
<ul>
<li>Observable data service 內部會使用 <code>BehaviorSubject</code> 儲存一份資料；而普通 service 不會</li>
</ul>
<p><img src="/images/angular/observable-data-service-counter/counter002.svg" alt="counter002"></p>
<ul>
<li>原本只有 <code>AppComponent</code>，現在分成 <code>ChangeCounterComponent</code> 與 <code>ShowCounterComponent</code> 2 個 component</li>
<li>Component 依然注入 <code>CounterService</code>，不過此時不是普通 service，而是 Observable Data Service，為 2 個 component 共用的資料</li>
<li>根據 <code>依賴反轉原則</code>，component 不直接相依於 <code>CounterService</code>，而是兩者相依於 interface；根據 <code>介面隔離原則</code>，component 只相依於它所需要的 interface，因此訂出 <code>ChangeCounterInterface</code> 與 <code>ShowCounterInterface</code> 2 個以 component 為需求的 interface，而 <code>CounterService</code> 必須實踐此 2 個 interface。如此 component 與 service 將徹底解耦合</li>
<li><code>ShowCounterComponent</code> 只負責 subscribe <code>CounterService</code>；當資料改變時，<code>CounterService</code> 會自動更新 <code>ShowCounterComponent</code></li>
</ul>
<h2 id="Implementation">Implementation</h2><hr>
<h3 id="AppComponent">AppComponent</h3><p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">app-change-value</span>&gt;</span><span class="tag">&lt;/<span class="title">app-change-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-change-value</span>&gt;</span><span class="tag">&lt;/<span class="title">app-change-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-show-value</span>&gt;</span><span class="tag">&lt;/<span class="title">app-show-value</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="ChangeCounterComponent">ChangeCounterComponent</h3><p><img src="/images/angular/observable-data-service-counter/counter004.svg" alt="counter004"></p>
<p><strong>change-counter.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onIncrementClick()"</span>&gt;</span>+<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onDecrementClick()"</span>&gt;</span>-<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>只負責 <code>增加</code> 與 <code>減少</code> counter 的 component，因此只有兩個 <code>&lt;button&gt;</code>。</p>
<p><strong>change-counter.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ChangeCounterInterface &#125; from <span class="string">'../../interface/change-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-change-value'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./change-counter.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./change-counter.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ChangeCounterComponent &#123;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private counterService: ChangeCounterInterface) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">  onIncrementClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterService.addOne();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onDecrementClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.counterService.minusOne();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onIncrementClick() &#123;</span><br><span class="line">  <span class="keyword">this</span>.counterService.addOne();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>CounterService</code> 提供的 <code>addOne()</code> 將 <code>counter</code> + 1。</p>
<p>17 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onDecrementClick() &#123;</span><br><span class="line">  <span class="keyword">this</span>.counterService.minusOne();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>CounterService</code> 提供的 <code>minusOne()</code> 將 <code>counter</code> - 1;</p>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private counterService: ChangeCounterInterface) </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>onIncrementClick()</code> 與 <code>onDecrementClick()</code> 都使用了 <code>CounterService</code>，因此需要 DI 注入 <code>CounterService</code>。</p>
<p>根據 <code>依賴反轉原則</code>，我們不應該直接相依於 <code>CounterService</code>，而應該相依於根據 <code>ChangeCounterComponent</code> 需求所定義出的 <code>ChangeCounterInterface</code>。</p>
<p><strong>change-counter.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> ChangeCounterInterface &#123;</span><br><span class="line">  abstract addOne(): <span class="built_in">void</span>;</span><br><span class="line">  abstract minusOne(): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，因為 <code>ChangeCounterComponent</code> 只使用了  <code>addOne()</code> 與 <code>minusOne()</code>，因此 <code>ChangeCounterInterface</code> 也應該只有 <code>addOne()</code> 與 <code>minusOne()</code>。</p>
<h3 id="ShowCounterComponent">ShowCounterComponent</h3><p><img src="/images/angular/observable-data-service-counter/counter005.svg" alt="counter005"></p>
<p><strong>show-counter.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; counter$|async &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>只負責顯示 <code>counter$</code> 的 component。</p>
<p><strong>show-counter.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ShowCounterInterface &#125; from <span class="string">'../../interface/show-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-show-value'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./show-counter.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./show-counter.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ShowValueComponent &#123;</span><br><span class="line">  counter$: Observable&lt;<span class="built_in">number</span>&gt; = <span class="keyword">this</span>.counterService.counter$;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private counterService: ShowCounterInterface) </span>&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">counter$: Observable&lt;<span class="built_in">number</span>&gt; = <span class="keyword">this</span>.counterService.counter$;</span><br></pre></td></tr></table></figure>
<p><code>counter$</code> 為 <code>Observable</code>，只接使用 <code>CounterService.counter$</code> property。</p>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private counterService: ShowCounterInterface) </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>ShowCounterComponent</code> 只用了 <code>CounterService</code>，因此需要 DI 注入 <code>CounterService</code>。</p>
<p>根據 <code>依賴反轉原則</code>，我們不應該直接相依於 <code>CounterService</code>，而應該相依於根據 <code>ShowCounterComponent</code> 需求所定義出的 <code>ShowCounterInterface</code>。</p>
<p><strong>show-counter.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> ShowCounterInterface &#123;</span><br><span class="line">  abstract counter$: Observable&lt;<span class="built_in">number</span>&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，因為 <code>ShowCounterComponent</code> 只使用了  <code>counter$</code> property，因此 <code>ShowCounterInterface</code> 也應該只有 <code>counter$</code> property。</p>
<h3 id="CounterService">CounterService</h3><p><img src="/images/angular/observable-data-service-counter/counter006.svg" alt="counter006"></p>
<p><strong>counter.service.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ChangeCounterInterface &#125; from <span class="string">'../../interface/change-counter.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ShowCounterInterface &#125; from <span class="string">'../../interface/show-counter.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BehaviorSubject &#125; from <span class="string">'rxjs/BehaviorSubject'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CounterService <span class="keyword">implements</span> ChangeCounterInterface, ShowCounterInterface &#123;</span><br><span class="line">  <span class="keyword">private</span> store$: BehaviorSubject&lt;<span class="built_in">number</span>&gt; = <span class="keyword">new</span> BehaviorSubject&lt;<span class="built_in">number</span>&gt;(<span class="number">0</span>);</span><br><span class="line">  counter$: Observable&lt;<span class="built_in">number</span>&gt; = <span class="keyword">this</span>.store$;</span><br><span class="line"></span><br><span class="line">  addOne(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.store$.next(<span class="keyword">this</span>.store$.getValue() + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  minusOne(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.store$.next(<span class="keyword">this</span>.store$.getValue() - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 8 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CounterService <span class="keyword">implements</span> ChangeCounterInterface, ShowCounterInterface</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，我們依照 component 需求訂出 <code>ChangeCounterInterface</code> 與 <code>ShowCounterInterface</code>，因此 <code>CounterService</code> 必須概括承受實現這些 interface。</p>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> store$: BehaviorSubject&lt;<span class="built_in">number</span>&gt; = <span class="keyword">new</span> BehaviorSubject&lt;<span class="built_in">number</span>&gt;(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>本文關鍵在此，使用 <code>BehaviorSubject</code> 當作 <code>CounterService</code> 內部的資料庫，儲存共用的 <code>counter</code>。</p>
<p>Observable Data Service  關鍵就在於使用 <code>BehaviorSubject</code>。</p>
<blockquote>
<p>Q : 什麼是 BehaviorSubject ?</p>
</blockquote>
<p>根據 RxJS 的 source code</p>
<p><strong>BehaviorSubject.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> BehaviorSubject&lt;T&gt; extends Subject&lt;T&gt;</span><br></pre></td></tr></table></figure>
<p><code>BehaviorSubject</code> 繼承於 <code>Subject</code>。</p>
<p><strong>Subject.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Subject&lt;T&gt; extends Observable&lt;T&gt; <span class="keyword">implements</span> ISubscription</span><br></pre></td></tr></table></figure>
<p>而 <code>Subject</code> 繼承於 <code>Observable</code>。</p>
<p><img src="/images/angular/observable-data-service-counter/counter007.svg" alt="ods009"></p>
<p>因此 <code>Observable</code> 所有的特性，<code>Subject</code> 與 <code>BehaviorSubject</code> 都有，如被 <code>subscribe()</code>。</p>
<blockquote>
<p><code>Subject</code> 與 <code>BehaviorSubject</code> 算是一種特殊的 <code>Observable</code>，提供一些原本 <code>Observable</code> 沒有的功能</p>
<p>Q : Observable 與 Subject  有何差別 ?</p>
</blockquote>
<ul>
<li><code>Observable</code> 只能從 <code>HttpClient</code> 或 array、event 提供資料，無法自行新增</li>
<li><code>Subject</code> 可以透過 <code>next()</code> 手動新增資料至 Observable</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> subject: Subject = <span class="keyword">new</span> Subject();</span><br><span class="line">subject.subscribe((value) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Subscription got '</span>, value);</span><br><span class="line">&#125;);</span><br><span class="line">subject.next(<span class="string">'Hello World'</span>);</span><br><span class="line"><span class="comment">// Hello World</span></span><br></pre></td></tr></table></figure>
<p>若你要手動將資料推進 <code>Observable</code>，就使用 <code>Subject</code></p>
<blockquote>
<p>Q : Subject 與 BehaviorSubject 有何差別 ?</p>
</blockquote>
<ul>
<li><code>Subject</code> 不能提供初始值，但 <code>BehaviorSubject</code> 可提供初始值</li>
<li><code>Subject</code> 在被 <code>subscribe()</code> 後，必續再 <code>next()</code> 才能收到變動資料；<code>BehaviorSubject</code> 只要被 <code>subscribe()</code> 後，就可收到之前最後一筆資料，不用再等 <code>next()</code></li>
<li><code>BehaviorSubject</code> 提供了 <code>getValue()</code>，能獲得目前 <code>BehaviorSubject</code> 最新一筆資料；而 <code>Subject</code> 無法</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> subject: BehaviorSubject = <span class="keyword">new</span> BehaviorSubject(<span class="string">'Hello World'</span>);</span><br><span class="line">subject.subscribe((value) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Subscription got '</span>, value);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Hello World</span></span><br><span class="line">subject.next(<span class="string">'Hello Taiwan'</span>)</span><br><span class="line"><span class="comment">// Hello Taiwan</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Q : 為什麼 Observable Data Service 要使用 BehaviorSubject ?</p>
</blockquote>
<p>因為 HTML 的 <code>async</code> pipe，每個 HTML template 執行 <code>subscribe()</code> 的時間不一致，有快有慢，若 <code>subscribe()</code> 早於 <code>next()</code>，則可收到變動資料；若晚於 <code>next()</code>，則可能收不到資料，必須等下一次 <code>next()</code>。</p>
<p>若使用 <code>BehaviorSubject</code>，無論 <code>subscribe()</code> 早於 <code>next()</code> 或晚於 <code>next()</code>，<code>async</code> pipe 都會獲得最新一筆 <code>next()</code>，因此 Observable Data Service 必須使用 <code>BehaviorSubject</code>。</p>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">addOne(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.store$.next(<span class="keyword">this</span>.store$.getValue() + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>this.store$.getValue()</code> 獲得目前 <code>store$</code> 最新一筆資料，也就是目前的 counter 值，然後 <code>+1</code>。</p>
<p>最後使用 <code>this.store$.next()</code> 將最新的 counter 寫入 <code>BehaviorSubject</code>。</p>
<p>16 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">minusOne(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.store$.next(<span class="keyword">this</span>.store$.getValue() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>this.store$.getValue()</code> 獲得目前 <code>store$</code> 最新一筆資料，也就是目前的 counter 值，然後 <code>-1</code>。</p>
<p>最後使用 <code>this.store$.next()</code> 將最新的 counter 寫入 <code>BehaviorSubject</code>。</p>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">counter$: Observable&lt;<span class="built_in">number</span>&gt; = <span class="keyword">this</span>.store$;</span><br></pre></td></tr></table></figure>
<p>已經都自己維護一份 <code>BehaviorSubject</code> 的 <code>store$</code>，我們希望當 <code>BehaviorSubject</code> 使用 <code>next()</code> 改變資料時，能通知所有 <code>subscribe()</code> 的 component 都能自動更新，這也是我們使用 Observable Data Service 的初衷。</p>
<p>既然 <code>BehaviorSubject</code> 繼承於 <code>Observable</code>，理論上我們也可直接將 <code>store$</code> 設定為 <code>public</code>，直接被 component <code>subscribe()</code>，但因為 <code>BehaviorSubject</code> 提供 <code>next()</code>，因此也可能被 component 誤用 <code>next()</code> 而新增資料，因此我們改用真的 <code>Observable</code> 給 component 訂閱，確保 <code>store$</code> 不會被 component 新增資料。</p>
<p>由於 <code>store$</code> 也是一種 <code>Observable</code>，根據 <code>里式替換原則</code>，父類別可被子類別取代，因此不需要特別傳型。</p>
<h3 id="AppModule">AppModule</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ChangeCounterComponent &#125; from <span class="string">'./component/change-counter/change-counter.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ShowValueComponent &#125; from <span class="string">'./component/show-counter/show-counter.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ChangeCounterInterface &#125; from <span class="string">'./interface/change-counter.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CounterService &#125; from <span class="string">'./service/counter/counter.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ShowCounterInterface &#125; from <span class="string">'./interface/show-counter.interface'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    ChangeCounterComponent,</span><br><span class="line">    ShowValueComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    CounterService,</span><br><span class="line">    &#123;provide: ChangeCounterInterface, useExisting: CounterService&#125;,</span><br><span class="line">    &#123;provide: ShowCounterInterface, useExisting: CounterService&#125;</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>由於我們 component 與 service 都是基於 <code>依賴反轉原則</code> 與 <code>介面隔離原則</code> 所設計，因此必須藉由 DI container 幫我們將相對應的 service 注入。</p>
<p>19 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  CounterService,</span><br><span class="line">  &#123;provide: ChangeCounterInterface, useExisting: CounterService&#125;,</span><br><span class="line">  &#123;provide: ShowCounterInterface, useExisting: CounterService&#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>一般我們使用普通 service 時，都是每個 component 注入新的 service，但使用 Observable Data Service 時不可如此，因為我們就是希望各 component 共用一份資料，只要在 provider 使用 <code>useExisting</code>，Angular DI container 就會以 Singleton 方式建立 service，各 component 才能共用同一份 <code>store$</code> 的 counter。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>只要是 component 間有共用資料，且彼此會根據資料互動，就可以使用 Observable Data Service</li>
<li>Observable Data Service 同時使用了 DI 與 RxJS，讓 component 與 service 解耦合，只要 service 的資料更新，所有 component 的資料解會隨之更新</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG51StateManagement" target="_blank" rel="external">GitHub</a>上找到</p>
]]></content>
    <summary type="html">
    <![CDATA[Observable Data Service 也能用來儲存不寫回 server 的資料]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="RxJS" scheme="http://oomusou.io/tags/RxJS/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 Observable Data Service ?]]></title>
    <link href="http://oomusou.io/angular/observable-data-service/"/>
    <id>http://oomusou.io/angular/observable-data-service/</id>
    <published>2018-01-04T12:23:43.000Z</published>
    <updated>2018-01-28T15:24:37.414Z</updated>
    <content type="html"><![CDATA[<p>當 HTML 都 component 化之後，看似美好，但卻也導出另外一個棘手的問題 : <code>component 間共用的資料該如何處理?</code> React 是以 Redux 來解決這個問題，當然在 Angular 也可使用類似 Redux 的 NgRx，但 Redux 稍嫌複雜，而 Observable Data Service 較為簡單。顧名思義，<code>Observable</code> 採用的是 RxJS，而 <code>Data Service</code> 採用是 DI。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.3<br>Angular CLI 1.6.2<br>Angular 5.1.2<br>RxJS 5.5.2</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/angular/observable-data-service/ods002.png" alt="ods000"></p>
<ul>
<li>一開始會顯示所有 post</li>
<li>當輸入 post 名稱，按下 <code>Add Post</code> 後，新增的 post 會顯示在下方</li>
<li>顯示目前 post 筆數</li>
<li>按下 <code>Reload</code> 會重新從 API server 下載最新資料</li>
</ul>
<h2 id="Task">Task</h2><hr>
<p><img src="/images/angular/observable-data-service/ods001.png" alt="obs001"></p>
<ul>
<li>原來該有的功能必須保留，但拆成 4 個 component</li>
<li>但 4 個 component 會共用一份資料，且互相影響</li>
</ul>
<h2 id="Architecture">Architecture</h2><hr>
<p><img src="/images/angular/observable-data-service/ods003.svg" alt="ods003"></p>
<blockquote>
<p>Observable Data Service vs. 普通 Service</p>
</blockquote>
<p>相同點 :</p>
<ul>
<li>兩者本質上都是 service</li>
<li>都使用 <code>@Injectable</code> decorator</li>
<li>都是回傳 <code>Observable</code></li>
</ul>
<p>相異點 :</p>
<ul>
<li>Observable data service 內部會使用 <code>BehaviorSubject</code> 儲存一份資料；而普通 service 會直接回傳 <code>HttpClient</code> 的 <code>Observable</code></li>
</ul>
<p><img src="/images/angular/observable-data-service/ods000.svg" alt="ods000"></p>
<ul>
<li>原本只有 <code>AppComponent</code>，現在分成 <code>AddPostComponent</code>、<code>ListPostsComponent</code>、<code>ShowCountComponent</code> 與 <code>ReloadPostsComponent</code> 4 個 component</li>
<li>Component 依然注入 <code>PostService</code>，不過此時不是普通 service，而是 observable data service，為 4 個 component 共用的資料</li>
<li>根據 <code>依賴反轉原則</code>，component 不直接相依於 <code>PostService</code>，而是兩者相依於 interface，根據 <code>介面隔離原則</code>，component 只相依於它所需要的 interface，因此訂出 <code>IAddPost</code>、<code>IListPosts</code>、<code>IShowCount</code> 與 <code>IReloadPosts</code> 4 個以 component 為導向的 interface，<code>PostService</code> 必須實踐此 4 個 interface</li>
<li>Component 只負責 subscribe <code>PostService</code>，當資料改變時，<code>PostService</code> 會自動更新 component</li>
</ul>
<h2 id="Implementation">Implementation</h2><hr>
<h3 id="AppComponent">AppComponent</h3><p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">app-add-post</span>&gt;</span><span class="tag">&lt;/<span class="title">app-add-post</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-list-posts</span>&gt;</span><span class="tag">&lt;/<span class="title">app-list-posts</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-show-count</span>&gt;</span><span class="tag">&lt;/<span class="title">app-show-count</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-reload-posts</span>&gt;</span><span class="tag">&lt;/<span class="title">app-reload-posts</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>原本只有一個 <code>AppComponent</code> 時，所有 HTML 都在 <code>app.component.html</code> 下，現在因為都切成 component，所以只會看到 component 的 selector 而已。</p>
<blockquote>
<p>切 Component 心法</p>
<p>切 component 與切 class、切 function 的心法一樣，就是 <code>單一職責原則</code>，讓你的 component 只有一個目的，且只有一個改變 component 的理由</p>
<p>理想的 component 會看到很多其他 component 的 selector，而不是一個 component 有大量的 HTML</p>
</blockquote>
<h3 id="AddPostComponent">AddPostComponent</h3><p><img src="/images/angular/observable-data-service/ods004.svg" alt="ods004"></p>
<p><strong>add-post.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> [(<span class="attribute">ngModel</span>)]=<span class="value">"title"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onAddPostClick()"</span>&gt;</span>Add Post<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>只負責新增 post 的 component，因此只有 <code>&lt;input&gt;</code> 與 <code>&lt;button&gt;</code>。</p>
<p><strong>add-post.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Post &#125; from <span class="string">'../../model/post.model'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IAddPost &#125; from <span class="string">'../../interface/iadd-post.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-add-post'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./add-post.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./add-post.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AddPostComponent &#123;</span><br><span class="line">  title: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private postService: IAddPost) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">  onAddPostClick() &#123;</span><br><span class="line">    <span class="keyword">const</span> post: Post = &#123;</span><br><span class="line">      <span class="string">'title'</span>: <span class="keyword">this</span>.title,</span><br><span class="line">      <span class="string">'author'</span>: <span class="string">'Sam'</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.postService.addPost(post);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.title = <span class="string">''</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">onAddPostClick() &#123;</span><br><span class="line">  <span class="keyword">const</span> post: Post = &#123;</span><br><span class="line">    <span class="string">'title'</span>: <span class="keyword">this</span>.title,</span><br><span class="line">    <span class="string">'author'</span>: <span class="string">'Sam'</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.postService.addPost(post);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.title = <span class="string">''</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>onAddPostClick()</code> 負責回應 <code>&lt;button&gt;</code> 的 <code>click</code> event。</p>
<p>因為 <code>addPost()</code> 傳入的型別為 <code>Post</code>，因此先宣告 <code>post</code> 為 <code>Post</code> 型別，並準備 post 物件。</p>
<p>透過 <code>PostService.addPost()</code> 傳入 <code>post</code>。 </p>
<p>最後將 <code>&lt;input&gt;</code> 清空，因為 <code>&lt;input&gt;</code> 與 <code>title</code> 使用 <code>ngModel</code> 的 two-way binding，因此對 title 指定空字串，就相當於清空 <code>&lt;input&gt;</code>。</p>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private postService: IAddPost) </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>onAddPostClick()</code> 使用了 <code>PostService</code>，因此需要 DI 注入 <code>PostService</code>。</p>
<p>根據 <code>依賴反轉原則</code>，我們不應該直接相依於 <code>PostService</code>，而應該相依於 <code>AddPostComponent</code> 所定義出的 <code>IAddPost</code> interface。</p>
<p><strong>iadd-post.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Post &#125; from <span class="string">'../model/post.model'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> IAddPost &#123;</span><br><span class="line">  abstract addPost(post: Post): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，因為 <code>AddPostComponent</code> 只使用了 <code>addPost()</code>，因此 <code>IAddPost</code> interface 也應該只有 <code>addPost()</code>。</p>
<h3 id="ListPostsComponent">ListPostsComponent</h3><p><img src="/images/angular/observable-data-service/ods005.svg" alt="ods005"></p>
<p><strong>list-posts.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">li</span> *<span class="attribute">ngFor</span>=<span class="value">"let post of posts$|async"</span>&gt;</span></span><br><span class="line">    &#123;&#123; post.title &#125;&#125; &#123;&#123; post.author &#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>只負責顯示post 的 component，因此只有 <code>&lt;ul&gt;</code> 與 <code>&lt;li&gt;</code>。</p>
<p><code>posts$</code> 因為為 <code>Observable</code>，因此要搭配 <code>async</code> pipe 做 subscribe。</p>
<p><strong>list-posts.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, OnInit &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span>&#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Post &#125; from <span class="string">'../../model/post.model'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IListPosts &#125; from <span class="string">'../../interface/ilist-posts.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-list-posts'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./list-posts.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./list-posts.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ListPostsComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  posts$: Observable&lt;Post[]&gt; = <span class="keyword">this</span>.postService.posts$;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private postService: IListPosts) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.postService.reloadPosts();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">posts$: Observable&lt;Post[]&gt; = <span class="keyword">this</span>.postService.posts$;</span><br></pre></td></tr></table></figure>
<p><code>posts$</code> 為 Observable，直接使用 <code>PostService.post$</code> property。</p>
<blockquote>
<p>當然也可以在 <code>ngOnInit()</code> 內 <code>this.posts$ = this.postService.post$</code>，但因為 RxJS 為 Declarative Programming，主要都在定義 <code>Observable</code> 關係，而不重視執行順序，反正最後都是在 <code>subscribe()</code> 或 <code>async</code> pipe 才執行，所以指令 <code>Observable</code> 時一般不寫在 <code>ngOnInit()</code> 內，直接寫在 <code>field</code> 即可。</p>
</blockquote>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private postService: IListPosts) </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>ListPostComponent</code> 使用了 <code>PostService</code>，因此需要 DI 注入 <code>PostService</code>。</p>
<p>根據 <code>依賴反轉原則</code>，我們不應該直接相依於 <code>PostService</code>，而應該相依於 <code>ListPostComponent</code> 所定義出的 <code>IListPosts</code> interface。</p>
<p>16 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.postService.reloadPosts();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ListPostsComponent</code> 主要用於顯示 post，而需求是 <code>一開始會顯示所有 post</code>，因此在 <code>ngOnInit()</code> 時要呼叫 <code>PostService.reloadPosts()</code> 將全部 post 灌入 <code>posts$</code> observable。</p>
<p><strong>ilist-posts.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Post &#125; from <span class="string">'../model/post.model'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> IListPosts &#123;</span><br><span class="line">  readonly posts$: Observable&lt;Post[]&gt;;</span><br><span class="line">  abstract reloadPosts(): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，因為 <code>ListPostsComponent</code> 只使用了 <code>post$</code> property 與 <code>reloadPosts()</code>，因此 <code>IListPosts</code> interface 也應該只有 <code>post$</code> property 與 <code>reloadPosts()</code>。</p>
<h3 id="ShowCountComponent">ShowCountComponent</h3><p><img src="/images/angular/observable-data-service/ods006.svg" alt="ods006"></p>
<p><strong>show-count.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; (posts$|async)?.length &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>只負責顯示 post 筆數的 component。</p>
<blockquote>
<p>當使用 <code>Observable</code> 的 property 時，要加上 <code>?</code>，表示當 <code>posts$</code> 有 <code>length</code> property 時，才會執行 <code>post$.length</code></p>
<p>因為 <code>post$</code> 為非同步，可能 HTML 在做 data binding 時，<code>post$</code> 還沒有產生</p>
<p>目前 <code>?</code> 寫法只能用在 HTML template，還不能用在 TypeScript，將來會提供</p>
</blockquote>
<p><strong>show-count.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Post &#125; from <span class="string">'../../model/post.model'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IShowCount &#125; from <span class="string">'../../interface/ishow-count.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-show-count'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./show-count.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./show-count.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ShowCountComponent &#123;</span><br><span class="line">  posts$: Observable&lt;Post[]&gt; = <span class="keyword">this</span>.postService.posts$;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private postService: IShowCount) </span>&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">posts$: Observable&lt;Post[]&gt; = <span class="keyword">this</span>.postService.posts$;</span><br></pre></td></tr></table></figure>
<p><code>posts$</code> 為 Observable，直接使用 <code>PostService.post$</code> property。</p>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private postService: IShowCount) </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>ShowCountCompone</code> 使用了 <code>PostService</code>，因此需要 DI 注入 <code>PostService</code>。</p>
<p>根據 <code>依賴反轉原則</code>，我們不應該直接相依於 <code>PostService</code>，而應該相依於 <code>ShowCountComponent</code> 所定義出的 <code>IShowCount</code> interface。</p>
<p><strong>ishow-count.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Post &#125; from <span class="string">'../model/post.model'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> IShowCount &#123;</span><br><span class="line">  readonly posts$: Observable&lt;Post[]&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，因為 <code>ShowCountComponent</code> 只使用了 <code>post$</code> property ，因此 <code>IShowCount</code> interface 也應該只有 <code>post$</code> property。</p>
<h3 id="ReloadPostsComponent">ReloadPostsComponent</h3><p><img src="/images/angular/observable-data-service/ods007.svg" alt="ods007"></p>
<p><strong>reload-posts.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onReloadClick()"</span>&gt;</span>Reload<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>只負責重新從 API server 抓資料的 component，因此只有 <code>&lt;button&gt;</code>。</p>
<p><strong>reload-posts.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IReloadPosts &#125; from <span class="string">'../../interface/ireload-posts.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-reload-posts'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./reload-posts.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./reload-posts.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ReloadPostsComponent &#123;</span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private postService: IReloadPosts) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">  onReloadClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.postService.reloadPosts();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onReloadClick() &#123;</span><br><span class="line">  <span class="keyword">this</span>.postService.reloadPosts();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>onReloadClick()</code> 負責回應 <code>&lt;button&gt;</code> 的 <code>click</code> event。</p>
<p>呼叫 <code>PostService.reloadPosts()</code> 重新透過 GET 向 API server 抓最新資料。</p>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private postService: IReloadPosts) </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>onReloadClick()</code> 使用了 <code>PostService</code>，因此需要 DI 注入 <code>PostService</code>。</p>
<p>根據 <code>依賴反轉原則</code>，我們不應該直接相依於 <code>PostService</code>，而應該相依於 <code>ReloadPostComponent</code> 所定義出的 <code>IReloadPosts</code> interface。</p>
<p><strong>ireload-posts.interface.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> IReloadPosts &#123;</span><br><span class="line">  abstract reloadPosts(): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，因為 <code>ReloadPostComponent</code> 只使了 <code>reloadPosts()</code>，因此 <code>IReloadPosts</code> interface 也應該只有 <code>reloadPosts()</code>。</p>
<h3 id="PostService">PostService</h3><p><img src="/images/angular/observable-data-service/ods008.svg" alt="ods008"></p>
<p><strong>post.service.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IAddPost &#125; from <span class="string">'../../interface/iadd-post.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IListPosts &#125; from <span class="string">'../../interface/ilist-posts.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IShowCount &#125; from <span class="string">'../../interface/ishow-count.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IReloadPosts &#125; from <span class="string">'../../interface/ireload-posts.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Post &#125; from <span class="string">'../../model/post.model'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpClient &#125; from <span class="string">'@angular/common/http'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BehaviorSubject &#125; from <span class="string">'rxjs/BehaviorSubject'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> PostService <span class="keyword">implements</span> IAddPost, IListPosts, IShowCount, IReloadPosts &#123;</span><br><span class="line">  <span class="keyword">private</span> store$: BehaviorSubject&lt;Post[]&gt; = <span class="keyword">new</span> BehaviorSubject&lt;Post[]&gt;([]);</span><br><span class="line">  readonly posts$: Observable&lt;Post[]&gt; = <span class="keyword">this</span>.store$;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private httpClient: HttpClient) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">  addPost(post: Post): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.httpClient</span><br><span class="line">      .post&lt;Post&gt;(<span class="string">'api/posts'</span>, post)</span><br><span class="line">      .subscribe();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.store$.next([...this.store$.getValue(), post]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reloadPosts(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.httpClient</span><br><span class="line">      .get&lt;Post[]&gt;(<span class="string">'api/posts'</span>)</span><br><span class="line">      .subscribe(posts =&gt; <span class="keyword">this</span>.store$.next(posts));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> PostService <span class="keyword">implements</span> IAddPost, IListPosts, IShowCount, IReloadPosts</span><br></pre></td></tr></table></figure>
<p>根據 <code>介面隔離原則</code>，我們根據 component 的需求訂出 <code>IAddPost</code>、<code>IListPosts</code>、<code>IShowCount</code> 與 <code>IReloadPosts</code> interface，因此 <code>PostService</code> 必須概括承受實現這些 interface。</p>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> store$: BehaviorSubject&lt;Post[]&gt; = <span class="keyword">new</span> BehaviorSubject&lt;Post[]&gt;([]);</span><br></pre></td></tr></table></figure>
<p>本文的關鍵在此，使用 <code>BehaviorSubject</code> 當作 <code>PostService</code> 內部的資料庫，儲存所有 post 資料，Observable Data Service 的關鍵就在於使用 <code>BehaviorSubject</code>。</p>
<blockquote>
<p>Q : 什麼是 BehaviorSubject ?</p>
</blockquote>
<p>根據 RxJS 的 source code</p>
<p><strong>BehaviorSubject.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> BehaviorSubject&lt;T&gt; extends Subject&lt;T&gt;</span><br></pre></td></tr></table></figure>
<p><code>BehaviorSubject</code> 繼承於 <code>Subject</code>。</p>
<p><strong>Subject.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Subject&lt;T&gt; extends Observable&lt;T&gt; <span class="keyword">implements</span> ISubscription</span><br></pre></td></tr></table></figure>
<p>而 <code>Subject</code> 繼承於 <code>Observable</code>。</p>
<p><img src="/images/angular/observable-data-service/ods009.svg" alt="ods009"></p>
<p>因此 <code>Observable</code> 所有的特性，<code>Subject</code> 與 <code>BehaviorSubject</code> 都有，如被 <code>subscribe()</code>。</p>
<blockquote>
<p><code>Subject</code> 與 <code>BehaviorSubject</code> 算是一種特殊的 <code>Observable</code>，提供一些原本 <code>Observable</code> 沒有的功能</p>
<p>Q : Observable 與 Subject  有何差別 ?</p>
</blockquote>
<ul>
<li><code>Observable</code> 只能從 <code>HttpClient</code> 或 array、event 提供資料，無法自行新增</li>
<li><code>Subject</code> 可以透過 <code>next()</code> 手動新增資料至 Observable</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> subject: Subject = <span class="keyword">new</span> Subject();</span><br><span class="line">subject.subscribe((value) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Subscription got '</span>, value);</span><br><span class="line">&#125;);</span><br><span class="line">subject.next(<span class="string">'Hello World'</span>);</span><br><span class="line"><span class="comment">// Hello World</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>若你要手動將資料推進 <code>Observable</code>，就使用 <code>Subject</code></p>
<p>Q : Subject 與 BehaviorSubject 有何差別 ?</p>
</blockquote>
<ul>
<li><code>Subject</code> 不能提供初始值，但 <code>BehaviorSubject</code> 可提供初始值</li>
<li><code>Subject</code> 在被 <code>subscribe()</code> 後，必續再 <code>next()</code> 才能收到變動資料；<code>BehaviorSubject</code> 只要被 <code>subscribe()</code> 後，就可收到之前最後一筆資料，不用再等 <code>next()</code></li>
<li><code>BehaviorSubject</code> 提供了 <code>getValue()</code>，能獲得目前 <code>BehaviorSubject</code> 最新一筆資料；而 <code>Subject</code> 無法</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> subject: BehaviorSubject = <span class="keyword">new</span> BehaviorSubject(<span class="string">'Hello World'</span>);</span><br><span class="line">subject.subscribe((value) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Subscription got '</span>, value);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Hello World</span></span><br><span class="line">subject.next(<span class="string">'Hello Taiwan'</span>)</span><br><span class="line"><span class="comment">// Hello Taiwan</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Q : 為什麼 Observable Data Service 要使用 BehaviorSubject ?</p>
</blockquote>
<p>因為 HTML 的 <code>async</code> pipe，每個 HTML template 執行 <code>subscribe()</code> 的時間不一致，有快有慢，若 <code>subscribe()</code> 早於 <code>next()</code>，則可收到變動資料；若晚於 <code>next()</code>，則可能收不到資料，必須等下一次 <code>next()</code>。</p>
<p>若使用 <code>BehaviorSubject</code>，無論 <code>subscribe()</code> 早於 <code>next()</code> 或晚於 <code>next()</code>，<code>async</code> pipe 都會獲得最新一筆 <code>next()</code>，因此 Observable Data Service 必須使用 <code>BehaviorSubject</code>。</p>
<p>16 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private httpClient: HttpClient) </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>PostService</code> 要使用 <code>HttpClient</code>，因此 DI 注入 <code>HttpClient</code>。</p>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addPost(post: Post): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.httpClient</span><br><span class="line">    .post&lt;Post&gt;(<span class="string">'api/posts'</span>, post)</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.store$.next([...this.store$.getValue(), post]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>HttpClient.Post()</code> 寫入 API，並且馬上 <code>subscribe()</code> 執行。</p>
<p>由於我們自己有維護一份 <code>store$</code> 儲存所有 post，因此新增的 post 也該寫入 <code>$store</code>。</p>
<p><code>this.store$.getValue()</code> 將取得目前最新的 post 陣列資料。</p>
<p><code>...this.store$.getValue()</code> 將會展開 post 陣列所有資料，此為 ES6 的 array spread operator。</p>
<p><code>[...this.store$.getValue(), post]</code> ，將 post 加到原本陣列之後，此為新的陣列。</p>
<p>使用 <code>next()</code> 將新的陣列推入 <code>BehaviorSubject</code>。</p>
<blockquote>
<p>Q : 這種寫法不就本地 <code>store$</code> 不是最新資料 ?</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addPost(post: Post): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.httpClient</span><br><span class="line">    .post&lt;Post&gt;(<span class="string">'api/posts'</span>, post)</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.reloadPosts();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若你很在乎前端是否為最新資料，就下 <code>reloadPosts()</code> 重新 GET，當然執行效率會較差一點，依你實務上的需求決定。</p>
<p>26 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">reloadPosts(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.httpClient</span><br><span class="line">    .get&lt;Post[]&gt;(<span class="string">'api/posts'</span>)</span><br><span class="line">    .subscribe(posts =&gt; <span class="keyword">this</span>.store$.next(posts));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重新對 API 下 GET 抓資料，由於是最新的一份資料，馬上下 <code>$store.next()</code> 將資料寫進 <code>BehaviorSubject</code>。</p>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readonly posts$: Observable&lt;Post[]&gt; = <span class="keyword">this</span>.store$;</span><br></pre></td></tr></table></figure>
<p>已經都自己維護一份 <code>BehaviorSubject</code> 的 <code>store$</code>，我們希望當 <code>BehaviorSubject()</code> 使用 <code>next()</code> 改變資料時，能通知所有 <code>subscribe()</code> 的 component 都能自動更新，這也是我們使用 Observable Data Service 的初衷。</p>
<p>既然 <code>BehaviorSubject</code> 繼承於 <code>Observable</code>，理論上我們也可直接將 <code>$store</code> 設定為 <code>public</code>，直接被 component <code>subscribe()</code>，但因為 <code>BehaviorSubject()</code> 提供 <code>next()</code>，因此也可能被 component 誤用 <code>next()</code> 新增資料，因此我們改用真的 <code>Observable</code> 給 component 訂閱，並且宣告為 <code>readonly</code>，表示不能被 component 修改。</p>
<p>由於 <code>store$</code> 也是一種  <code>Observable</code>，基於 <code>里式替換原則</code> : <code>父類別可用子類別取代</code>，因此不需要轉型即可。</p>
<h3 id="AppModule">AppModule</h3><p><strong>app.module.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FormsModule &#125; from <span class="string">'@angular/forms'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpClientModule &#125; from <span class="string">'@angular/common/http'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AddPostComponent &#125; from <span class="string">'./component/add-post/add-post.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ListPostsComponent &#125; from <span class="string">'./component/list-posts/list-posts.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ShowCountComponent &#125; from <span class="string">'./component/show-count/show-count.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ReloadPostsComponent &#125; from <span class="string">'./component/reload-posts/reload-posts.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IAddPost &#125; from <span class="string">'./interface/iadd-post.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IListPosts &#125; from <span class="string">'./interface/ilist-posts.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IShowCount &#125; from <span class="string">'./interface/ishow-count.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IReloadPosts &#125; from <span class="string">'./interface/ireload-posts.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostService &#125; from <span class="string">'./service/post/post.service'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    AddPostComponent,</span><br><span class="line">    ListPostsComponent,</span><br><span class="line">    ShowCountComponent,</span><br><span class="line">    ReloadPostsComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule,</span><br><span class="line">    FormsModule,</span><br><span class="line">    HttpClientModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    PostService,</span><br><span class="line">    &#123;provide: IAddPost, useExisting: PostService&#125;,</span><br><span class="line">    &#123;provide: IListPosts, useExisting: PostService&#125;,</span><br><span class="line">    &#123;provide: IShowCount, useExisting: PostService&#125;,</span><br><span class="line">    &#123;provide: IReloadPosts, useExisting: PostService&#125;</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>由於我們 component 與 service 都是基於 <code>依賴反轉原則</code> 與 <code>介面隔離原則</code> 所設計，因此必須藉由 DI container 幫我們相對應的 service 注入。</p>
<p>29 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PostService,</span><br><span class="line">&#123;provide: IAddPost, useExisting: PostService&#125;,</span><br><span class="line">&#123;provide: IListPosts, useExisting: PostService&#125;,</span><br><span class="line">&#123;provide: IShowCount, useExisting: PostService&#125;,</span><br><span class="line">&#123;provide: IReloadPosts, useExisting: PostService&#125;</span><br></pre></td></tr></table></figure>
<p>一般我們使用普通 service 時，都是每個 component 注入新的 service，但使用 Observable Data Service 時不可如此，因為我們就是希望各 component 共用同一份資料，只要在 provider 使用 <code>useExisting</code>，Angular DI 就會以 Singleton 方式建立 service，各 component 才能共用一份 <code>store$</code>。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Observable Data Service 在實務上常常使用，只要各 component 間有資料共用，且會根據共用資料有不同互動，就可以使用，不侷限在資料來自於 API，也可以用在與 API 無關的資料</li>
<li>Observable Data Service 同時使用了 DI 與 RxJS，讓 component 與 service 解耦合，只要 service 的資料更新，所有 component 的資料也會隨之更新</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG51ObservableDataService" target="_blank" rel="external">GitHub</a> 上找到</p>
]]></content>
    <summary type="html">
    <![CDATA[RxJS 的 BehaviorSubject 為 Observable Data Service 的核心技術]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="RxJS" scheme="http://oomusou.io/tags/RxJS/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 Angular 存取 Web API ?]]></title>
    <link href="http://oomusou.io/angular/api/"/>
    <id>http://oomusou.io/angular/api/</id>
    <published>2017-12-24T12:23:43.000Z</published>
    <updated>2018-01-07T08:04:20.000Z</updated>
    <content type="html"><![CDATA[<p>前後端分離後，前端除了負責顯示邏輯外，最重要的就是與 API 溝通。在 JQuery 只要使用 <code>$.ajax()</code> 就可存取 API；但在 Angular，則必須透過 service 與 DI container ，component 才可存取 API，完全遵守 <code>依賴反轉原則</code>。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Node.js 8.9.0<br>Angular 5.1.0<br>JSON Server 0.12.1</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/angular/angular-json-schema/http000.png" alt="http000"></p>
<ul>
<li><code>Add Post</code> : 使用 <code>POST</code> 對 API 新增資料</li>
<li><code>Show All Posts</code> : 使用 <code>GET</code> 對 API 抓資料</li>
</ul>
<h2 id="Architecture">Architecture</h2><hr>
<p><img src="/images/angular/angular-json-schema/http001.svg" alt="http001"></p>
<ul>
<li><code>AppComponent</code> : 專門負責顯示邏輯</li>
<li><code>PostService</code> : 專門負責連接 API 與資料處理部份</li>
<li><code>IPostService</code> : 由 <code>AppComponent</code> 觀點所定義出的 interface</li>
<li><code>HttpClient</code> : Angular 4.3 所新增處理 AJAX 的 class</li>
</ul>
<blockquote>
<p>依賴反轉原則</p>
<p>高階模組不應該依賴低階模組；兩著都應該依賴高階模組所定義的 interface</p>
</blockquote>
<p><code>AppComponent</code> 不直接依賴 <code>PostService</code>，且 <code>AppComponent</code> 與  <code>PostService</code> 都反過來依賴 <code>AppComponent</code> 所定義的 <code>IPostService</code> interface。</p>
<h2 id="Implementation">Implementation</h2><hr>
<h3 id="JSON_Server">JSON Server</h3><p>前後端分離後，前後端所依據的就是 JSON 資料，傳統前端會在先 <code>var</code> 一個 JSON，等要連 API 時，再用 <code>$.ajax()</code> 去改變 JSON 資料，這樣雖然可行，但必須去修改 code。</p>
<p><img src="/images/angular/angular-json-schema/http020.svg" alt="http020"></p>
<p>比較好的方式是改用 JSON Server，讓我們實際去模擬 HTTP 的 GET/POST/PUT/PATCH 與 DELETE，只要透過 proxy，就會連上 JSON Server，若不透過 proxy，就連上 API Server，無論怎麼切換，都不用去修改 code。</p>
<h4 id="安裝_JSON_Server">安裝 JSON Server</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm <span class="operator"><span class="keyword">install</span> -<span class="keyword">g</span> <span class="keyword">json</span>-<span class="keyword">server</span></span></span><br></pre></td></tr></table></figure>
<p>將 JSON Server 安裝在 global 環境。</p>
<p><img src="/images/angular/angular-json-schema/http002.png" alt="http002"></p>
<h4 id="第一次啟動_JSON_Server">第一次啟動 JSON Server</h4><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ cd MyProject</span><br><span class="line">~/MyProject$ mkdir json-<span class="keyword">server</span></span><br><span class="line">~/MyProject$ cd json-<span class="keyword">server</span></span><br><span class="line">~/MyProject/json-<span class="keyword">server</span>$ json-<span class="keyword">server</span> db.json</span><br></pre></td></tr></table></figure>
<p><img src="/images/angular/angular-json-schema/http003.png" alt="http003"></p>
<ol>
<li>進入專案目錄</li>
<li>在專案目錄建立 <code>json-server</code> 子目錄</li>
<li>進入 <code>json-server</code> 子目錄</li>
<li>第一次啟動 JSON Server，指定 <code>db.json</code> 為資料庫檔案</li>
<li>JSON Server 預設會啟動在 <code>http://localhost:3000</code> ，並提供 <code>posts</code>、 <code>comments</code> 與 <code>profile</code> 3 個 table</li>
</ol>
<p><img src="/images/angular/angular-json-schema/http004.png" alt="http004"></p>
<ol>
<li>若 <code>db.json</code> 存在，則 JSON Server 會以此檔案為資料庫，若不存在，則會建立新的 <code>db.json</code> </li>
<li>預設會有 <code>posts</code>、<code>comments</code> 與 <code>profile</code> 3 個 table</li>
</ol>
<h4 id="測試_JSON_Server">測試 JSON Server</h4><p>預設 <code>db.json</code> 已經有資料，可藉此測試 JSONServer 是否有成功啟動。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">http:</span><span class="comment">//localhost:3000/posts</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/angular/angular-json-schema/http005.png" alt="http005"></p>
<p>使用 Postman 測試 GET </p>
<ol>
<li>選擇 <code>GET</code></li>
<li>輸入 <code>http://localhost:3000/posts</code></li>
<li>正確回傳 JSON</li>
</ol>
<p><img src="/images/angular/angular-json-schema/http006.png" alt="http006"></p>
<p>使用 Postman 測試 POST</p>
<ol>
<li>選擇 <code>POST</code></li>
<li>輸入 <code>http://localhost:3000/posts</code></li>
<li>選擇 <code>Headers</code></li>
<li>Key 為 <code>Content-Type</code>，value 為 <code>application/json</code></li>
</ol>
<p><img src="/images/angular/angular-json-schema/http007.png" alt="http007"></p>
<ol>
<li>選擇 <code>Body</code></li>
<li>選擇 <code>raw</code></li>
<li>選擇 <code>JSON (application/json)</code></li>
<li>輸入要新增的 JSON 資料</li>
</ol>
<blockquote>
<p>不用包含 <code>id</code>，JSON Server 會自動幫你新增</p>
</blockquote>
<p><img src="/images/angular/angular-json-schema/http008.png" alt="http008"></p>
<ol>
<li>選擇 <code>db.json</code></li>
<li>剛剛由 Postman 新增的資料會寫入 <code>db.json</code></li>
</ol>
<h4 id="建立_JSON_Server_Routes">建立 JSON Server Routes</h4><p>我們可以自行在 <code>db.json</code> 建立新的 table，但預設 URI 都會在 root，可能不適合使用 (一般都會放在 <code>/api</code> 下，如 <code>/api/posts</code>)，我們可自行加入 route 加以 mapping。</p>
<p><strong>json-server/routes.json</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">/api/posts</span>": <span class="value"><span class="string">"/posts"</span></span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>json-server</code> 目錄下新增 <code>routes.json</code>，將 <code>/api/posts</code> 對應到 JSON Server 的  <code>/posts</code>。<br><img src="/images/angular/angular-json-schema/http009.png" alt="http009"></p>
<ol>
<li>在 <code>json-server</code> 目錄下新增 <code>routes.json</code></li>
<li>將 <code>/api/routes</code> 對應到 JSON Server 的 <code>/posts</code></li>
</ol>
<h4 id="建立_Angular_CLI_Proxy">建立 Angular CLI Proxy</h4><p>Angular CLI 預設並不會使用 JSON Server，因此我們必須讓 Angular 會透過 proxy 去打 JSON Server。</p>
<p><strong>proxy.conf.json</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">/api</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">target</span>": <span class="value"><span class="string">"http://localhost:3000"</span></span>,</span><br><span class="line">    "<span class="attribute">secure</span>": <span class="value"><span class="literal">false</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>在專案根目錄下新增 <code>proxy.conf.json</code>，將 <code>/api</code> mapping 到 <code>http://localhost:3000</code>，也就是 JSON Server。</p>
<p><img src="/images/angular/angular-json-schema/http010.png" alt="http010"></p>
<ol>
<li>在專案根目錄下新增 <code>proxy.conf.json</code> </li>
<li>將 <code>/api</code> 對應到 JSON Server 的 <code>http://localhost:3000</code></li>
</ol>
<h4 id="由_npm_管理_JSON_Server_與_Proxy">由 npm 管理 JSON Server 與 Proxy</h4><p>由於每次都要啟動 JSON Server 與 proxy，且參數有點繁瑣，比較好的方式是統一由 npm 來管理。</p>
<p><strong>package.json</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "name": "ng5-http-client",</span><br><span class="line">  "version": "0.0.0",</span><br><span class="line">  "license": "MIT",</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    "ng": "ng",</span><br><span class="line">    "start": "ng serve",</span><br><span class="line">    "proxy": "ng serve --proxy-config proxy.conf.json",</span><br><span class="line">    "build": "ng build",</span><br><span class="line">    "test": "ng test",</span><br><span class="line">    "lint": "ng lint",</span><br><span class="line">    "e2e": "ng e2e",</span><br><span class="line">    "json-server": "json-server ./json-server/db.json --routes ./json-server/routes.json"</span><br><span class="line">  &#125;,</span><br><span class="line">  (略)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>13 行</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"json-server"</span>: <span class="string">"json-server ./json-server/db.json --routes ./json-server/routes.json"</span></span><br></pre></td></tr></table></figure>
<p>新增 <code>npm json-server</code>，除了指定使用 <code>db.json</code> 外，還會使用自訂 route。</p>
<p>第 8 行</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"proxy"</span>: <span class="string">"ng serve --proxy-config proxy.conf.json"</span>,</span><br></pre></td></tr></table></figure>
<p>原本 <code>npm start</code> 得以保留，此為不透過 proxy 方式，另外新增 <code>npm proxy</code>，將會透過 proxy 使用 JSON Server。</p>
<p><img src="/images/angular/angular-json-schema/http011.png" alt="http011"></p>
<ol>
<li>選擇 <code>package.json</code></li>
<li>新增 <code>proxy</code> 使 Angular CLI 透過 proxy 使用 JSON Server</li>
<li>新增 <code>json-server</code> 啟動 JSON Server</li>
</ol>
<p>每次要開發專案時 :</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject$ npm <span class="command">run</span> json-server</span><br></pre></td></tr></table></figure>
<p>先 <code>npm run json-server</code> 執行 JSON Server</p>
<p><img src="/images/angular/angular-json-schema/http012.png" alt="http012"></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject$ npm <span class="command">run</span> proxy</span><br></pre></td></tr></table></figure>
<p>再 <code>npm run proxy</code> 透過 proxy 使用 JSON Server</p>
<p><img src="/images/angular/angular-json-schema/http013.png" alt="http013"></p>
<blockquote>
<p>必須開兩個 terminal 分別執行 <code>npm run json-server</code> 與 <code>npm run proxy</code>，因為都必須同時在背景執行</p>
</blockquote>
<h3 id="JSON_Schema_to_TypeScript">JSON Schema to TypeScript</h3><p>後端會以 JSON Schema 定義 JSON 格式與型別，而 Angular 亦會使用 interface 定義 JSON 的型別提供檢查。</p>
<p>透過 <code>JSON Schema to TypeScript</code>，我們可以直接將 JSON Schema 轉成 TypeScript interface，可節省時間，也可避免 typo。</p>
<h4 id="安裝_JSON_Schema_to_TypeScript">安裝 JSON Schema to TypeScript</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g json-schema-to-typescript</span><br></pre></td></tr></table></figure>
<p>將 JSON schema to TypeScript 安裝在 global 環境。</p>
<h4 id="JSON_Schema">JSON Schema</h4><p><strong>post.schema.json</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">title</span>": <span class="value"><span class="string">"Post"</span></span>,</span><br><span class="line">  "<span class="attribute">type</span>": <span class="value"><span class="string">"object"</span></span>,</span><br><span class="line">  "<span class="attribute">properties</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">id</span>": <span class="value">&#123;</span><br><span class="line">      "<span class="attribute">type</span>": <span class="value"><span class="string">"number"</span></span><br><span class="line">    </span>&#125;</span>,</span><br><span class="line">    "<span class="attribute">title</span>": <span class="value">&#123;</span><br><span class="line">      "<span class="attribute">type</span>": <span class="value"><span class="string">"string"</span></span><br><span class="line">    </span>&#125;</span>,</span><br><span class="line">    "<span class="attribute">author</span>": <span class="value">&#123;</span><br><span class="line">      "<span class="attribute">type</span>": <span class="value"><span class="string">"string"</span></span><br><span class="line">    </span>&#125;</span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">additionalProperties</span>": <span class="value"><span class="literal">false</span></span>,</span><br><span class="line">  "<span class="attribute">required</span>": <span class="value">[<span class="string">"title"</span>, <span class="string">"author"</span>]</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>定義了 <code>id</code>、<code>title</code> 與 <code>author</code> 3 個欄位，其中 <code>title</code> 與 <code>author</code> 為必填。</p>
<h4 id="將_JSON_Schema_轉_TypeScript_Interface">將 JSON Schema 轉 TypeScript Interface</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject/src/app/model$ json2ts post<span class="class">.schema</span><span class="class">.json</span> post<span class="class">.model</span><span class="class">.ts</span></span><br></pre></td></tr></table></figure>
<p>目前將 <code>post.schema.json</code> 放在 <code>/src/app/model</code> 目錄下。</p>
<p>使用 <code>json2ts</code> 將 <code>post.schema.json</code> 轉成 <code>post.model.ts</code>。</p>
<p><img src="/images/angular/angular-json-schema/http014.png" alt="http014"></p>
<h4 id="TypeScript_Interface">TypeScript Interface</h4><p><strong>post.model.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * This file was automatically generated by json-schema-to-typescript.</span><br><span class="line"> * DO NOT MODIFY IT BY HAND. Instead, modify the source JSONSchema file,</span><br><span class="line"> * and run json-schema-to-typescript to regenerate this file.</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> Post </span>&#123;</span><br><span class="line">  id?: <span class="built_in">number</span>;</span><br><span class="line">  title: <span class="built_in">string</span>;</span><br><span class="line">  author: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由 <code>json2ts</code> 所轉出來的 TypeScript interface，最上面有 <code>json2ts</code> 所產生的註解。</p>
<blockquote>
<p>將然若有 JSON 欄位異動，請不要直接修改 TypeScript interface，而應該直接去修改 JSON Schema，再由 <code>json2ts</code> 產生 TypeScript interface</p>
</blockquote>
<p><img src="/images/angular/angular-json-schema/http015.png" alt="http015"></p>
<ol>
<li>由 <code>json2ts</code> 所產生的 <code>post.model.ts</code></li>
<li>由 <code>json2ts</code> 所產生的註解</li>
<li>由 <code>json2ts</code> 所轉出的 TypeScript interface</li>
</ol>
<h3 id="AppComponent">AppComponent</h3><p><img src="/images/angular/angular-json-schema/http017.svg" alt="http017"></p>
<p><strong>app.component.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> [(<span class="attribute">ngModel</span>)]=<span class="value">"title"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onClick()"</span>&gt;</span>Add Post<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">li</span> *<span class="attribute">ngFor</span>=<span class="value">"let post of posts"</span>&gt;</span></span><br><span class="line">    &#123;&#123; post.id&#125;&#125; &#123;&#123;post.title&#125;&#125; &#123;&#123;post.author&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>第 1 行</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> [(<span class="attribute">ngModel</span>)]=<span class="value">"title"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>title</code> 的輸入框，直接使用 <code>ngModel</code> 的 two way binding 到 <code>title</code> field。</p>
<p>第 2 行</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"onClick()"</span>&gt;</span>Add Post<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Button 的 <code>click</code> event 對應到 <code>AppComponent.onClick()</code>。</p>
<p>第 4 行</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">l</span> *<span class="attribute">ngFor</span>=<span class="value">"let post of posts"</span>&gt;</span></span><br><span class="line">    &#123;&#123; post.id&#125;&#125; &#123;&#123;post.title&#125;&#125; &#123;&#123;post.author&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用 <code>*ngFor</code> 將所有 <code>posts</code> 展開。</p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, OnInit &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IPostService &#125; from <span class="string">'./service/post/ipostservice.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Post &#125; from <span class="string">'./model/post.model'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  title: <span class="built_in">string</span>;</span><br><span class="line">  posts: Post[];</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private postService: IPostService) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.getAllPosts();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onClick() &#123;</span><br><span class="line">    <span class="keyword">const</span> post = &lt;Post&gt;&#123;</span><br><span class="line">      <span class="string">'title'</span> : <span class="keyword">this</span>.title,</span><br><span class="line">      <span class="string">'author'</span> : <span class="string">'Sam'</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.postService.addPost(post)</span><br><span class="line">      .subscribe(</span><br><span class="line">        value =&gt; <span class="built_in">console</span>.log(value),</span><br><span class="line">        error =&gt; <span class="built_in">console</span>.log(error),</span><br><span class="line">        () =&gt; <span class="built_in">console</span>.log(<span class="string">'PUT completed'</span>)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.getAllPosts();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> getAllPosts() &#123;</span><br><span class="line">    <span class="keyword">this</span>.postService.getAllPosts()</span><br><span class="line">      .subscribe(</span><br><span class="line">        value =&gt; <span class="keyword">this</span>.posts = value,</span><br><span class="line">        error =&gt; <span class="built_in">console</span>.log(error),</span><br><span class="line">        () =&gt; <span class="built_in">console</span>.log(<span class="string">'GET completed'</span>)</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">title: <span class="built_in">string</span>;</span><br><span class="line">posts: Post[];</span><br></pre></td></tr></table></figure>
<p>要與 HTML 做 data binding 的東西都會宣告在 public field。</p>
<ul>
<li><code>title</code> : 給 <code>&lt;input type=&quot;text&quot;&gt;</code> 做 two-way binding </li>
<li><code>posts</code> :  給 <code>*ngFor</code> 做 data binding</li>
</ul>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private postService: IPostService) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將 <code>PostService</code> 依賴注入，其型別為 <code>IPostService</code> interface。</p>
<blockquote>
<p>依賴反轉原則</p>
<p>高階模組不應該依賴低階模組；兩著都應該依賴高階模組所定義的 interface</p>
</blockquote>
<p>所以 <code>AppComponent</code> 不應該直接依賴 <code>PostService</code>，而應該依賴 <code>IPostService</code> interface，因此 <code>PostService</code> 的型別是 <code>IPostService</code>。</p>
<p>17 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.getAllPosts();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一載入時，希望能顯示所有 <code>Post</code> 。</p>
<p>37 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> getAllPosts() &#123;</span><br><span class="line">  <span class="keyword">this</span>.postService.getAllPosts()</span><br><span class="line">    .subscribe(</span><br><span class="line">      value =&gt; <span class="keyword">this</span>.posts = value,</span><br><span class="line">      error =&gt; <span class="built_in">console</span>.log(error),</span><br><span class="line">      () =&gt; <span class="built_in">console</span>.log(<span class="string">'GET completed'</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>ngOnInit()</code> 與 <code>onClick()</code> 都會呼叫 <code>PostService.getAllPosts()</code>，基於 <code>DRY 原則</code>，將共用抽到 <code>getAllPosts()</code>。</p>
<p>因為呼叫 <code>PostService</code> 的 <code>getAllPosts()</code>，也因此期望 <code>IPostService</code> interface 有 <code>getAllPosts()</code>。</p>
<p><code>PostService.getAllPost()</code> 回傳為 <code>Observable</code>，因此要使用 <code>subscribe()</code> 訂閱 <code>Observable</code>。</p>
<p><code>subscribe()</code> 共有 3 個參數 :</p>
<ul>
<li><strong>next</strong> : 當 service 的非同步執行完後，<code>下一個</code> 要執行的動作，<code>value</code> 會傳回 <code>Post[]</code>，因此可直接指定給 <code>this.posts</code></li>
<li><strong>error</strong> : 當 <code>HttpClient</code> 執行錯誤時所執行的 arrow function</li>
<li><strong>complete</strong> : 當 <code>HttpClient</code> 執行完成時所執行的 arrow function</li>
</ul>
<p>21 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">onClick() &#123;</span><br><span class="line">  <span class="keyword">const</span> post = &lt;Post&gt;&#123;</span><br><span class="line">    <span class="string">'title'</span> : <span class="keyword">this</span>.title,</span><br><span class="line">    <span class="string">'author'</span> : <span class="string">'Sam'</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.postService.addPost(post)</span><br><span class="line">    .subscribe(</span><br><span class="line">      value =&gt; <span class="built_in">console</span>.log(value),</span><br><span class="line">      error =&gt; <span class="built_in">console</span>.log(error),</span><br><span class="line">      () =&gt; <span class="built_in">console</span>.log(<span class="string">'PUT completed'</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.getAllPosts();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新增 <code>Post</code> 到資料庫。</p>
<p>因為呼叫 <code>PostService</code> 的 <code>addPost()</code>，傳入 <code>Post</code> model，也因此希望 <code>IPostService</code> interface 有  <code>addPost()</code>。</p>
<p><code>PostService.addPost()</code> 也是回傳 <code>Observable</code>，因此要使用 <code>subscribe()</code> 訂閱 <code>Observable</code>。</p>
<h3 id="IPostService">IPostService</h3><p><img src="/images/angular/angular-json-schema/http018.svg" alt="http018"></p>
<p><strong>ipostservice.interface.ts</strong><br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Post &#125; from <span class="string">'../../model/post.model'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> IPostService &#123;</span><br><span class="line">  abstract addPost(post: Post): Observable&lt;Post&gt;;</span><br><span class="line">  abstract getAllPosts(): Observable&lt;Post[]&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根據 <code>AppComponent</code> 的需求，我們希望 <code>IPostService</code> 有 <code>addPost()</code> 與 <code>getAllPosts()</code> 兩個 method。</p>
<p><code>IPostService</code> 觀念上是 interface，所以理想上應該這樣寫 :</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> IPostService </span>&#123;</span><br><span class="line">  addPost(post: Post): Observable&lt;Post&gt;;</span><br><span class="line">  getAllPosts(): Observable&lt;Post[]&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但若實際這樣寫，TypeScript 編譯沒問題，但 <code>ng serve</code> 時會執行錯誤。</p>
<p><img src="/images/angular/angular-json-schema/http016.png" alt="http016"></p>
<p>主要在於 interface 是 TypeScript 所擴充，在編譯成 JavaScript 後並沒有 interface，導致 DI container 在執行時找不到 interface 而造成 run-time 錯誤。</p>
<p>也就是說 interface 在 TypeScript 主要是用來 <code>編譯檢查</code>。</p>
<p><code>抽象</code> 除了使用 interface 實現外，也可以使用 <code>abstract class</code>，在 ES6 有 <code>abstract class</code>，在 ES5 也有相對應的解法，所以目前必須改用 <code>abstract class</code> 取代 <code>interface</code> 實現 <code>抽象</code>。</p>
<blockquote>
<p>在 Angular 的 DI container，觀念上是 interface，但實作上須與 JavaScript 妥協，改用 <code>abstract class</code> 實踐 <code>interface</code>。</p>
</blockquote>
<h3 id="PostService">PostService</h3><p><img src="/images/angular/angular-json-schema/http019.svg" alt="http019"></p>
<p><strong>post.service.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IPostService &#125; from <span class="string">'./ipostservice.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Post &#125; from <span class="string">'../../model/post.model'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpClient &#125; from <span class="string">'@angular/common/http'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> PostService <span class="keyword">implements</span> IPostService &#123;</span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private httpClient: HttpClient) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">  addPost(post: Post): Observable&lt;Post&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.httpClient</span><br><span class="line">      .post&lt;Post&gt;(<span class="string">'api/posts'</span>, post);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getAllPosts(): Observable&lt;Post[]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.httpClient</span><br><span class="line">      .get&lt;Post[]&gt;(<span class="string">'api/posts'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 7 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Injectable()</span><br></pre></td></tr></table></figure>
<p>因為加了 <code>@Injectable()</code> decorator，所以 <code>PostService</code> 可以透過 DI container 依賴注入。</p>
<blockquote>
<p>並不是所有的 class 都可以由 DI container 依賴注入，必須要加上 <code>@Injectable</code> decorator 的 class 才可以</p>
</blockquote>
<p>第 8 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> PostService <span class="keyword">implements</span> IPostService &#123;</span><br></pre></td></tr></table></figure>
<p>因為 <code>依賴反轉原則</code>，<code>PostService</code> 必須實作 <code>IPostService</code> interface。</p>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private httpClient: HttpClient) </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>因為要使用 <code>HttpClient</code>，將 <code>HttpClient</code> 注入到 <code>PostService</code>。</p>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">addPost(post: Post): Observable&lt;Post&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.httpClient</span><br><span class="line">    .post&lt;Post&gt;(<span class="string">'api/posts'</span>, post);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>HttpClient.post&lt;T&gt;()</code> 執行 POST，將 <code>Post</code> model 傳入，其中 <code>&lt;T&gt;</code> 傳入 <code>Post</code> model 的型別 <code>Post</code>。</p>
<p><code>HttpClient.post&lt;T&gt;()</code> 回傳的型別為 <code>Observable</code>，其本質為 <code>Post</code> model，會將傳進來的 <code>Post</code> 再傳回 <code>Observable&lt;Post&gt;</code>。</p>
<p>由於 <code>subscribe()</code> 最後要由 component 決定，因此將 <code>Observale</code> 回傳給 component 去 <code>subscribe()</code>。</p>
<blockquote>
<p>由於在 <code>addPost()</code> 並沒有 <code>subscribe()</code>，因此 <code>addPost()</code> 目前為止還沒有真的執行 POST</p>
</blockquote>
<p>16 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getAllPosts(): Observable&lt;Post[]&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.httpClient</span><br><span class="line">    .get&lt;Post[]&gt;(<span class="string">'api/posts'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>HttpClient.get&lt;T&gt;()</code> 執行 GET，其中 <code>&lt;T&gt;</code> 為回傳的 <code>Post[]</code> 型別。</p>
<p><code>HttpClient.get&lt;T&gt;()</code> 回傳的型別為 <code>Observable</code>，其本質為 <code>Post[]</code>。</p>
<p>由於 <code>subscribe()</code> 最後要由 component 決定，因此將 <code>Observale</code> 回傳給 component 去 <code>subscribe()</code>。</p>
<blockquote>
<p>由於在 <code>getAllPosts()</code> 並沒有 <code>subscribe()</code>，因此 <code>getAllPosts()</code> 目前為止還沒有真的執行 GET</p>
</blockquote>
<p>在 Angular 2 所提供的 <code>Http</code>，至今仍可用，但用法較麻煩 :<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.http.get(<span class="string">'api/posts'</span>)</span><br><span class="line">  .map(response =&gt; response.json());</span><br></pre></td></tr></table></figure></p>
<p>Angular 4.3 的 <code>HttpClient</code> 改用泛型後，除了在 <code>get()</code> 與  <code>post()</code> 都可以明顯看到型別，語意較佳，且寫法也教精簡，不用再透過 <code>map()</code> 去轉成 JSON。</p>
<blockquote>
<p>實務上建議改用 <code>HttpClient</code>，不要再使用 <code>Http</code></p>
</blockquote>
<h3 id="AppModule">AppModule</h3><p><strong>app.module.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IPostService &#125; from <span class="string">'./service/post/ipostservice.interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostService &#125; from <span class="string">'./service/post/post.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpClientModule &#125; from <span class="string">'@angular/common/http'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FormsModule &#125; from <span class="string">'@angular/forms'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule,</span><br><span class="line">    HttpClientModule,</span><br><span class="line">    FormsModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    &#123;provide: IPostService, useClass: PostService&#125;</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">imports: [</span><br><span class="line">  BrowserModule,</span><br><span class="line">  HttpClientModule,</span><br><span class="line">  FormsModule</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<ul>
<li><code>HttpClient</code> 須使用 <code>HttpClientModule</code></li>
<li><code>[(ngModel)]</code> 須使用 <code>FormsModule</code></li>
</ul>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  &#123;provide: IPostService, useClass: PostService&#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>DI container 一定要提供 interface 與 class 的 mapping。</p>
<p>在 <code>providers</code> 後為 object array，每一個 object  為 interface 與 class 的 mapping。</p>
<ul>
<li><strong>provide</strong> : interface 名稱</li>
<li><strong>useClass</strong> : class 名稱</li>
</ul>
<h2 id="為什麼要使用_Service?">為什麼要使用 Service?</h2><hr>
<p>或許你會認為，明明使用  <code>$.ajax()</code> 向後端 API 抓資料是很單純的事情，為什麼 Angular 還要大費周章透過 Service + DI container，而不是提供一個簡單的 function 就好了嗎？有幾個原因：</p>
<ul>
<li>將來若其他 component 要使用 API 時，將 service 直接 DI 進 compoent 即可</li>
<li>將來若要對 API 的 service 做抽換，可直接透過 DI 換掉即可</li>
<li>將來若要對 component 做單元測試，可輕易的 <code>spyOn</code> API service 即可</li>
</ul>
<blockquote>
<p>簡單的說，將 API 部分獨立成 service，目的要使 component 與 API <code>解耦合</code>，且讓 component 不直接相依於 service，兩者僅相依於 component 所定義的 interface，符合 <code>依賴反轉原則</code></p>
</blockquote>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li><strong>JSON Server</strong> : 讓我們在開發階段模擬真實的 API server</li>
<li><strong>JSON Schema to TypeScript</strong> : 將 JSON Schema 轉成 TypeScript interface，更有效率也避免 typo</li>
<li><strong>HttpClient</strong> : 語意更佳，也更簡單的寫法存取 API</li>
<li><strong>Angular DI Container</strong> : Angular 實現 <code>依賴反傳</code> 與 <code>依賴注入</code> 的解決方案</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG5HttpClient" target="_blank" rel="external">GitHub</a> 上找到。</p>
]]></content>
    <summary type="html">
    <![CDATA[使用 JSON Server + JSON2TS + HttpClient + Service + DI Container 存取 Web API]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何在 .NET Core Web API 使用 DI ?]]></title>
    <link href="http://oomusou.io/netcore/netcore-webapi-di/"/>
    <id>http://oomusou.io/netcore/netcore-webapi-di/</id>
    <published>2017-12-02T12:23:43.000Z</published>
    <updated>2017-12-03T03:20:39.000Z</updated>
    <content type="html"><![CDATA[<p>.NET Core 已經內建 DI，讓我們可以享受 DI container 實現 <code>依賴注入</code> 的方便，Visual Studio 2017 在 ASP.NET Core Web Application 的 template 中，預設已經可直接使用 DI，不需另外設定。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Visual Studio 2017 15.4.5<br>.NET Core 2.0<br>Microsoft.Extensions.DependencyInjection 2.0.0</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/netcore/netcore-webapi-di/di012.svg" alt="di012"></p>
<p>一個常見的分層架構，除了 <code>OrderController</code> 外，常見我們還會依 <code>職責</code> 拆分 <code>OrderService</code> 與 <code>PaymentService</code> … 等。</p>
<p><code>OrderController.Index()</code> 呼叫 <code>OrderService.CreateOrder()</code>，然後 <code>OrderService.CreateOrder()</code> 再去呼叫 <code>PaymentService.PayCreditCard()</code>。</p>
<p>傳統我們會這樣寫 code :</p>
<p><strong>OrderController.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">OrderController</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> OrderService orderService;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">OrderController</span>(<span class="params"></span>)</span><br><span class="line">  </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.orderService = <span class="keyword">new</span> OrderService();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Index</span>(<span class="params"></span>)</span><br><span class="line">  </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.orderService.CreateOrder();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>OrderService.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> PaymentService paymentService;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderService</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.paymentService = <span class="keyword">new</span> PaymentService();      </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateOrder</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.paymentService.payCreditCard();      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>PaymentService.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">PaymentService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PayCreditCard</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這是傳統 OOP 寫法，但這有幾個問題 :</p>
<ul>
<li><code>PaymentService</code> 直接被 <code>OrderService</code> <code>new</code> 在裡面，因此 <code>OrderController</code> 只要用了 <code>OrderService</code> 就必須得用 <code>PaymentService</code>，完全沒有改變 <code>PaymentService</code> 的空間，也就是 <code>OrderController</code> 直接耦合 <code>PaymentService</code> ，無法替換 <code>PaymentService</code></li>
<li>無法對 <code>OrderService</code> 做單元測試，因為 <code>PaymentService</code> 直接 <code>new</code> 在 <code>OrderService</code> 內，無法對 <code>PaymentService</code> 做 mock</li>
</ul>
<blockquote>
<p>這就是典型的 <code>耦合</code>，也就是 高階模組 直接相依於低階模組，然後高階模組就被低階模組綁死了，無法抽換，也無法單元測試。</p>
</blockquote>
<h2 id="Task">Task</h2><hr>
<p>目前 <code>OrderController</code> 與 <code>PaymentService</code> 直接偶合在一起，也就是用戶端只要用了 <code>OrderController</code>，就一定得使用 <code>PaymentService</code>，別無選擇。</p>
<p>現在用戶端希望使用 <code>OrderController</code> 時，還能決定 <code>OrderController</code> 的相依物件，不見的一定要 <code>PaymentService</code>，完全由用戶端決定，也就是對用戶端與 <code>PaymentService</code> 解耦合。</p>
<h2 id="Architecture">Architecture</h2><hr>
<p><img src="/images/netcore/netcore-webapi-di/di000.svg" alt="di000"></p>
<p><code>OrderController</code>、<code>OrderService</code> 與 <code>PaymentService</code> 已經符合 <code>依賴反轉原則</code>，也使用了 <code>依賴注入</code>，但要如何設定 <code>依賴注入容器</code> 呢 ?</p>
<h2 id="Implementation">Implementation</h2><hr>
<h3 id="IPaymentService">IPaymentService</h3><p><img src="/images/netcore/netcore-webapi-di/di001.svg" alt="di001"></p>
<p><strong>IPayment.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPaymentService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">string</span> <span class="title">PayCreditCard</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>OrderService</code> 為 <code>PaymentService</code> 的高階模組，由 <code>OrderService</code> 定義出 <code>IPaymentService</code>，由 <code>PaymentService</code> 所依賴。</p>
<h3 id="PaymentService">PaymentService</h3><p><img src="/images/netcore/netcore-webapi-di/di002.svg" alt="di002"></p>
<p><strong>PaymentService.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PaymentService</span> : <span class="title">IPaymentService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">PayCreditCard</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"PaymentService.PayCreditCard()"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>低階模組 <code>PaymentService</code> 實現 (依賴) <code>IPaymentService</code>。</p>
<h3 id="IOrderService">IOrderService</h3><p><img src="/images/netcore/netcore-webapi-di/di003.svg" alt="di003"></p>
<p><strong>IOrderService.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IOrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">string</span> <span class="title">CreateOrder</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>OrderController</code> 為 <code>OrderService</code> 的高階模組，由 <code>OrderController</code> 定義出 <code>IOrderService</code>，由 <code>OrderService</code> 所依賴。</p>
<h3 id="OrderService">OrderService</h3><p><img src="/images/netcore/netcore-webapi-di/di004.svg" alt="di004"></p>
<p><strong>OrderService.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderService</span> : <span class="title">IOrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IPaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderService</span>(<span class="params">IPaymentService paymentService</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.paymentService = paymentService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">CreateOrder</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.paymentService.PayCreditCard();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>低階模組 <code>OrderService</code> 實現 (依賴) <code>IOrderService</code>。</p>
<p>第 3 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> IPaymentService paymentService;</span><br></pre></td></tr></table></figure>
<p>我們宣告了 <code>IPaymentService</code> 型別的 field，注意此為抽象型別 interface，而非具體型別，所以 <code>OrderService</code> 不會直接依賴 <code>PaymentService</code>，而是依賴 <code>IPaymentService</code>，符合 <code>依賴反轉原則</code> : <code>高階模組不直接依賴低階模組，而是依賴抽象</code>。</p>
<p>第 5 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OrderService</span>(<span class="params">IPaymentService paymentService</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.paymentService = paymentService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PaymentService</code> 由 constructor 的參數傳進來，而不是直接 <code>new</code> 在 constructor 內。</p>
<p>如此 <code>OrderService</code> 的相依物件，就可透過 constructor 傳進來，從此高階模組 <code>OrderService</code> 就不再直接相依於低階模組 <code>PaymentService</code>，而是由更高階模組 <code>OrderController</code> 決定 <code>OrderService</code> 該依賴什麼物件，再由 constructor 參數傳進來，這就是 <code>依賴注入</code>。</p>
<p>注意 constructor 參數的型別是 <code>IPaymentService</code>，而不是 <code>PaymentService</code>，如此才會符合 <code>依賴反轉原則</code> : <code>高階模組不直接依賴低階模組，而是依賴抽象</code>。</p>
<p>我們改用 <code>依賴注入</code> 後有幾個優點 :</p>
<ul>
<li>由原本相依於 <code>PaymentService</code>，改相依於 <code>IPaymentService</code> interface，符合 <code>依賴反轉原則</code></li>
<li>原本直接在 constructor 去 <code>new</code>，高階模組無法抽換低階模組，現在高階模組可透過 constructor 直接換掉低階模組，原來的 <code>OrderService</code> 程式碼不用變動，符合 <code>開放封閉原則</code></li>
<li>單元測試時，可直接透過 constructor 注入 mock 物件隔離測試</li>
</ul>
<blockquote>
<p>OOP 心法</p>
<p>若使用 DI 寫法，則不須再使用 <code>new</code>，讓程式碼更為乾淨，類似 static class 只要一行程式碼就可解決</p>
</blockquote>
<p>10 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">CreateOrder</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.paymentService.PayCreditCard();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由 <code>CreateOrder()</code> 去呼叫 <code>PaymentService.PayCreditCard()</code>，其中也因為要呼叫 <code>PaymentService</code> 的 <code>PayCreditCard()</code>，根據 <code>界面隔離原則</code>，因此 <code>IPaymentService</code> 有 <code>PayCreditCard()</code>。</p>
<h3 id="OrderController">OrderController</h3><p><img src="/images/netcore/netcore-webapi-di/di005.svg" alt="di005"></p>
<p><strong>OrderController.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> NETCoreAPIDI.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NETCoreAPIDI.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [Route(<span class="string">"api/[controller]"</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IOrderService orderService;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OrderController</span>(<span class="params">IOrderService orderService</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.orderService = orderService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// GET api/order</span></span><br><span class="line">        [HttpGet]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Get</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.orderService.CreateOrder();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>13 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> IOrderService orderService;</span><br></pre></td></tr></table></figure>
<p>我們宣告了 <code>IOrderService</code> 型別的 field，注意此為抽象型別 interface，而非具體型別，所以 <code>OrderController</code> 不會直接依賴 <code>OrderService</code>，而是依賴 <code>IOrderService</code>，符合 <code>依賴反轉原則</code> : <code>高階模組不直接依賴低階模組，而是依賴抽象</code>。</p>
<p>15 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OrderController</span>(<span class="params">IOrderService orderService</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.orderService = orderService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>OrderService</code> 由 constructor 的參數傳進來，而不是直接 <code>new</code> 在 constructor 內。</p>
<p>如此 <code>OrderController</code> 的相依物件，就可透過 constructor 傳進來，從此高階模組 <code>OrderController</code> 就不再直接相依於低階模組 <code>OrderService</code>，而是由更高階模組決定 <code>OrderController</code> 該依賴什麼物件，再由 constructor 參數傳進來，這就是 <code>依賴注入</code>。</p>
<p>注意 constructor 參數的型別是 <code>IOrderService</code>，而不是 <code>OrderService</code>，如此才會符合 <code>依賴反轉原則</code> : <code>高階模組不直接依賴低階模組，而是依賴抽象</code>。</p>
<p>20 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET api/order</span></span><br><span class="line">[HttpGet]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Get</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.orderService.CreateOrder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>當 <code>GET</code> 時，執行 <code>OrderService.CreateOrder()</code>。</p>
<h3 id="Startup">Startup</h3><p><strong>Startup.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Builder;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Options;</span><br><span class="line"><span class="keyword">using</span> NETCoreAPIDI.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NETCoreAPIDI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params">IConfiguration configuration</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            Configuration = configuration;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> IConfiguration Configuration &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to add services to the container.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            services.AddMvc();</span><br><span class="line">            services.AddTransient&lt;IOrderService, OrderService&gt;();</span><br><span class="line">            services.AddTransient&lt;IPaymentService, PaymentService&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">            &#123;</span><br><span class="line">                app.UseDeveloperExceptionPage();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            app.UseMvc();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 console app 時，若我們要使用 DI，還要自己建立 <code>ServiceCollection</code> 與 <code>ServiceProvider</code>，但在 ASP.NET Core，我們有更簡單的方法。</p>
<p>25 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    services.AddMvc();</span><br><span class="line">    services.AddTransient&lt;IOrderService, OrderService&gt;();</span><br><span class="line">    services.AddTransient&lt;IPaymentService, PaymentService&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 ASP.NET Core 要設定 DI 很簡單，不用自己建立 <code>ServiceCollection</code> 與 <code>ServiceProvider</code>，只要在 <code>ConfigureServices()</code> 下使用 <code>AddTrasient()</code> 建立 interface 與 class 的 mapping 即可。</p>
<ul>
<li><code>AddTrasient()</code> : 每次注入時，都重新 <code>new</code> 一個新的 instance</li>
<li><code>AddScoped()</code> : 每個 request 都重新 <code>new</code> 一個新的instance</li>
<li><code>AddSingleton()</code> : 程式啟動後會 <code>new</code> 一個 instance，之後會重複使用，也就是運行期間只有一個 instance</li>
</ul>
<p>泛型參數部份 :</p>
<ul>
<li>若只有 class，沒有 interface，如 <code>OrderController</code> :<ul>
<li>只須傳入第一個參數為 class</li>
</ul>
</li>
<li>若有 interface 與對應 class<ul>
<li>第一個參數為 interface</li>
<li>第二個參數為 class</li>
</ul>
</li>
</ul>
<p>也就是告訴 <code>ServiceCollection</code>，當 constructor 的型別為此 interface 時，請幫我 new 這個 class。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static IServiceCollection AddTransient&lt;TService, TImplementation&gt;(this IServiceCollection services)</span><br><span class="line">        where TService : class</span><br><span class="line">        where TImplementation : class, TService;</span><br></pre></td></tr></table></figure>
<p>其中 <code>TImplementation</code> 的 constraint 為 <code>TService</code>，也就是若你這樣寫</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">services.AddTransient&lt;IPaymentService, OrderService&gt;();</span><br></pre></td></tr></table></figure>
<p>因為 <code>OrderService</code> 根本沒有實作  <code>IPaymentService</code>，編譯會錯誤。</p>
<blockquote>
<p>OOP 心法</p>
<p>在使用泛型時，一定要搭配 constraint，才會發揮泛型的威力</p>
</blockquote>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>ASP.NET Core 已經將 DI container 準備好，可直接使用</li>
<li>DI 可以讓程式碼更乾淨，用起來類似 static 只要一行</li>
<li>DI container 讓 <code>依賴注入</code> 更容易實現，尤其在用戶端可以完全掌握 <code>低階模組</code> 的相依物件，完全符合 <code>依賴反轉原則</code></li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NETCoreAPIDI" target="_blank" rel="external">GitHub</a> 找到。</p>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://blog.johnwu.cc/" target="_blank" rel="external">John Wu</a>, <a href="https://blog.johnwu.cc/article/asp-net-core-dependency-injection.html" target="_blank" rel="external">ASP.NET Core 教學 - Dependency Injection</a><br><a href="https://www.microsoft.com/en-us/" target="_blank" rel="external">Microsoft</a>, <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection" target="_blank" rel="external">Introduction to Dependency Injection in ASP.NET Core</a><br><a href="https://joonasw.net/" target="_blank" rel="external">Joonas W</a>, <a href="https://joonasw.net/view/aspnet-core-di-deep-dive" target="_blank" rel="external">ASP.NET Core Dependency Injection Deep Dive</a><br><a href="http://asp.net-hacker.rocks/" target="_blank" rel="external">ASP.NET Hacker</a>, <a href="http://asp.net-hacker.rocks/2017/02/08/using-dependency-injection-in-dotnet-core-console-apps.html" target="_blank" rel="external">Using Dependency Injection in .NET Core Console Apps</a></p>
]]></content>
    <summary type="html">
    <![CDATA[在 ASP.NET Core 也能優雅地使用 DI]]>
    
    </summary>
    
      <category term=".NET Core" scheme="http://oomusou.io/tags/NET-Core/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何在 .NET Core 使用 DI ?]]></title>
    <link href="http://oomusou.io/netcore/netcore-di/"/>
    <id>http://oomusou.io/netcore/netcore-di/</id>
    <published>2017-11-29T12:23:43.000Z</published>
    <updated>2017-12-03T03:11:06.000Z</updated>
    <content type="html"><![CDATA[<p>.NET Core 已經內建 DI，讓我們可以享受 DI container 實現 <code>依賴注入</code> 的方便，Visual Studio 2017 在 ASP.NET Core Web Application 的 template 中，預設已經可直接使用 DI，若要在 console app 也使用 DI，則需另外設定。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Visual Studio 2017 15.4.5<br>.NET Core 2.0<br>Microsoft.Extensions.DependencyInjection 2.0.0</p>
<h2 id="User_Story">User Story</h2><hr>
<p><img src="/images/netcore/netcore-di/di012.svg" alt="di012"></p>
<p>一個常見的分層架構，除了 <code>OrderController</code> 外，常見我們還會依 <code>職責</code> 拆分 <code>OrderService</code> 與 <code>PaymentService</code> … 等。</p>
<p><code>OrderController.Index()</code> 呼叫 <code>OrderService.CreateOrder()</code>，然後 <code>OrderService.CreateOrder()</code> 再去呼叫 <code>PaymentService.PayCreditCard()</code>。</p>
<p>傳統我們會這樣寫 code :</p>
<p><strong>OrderController.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">OrderController</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> OrderService orderService;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">OrderController</span>(<span class="params"></span>)</span><br><span class="line">  </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.orderService = <span class="keyword">new</span> OrderService();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Index</span>(<span class="params"></span>)</span><br><span class="line">  </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.orderService.CreateOrder();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>OrderService.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> PaymentService paymentService;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderService</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.paymentService = <span class="keyword">new</span> PaymentService();      </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateOrder</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.paymentService.payCreditCard();      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>PaymentService.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">PaymentService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PayCreditCard</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這是傳統 OOP 寫法，但這有幾個問題 :</p>
<ul>
<li><code>PaymentService</code> 直接被 <code>OrderService</code> <code>new</code> 在裡面，因此 <code>OrderController</code> 只要用了 <code>OrderService</code> 就必須得用 <code>PaymentService</code>，完全沒有改變 <code>PaymentService</code> 的空間，也就是 <code>OrderController</code> 直接耦合 <code>PaymentService</code> ，無法替換 <code>PaymentService</code></li>
<li>無法對 <code>OrderService</code> 做單元測試，因為 <code>PaymentService</code> 直接 <code>new</code> 在 <code>OrderService</code> 內，無法對 <code>PaymentService</code> 做 mock</li>
</ul>
<blockquote>
<p>這就是典型的 <code>耦合</code>，也就是 高階模組 直接相依於低階模組，然後高階模組就被低階模組綁死了，無法抽換，也無法單元測試。</p>
</blockquote>
<h2 id="Task">Task</h2><hr>
<p>目前 <code>OrderController</code> 與 <code>PaymentService</code> 直接偶合在一起，也就是用戶端只要用了 <code>OrderController</code>，就一定得使用 <code>PaymentService</code>，別無選擇。</p>
<p>現在用戶端希望使用 <code>OrderController</code> 時，還能決定 <code>OrderController</code> 的相依物件，不見的一定要 <code>PaymentService</code>，完全由用戶端決定，也就是對用戶端與 <code>PaymentService</code> 解耦合。</p>
<h2 id="Architecture">Architecture</h2><hr>
<p><img src="/images/netcore/netcore-di/di005.svg" alt="di005"></p>
<p><code>OrderController</code>、<code>OrderService</code> 與 <code>PaymentService</code> 已經符合 <code>依賴反轉原則</code>，也使用了 <code>依賴注入</code>，但用戶端要注入相依物件還是很複雜，因此要使用 <code>依賴注入容器</code> 簡化 <code>依賴注入</code>。</p>
<h2 id="Implementation">Implementation</h2><hr>
<h3 id="安裝_DependencyInjnection_套件">安裝 DependencyInjnection 套件</h3><p>DI 主要是在 <code>Microsoft.Extensions.DependencyInjection</code> 套件裡，console app 預設沒有安裝，需要手動自行安裝。</p>
<h4 id="GUI_安裝">GUI 安裝</h4><p><img src="/images/netcore/netcore-di/di000.png" alt="di000"></p>
<ol>
<li>在 project 選擇 <code>Dependencies</code></li>
<li>按滑鼠右鍵選擇 <code>Manage NuGet Packages...</code></li>
</ol>
<p><img src="/images/netcore/netcore-di/di001.png" alt="di001"></p>
<ol>
<li>選擇 <code>Browse</code></li>
<li>輸入 <code>DependencyInjection</code></li>
<li>選擇 <code>Microsoft.Extensions.DependencyInjection</code> 套件</li>
<li>按 <code>Install</code> 安裝套件</li>
</ol>
<p><img src="/images/netcore/netcore-di/di002.png" alt="di002"></p>
<p>安裝完成後，在 <code>Dependencies</code> 下的 <code>NuGet</code> 會看到 <code>Microsoft.Extensions.DependencyInjection</code> 套件。</p>
<h4 id="指令安裝">指令安裝</h4><p><img src="/images/netcore/netcore-di/di003.png" alt="di003"></p>
<p><strong><em>Tools -&gt; NuGet Package Manager -&gt; Package Manager Console</em></strong></p>
<p>啟動 package manager console</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PM&gt; Install-Package Microsoft<span class="class">.Extensions</span><span class="class">.DependencyInjection</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/netcore/netcore-di/di004.png" alt="di004"></p>
<p>使用 <code>Install-Package</code> 指令安裝 <code>Microsoft.Extensions.DependencyInjection</code> 套件。</p>
<p><img src="/images/netcore/netcore-di/di002.png" alt="di002"></p>
<p>安裝完成後，在 <code>Dependencies</code> 下的 <code>NuGet</code> 會看到 <code>Microsoft.Extensions.DependencyInjection</code> 套件。</p>
<h3 id="IPaymentService">IPaymentService</h3><p><img src="/images/netcore/netcore-di/di009.svg" alt="di009"></p>
<p><strong>IPaymentService.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title">IPaymentService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">PayCreditCard</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>OrderService</code> 為 <code>PaymentService</code> 的高階模組，由 <code>OrderService</code> 定義出 <code>IPaymentService</code>，由 <code>PaymentService</code> 所依賴。</p>
<h3 id="PaymentService">PaymentService</h3><p><img src="/images/netcore/netcore-di/di006.svg" alt="di006"></p>
<p><strong>PaymentService.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">PaymentService</span> : <span class="title">IPaymentService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PayCreditCard</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        Console.WriteLine(<span class="string">"PaymentService.PayCreditCard()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>低階模組 <code>PaymentService</code> 實現 (依賴) <code>IPaymentService</code>。</p>
<h3 id="IOrderService">IOrderService</h3><p><img src="/images/netcore/netcore-di/di010.svg" alt="di010"></p>
<p><strong>IOrderService.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title">IOrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">CreateOrder</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>OrderController</code> 為 <code>OrderService</code> 的高階模組，由 <code>OrderController</code> 定義出 <code>IOrderService</code>，由 <code>OrderService</code> 所依賴。</p>
<h3 id="OrderService">OrderService</h3><p><img src="/images/netcore/netcore-di/di007.svg" alt="di007"></p>
<p><strong>OrderService.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">OrderService</span>: <span class="title">IOrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IPaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderService</span>(<span class="params">IPaymentService paymentService</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.paymentService = paymentService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateOrder</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.paymentService.PayCreditCard();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>低階模組 <code>OrderService</code> 實現 (依賴) <code>IOrderService</code>。</p>
<p>第 3 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> IPaymentService paymentService;</span><br></pre></td></tr></table></figure>
<p>我們宣告了 <code>IPaymentService</code> 型別的 field，注意此為抽象型別 interface，而非具體型別，所以 <code>OrderService</code> 不會直接依賴 <code>PaymentService</code>，而是依賴 <code>IPaymentService</code>，符合 <code>依賴反轉原則</code> : <code>高階模組不直接依賴低階模組，而是依賴抽象</code>。</p>
<p>第 5 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OrderService</span>(<span class="params">IPaymentService paymentService</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.paymentService = paymentService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PaymentService</code> 由 constructor 的參數傳進來，而不是直接 <code>new</code> 在 constructor 內。</p>
<p>如此 <code>OrderService</code> 的相依物件，就可透過 constructor 傳進來，從此高階模組 <code>OrderService</code> 就不再直接相依於低階模組 <code>PaymentService</code>，而是由更高階模組 <code>OrderController</code> 決定 <code>OrderService</code> 該依賴什麼物件，再由 constructor 參數傳進來，這就是 <code>依賴注入</code>。</p>
<p>注意 constructor 參數的型別是 <code>IPaymentService</code>，而不是 <code>PaymentService</code>，如此才會符合 <code>依賴反轉原則</code> : <code>高階模組不直接依賴低階模組，而是依賴抽象</code>。</p>
<p>我們改用 <code>依賴注入</code> 後有幾個優點 :</p>
<ul>
<li>由原本相依於 <code>PaymentService</code>，改相依於 <code>IPaymentService</code> interface，符合 <code>依賴反轉原則</code></li>
<li>原本直接在 constructor 去 <code>new</code>，高階模組無法抽換低階模組，現在高階模組可透過 constructor 直接換掉低階模組，原來的 <code>OrderService</code> 程式碼不用變動，符合 <code>開放封閉原則</code></li>
<li>單元測試時，可直接透過 constructor 注入 mock 物件隔離測試</li>
</ul>
<blockquote>
<p>OOP 心法</p>
<p>若使用 DI 寫法，則不須再使用 <code>new</code>，讓程式碼更為乾淨，類似 static class 只要一行程式碼就可解決</p>
</blockquote>
<p>10 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateOrder</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.paymentService.PayCreditCard();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由 <code>CreateOrder()</code> 去呼叫 <code>PaymentService.PayCreditCard()</code>，其中也因為要呼叫 <code>PaymentService</code> 的 <code>PayCreditCard()</code>，根據 <code>界面隔離原則</code>，因此 <code>IPaymentService</code> 有 <code>PayCreditCard()</code>。</p>
<h3 id="OrderController">OrderController</h3><p><img src="/images/netcore/netcore-di/di011.svg" alt="di011"></p>
<p><strong>OrderController.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">OrderController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IOrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderController</span>(<span class="params">IOrderService orderService</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderService = orderService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Index</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderService.CreateOrder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 3 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> IOrderService orderService;</span><br></pre></td></tr></table></figure>
<p>我們宣告了 <code>IOrderService</code> 型別的 field，注意此為抽象型別 interface，而非具體型別，所以 <code>OrderController</code> 不會直接依賴 <code>OrderService</code>，而是依賴 <code>IOrderService</code>，符合 <code>依賴反轉原則</code> : <code>高階模組不直接依賴低階模組，而是依賴抽象</code>。</p>
<p>第 5 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OrderController</span>(<span class="params">IOrderService orderService</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.orderService = orderService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>OrderController</code> 由 constructor 的參數傳進來，而不是直接 <code>new</code> 在 constructor 內。</p>
<p>如此 <code>OrderController</code> 的相依物件，就可透過 constructor 傳進來，從此高階模組 <code>OrderController</code> 就不再直接相依於低階模組 <code>OrderService</code>，而是由更高階模組 <code>Program</code> 決定 <code>OrderController</code> 該依賴什麼物件，再由 constructor 參數傳進來，這就是 <code>依賴注入</code>。</p>
<p>注意 constructor 參數的型別是 <code>IOrderService</code>，而不是 <code>OrderService</code>，如此才會符合 <code>依賴反轉原則</code> : <code>高階模組不直接依賴低階模組，而是依賴抽象</code>。</p>
<p>第 10 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Index</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.orderService.CreateOrder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由 <code>Index()</code> 去呼叫 <code>OrderService.CreateOrder()</code>，其中也因為要呼叫 <code>OrderService</code> 的 <code>CreateOrder()</code>，根據 <code>界面隔離原則</code>，因此 <code>IOrderService</code> 有 <code>CreateOrder()</code>。</p>
<h3 id="Program">Program</h3><p><img src="/images/netcore/netcore-di/di008.svg" alt="di008"></p>
<p><strong>Program.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">        services.AddTransient&lt;OrderController&gt;();</span><br><span class="line">        services.AddTransient&lt;IOrderService, OrderService&gt;();</span><br><span class="line">        services.AddTransient&lt;IPaymentService, PaymentService&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> serviceProvider = services.BuildServiceProvider();</span><br><span class="line">      </span><br><span class="line">        OrderController orderController = serviceProvider.GetService&lt;OrderController&gt;();      </span><br><span class="line">        orderController.Index();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>OrderController</code> 與 <code>OrderService</code> 都已經用了 <code>依賴注入</code>，讓我們可以在 constructor 注入相依的 <code>OrderService</code> 與 <code>PaymentService</code>，傳統我們會這樣建立 <code>OrderController</code> :</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        OrderController orderController = <span class="keyword">new</span> OrderController(</span><br><span class="line">                                              <span class="keyword">new</span> OrderService(</span><br><span class="line">                                                  <span class="keyword">new</span> PaymentService()</span><br><span class="line">                                              )</span><br><span class="line">                                          );</span><br><span class="line">        orderController.Index();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由於 <code>OrderController</code> 與 <code>OrderService</code> 都使用了 <code>依賴注入</code>，所以必須使用巢狀的 <code>new</code> 才能將 <code>低階模組</code> 的相依物件一一注入。</p>
<p>目前只是很簡單的 3 個 service，用戶端就已經出現很複雜的寫法，實務上的 <code>低階模組</code> 會多，<code>new</code> 的寫法會更加複雜。</p>
<p>此時我們需要使用 <code>依賴注入容器</code> (DI Container / IoC Container)。</p>
<p>第 5 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">services.AddTransient&lt;OrderController&gt;();</span><br><span class="line">services.AddTransient&lt;IOrderService, OrderService&gt;();</span><br><span class="line">services.AddTransient&lt;IPaymentService, PaymentService&gt;();</span><br></pre></td></tr></table></figure>
<p>要讓 DI container 幫我們 <code>new</code>，首先必須告訴 DI container :</p>
<blockquote>
<p>當遇到 xxx interface 時，請幫我注入 yyy class</p>
</blockquote>
<p>.NET 提供了 <code>ServiceCollection</code>，由它負責蒐集所有 interface 與 class 的 mapping。</p>
<ul>
<li><code>AddTrasient()</code> : 每次注入時，都重新 <code>new</code> 一個新的 instance</li>
<li><code>AddScoped()</code> : 每個 request 都重新 <code>new</code> 一個新的instance</li>
<li><code>AddSingleton()</code> : 程式啟動後會 <code>new</code> 一個 instance，之後會重複使用，也就是運行期間只有一個 instance</li>
</ul>
<p>泛型參數部份 :</p>
<ul>
<li>若只有 class，沒有 interface，如 <code>OrderController</code> :<ul>
<li>只須傳入第一個參數為 class</li>
</ul>
</li>
<li>若有 interface 與對應 class<ul>
<li>第一個參數為 interface</li>
<li>第二個參數為 class</li>
</ul>
</li>
</ul>
<p>也就是告訴 <code>ServiceCollection</code>，當 constructor 的型別為此 interface 時，請幫我 new 這個 class。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static IServiceCollection AddTransient&lt;TService, TImplementation&gt;(this IServiceCollection services)</span><br><span class="line">        where TService : class</span><br><span class="line">        where TImplementation : class, TService;</span><br></pre></td></tr></table></figure>
<p>其中 <code>TImplementation</code> 的 constraint 為 <code>TService</code>，也就是若你這樣寫</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">services.AddTransient&lt;IPaymentService, OrderService&gt;();</span><br></pre></td></tr></table></figure>
<p>因為 <code>OrderService</code> 根本沒有實作  <code>IPaymentService</code>，編譯會錯誤。</p>
<blockquote>
<p>OOP 心法</p>
<p>在使用泛型時，一定要搭配 constraint，才會發揮泛型的威力</p>
</blockquote>
<p>10 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> serviceProvider = services.BuildServiceProvider();</span><br></pre></td></tr></table></figure>
<p>DI container 要靠 service provider 來建立 object，所以下一步要靠 <code>ServiceCollection.BuildServiceProvider()</code> 先產生 <code>ServiceProvider</code>。</p>
<p>12 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderController orderController = serviceProvider.GetService&lt;OrderController&gt;();</span><br></pre></td></tr></table></figure>
<p>之後就可用 <code>ServiceProvider.GetService()</code> 來建立 object，而不須使用巢狀 <code>new</code>。</p>
<blockquote>
<p>DI 常犯錯誤</p>
<ul>
<li>若只有 class，則 <code>GetService()</code> 泛型參數傳入 class</li>
<li>若有 interface，則 <code>GetService()</code> 泛型參數要傳的是 interface，而不是 class，因為 constructor 宣告的是 interface 型別，不是 class 型別。</li>
</ul>
<p>Q : 使用 service provider 建立 object，與自己 <code>new</code> object，差別在哪裡 ?</p>
</blockquote>
<p>A : 你只須用 service provider 建立最外層的 object 即可，剩下相依物件，DI container 會幫你建立；但若你使用 <code>new</code>，怎每一層的相依物件都要自己處理。</p>
<p>13 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orderController.Index();</span><br></pre></td></tr></table></figure>
<p><code>orderController</code> 已經被 DI container 建立，就可以使用一般的方式使用 method。</p>
<blockquote>
<p>Q : 依賴注入與 DI container 除了讓我們不用複雜的 <code>new</code> ，還有其他優點嗎 ?</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> orderController = <span class="keyword">new</span> OrderController();</span><br><span class="line">        orderController.Index();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在沒有使用 <code>依賴注入</code> 與 DI container 之前，<code>Program</code> 只能去 <code>new OrderController()</code>，至於 <code>OrderController</code> 用了哪些相依物件，高階模組 <code>Program</code> 無法決定，也就是高階模組已經被低階模組綁死了，無從決定低階模組到底用了什麼相依物件。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">        services.AddTransient&lt;OrderController&gt;();</span><br><span class="line">        services.AddTransient&lt;IOrderService, OrderService&gt;();</span><br><span class="line">        services.AddTransient&lt;IPaymentService, PaymentService&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> serviceProvider = services.BuildServiceProvider();</span><br><span class="line">      </span><br><span class="line">        OrderController orderController = serviceProvider.GetService&lt;OrderController&gt;();     </span><br><span class="line">        orderController.Index();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 5 行</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">services.AddTransient&lt;OrderController&gt;();</span><br><span class="line">services.AddTransient&lt;IOrderService, OrderService&gt;();</span><br><span class="line">services.AddTransient&lt;IPaymentService, PaymentService&gt;();</span><br></pre></td></tr></table></figure>
<p>高階模組 <code>Program</code> 可以決定低階模組 <code>OrderController</code> 與 <code>OrderService</code> 相依什麼物件，只要在 <code>ServiceCollection</code> 加以定義即可。</p>
<p>也就是高階模組不再相依於低階模組，而是高階模組可以自行定義低階模組的相依物件，符合 <code>依賴反轉原則</code>。</p>
<blockquote>
<p>Q : 高階模組能決定低階模組有什麼意義呢 ?</p>
</blockquote>
<p>一旦高階模組可以決定低階模組，就可以在程式一開始 <code>if else</code> 就決定使用那些低階模組，決定之後，程式就可以很簡單的執行，不須再 <code>if else</code> 判斷。</p>
<p>但若高階模組無法決定低階模組，則在低階模組勢必增加很多 <code>if else</code> 判斷，判斷在什麼條件下，使用什麼低階模組，而且 <code>if else</code> 會分散在各低階模組，程式複雜度會提高。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Console app 無法使用 DI container，須自行安裝 <code>Microsoft.Extensions.DependencyInjection</code>，可使用 GUI 安裝，可以使用指令安裝</li>
<li>DI 可以讓程式碼更乾淨，用起來類似 static 只要一行</li>
<li>DI container 讓 <code>依賴注入</code> 更容易實現，尤其在用戶端可以完全掌握 <code>低階模組</code> 的相依物件，完全符合 <code>依賴反轉原則</code></li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NETCore2MVCDI" target="_blank" rel="external">GitHub</a> 找到。</p>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://blog.johnwu.cc/" target="_blank" rel="external">John Wu</a>, <a href="https://blog.johnwu.cc/article/asp-net-core-dependency-injection.html" target="_blank" rel="external">ASP.NET Core 教學 - Dependency Injection</a><br><a href="https://www.microsoft.com/en-us/" target="_blank" rel="external">Microsoft</a>, <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection" target="_blank" rel="external">Introduction to Dependency Injection in ASP.NET Core</a><br><a href="https://joonasw.net/" target="_blank" rel="external">Joonas W</a>, <a href="https://joonasw.net/view/aspnet-core-di-deep-dive" target="_blank" rel="external">ASP.NET Core Dependency Injection Deep Dive</a><br><a href="http://asp.net-hacker.rocks/" target="_blank" rel="external">ASP.NET Hacker</a>, <a href="http://asp.net-hacker.rocks/2017/02/08/using-dependency-injection-in-dotnet-core-console-apps.html" target="_blank" rel="external">Using Dependency Injection in .NET Core Console Apps</a></p>
]]></content>
    <summary type="html">
    <![CDATA[在 .NET Core 也能優雅地使用 DI]]>
    
    </summary>
    
      <category term=".NET Core" scheme="http://oomusou.io/tags/NET-Core/"/>
    
  </entry>
  
</feed>
