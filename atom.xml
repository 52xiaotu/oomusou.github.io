<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[點燈坊]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="http://oomusou.io/"/>
  <updated>2017-06-15T07:31:17.000Z</updated>
  <id>http://oomusou.io/</id>
  
  <author>
    <name><![CDATA[真 OO無双]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[如何將 Git Bash 整合進 WebStorm？]]></title>
    <link href="http://oomusou.io/webstorm/webstorm-git-bash/"/>
    <id>http://oomusou.io/webstorm/webstorm-git-bash/</id>
    <published>2017-06-19T12:23:43.000Z</published>
    <updated>2017-06-15T07:31:17.000Z</updated>
    <content type="html"><![CDATA[<p>WebStorm for Windows 的 terminal 預設是使用 Windows 內建的 Command Prompt，但可惜內建的 Command Prompt 不強，而 Git Bash 是 Git for Windows 所提供的 git 文字介面，讓我們可以直接對 git 下指令，並顯示當前的 branch，重點是能在 Windows 使用 Bash，且整合進 PhpStorm 的 terminal。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>WebStorm 2017.1.4<br>Git for Windows 2.13.1</p>
<h2 id="下載_Git_Bash">下載 Git Bash</h2><hr>
<p>到 <a href="https://git-for-windows.github.io/" target="_blank" rel="external">Git for Windows</a> 下載 Git Bash。</p>
<p><img src="/images/webstorm/webstorm-git-bash/bash000.png" alt="bash000"></p>
<h2 id="安裝_Git_Bash">安裝 Git Bash</h2><hr>
<p>基本下都 <code>下一步</code> 即可。</p>
<h2 id="設定_WebStorm">設定 WebStorm</h2><hr>
<p><img src="/images/webstorm/webstorm-git-bash/bash001.png" alt="bash001"></p>
<p><strong><em>File -&gt; Settings -&gt; Tools -&gt; Terminal</em></strong></p>
<ul>
<li><strong>Shell path</strong> : <code>&quot;C:\Program Files\Git\bin\sh.exe&quot; -login -i</code></li>
</ul>
<p>重新啟動 WebStorm。</p>
<h2 id="執行_Git_Bash">執行 Git Bash</h2><hr>
<p><img src="/images/webstorm/webstorm-git-bash/bash002.png" alt="bash002"></p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Git Bash 算是在 Windows 下最接近 Linux 血統的 terminal，實務上完全可以取代 Windows 內建的 Command Prompt。</li>
<li>WebStorm 的 terminal 也能順利跑 Git Bash。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<ul>
<li><a href="https://bobsguides.com/" target="_blank" rel="external">Bob’s Guide</a>, <a href="https://bobsguides.com/blog.html/2014/10/23/git-bash-inside-phpstorm/" target="_blank" rel="external">Git Bash Inside PhpStorm</a></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[Git Bash 也能跑在 WebStorm 的 terminal]]>
    
    </summary>
    
      <category term="WebStorm" scheme="http://oomusou.io/tags/WebStorm/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[TypeScript 之 Module]]></title>
    <link href="http://oomusou.io/typescript/typescript-module/"/>
    <id>http://oomusou.io/typescript/typescript-module/</id>
    <published>2017-06-18T12:23:43.000Z</published>
    <updated>2017-06-13T16:15:26.000Z</updated>
    <content type="html"><![CDATA[<p>ES6 提出了 module 概念，讓我們將程式碼加以模組化，避免如 ES5 一樣常常寫出幾千行的程式碼，造成日後難以維護，TypeScript 也支援 ES6 的 module。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>TypeScrpit 2.3</p>
<h2 id="Introduction">Introduction</h2><hr>
<p>Module 有自己的 scope，不是 global scope，也就是說，在 module 內的變數、function、class 與 interface …，只有在同一個 module 內才看得到，除非特別加上 <code>export</code> 關鍵字，外界才能存取；同樣的，module 要使用其他 module 的變數、function、class 與 interface …，除非特別加上 <code>import</code> 關鍵字，才能存取外界。</p>
<blockquote>
<p>在 TypeScript，只要檔案中存在 <code>import</code> 或 <code>export</code> 關鍵字，都被視為 module。</p>
</blockquote>
<h2 id="Export">Export</h2><hr>
<h3 id="直接_Export">直接 Export</h3><p><strong>Validation.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> StringValidator </span>&#123;</span><br><span class="line">    isAcceptable(s: <span class="built_in">string</span>): <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>interface</code> 前面加上 <code>export</code>，則可直接 export 出去。</p>
<p><strong>ZipCodeValidator.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> numberRegexp = <span class="regexp">/^[0-9]+$/</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ZipCodeValidator <span class="keyword">implements</span> StringValidator &#123;</span><br><span class="line">    isAcceptable(s: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> s.length === <span class="number">5</span> &amp;&amp; numberRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>const</code> 之前加上 <code>export</code>，則可直接 export 出去。</p>
<p>在 <code>class</code> 之前加上 <code>export</code> ，則可直接 export 出去。</p>
<blockquote>
<p>要直接 export，只要在 <code>const</code>、<code>function</code> 、<code>class</code> 與 <code>interface</code> 之前加上 <code>export</code> 關鍵字即可。</p>
</blockquote>
<h3 id="以別名_Export">以別名 Export</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> ZipCodeValidator <span class="keyword">implements</span> StringValidator &#123;</span><br><span class="line">    isAcceptable(s: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> s.length === <span class="number">5</span> &amp;&amp; numberRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123; ZipCodeValidator &#125;;</span><br><span class="line"><span class="keyword">export</span> &#123; ZipCodeValidator as mainValidator &#125;;</span><br></pre></td></tr></table></figure>
<p>第 6 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123; ZipCodeValidator &#125;;</span><br></pre></td></tr></table></figure>
<p>相當於</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ZipCodeValidator <span class="keyword">implements</span> StringValidator &#123;</span><br><span class="line">    isAcceptable(s: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> s.length === <span class="number">5</span> &amp;&amp; numberRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 7 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123; ZipCodeValidator as mainValidator &#125;;</span><br></pre></td></tr></table></figure>
<p>將原本 <code>ZipCodeValidator</code> 以 <code>mainValidator</code> 名稱 export 出去。</p>
<blockquote>
<p>實務上有可能原本要 export 的名稱太長，或者不夠貼近 domain，因此不適合使用者，需要用更簡短、更精準的名稱時，可以搭配 <code>as</code>。</p>
</blockquote>
<h3 id="重新_Export">重新 Export</h3><p><strong>ParseIntBasedZipCodeValidator.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> ParseIntBasedZipCodeValidator &#123;</span><br><span class="line">    isAcceptable(s: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> s.length === <span class="number">5</span> &amp;&amp; <span class="built_in">parseInt</span>(s).toString() === s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Export original validator but rename it</span></span><br><span class="line"><span class="keyword">export</span> &#123;ZipCodeValidator as RegExpBasedZipCodeValidator&#125; from <span class="string">"./ZipCodeValidator"</span>;</span><br></pre></td></tr></table></figure>
<p>使用 <code>export {} from</code> 可以從另外一個 module 間接的將另外一個 module 內的東西 export 出去。</p>
<p>可明確指定要 export 什麼東西。</p>
<p><strong>AllValidators.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> * from <span class="string">"./StringValidator"</span>; <span class="comment">// exports interface 'StringValidator'</span></span><br><span class="line"><span class="keyword">export</span> * from <span class="string">"./LettersOnlyValidator"</span>; <span class="comment">// exports class 'LettersOnlyValidator'</span></span><br><span class="line"><span class="keyword">export</span> * from <span class="string">"./ZipCodeValidator"</span>;  <span class="comment">// exports class 'ZipCodeValidator'</span></span><br></pre></td></tr></table></figure>
<p>使用 <code>export * from</code> 明確另外一個 module 的<strong>所有東西</strong> export 出去。</p>
<h2 id="Import">Import</h2><hr>
<h3 id="單一_Import">單一 Import</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ZipCodeValidator &#125; from <span class="string">"./ZipCodeValidator"</span>;</span><br><span class="line"><span class="keyword">let</span> myValidator = <span class="keyword">new</span> ZipCodeValidator();</span><br></pre></td></tr></table></figure>
<p>使用 <code>import {} from</code> 可以從一個 module 單一 import 一個東西。</p>
<h3 id="以別名_Import">以別名 Import</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ZipCodeValidator as ZCV &#125; from <span class="string">"./ZipCodeValidator"</span>;</span><br><span class="line"><span class="keyword">let</span> myValidator = <span class="keyword">new</span> ZCV();</span><br></pre></td></tr></table></figure>
<p>使用 <code>import { as } from</code> 可以從一個 module 單一 import 後，並同時取別名。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * as validator from <span class="string">"./ZipCodeValidator"</span>;</span><br><span class="line"><span class="keyword">let</span> myValidator = <span class="keyword">new</span> validator.ZipCodeValidator();</span><br></pre></td></tr></table></figure>
<p>使用 <code>import * as from</code> 將一個 module 所有東西 import 成一個變數，並透過變數去存取所有 export 的東西。</p>
<h2 id="Default_Export">Default Export</h2><hr>
<p>一個 module 僅可以有一個 default export。</p>
<p><strong>ZipCodeValidator.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> ZipCodeValidator &#123;</span><br><span class="line">    <span class="keyword">static</span> numberRegexp = <span class="regexp">/^[0-9]+$/</span>;</span><br><span class="line">    isAcceptable(s: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> s.length === <span class="number">5</span> &amp;&amp; ZipCodeValidator.numberRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>export</code> 之後加上 <code>default</code>。</p>
<p><strong>Test.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> validator from <span class="string">"./ZipCodeValidator"</span>;</span><br><span class="line"><span class="keyword">let</span> myValidator = <span class="keyword">new</span> validator();</span><br></pre></td></tr></table></figure>
<p>使用 <code>import 名稱 from</code>，不需使用 <code>{}</code>，直接將 default export 成特定名稱。 </p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>透過 module，我們能將功能相近的變數、function、class 與 interface 放在同一個 module，讓程式碼更加模組化，避免一個檔案好幾千行而難以維護。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://www.typescriptlang.org/" target="_blank" rel="external">TypeScript</a>, <a href="https://www.typescriptlang.org/docs/handbook/modules.html" target="_blank" rel="external">Handbook : Modules</a></p>
]]></content>
    <summary type="html">
    <![CDATA[TypeScript 也支援 ES6 的 module]]>
    
    </summary>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[TypeScript 之 Arrow Function]]></title>
    <link href="http://oomusou.io/typescript/typescript-arrow-function/"/>
    <id>http://oomusou.io/typescript/typescript-arrow-function/</id>
    <published>2017-06-17T12:23:43.000Z</published>
    <updated>2017-06-13T06:31:58.000Z</updated>
    <content type="html"><![CDATA[<p>Arrow function 是 ES6 最重要的發明，讓 FRP 能以更簡潔的方式呈現，TypeScript 當然可使用，在 Angular 也隨處可見，如 RxJS 就必須大量使用 arrow function，是學習 Angular 一定要會的。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>TypeScript 2.3</p>
<h2 id="以_=&gt;_取代_Anonymous_Function">以 =&gt; 取代 Anonymous Function</h2><hr>
<p>Arrow function 可以用來取代 anonymous function。<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> hello = <span class="function"><span class="keyword">function</span> (<span class="params">firstName: <span class="built_in">string</span>, lastName: <span class="built_in">string</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> `Hello $&#123;firstName&#125; $&#123;lastName&#125;`;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">message = hello(<span class="string">'Sam'</span>, <span class="string">'Xiao'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(message); <span class="comment">// Hello Sam Xiao</span></span><br></pre></td></tr></table></figure></p>
<p>後面是 anonymous function，但我們可發現，<code>function</code> 事實上是個虛字。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> hello = (firstName: <span class="built_in">string</span>, lastName: <span class="built_in">string</span>): <span class="built_in">string</span> =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> `Hello $&#123;firstName&#125; $&#123;lastName&#125;`;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">message = hello(<span class="string">'Sam'</span>, <span class="string">'Xiao'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(message); <span class="comment">// Hello Sam Xiao</span></span><br></pre></td></tr></table></figure>
<p>將 <code>function</code> 省略，改以 <code>=&gt;</code> 取代。</p>
<p>但又發現 <code>return</code> 也是虛字。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> hello = (firstName: <span class="built_in">string</span>, lastName: <span class="built_in">string</span>): <span class="built_in">string</span> =&gt; `Hello $&#123;firstName&#125; $&#123;lastName&#125;`;</span><br><span class="line"></span><br><span class="line">message = hello(<span class="string">'Sam'</span>, <span class="string">'Xiao'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(message); <span class="comment">// Hello Sam Xiao</span></span><br></pre></td></tr></table></figure>
<p>因為只有單一 <code>return</code>，可將 <code>{return}</code> 一起省略。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> hello = (firstName: <span class="built_in">string</span>): <span class="built_in">string</span> =&gt; `Hello $&#123;firstName&#125;`;</span><br><span class="line"></span><br><span class="line">message = hello(<span class="string">'Sam'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(message); <span class="comment">// Hello Sam</span></span><br></pre></td></tr></table></figure>
<p>假如我們只保留 <code>firstName</code> 1 個參數。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> hello = firstName =&gt; `Hello $&#123;firstName&#125;`;</span><br><span class="line"></span><br><span class="line">message = hello(<span class="string">'Sam'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(message); <span class="comment">// Hello Sam</span></span><br></pre></td></tr></table></figure>
<p>因為只有單一參數，連 <code>()</code> 都可省略。</p>
<h2 id="以_=&gt;_取代_Callback">以 =&gt; 取代 Callback</h2><hr>
<p>Arrow function 可以用來取代 callback。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> angular = [</span><br><span class="line">  <span class="string">'Kevin'</span>,</span><br><span class="line">  <span class="string">'Jeff'</span>,</span><br><span class="line">  <span class="string">'Jimmy'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> length = angular.map(<span class="function"><span class="keyword">function</span>(<span class="params">person</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> person.length;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(length); <span class="comment">// [5, 4, 5]</span></span><br></pre></td></tr></table></figure>
<p>如常用的 <code>map()</code>，會需要我們傳入 callback，決定要回傳的新陣列。</p>
<p>但我們可發現，<code>function</code> 事實上是個虛字。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> angular = [</span><br><span class="line">  <span class="string">'Kevin'</span>,</span><br><span class="line">  <span class="string">'Jeff'</span>,</span><br><span class="line">  <span class="string">'Jimmy'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> length = angular.map((person) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> person.length;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(length); <span class="comment">// [5, 4, 5]</span></span><br></pre></td></tr></table></figure>
<p>可將 <code>function</code> 省略，改用 <code>=&gt;</code>。</p>
<p>但又發現 <code>return</code> 也是虛字。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> angular = [</span><br><span class="line">  <span class="string">'Kevin'</span>,</span><br><span class="line">  <span class="string">'Jeff'</span>,</span><br><span class="line">  <span class="string">'Jimmy'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> length = angular.map((person) =&gt; person.length);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(length); <span class="comment">// [5, 4, 5]</span></span><br></pre></td></tr></table></figure>
<p>因為只有單一 <code>return</code>，可將 <code>{return}</code> 一起省略。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> angular = [</span><br><span class="line">  <span class="string">'Kevin'</span>,</span><br><span class="line">  <span class="string">'Jeff'</span>,</span><br><span class="line">  <span class="string">'Jimmy'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> length = angular.map(person =&gt; person.length);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(length);</span><br></pre></td></tr></table></figure>
<p>因為只有單一參數，連 <code>()</code> 都可省略。</p>
<h2 id="語法規則">語法規則</h2><hr>
<h3 id="多參數">多參數</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(param1, param2, …, paramN) =&gt; &#123; statements &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>將 <code>function</code> 以 <code>=&gt;</code> 取代。</li>
<li>若有多行程式，須以 <code>{}</code> 包起來。</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(param1, param2, …, paramN) =&gt; expression</span><br><span class="line">(param1, param2, …, paramN) =&gt; &#123; <span class="keyword">return</span> expression;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>將 <code>function</code> 以 <code>=&gt;</code> 取代。</li>
<li>若只有單一 <code>return</code>，可將 <code>{return }</code> 拿掉。</li>
</ul>
<h3 id="單一參數">單一參數</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(singleParam) =&gt; &#123; statements &#125;</span><br><span class="line">singleParam =&gt; &#123; statements &#125;</span><br><span class="line">singleParam =&gt; expression</span><br></pre></td></tr></table></figure>
<ul>
<li>將 <code>function</code> 以 <code>=&gt;</code> 取代。</li>
<li>若有多行程式，須以 <code>{}</code> 包起來。</li>
<li>若只有單一 <code>return</code>，可將 <code>{return }</code> 拿掉。</li>
<li>單一參數，可連 <code>()</code> 都拿掉。</li>
</ul>
<h3 id="無參數">無參數</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">() =&gt; &#123; statements &#125;</span><br><span class="line">() =&gt; expression</span><br></pre></td></tr></table></figure>
<ul>
<li>將 <code>function</code> 以 <code>=&gt;</code> 取代。</li>
<li>若有多行程式，須以 <code>{}</code> 包起來。</li>
<li>若只有單一 <code>return</code>，可將 <code>{return }</code> 拿掉。</li>
<li>無參數必須保留 <code>()</code>。</li>
</ul>
<h3 id="回傳物件">回傳物件</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">params =&gt; (&#123;foo:bar&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>將 <code>function</code> 以 <code>=&gt;</code> 取代。</li>
<li>多參數/單一參數/無參數的規則依舊。</li>
<li>將回傳物件外面加上 <code>()</code></li>
</ul>
<blockquote>
<p>因為 <code>{}</code> 已經被物件使用，只好改用 <code>()</code>。</p>
</blockquote>
<h2 id="Anonymous_Function_與_this">Anonymous Function 與 this</h2><hr>
<p>在 ES5 時，anonymous function 搭配 this 時，總讓人很糾結。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Foo =&#123;</span><br><span class="line">  name: <span class="string">"Sam"</span>,</span><br><span class="line"></span><br><span class="line">  handleMessage: <span class="function"><span class="keyword">function</span> (<span class="params">message, callback</span>)</span>&#123;</span><br><span class="line">    callback(message);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  receive: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.handleMessage(<span class="string">"Hello, "</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Foo.receive(); <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>
<p>結果執行錯誤，<code>this.name</code> 為 undefined。</p>
<p>因為 anonymous function 的 this，並不是指向 <code>Foo</code>，所以存取不到 <code>this.name</code>。</p>
<p>在 ES5，我們會這用以下寫法：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Foo =&#123;</span><br><span class="line">  name: <span class="string">"Sam"</span>,</span><br><span class="line"></span><br><span class="line">  handleMessage: <span class="function"><span class="keyword">function</span> (<span class="params">message, callback</span>)</span>&#123;</span><br><span class="line">    callback(message);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  receive: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    that = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">this</span>.handleMessage(<span class="string">"Hello, "</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(that.name);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Foo.receive(); <span class="comment">// Hello Sam</span></span><br></pre></td></tr></table></figure>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">that = <span class="keyword">this</span>;</span><br></pre></td></tr></table></figure>
<p>讓 <code>receive</code> scope 的 <code>that</code> 指向 <code>this</code>。</p>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(that.name);</span><br></pre></td></tr></table></figure>
<p>改用 <code>that.name</code>，就可以正確顯示 <code>Hello Sam</code>。</p>
<blockquote>
<p>很多人搞不懂 this 是什麼，就乾脆都寫成 that = this。</p>
</blockquote>
<h2 id="Arrow_Function_與_this">Arrow Function 與 this</h2><hr>
<p>我們剛剛知道，在ES6 可以使用 arrow function 取代 anonymous function。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Foo =&#123;</span><br><span class="line">  name: <span class="string">"Sam"</span>,</span><br><span class="line"></span><br><span class="line">  handleMessage: <span class="function"><span class="keyword">function</span> (<span class="params">message, callback</span>)</span>&#123;</span><br><span class="line">    callback(message);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  receive: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.handleMessage(<span class="string">"Hello, "</span>, () =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Foo.receive(); <span class="comment">// Hello Sam</span></span><br></pre></td></tr></table></figure>
<p>使用 arrow function 後，<code>this</code> 就能如預期的抓到 <code>this.name</code>，顯示 <code>Hello Sam</code>。</p>
<p>透過 <a href="https://www.typescriptlang.org/play/" target="_blank" rel="external">TypeScript Playground</a>，我們來看看到底有什麼黑魔法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Foo = &#123;</span><br><span class="line">    name: <span class="string">"Sam"</span>,</span><br><span class="line">    handleMessage: <span class="function"><span class="keyword">function</span> (<span class="params">message, callback</span>) </span>&#123;</span><br><span class="line">        callback(message);</span><br><span class="line">    &#125;,</span><br><span class="line">    receive: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> _this = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>.handleMessage(<span class="string">"Hello, "</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(_this.name);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Foo.receive(); <span class="comment">// Hello Sam</span></span><br></pre></td></tr></table></figure>
<p>第 7 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _this = <span class="keyword">this</span>;</span><br></pre></td></tr></table></figure>
<p>原來編譯成 ES5 之後，TypeScript 自動幫我們加上 <code>_this = this</code>，因此我們可以抓到 <code>name</code>。</p>
<blockquote>
<p>雖然 anonymous function 與 arrow function 對 this 的觀點不同，但並沒有誰對誰錯，只是應用場合不同，當你比較需要類似 OOP 的方式，就使用 arrow function；若比較需要 FRP 的方式，就使用 anonymous function，當你手中不再只有錘子，所看的東西就不再只是釘子。</p>
</blockquote>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Arrow function 是 FRP 的重要推手，讓我們可以使用更精簡的方式使用 callback，將更多的虛字拿掉，只留下商業邏輯中最關鍵的部分。</li>
<li><code>this</code> 一直是 JavaScript 頗具爭議之處，arrow function 讓我們有另外一種方式使用 <code>this</code>，我們可以視需求決定該使用 arrow function 或 anonymous function。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://www.typescriptlang.org/" target="_blank" rel="external">TypeScript</a>, <a href="https://www.typescriptlang.org/docs/handbook/functions.html" target="_blank" rel="external">Handbook : Functions</a><br><a href="https://egghead.io" target="_blank" rel="external">Egghead.io</a>, <a href="https://egghead.io/lessons/ecmascript-6-arrow-function-in-es6" target="_blank" rel="external">Arrow Function =&gt; in ES6</a></p>
]]></content>
    <summary type="html">
    <![CDATA[探討 ES6 的招牌菜 Arrow Function]]>
    
    </summary>
    
      <category term="TypeScript" scheme="http://oomusou.io/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[TypeScript 之 Function]]></title>
    <link href="http://oomusou.io/typescript/typescript-function/"/>
    <id>http://oomusou.io/typescript/typescript-function/</id>
    <published>2017-06-17T11:23:43.000Z</published>
    <updated>2017-06-14T02:22:40.000Z</updated>
    <content type="html"><![CDATA[<p>TypeScript 的 function 可對參數做強型別檢查與 function type，此外 ES6 還多了 optional / default / rest parameter，當然 TypeScript 也可使用。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>TypeScript 2.3</p>
<h2 id="Parameter_with_Type">Parameter with Type</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// named function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x: <span class="built_in">number</span>, y: <span class="built_in">number</span></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// anonymous function</span></span><br><span class="line"><span class="keyword">let</span> myAdd = <span class="function"><span class="keyword">function</span>(<span class="params">x: <span class="built_in">number</span>, y: <span class="built_in">number</span></span>): <span class="title">number</span> </span>&#123; <span class="keyword">return</span> x+y; &#125;;</span><br></pre></td></tr></table></figure>
<p>無論是 named function 或者是 anonymous function，都可以在參數與回傳值明確指定 type，讓編譯器幫我們做檢查，一但型別錯誤，編譯將會失敗。</p>
<h2 id="Function_Type">Function Type</h2><hr>
<p>除了參數加上型別外，我們還可以對整個 function 也加上型別，讓編譯器幫我們檢查 function 是否符合這個型別。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myAdd: (x: <span class="built_in">number</span>, y: <span class="built_in">number</span>)=&gt;<span class="built_in">number</span> =</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">x: <span class="built_in">number</span>, y: <span class="built_in">number</span></span>): <span class="title">number</span> </span>&#123; <span class="keyword">return</span> x+y; &#125;;</span><br></pre></td></tr></table></figure>
<p><code>myAdd</code> 的型別為 <code>(x: number, y: number)=&gt;number</code>，關於 function type，主要分成兩部分：</p>
<ul>
<li>參數型別</li>
<li>回傳值型別</li>
</ul>
<p>因為宣告了 function type，在 <code>=</code> 之後的 anonymous function 就必須符合所規定的 function type，若 anonymous function 不符合 function type，編譯會錯誤。</p>
<p>不過在實務上，我們不會真的這樣寫，因為實在太冗長了，只會寫成：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myAdd = <span class="function"><span class="keyword">function</span>(<span class="params">x: <span class="built_in">number</span>, y: <span class="built_in">number</span></span>): <span class="title">number</span> </span>&#123; <span class="keyword">return</span> x+y; &#125;;</span><br></pre></td></tr></table></figure>
<p>TypeScript 編譯器會自動幫我們轉成</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myAdd: (x: <span class="built_in">number</span>, y: <span class="built_in">number</span>)=&gt;<span class="built_in">number</span> =</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">x: <span class="built_in">number</span>, y: <span class="built_in">number</span></span>): <span class="title">number</span> </span>&#123; <span class="keyword">return</span> x+y; &#125;;</span><br></pre></td></tr></table></figure>
<p>TypeScript 會自動幫我們將 <code>myAdd</code> 加上型別，若之後再指定其他 function 給 <code>myAdd</code>，只要不符合 function type 就會報錯。</p>
<blockquote>
<p>TypeScript 在觀念上有 function type，不過實務上不用特別去指定 function type，只要將 anonymous function 指定給變數，就會自動幫我們加上 function type。</p>
</blockquote>
<h2 id="Optional_Parameters">Optional Parameters</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildName</span>(<span class="params">firstName: <span class="built_in">string</span>, lastName: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> firstName + <span class="string">" "</span> + lastName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> result1 = buildName(<span class="string">"Bob"</span>);                  <span class="comment">// 編譯錯誤，少 1 個參數</span></span><br><span class="line"><span class="keyword">let</span> result2 = buildName(<span class="string">"Bob"</span>, <span class="string">"Adams"</span>, <span class="string">"Sr."</span>);  <span class="comment">// 編譯錯誤，多 1 個參數</span></span><br><span class="line"><span class="keyword">let</span> result3 = buildName(<span class="string">"Bob"</span>, <span class="string">"Adams"</span>);         <span class="comment">// 編譯通過</span></span><br></pre></td></tr></table></figure>
<p>在 TypeScript 世界，既然宣告了參數，就代表傳入參數的個數與型別必須完全符合，過多或過少都不行。</p>
<p>但  JavaScript 世界，每個變數都是 optional，若參數個數不對，只是 <code>undefined</code> 而已，為了讓 TypeScript 有強型別檢查，又能相容於 JavaScript 習慣，可在參數後加上 <code>?</code>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildName</span>(<span class="params">firstName: <span class="built_in">string</span>, lastName?: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (lastName)</span><br><span class="line">        <span class="keyword">return</span> firstName + <span class="string">" "</span> + lastName;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> firstName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> result1 = buildName(<span class="string">"Bob"</span>);                  <span class="comment">// 編譯通過</span></span><br><span class="line"><span class="keyword">let</span> result2 = buildName(<span class="string">"Bob"</span>, <span class="string">"Adams"</span>, <span class="string">"Sr."</span>);  <span class="comment">// 編譯錯誤，多一個</span></span><br><span class="line"><span class="keyword">let</span> result3 = buildName(<span class="string">"Bob"</span>, <span class="string">"Adams"</span>);         <span class="comment">// 編譯通過</span></span><br></pre></td></tr></table></figure>
<p>若使用 <code>?</code> optional parameter，記得將必要參數寫在最前面，後面才擺 optional parameter。</p>
<h2 id="Default_Parameter">Default Parameter</h2><hr>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function buildName(firstName: string, lastName = "Smith") &#123;</span><br><span class="line">    return firstName + " " + lastName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let result1 = buildName("Bob");                  // Bob Smith</span><br><span class="line">let result2 = buildName("Bob", undefined);       // Bob Smite</span><br><span class="line">let result3 = buildName("Bob", "Adams", "Sr.");  // 編譯錯誤，多一個參數</span><br><span class="line">let result4 = buildName("Bob", "Adams");         // Bob Adams</span><br></pre></td></tr></table></figure>
<p>TypeScript 亦提供 default parameter，當傳入 <code>undefined</code> 時，則會以 default parameter 取代。</p>
<p>Default parameter 若放在必要參數後面，則相當於 optional parameter 一樣，只是差別在有預設值。</p>
<p>Default parameter 並不像 optional parameter 一樣，一定放在必要參數後面，若放在必要參數前面，則必須明確的指定 <code>undefined</code>，而不能省略。</p>
<h2 id="Rest_Parameter">Rest Parameter</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildName</span>(<span class="params">firstName: <span class="built_in">string</span>, ...restOfName: <span class="built_in">string</span>[]</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> firstName + <span class="string">" "</span> + restOfName.join(<span class="string">" "</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> employeeName = buildName(<span class="string">"Kevin"</span>, <span class="string">"Jeff"</span>, <span class="string">"Jimmy"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(employeeName); <span class="comment">// Kevin Jeff Jimmy</span></span><br></pre></td></tr></table></figure>
<p>無論是 optional parameter，或是 default paramter，討論的都是一個參數對應一個值，但實務上可能遇到參數個數不確定，希望參數以陣列接收。</p>
<p>第 1 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...restOfName: <span class="built_in">string</span>[]</span><br></pre></td></tr></table></figure>
<p>以 <code>…</code> 宣告為 rest parameter，並明確宣告其型別為  string 陣列，則無論多少參數個數，最後都會塞進 <code>restOfName</code> 陣列。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Function 的參數加上型別檢查後，我們將可少撰寫很多檢查型別的程式碼，由 TypeScript 編譯器幫我們把關。</li>
<li>有了 optioanl / default / rest parameter，參數將更加靈活。</li>
</ul>
<h2 id="References">References</h2><hr>
<p><a href="https://www.typescriptlang.org/" target="_blank" rel="external">TypeScript</a>, <a href="https://www.typescriptlang.org/docs/handbook/functions.html" target="_blank" rel="external">Handbook : Functions</a></p>
]]></content>
    <summary type="html">
    <![CDATA[TypeScript/ES6 對 function 支援的擴展]]>
    
    </summary>
    
      <category term="TypeScript" scheme="http://oomusou.io/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[TypeScript 之變數宣告與建立]]></title>
    <link href="http://oomusou.io/typescript/typescript-variable/"/>
    <id>http://oomusou.io/typescript/typescript-variable/</id>
    <published>2017-06-16T12:23:43.000Z</published>
    <updated>2017-06-15T07:34:22.000Z</updated>
    <content type="html"><![CDATA[<p>變數宣告部分，除了 <code>var</code> 以外，在 ES6 增加了 <code>let</code> 與 <code>const</code>，在變數建立部分，則增加了 destructuring 與 spread，當然 TypeScript 也完全支援。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>TypeScript 2.3</p>
<h2 id="var">var</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i);</span><br><span class="line">  &#125;, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>var</code> 最經典的範例莫過於此，原本我們預期會輸出</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>結果輸出</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>這裡有兩個觀念：</p>
<ul>
<li><code>setTimeout()</code> 屬於非同步 function，JavaScript 的 event loop model 會在最後執行。</li>
<li><code>var</code> 看似在 <code>{}</code> 內，但沒有 scope 概念，因為其 hoisting 機制，會將 <code>var</code> 提升到程式最前面，相當於全域變數，因此 <code>console.log()</code> 印出 for loop 執行完的 <code>10</code>。</li>
</ul>
<h2 id="let">let</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i);</span><br><span class="line">  &#125;, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將 <code>var</code> 改成 <code>let</code> 之後，結果就如預期了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br></pre></td></tr></table></figure>
<p><code>let</code> 對變數有 scope 概念，其生命週期只存在於 <code>{}</code> ，因此儘管非同步的 <code>setTimeout()</code> 最後執行，let 仍將 <code>i</code> 鎖住到最後，而不像 <code>var</code> 沒有 scope 概念，都是全域變數。</p>
<blockquote>
<p>實務上應該全面使用 let 取代 var，若你使用 var，language service 也會提出警告，要你改用 let。</p>
</blockquote>
<h2 id="const">const</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> numLivesForCat = <span class="number">9</span>;</span><br></pre></td></tr></table></figure>
<p> 若此變數不會再被修改，則應宣告成 const。</p>
<blockquote>
<p>傳統我們都是確定此變數不能被修改，才會宣告成 const，但在 TypeScript 中是反過來，<strong>變數應該盡量宣告成 const，除非要修改才宣告成 let</strong>，事實上，若 language service 發現變數從來沒被修改過，會主動提出警告，要求你改成 const，這是希望大家盡量寫出 immutable 的 pure function，減少不必要的 side effect。</p>
</blockquote>
<h2 id="Destructuring">Destructuring</h2><hr>
<h3 id="Array_Destructing">Array Destructing</h3><p>ES6 允許我們直接將陣列加以解構成變數。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> input = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="keyword">var</span> first = input[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> second = input[<span class="number">1</span>];</span><br><span class="line"><span class="built_in">console</span>.log(first); <span class="comment">// outputs 1</span></span><br><span class="line"><span class="built_in">console</span>.log(second); <span class="comment">// outputs 2</span></span><br></pre></td></tr></table></figure>
<p>在 ES5，我們必須使用 array index 方式，才能將值指定到變數。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> input = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="keyword">let</span> [first, second] = input;</span><br><span class="line"><span class="built_in">console</span>.log(first); <span class="comment">// outputs 1</span></span><br><span class="line"><span class="built_in">console</span>.log(second); <span class="comment">// outputs 2</span></span><br></pre></td></tr></table></figure>
<p>ES6 我們可以直接使用 <code>[]</code> 將陣列加以解構。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// swap variables</span></span><br><span class="line">[first, second] = [second, first];</span><br></pre></td></tr></table></figure>
<p>交換變數，只要一行就可以寫出來。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">[first, second]: <span class="built_in">number</span>[]</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(first); <span class="comment">// 1</span></span><br><span class="line">  <span class="built_in">console</span>.log(second); <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line">f([<span class="number">1</span>, <span class="number">2</span>]);</span><br></pre></td></tr></table></figure>
<p>若用在 function 的參數，可以接陣列解構成變數。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [first, ...rest] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="built_in">console</span>.log(first); <span class="comment">// outputs 1</span></span><br><span class="line"><span class="built_in">console</span>.log(rest); <span class="comment">// outputs [ 2, 3, 4 ]</span></span><br></pre></td></tr></table></figure>
<p>配合 <code>…</code>，將剩餘的值結構成陣列。</p>
<p><code>first</code> 為單一變數，<code>rest</code> 為陣列。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [first] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="built_in">console</span>.log(first); <span class="comment">// outputs 1</span></span><br></pre></td></tr></table></figure>
<p><code>first</code> 為 <code>1</code>，其他值會忽略。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [, second, , fourth] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="built_in">console</span>.log(second); <span class="comment">// 2</span></span><br><span class="line"><span class="built_in">console</span>.log(fourth); <span class="comment">// 4</span></span><br></pre></td></tr></table></figure>
<p>只有 <code>2</code> 與 <code>4</code> 會解構，其他值會忽略。</p>
<h3 id="Object_Destructing">Object Destructing</h3><p>除了解構陣列外，ES6 還允許我們解構物件。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> o = &#123;</span><br><span class="line">  a: <span class="string">"foo"</span>,</span><br><span class="line">  b: <span class="number">12</span>,</span><br><span class="line">  c: <span class="string">"bar"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> &#123; a, b &#125; = o;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a); <span class="comment">// foo</span></span><br><span class="line"><span class="built_in">console</span>.log(b); <span class="comment">// 12</span></span><br></pre></td></tr></table></figure>
<p> <code>c</code> 因為沒有變數解構，會自動忽略。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> o = &#123;</span><br><span class="line">  a: <span class="string">"foo"</span>,</span><br><span class="line">  b: <span class="number">12</span>,</span><br><span class="line">  c: <span class="string">"bar"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> &#123; a, ...passthrough &#125; = o;</span><br><span class="line"><span class="keyword">let</span> total = passthrough.b + passthrough.c.length</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a); <span class="comment">// foo</span></span><br><span class="line"><span class="built_in">console</span>.log(total); <span class="comment">// 15</span></span><br></pre></td></tr></table></figure>
<p>配合 <code>…</code>，將剩餘的值結構成物件。</p>
<p><code>a</code> 為單一變數，<code>passthrough</code> 為物件。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> C = &#123; a: <span class="built_in">string</span>, b: <span class="built_in">number</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">&#123;a, b&#125;: C</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a); <span class="comment">// foo</span></span><br><span class="line">  <span class="built_in">console</span>.log(b); <span class="comment">// 12</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> o = &#123;</span><br><span class="line">  a: <span class="string">"foo"</span>,</span><br><span class="line">  b: <span class="number">12</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">f(o);</span><br></pre></td></tr></table></figure>
<p>若用在 function 的參數，可以接物件解構成變數。</p>
<h2 id="Spread">Spread</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> first = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="keyword">let</span> second = [<span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="keyword">let</span> bothPlus = [<span class="number">0</span>, ...first, ...second, <span class="number">5</span>];</span><br></pre></td></tr></table></figure>
<p><code>…</code> 會將陣列加以展開。</p>
<p><code>bothPlus</code> 為 <code>[0, 1, 2, 3, 4, 5]</code> 。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> defaults = &#123; food: <span class="string">"spicy"</span>, price: <span class="string">"$$"</span>, ambiance: <span class="string">"noisy"</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> search = &#123; ...defaults, food: <span class="string">"rich"</span> &#125;;</span><br></pre></td></tr></table></figure>
<p><code>…</code> 會將物件屬性加以展開。</p>
<p><code>search</code> 為 <code>{ food: &quot;rich&quot;, price: &quot;$$&quot;, ambiance: &quot;noisy&quot; }</code></p>
<blockquote>
<p>若屬性有重複，將後面蓋前面。</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> C &#123;</span><br><span class="line">  p = <span class="number">12</span>;</span><br><span class="line">  m() &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> c = <span class="keyword">new</span> C();</span><br><span class="line"><span class="keyword">let</span> clone = &#123; ...c &#125;;</span><br><span class="line">clone.p; <span class="comment">// ok</span></span><br><span class="line">clone.m(); <span class="comment">// error!</span></span><br></pre></td></tr></table></figure>
<p><code>…</code> 只能展開 property，不能展開 method。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>實務上應該盡量使用 <code>const</code>，除非變數需要被修改才用 <code>let</code>。</li>
<li>盡量寫出 pure function 減少 side effect。</li>
<li>Destructuring 與 spread 非常好用，可以讓程式碼更精簡。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://www.typescriptlang.org/" target="_blank" rel="external">TypeScript</a>, <a href="https://www.typescriptlang.org/docs/handbook/variable-declarations.html" target="_blank" rel="external">Handbook : Variable Declaration</a></p>
]]></content>
    <summary type="html">
    <![CDATA[ES6 提供不少語法關於變數宣告與建立]]>
    
    </summary>
    
      <category term="TypeScript" scheme="http://oomusou.io/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[TypeScript 之基本型別]]></title>
    <link href="http://oomusou.io/typescript/typescript-basic-type/"/>
    <id>http://oomusou.io/typescript/typescript-basic-type/</id>
    <published>2017-06-15T12:23:43.000Z</published>
    <updated>2017-06-11T13:13:00.000Z</updated>
    <content type="html"><![CDATA[<p>TypeScript 既然稱為 TypeScript，想當然爾型別就是該語言的重頭戲，本文我們來看看 TypeScript 對於 JavaScript 增加了哪些型別支援。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>TypeScript 2.3</p>
<h2 id="Boolean">Boolean</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> isDone: <span class="built_in">boolean</span> = <span class="literal">false</span>;</span><br><span class="line">isDone = <span class="number">1</span>; <span class="comment">// 編譯失敗</span></span><br></pre></td></tr></table></figure>
<p>若值只有 <code>true</code> 與 <code>false</code>，則其型別為 <code>boolean</code>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> isDone = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>若變數可直接由初始值 <code>true</code> 或 <code>false</code> 獲得型別，language service 會加以提示省略型別宣告，但 <code>isDone</code> 本質仍是強型別 <code>boolean</code>，<strong>編譯器會加以檢查</strong>，只是程式不用宣告 <code>boolean</code> 而已。</p>
<h2 id="Number">Number</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> decimal: <span class="built_in">number</span> = <span class="number">6</span>; <span class="comment">// 十進位</span></span><br><span class="line"><span class="keyword">let</span> hex: <span class="built_in">number</span> = <span class="number">0xf00d</span>; <span class="comment">// 0x 開頭為十六進位</span></span><br><span class="line"><span class="keyword">let</span> binary: <span class="built_in">number</span> = <span class="number">0b1010</span>; <span class="comment">// 0b 開頭為二進位 (ES6)</span></span><br><span class="line"><span class="keyword">let</span> octal: <span class="built_in">number</span> = <span class="number">0o744</span>; <span class="comment">// 0o 開頭為八進位 (ES6)</span></span><br></pre></td></tr></table></figure>
<p>TypeScript 與 JavaScript 一樣，數字只有 <code>number</code> 型別，且本質是<strong>浮點數</strong>，不像 C# 數字有 <code>int</code> 、 <code>float</code> 與 <code>double</code>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> decimal = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">let</span> hex = <span class="number">0xf00d</span>;</span><br><span class="line"><span class="keyword">let</span> binary = <span class="number">0b1010</span>;</span><br><span class="line"><span class="keyword">let</span> octal = <span class="number">0o744</span>;</span><br></pre></td></tr></table></figure>
<p>若變數可直接由初始值<strong>數字</strong>獲得型別，language service 會加以提示省略型別宣告，但變數本質仍是強型別 <code>number</code>，<strong>編譯器會加以檢查</strong>，只是程式不用宣告 <code>number</code> 而已。</p>
<h2 id="String">String</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> firstName: <span class="built_in">string</span> = <span class="string">"Sam"</span>;</span><br><span class="line"><span class="keyword">let</span> lastName: <span class="built_in">string</span> = <span class="string">'Xiao'</span>;</span><br><span class="line"><span class="keyword">let</span> sentence: <span class="built_in">string</span> = `Hello, my name is $&#123;firstName&#125; $&#123;lastName&#125;`;</span><br></pre></td></tr></table></figure>
<p>TypeScript 與 JavaScript 一樣，提供 <code>string</code> 型別，有 3 種表示法：</p>
<ul>
<li>雙引號</li>
<li>單引號</li>
<li>Backtick</li>
</ul>
<p>其中 backtick 寫法，稱為 template string，可配合變數直接鑲在字串內，而不用靠 <code>+</code> 湊字串，可讀性較高，實務上建議使用。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> firstName = <span class="string">"Sam"</span>;</span><br><span class="line"><span class="keyword">let</span> lastName = <span class="string">'Xiao'</span>;</span><br><span class="line"><span class="keyword">let</span> sentence = `Hello, my name is $&#123;firstName&#125; $&#123;lastName&#125;`;</span><br></pre></td></tr></table></figure>
<p>若變數可直接由初始值<strong>字串</strong>獲得型別，language service 會加以提示省略型別宣告，但變數本質仍是強型別 <code>string</code>，<strong>編譯器會加以檢查</strong>，只是程式不用宣告 <code>string</code> 而已。</p>
<blockquote>
<p>雖然 TypeScript 允許 string 使用雙引號，但 language service 會提示建議使用單引號。</p>
</blockquote>
<h2 id="Array">Array</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> list: <span class="built_in">number</span>[] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> list: <span class="built_in">Array</span>&lt;<span class="built_in">number</span>&gt; = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br></pre></td></tr></table></figure>
<p>TypeScript 對於陣列提供兩種寫法：</p>
<ul>
<li>傳統 JavaScript 風格寫法。</li>
<li>泛型風格寫法。</li>
</ul>
<blockquote>
<p>兩種寫法可讀性都很高，實務上都推薦，只要團隊取得共識要使用哪種寫法即可。</p>
</blockquote>
<h2 id="Tuple">Tuple</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x: [<span class="built_in">string</span>, <span class="built_in">number</span>];</span><br><span class="line">x = [<span class="string">"hello"</span>, <span class="number">10</span>];</span><br><span class="line">x = [<span class="number">10</span>, <span class="string">"hello"</span>]; <span class="comment">// 編譯失敗</span></span><br></pre></td></tr></table></figure>
<p>陣列必須每個元素的型別都相同，若你希望陣列中有不同型別的元素，則應該使用 <code>tuple</code>。</p>
<blockquote>
<p>實務上若你希望 function 回傳多值，且型態不相同，則可使用 tuple。</p>
</blockquote>
<h2 id="Enum">Enum</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Color &#123;Red, Green, Blue&#125;</span><br><span class="line"><span class="keyword">let</span> c: Color = Color.Green;</span><br></pre></td></tr></table></figure>
<p>Enum 型別是強型別語言的代表，從 C 語言就已經有 enum，C++ 與 C# 也有 <code>enum</code>，但 JavaScript 一直都沒有 <code>enum</code> (未來有的機會也不高)，TypeScript 將之補上，它有幾個優點：</p>
<ul>
<li>參數之間的傳遞不用在使用 magic number，可以透過 enum 取可讀性更高的名字。</li>
<li>Number 不用再直接輸入，可由 enum 型別透過 intellisense 自動帶出。</li>
<li>若輸入 enum 型別沒有的數字，編譯器會幫我們擋下來。</li>
</ul>
<blockquote>
<p>TypeScript 2.4 的 enum 即將支援字串，讓我們透過 enum 可以確保所輸入的是我們要的字串。</p>
</blockquote>
<h2 id="Any">Any</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> notSure: <span class="built_in">any</span> = <span class="number">4</span>;</span><br><span class="line">notSure = <span class="string">"maybe a string instead"</span>; <span class="comment">// 編譯器不會檢查</span></span><br><span class="line">notSure = <span class="literal">false</span>; <span class="comment">// 編譯器不會檢查</span></span><br></pre></td></tr></table></figure>
<p>對於 JavaScript legacy code 或 3rd party library，若一時導入 TypeScript 有其困難，可先暫時宣告為 <code>any</code> 放生，讓 TypeScript 不做型別檢查，日後再慢慢重構成適當型別。</p>
<blockquote>
<p>實務上不建議使用 any 型別，因為這將喪失 TypeScript  的型別檢查機制，除非有充分的理由。</p>
</blockquote>
<h2 id="Void">Void</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">warnUser</span>(<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">   alert(<span class="string">"This is my warning message"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> message = warnUser(); <span class="comment">// 編譯失敗</span></span><br></pre></td></tr></table></figure>
<p>若 function 明確不傳回任何值，可宣告為 <code>void</code> 型別，若將此 function 的回傳值指定為變數，將編譯失敗。</p>
<h2 id="Null_與_Undefined">Null 與 Undefined</h2><p><code>null</code> 與 <code>undefined</code> 一直是寫 JavaScript 很惱人的問題，我們必須在程式碼內判斷輸入的參數是否為 <code>null</code> 或 <code>undefined</code>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Compiled with --strictNullChecks</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">a: <span class="built_in">number</span> , b: <span class="built_in">number</span> | <span class="literal">null</span> </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;  <span class="comment">// Produces value of type number</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 TypeScript 2.0 提供了 strict null check，可以幫我們檢查參數是否為 <code>null</code> 或 <code>undefined</code>。 </p>
<p>若我們參數明確要接受 <code>null</code> 或 <code>undefined</code>，則必須在參數用 <code>|</code>  明確宣告，否則預設不接受 <code>null</code> 與 <code>undefined</code>。</p>
<p><code>a</code> 可接受的型別為 <code>number</code> ，不接受 <code>null</code> 與 <code>undefined</code> ，但 <code>b</code> 可接受的型別為 <code>number</code>、<code>null</code> ，不接受 <code>undefined</code>。</p>
<p>若輸入的參數 <code>a</code> 為 <code>null</code> 或 <code>undefined</code>，將編譯失敗。</p>
<p><img src="/images/typescript/typescript-basic-type/type000.png" alt="type000"></p>
<p>Angular 預設並沒有啟動 <code>strictNullChecks</code>，須在專案根目錄的 <code>tsconfig.json</code> 的 <code>compilerOptions</code> 加上 <code>strictNullChecks</code> 為 <code>true</code>，TypeScript 才會啟動 <code>strictNullChecks</code>。</p>
<h2 id="Never">Never</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error</span>(<span class="params">message: <span class="built_in">string</span></span>): <span class="title">never</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">infiniteLoop</span>(<span class="params"></span>): <span class="title">never</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = error(<span class="string">'Sam'</span>); <span class="comment">// 編譯失敗</span></span><br><span class="line"><span class="keyword">let</span> b = infiniteLoop(<span class="string">'Sam'</span>); <span class="comment">// 編譯失敗</span></span><br></pre></td></tr></table></figure>
<p>有些 function 永遠不傳回值，只會拋出 exception 或無窮回圈，雖然可以回傳 <code>void</code>，<strong>但語意上並不精確</strong>，TypeScript 另外提出 <code>never</code> 型別，專門對付 exception 或無窮迴圈。</p>
<p>若將回傳 <code>never</code> 型別的 function 指定給變數，將編譯失敗。</p>
<h2 id="Type_Assertion">Type Assertion</h2><hr>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> someValue: <span class="built_in">any</span> = <span class="string">'this is a string'</span>;</span><br><span class="line"><span class="keyword">let</span> strLength: <span class="built_in">number</span> = (&lt;<span class="built_in">string</span>&gt;someValue).length;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> someValue: <span class="built_in">any</span> = <span class="string">'this is a string'</span>;</span><br><span class="line"><span class="keyword">let</span> strLength: <span class="built_in">number</span> = (someValue as <span class="built_in">string</span>).length;</span><br></pre></td></tr></table></figure>
<p>實務上有時宣告了 <code>any</code>，但為了 intellisense 或其他變數，需要做明確的轉型，此時可使用 <code>type assertion</code> 明確轉型，也就是告訴編譯器：</p>
<ul>
<li>我自己知道此變數的明確型別，請相信我的轉型。</li>
</ul>
<blockquote>
<p>雖然 type assertion 有兩種寫法，實務上建議使用第一種，第二種是為了 React 的 JSX 所妥協的語法，在 Angular 用不到。</p>
</blockquote>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>透過 TypeScript 的明確型別宣告，可以讓編譯器幫我們檢查傳入參數是否符合型別，不用再寫一堆程式判斷。</li>
<li><code>enum</code> 在實務上非常用有，建議大家多用。</li>
<li>建議大家將 <code>strictNullCheck</code> 打開，讓 TypeScript 編譯器幫我們檢查惱人 <code>null</code> 與 <code>undefined</code>。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://www.typescriptlang.org/" target="_blank" rel="external">TypeScript</a>, <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" rel="external">Handbook : Basic Types</a></p>
]]></content>
    <summary type="html">
    <![CDATA[簡介 TypeScript 所有內建的型別]]>
    
    </summary>
    
      <category term="TypeScript" scheme="http://oomusou.io/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[TypeScript 特色與歷史簡介]]></title>
    <link href="http://oomusou.io/typescript/typescript101/"/>
    <id>http://oomusou.io/typescript/typescript101/</id>
    <published>2017-06-14T12:23:43.000Z</published>
    <updated>2017-06-12T02:08:46.000Z</updated>
    <content type="html"><![CDATA[<p>TypeScript 是 Angular 欽定的開發語言，所以學 Angular 一定要學 TypeScript，但很多人認為 TypeScript 是 JavaScript 的<strong>方言</strong>，不是 JavaScript 標準，因而有所疑慮，本文簡單介紹 TypeScript 的歷史與特色，提供大家技術選擇的參考。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>TypeScript 2.3</p>
<h2 id="什麼是_TypeScript？">什麼是 TypeScript？</h2><hr>
<p><img src="/images/typescript/typescript101/ts000.png" alt="ts000"></p>
<p>在 TypeScript 官網，大大的 3 個字</p>
<blockquote>
<p>JavaScript that scales.</p>
</blockquote>
<p>簡單的說，TypeScript 就是為了讓 JavaScript 可以寫<strong>大型應用程式</strong>的<strong>商業邏輯</strong>所設計，讓 JavaScript 不再只是控制 DOM 而已，而是真的可以寫<strong>複雜</strong>商業邏輯。</p>
<blockquote>
<p>Visual Studio Code 就是使用 TypeScript 開發。</p>
</blockquote>
<p>TypeScript 既然稱為 <strong>Type</strong>Script，重點就是將 JavaScript 加上 <strong>type</strong>。</p>
<ul>
<li>更多型別 (more types) 與強型別檢查</li>
<li>多型 (interface)</li>
<li>泛型 (generic)</li>
</ul>
<p><img src="/images/typescript/typescript101/ts001.svg" alt="ts001"></p>
<p>一旦有了型別，則很多圍繞在<strong>型別</strong>的技術都可在 TypeScript 使用。</p>
<h2 id="TypeScript_的歷史">TypeScript 的歷史</h2><hr>
<p>TypeScript 是由 Turbo Pascal、Delphi、J++ 與 C# 的爸爸 <a href="https://en.wikipedia.org/wiki/Anders_Hejlsberg" target="_blank" rel="external">Anders Hejlsberg</a> 所設計的程式語言，Anders 在很年輕時，就立志要幫 JavaScript 寫一個 compiler，在他 <code>52</code> 歲時，發表了 TypeScript，幫 JavaScript 補上很多<strong>強型別</strong>語言該有的元素，並且相容 JavaScript。</p>
<p><img src="/images/typescript/typescript101/ts002.png" alt="ts002"></p>
<p>只要是 ES5、ES6 有的東西，TypeScript 都會概括承受，所以你原本在 ES5、ES6 的投資，都可以繼續用在 TypeScript。</p>
<p>Angular 團隊原本用自己的 AtScript 開發，它除了有 TypeScript 的強型別外，更擴展了一些東西，當然也包含 ES5、ES6。</p>
<p><img src="/images/typescript/typescript101/ts005.png" alt="ts005"></p>
<p>2015 年 3 月，Angular 團隊決定從原本自己的 AtScript，改用 Microsoft 的 TypeScript，Google 專心於 framework 部分，Microsoft 則專心於程式語言部分，這也是 Google 與 Microsoft 首次攜手合作。</p>
<p><img src="/images/typescript/typescript101/ts003.png" alt="ts003"></p>
<p>原本 Angular 大量依賴 AtScript 的 annotation，為了配合 Angular，TypeScript 根據了 ECMAScript 的 decorator 草案加以實作，在 NG-Conf 2015 也宣布 AtScript 與 TypeScript 合而為一。</p>
<p><img src="/images/typescript/typescript101/ts004.gif" alt="ts004"></p>
<p>在 NG-Conf 2017，Google 宣布 TypeScript 正式成為 Google 內部所使用的語言之一。</p>
<p><img src="/images/typescript/typescript101/ts006.jpg" alt="ts006"></p>
<p>TypeScript 雖然早在 2012 年就上市，但始終叫好不叫座，尤其遠不如 CoffeeScript，但在 2015 年開始有了爆炸性的成長。</p>
<p>因為 TypeScript 總算有殺手級的應用出現：Angular。</p>
<h2 id="為什麼選擇_TypeScript？">為什麼選擇 TypeScript？</h2><hr>
<p>除了 Angular 挑選 TypeScript 外，讓我們回歸<strong>需求面</strong>，為什麼要選擇 TypeScript？</p>
<h3 id="JavaScript_規格與瀏覽器支援">JavaScript 規格與瀏覽器支援</h3><p><img src="/images/typescript/typescript101/ts007.png" alt="ts007"></p>
<p>在今年的 Microsoft Build 2017，<a href="https://en.wikipedia.org/wiki/Anders_Hejlsberg" target="_blank" rel="external">Anders Hejlsberg</a> 提到了 JavaScript 所謂的 feature gap，以往我們在寫 JavaScript 時，都要很在乎瀏覽器是否支援了 JavaScript 某個 keyword 與 function，以目前來說，ES7 (ES2016) 規格都已經出來，但瀏覽器卻只有支援 ES5 與少部份 ES6，因此很多 JavaScript 語言功能根本是看得到但吃不到。</p>
<p>但透過 TypeScript，你立刻就能使用最新的 JavaScript 規格，透過編譯技術將 TypeScript 編譯成 ES5，不用再擔心瀏覽器版本問題。</p>
<h3 id="前端越來越複雜">前端越來越複雜</h3><p>JavaScript 一開始設計只是為了控制 DOM，但隨著 Ajax 與 SPA 出現後，為了更好的使用者體驗，我們開始將一部分的商業邏輯寫在 JavaScript，這也使得前端常常動不動出現上千行的程式碼，JavaScript 的<strong>可維護性</strong>一直受到質疑，因此我們需要一個能夠寫<strong>複雜商業邏輯</strong>的語言。</p>
<blockquote>
<p>JavaScript 的 ES6、ES7 … 已經朝更成熟的語言邁進，不過現階段還不夠成熟，TypeScript 則包含了開發大型應用程式所需要的必要元素。</p>
</blockquote>
<h3 id="強型別_+_編譯_=_大型應用程式的保證">強型別 + 編譯 =  大型應用程式的保證</h3><p>Web 發展之初，由於需求單純，無論是前後端，都放棄了強型別與編譯技術，改用弱型別與解譯技術，但 Web 20 年來的發展，前後端都越來越複雜，弱型別與解譯技術則面臨了強大的挑戰：</p>
<ul>
<li>Framework 越來越龐大，眾多的 class 與 method，弱型別無法 intellisense。</li>
<li>參數沒有型別，也沒有編譯器檢查，因此要撰寫大量的驗證參數的程式碼。</li>
<li>沒有編譯做第一層的把關，因此必須<strong>寫大量測試</strong>取代編譯器，測試的 coverage 必須要拉很高。</li>
</ul>
<blockquote>
<p>你覺得寫型別很麻煩？寫測試不是更麻煩？</p>
<p>你覺得寫測試很麻煩？手動測試不是更麻煩？</p>
</blockquote>
<p>有了<strong>強型別 + 編譯</strong>保護，透過編譯器檢查，讓我們可以少寫很多測試，專注在為<strong>商業邏輯的需求寫測試</strong>，而不是為了追求 coverage 100% ，為測試而寫測試。</p>
<h3 id="Multi-Paradigm">Multi-Paradigm</h3><p>因為 TypeScript 包含 JavaScript (ES5、ES6、ES7 …)，而 JavaScript 比較偏向 FRP (Functional Reactive Programming)，但 TypeScript 有自己的的強型別系統，比較偏向 OOP (Object Oriented Programming) 與 GP (Generic Progrmming)，因此在寫 TypeScript 時，基本上你會有 3 套武器可用：</p>
<ul>
<li><strong>FRP</strong> : Functional Reactive Programming</li>
<li><strong>OOP</strong> : Object Oriented Programming</li>
<li><strong>GP</strong> : Generic Programming</li>
</ul>
<p>可以視專案需求與規模，選擇適當的武器，不再你手上只有錘子，所有的東西都是釘子。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>TypeScript 是我這幾年來，僅見的集<strong>優雅</strong>與<strong>強悍</strong>於一身的程式語言，原本因為 Angular 學習 TypeScript，但最後卻發現對於 TypeScript 的愛遠勝於 Angular。</li>
<li><strong>強型別 + 編譯</strong>才是開發大型應用程式的保證，讓我們可以根據需求寫測試，不是為測試而寫測試。</li>
<li>TypeScript 融合 FRP、OOP 與 GP，在 multi-paradigm 下，你可以選擇適當的武器，不再手中只有錘子。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://en.wikipedia.org/wiki/Anders_Hejlsberg" target="_blank" rel="external">Anders Hejlsberg</a>, <a href="https://www.typescriptlang.org" target="_blank" rel="external">TypeScript</a><br><a href="https://stackoverflow.com/" target="_blank" rel="external">stack overflow</a>, <a href="https://stackoverflow.com/questions/28960934/what-is-difference-between-typescript-and-atscript" target="_blank" rel="external">What is difference between TypeScript and AtScript?</a><br><a href="https://social.msdn.microsoft.com/profile/Jonathan+Turner+%5BMS%5D" target="_blank" rel="external">Jonathan Turner</a>, <a href="https://blogs.msdn.microsoft.com/typescript/2015/03/05/angular-2-built-on-typescript/" target="_blank" rel="external">Angular 2: Built on TypeScript</a><br><a href="https://twitter.com/ngconf" target="_blank" rel="external">@ngconf</a>, <a href="https://twitter.com/ngconf/status/573521849780305920" target="_blank" rel="external">AtScript is TypeScript</a><br><a href="http://developer.telerik.com/author/tvantoll/" target="_blank" rel="external">TJ VanToll</a>, <a href="http://developer.telerik.com/featured/the-rise-of-typescript/" target="_blank" rel="external">The Rise of TypeScript?</a><br><a href="https://build.microsoft.com/" target="_blank" rel="external">Microsoft Build 2017</a>, <a href="https://channel9.msdn.com/Events/Build/2017/B8088" target="_blank" rel="external">What’s new in TypeScript</a></p>
]]></content>
    <summary type="html">
    <![CDATA[以開發者角度看 TypeScript]]>
    
    </summary>
    
      <category term="TypeScript" scheme="http://oomusou.io/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何在 WebStorm 對 Angular 下中斷點 Debug?]]></title>
    <link href="http://oomusou.io/webstorm/webstorm-debug/"/>
    <id>http://oomusou.io/webstorm/webstorm-debug/</id>
    <published>2017-06-07T12:23:43.000Z</published>
    <updated>2017-06-11T07:04:07.000Z</updated>
    <content type="html"><![CDATA[<p>WebStorm 允許我們如同 Visual Studio 一樣，直接在 IDE 內設定<strong>中斷點</strong>，並停止執行在那一行，我們可觀察當時的變數，也可使用 step over、step into、step out 等除錯技巧，重點是它是停止在 TypeScript 上，而非 JavaScript 上。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>WebStorm 2017.1.2<br>Angular CLI 1.0.1<br>Angular 4.1.0</p>
<h2 id="Installation">Installation</h2><hr>
<h3 id="安裝_Chrome_Extension">安裝 Chrome Extension</h3><p><img src="/images/webstorm/webstorm-debug/debug000.png" alt="debug000"></p>
<p>安裝 <code>JetBrains IDE Support</code> Chrome extension。</p>
<h3 id="WebStorm_設定">WebStorm 設定</h3><p><img src="/images/webstorm/webstorm-debug/debug001.png" alt="debug001"></p>
<p><strong><em>Run -&gt; Edit Configurations…</em></strong></p>
<p><img src="/images/webstorm/webstorm-debug/debug002.png" alt="debug002"></p>
<p>按左上角的 <code>+</code>，選擇 <code>JavaScript Debug</code>。</p>
<p><img src="/images/webstorm/webstorm-debug/debug003.png" alt="debug003"></p>
<ul>
<li><strong>URL</strong> : 輸入 <code>http://localhost:4200</code>。</li>
</ul>
<p>按 <code>Apply</code> 與 <code>OK</code> 繼續。</p>
<h2 id="Debug">Debug</h2><hr>
<h3 id="設定_TypeScript_中斷點">設定 TypeScript 中斷點</h3><p><img src="/images/webstorm/webstorm-debug/debug004.png" alt="debug004"></p>
<p>在任意 TypeScript 你想停止的地方，加上<strong>中斷點</strong>。</p>
<h3 id="開始_Debug">開始 Debug</h3><p><img src="/images/webstorm/webstorm-debug/debug005.png" alt="debug005"></p>
<p>使用 <code>ng serve</code> 啟動 Angular CLI 內建 web server，並按下上方的 <code>瓢蟲</code> 開始 debug。</p>
<p><img src="/images/webstorm/webstorm-debug/debug006.png" alt="debug006"></p>
<p>畫面會跳到 Chrome，並在上面顯示 <code>JetBrains IDE Support is debugging this browser</code>.</p>
<p>在 tod 輸入任何值，按 <code>enter</code>。</p>
<p><img src="/images/webstorm/webstorm-debug/debug007.png" alt="debug007"></p>
<p>從 Chrome 自動跳回 WebStorm，並且停到中斷點，顯示目前所有變數與 call stack。</p>
<p><img src="/images/webstorm/webstorm-debug/debug008.png" alt="debug008"></p>
<p>但這樣使用有個前提，就是要產生 source map，我們才有辦法透過 source map 將中斷點停在 TypeScript。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>後端使用<strong>中斷點</strong>的 debug 經驗，一樣可以套用在 TypeScript 與 Angular。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://manuel-rauber.com/author/manuelrauber/" target="_blank" rel="external">Manuel Rauber</a>,<a href="https://manuel-rauber.com/2016/09/30/how-to-debug-angular-2-with-webstorm/" target="_blank" rel="external">How to debug Angular 2 with WebStorm?</a></p>
]]></content>
    <summary type="html">
    <![CDATA[直接在 IDE 下中斷點 debug]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="WebStorm" scheme="http://oomusou.io/tags/WebStorm/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Quokka for WebStorm]]></title>
    <link href="http://oomusou.io/webstorm/webstorm-quokka/"/>
    <id>http://oomusou.io/webstorm/webstorm-quokka/</id>
    <published>2017-06-01T12:23:43.000Z</published>
    <updated>2017-06-01T05:07:50.000Z</updated>
    <content type="html"><![CDATA[<p>Angular CLI 雖然讓我們簡化了前端工具的建置，但有時只想測試或示範 TypeScript，並不想真的去跑 Angular，此時 Quokka 就是我們的好幫手了。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>WebStorm 2017.1.3<br>Quokka 1.0.11</p>
<h2 id="Installation">Installation</h2><hr>
<p><img src="/images/webstorm/webstorm-quokka/quokka000.png" alt="quokka000"></p>
<p><strong><em>WebStorm -&gt; Preferences -&gt; Plugins</em></strong></p>
<p>按 <code>Brose repositories…</code>。</p>
<p><img src="/images/webstorm/webstorm-quokka/quokka001.png" alt="quokka001"></p>
<p>搜尋 <code>Quokka</code>，按 <code>Install</code> 安裝。</p>
<p><img src="/images/webstorm/webstorm-quokka/quokka002.png" alt="quokka002"></p>
<p>安裝完  <code>Quokka</code> 後，按 <code>Restart WebStorm</code> 重新啟動 WebStorm。</p>
<h2 id="執行_Quokka">執行 Quokka</h2><hr>
<p><img src="/images/webstorm/webstorm-quokka/quokka003.png" alt="quokka003"></p>
<p>按 <code>⌘ + ⇧ + N</code> 新增 Scratch File，這並沒有一個實體檔案，只用來測試而已。</p>
<p><img src="/images/webstorm/webstorm-quokka/quokka004.png" alt="quokka004"></p>
<p>可以開始輸入 TypeScript，不需存檔，不需編譯，馬上就可以在下方的 <code>Quokka</code> 視窗看到執行結果，而且在一行的最後面也可以立即顯示這行的執行結果。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>使用 Quokka，就可以在你熟悉的 WebStorm 測試 TypeScript，非常方便。</li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[不用編譯，不用存檔，馬上就可以顯示 TypeScript 結果]]>
    
    </summary>
    
      <category term="TypeScript" scheme="http://oomusou.io/tags/TypeScript/"/>
    
      <category term="WebStorm" scheme="http://oomusou.io/tags/WebStorm/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[TypeScript 之 Type Assertion]]></title>
    <link href="http://oomusou.io/typescript/typescript-type-assertion/"/>
    <id>http://oomusou.io/typescript/typescript-type-assertion/</id>
    <published>2017-05-22T12:23:43.000Z</published>
    <updated>2017-05-28T04:35:02.000Z</updated>
    <content type="html"><![CDATA[<p>C# 有所謂的 Object Initializer，讓我們可以很優雅的建立物件，並且將物件的 field 一次填滿，TypeScript 是否也提供如 C# 一樣的寫法呢？</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>TypeScript 2.2</p>
<h2 id="傳統建立物件方式">傳統建立物件方式</h2><hr>
<p><strong>hero.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Hero &#123;</span><br><span class="line">  name: <span class="built_in">string</span>;</span><br><span class="line">  state: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 class 建立 model。</p>
<p><strong>app.component.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">onAddHeroClick() &#123;</span><br><span class="line">  <span class="keyword">const</span> hero = <span class="keyword">new</span> Hero();</span><br><span class="line">  hero.name = <span class="string">'Sam'</span>;</span><br><span class="line">  hero.state = <span class="string">'active'</span>;</span><br><span class="line">  <span class="keyword">this</span>.heroes.push(hero);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>建立 <code>Hero</code> 物件，然後指定 field 值，最後再 push 進陣列。</p>
<p>這樣寫當然沒有錯，只是必須先透過 constructor 建立物件，然後一一指定 field 值，程式行數會很多，且沒那麼優雅。</p>
<h2 id="C_Sharp">C Sharp</h2><hr>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hero = <span class="keyword">new</span> Hero</span><br><span class="line">&#123;</span><br><span class="line">  Name = <span class="string">"Sam"</span>,</span><br><span class="line">  State = <span class="string">"active"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>C# 的 Object Initializer 允許我們不用透過 constructor，直接在型別後面使用 <code>{}</code>，且 Intellisense 會自動對 field 加以提示。</p>
<p>這種方式比起傳統物件導向寫法優雅。</p>
<h2 id="TypeScript">TypeScript</h2><hr>
<p>在 2015 年，就有人開始討論如何在 TypeScript 提供 Object Initializer，也提出各種語法上的建議。</p>
<p><a href="https://github.com/Microsoft/TypeScript/issues/3895" target="_blank" rel="external">[New Feature] Initialize Classes by Using an Object Initializer#3895</a></p>
<p>TypeScript 有 3 種寫法，可以寫出類似 C# Object Initializer 風格的程式碼。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hero: Hero = &#123;</span><br><span class="line">  name: <span class="string">'Sam'</span>,</span><br><span class="line">  state: <span class="string">'active'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>這種寫法也不用透過 new 與 constructor，語法精簡，且 Intellisense 會自動對 field 加以提示。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hero = &lt;Hero&gt;&#123;</span><br><span class="line">  name: <span class="string">'Sam'</span>,</span><br><span class="line">  state: <span class="string">'active'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>這種寫法也不用透過 new 與 constructor，使用 type assertion，類似泛型的寫法，將 object type 轉成 <code>Hero</code>，語法精簡，且 Intellisense 會自動對 field 加以提示。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hero = &#123;</span><br><span class="line">  name: <span class="string">'Sam'</span>,</span><br><span class="line">  state: <span class="string">'active'</span></span><br><span class="line">&#125; as Hero;</span><br></pre></td></tr></table></figure>
<p>這種寫法也不用透過 new 與 constructor，是 type assertion 的另一種寫法，在最後補上 <code>as</code> 將 object type 轉成 <code>Hero</code>，語法精簡，且 Intellisense 會自動對 field 加以提示。</p>
<h2 id="&lt;Foo&gt;_vs-_as_Foo"><code>&lt;Foo&gt;</code> vs. <code>as Foo</code></h2><hr>
<p><code>&lt;Foo&gt;</code> 與 <code>as Foo</code> 寫法都屬於 type assertion，該用哪一種寫法呢？</p>
<p>一開始 TypeScript 只提供 <code>&lt;Foo&gt;</code>的語法，但這種寫法搭配 JSX 會有問題。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = &lt;<span class="built_in">string</span>&gt;bar;</span><br><span class="line">&lt;<span class="regexp">/string&gt;</span></span><br></pre></td></tr></table></figure>
<p>因此 TypeScript 另外提供 <code>as Foo</code> 寫法給 JSX。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = bar as <span class="built_in">string</span>;</span><br><span class="line">&lt;<span class="regexp">/string&gt;</span></span><br></pre></td></tr></table></figure>
<p>對於 Angular 來說，<code>&lt;Foo&gt;</code> 與 <code>as Foo</code> 都可以用，但就語意而言，<code>&lt;Foo&gt;</code> 寫法較優。</p>
<p>因為 type assertion 是在<strong>編譯時期</strong>的<strong>靜態轉型</strong>，而非<strong>執行時期</strong>的<strong>動態轉型</strong>，使用泛型的 <code>&lt;&gt;</code> 符號較能彰顯其<strong>編譯時期</strong>的特性。</p>
<h2 id="Type_Assertion_vs-_Type_Casting">Type Assertion vs. Type Casting</h2><hr>
<p>或許你會覺得 type assertion 就是一種轉型而已，只是使用了 <code>&lt;Foo&gt;</code> 或 <code>as Foo</code> 的語法，但事實上並不是如此。</p>
<p>在 TypeScript PlayGround，我們可以發現使用 type assertion 之後的 JavaScript 的差異：</p>
<p><strong>TypeScript</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hero = &lt;Hero&gt;&#123;</span><br><span class="line">  name: <span class="string">'Sam'</span>,</span><br><span class="line">  state: <span class="string">'active'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>JavaScript</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hero = &#123;</span><br><span class="line"> name: <span class="string">'Sam'</span>,</span><br><span class="line"> state: <span class="string">'active'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>也就是對於 JavaScript 而言，並沒有所謂的 <code>Hero</code> 型別，只是 <code>object</code> 型別，所以並沒有所謂的<strong>執行時期</strong>的<strong>動態轉型</strong>，type assertion 實際上只有兩個功能：</p>
<ul>
<li>編譯時期的型別檢查</li>
<li>開發時期的 Intellisense。</li>
</ul>
<h2 id="Type_Assertion_的盲點">Type Assertion 的盲點</h2><hr>
<p>Type assertion 並非萬靈丹，事實上它有以下盲點，回顧一下我們的 model：</p>
<p><strong>hero.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Hero &#123;</span><br><span class="line">  name: <span class="built_in">string</span>;</span><br><span class="line">  state: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hero 有兩個 fields。</p>
<p><img src="/images/typescript/typescript-assertion/assert000.png" alt="assert000"></p>
<p>使用 <code>&lt;Hero&gt;</code> 寫法，就算少寫了 <code>state</code>，TypeScript language service 與 TSLint 都不會警告，且編譯後也沒有錯誤。</p>
<p><img src="/images/typescript/typescript-assertion/assert001.png" alt="assert001"></p>
<p>改用了 <code>as Hero</code> 寫法依舊，就算少寫了 <code>state</code>，TypeScript language service 與 TSLint 都不會警告，且編譯後也沒有錯誤。</p>
<p><img src="/images/typescript/typescript-assertion/assert002.png" alt="assert002"></p>
<p>若使用了型別宣告，少寫了 <code>state</code>，TypeScript language service 會提出警告，編譯也會失敗，明確告知少指定了 <code>state</code> fields。</p>
<blockquote>
<p>以上 3 種寫法，Intellisense 皆正常，但只有明確宣告型別，才能完整檢查出少了 field。</p>
</blockquote>
<h2 id="Nullable">Nullable</h2><hr>
<p>若 model 有些 field 允許不指定值，卻又希望 TypeScript 強型別檢查呢？</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Hero &#123;</span><br><span class="line">  name: <span class="built_in">string</span>;</span><br><span class="line">  state？: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>請在 field 名稱後方加上 <code>?</code>，則 TypeScript language service 不會提出警告，編譯也不會失敗。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Type Assertion 並非最完美的強型別解決方案，只能對 Intellisense 有幫助。</li>
<li>若要完整的檢查，還是要明確的指定型別，如此才能發揮 TypeScript 的 type 威力。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/NG4TypeAssertion" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://github.com/Microsoft/TypeScript" target="_blank" rel="external">TypeScript</a>, <a href="https://github.com/Microsoft/TypeScript/issues/3895" target="_blank" rel="external">[New Feature] Initialize Classes by Using an Object Initializer#3895</a><br><a href="https://www.gitbook.com/book/basarat/typescript/details" target="_blank" rel="external">TypeScript Deep Dive</a>, <a href="https://basarat.gitbooks.io/typescript/docs/types/type-assertion.html" target="_blank" rel="external">Type Assertion</a></p>
]]></content>
    <summary type="html">
    <![CDATA[釐清 Type Assertion 觀念與盲點]]>
    
    </summary>
    
      <category term="TypeScript" scheme="http://oomusou.io/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[使用 Observable Data Service]]></title>
    <link href="http://oomusou.io/angular/angular-observable-data-service/"/>
    <id>http://oomusou.io/angular/angular-observable-data-service/</id>
    <published>2017-04-24T12:23:43.000Z</published>
    <updated>2017-04-24T13:32:31.000Z</updated>
    <content type="html"><![CDATA[<p>在 <a href="/angular/angular-ngrx/">Angular 也走 Redux 風 (使用 Ngrx)</a> 一文中，我們使用了 <code>Ngrx</code> 這種 <code>Redux</code> 風格的 store 來處理 component 之間共用的 state，雖然可行，但有一點 over design，在 RxJS 出現後，我們使用 Observable Data Service 也能實現出相同的效果。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>macOS 10.12.4<br>Angular CLI 1.0.0<br>Angular 4.0.1</p>
<h2 id="Todo_範例">Todo 範例</h2><hr>
<p><img src="/images/angular/ods/service000.png" alt="service000"></p>
<h3 id="AppModule">AppModule</h3><p><strong>app.module.ts</strong><span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/TodoObservable/blob/master/src/app/app.module.ts" target="_blank" rel="external">app.module.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;BrowserModule&#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NgModule&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;FormsModule&#125; from <span class="string">'@angular/forms'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;HttpModule&#125; from <span class="string">'@angular/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;AppComponent&#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;TodoListComponent&#125; from <span class="string">'./components/todo-list/todo-list.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;TodoDashboardComponent&#125; from <span class="string">'./components/todo-dashboard/todo-dashboard.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;TodoService&#125; from <span class="string">'./services/todo/todo.service'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    TodoListComponent,</span><br><span class="line">    TodoDashboardComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule,</span><br><span class="line">    FormsModule,</span><br><span class="line">    HttpModule</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    TodoService</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>22 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  TodoService</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>須在 <code>AppModule</code> 的 <code>providers</code> 加入 <code>TodoService</code>。</p>
<h3 id="Component">Component</h3><h4 id="AppComponent">AppComponent</h4><p><strong>app.component.html</strong><span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>GitHub Commit : <a href="https://github.com/oomusou/TodoObservable/blob/master/src/app/app.component.html" target="_blank" rel="external">app.component.html</a></span></span></span></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">h1</span>&gt;</span>Todo<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-todo-list</span>&gt;</span><span class="tag">&lt;/<span class="title">app-todo-list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-todo-dashboard</span>&gt;</span><span class="tag">&lt;/<span class="title">app-todo-dashboard</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>包含了 <code>TodoList</code> 與 <code>TodoDashboard</code> 兩個 component。</p>
<h4 id="TodoList">TodoList</h4><p><strong>todo-list.component.html</strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/TodoObservable/blob/master/src/app/components/todo-list/todo-list.component.html" target="_blank" rel="external">todo-list.component.html</a></span></span></span></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> #<span class="attribute">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"addTodo(title)"</span>&gt;</span>Add<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">li</span> *<span class="attribute">ngFor</span>=<span class="value">"let todo of todos|async"</span>&gt;</span></span><br><span class="line">    &#123;&#123; todo.title &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"removeTodo(todo.id)"</span>&gt;</span>Remove<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>todos</code> 為 <code>Observable</code>，需加上 <code>async</code> 將 <code>Observable</code> 來 subscribe 與 unsubscribe。</p>
<p>但這有個限制，<code>todos</code> 必須為宣告成 <code>Observable&lt;Todo[]&gt;</code> 型別。</p>
<p>Component 包含了<code>Add</code> 與 <code>Remove</code> 2 個 button。</p>
<p><strong>todo-list.component.ts</strong><span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/TodoObservable/blob/master/src/app/components/todo-list/todo-list.component.ts" target="_blank" rel="external">todo-list.component.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;TodoService&#125; from <span class="string">'../../services/todo/todo.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Todo&#125; from <span class="string">'../../models/todo'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Observable&#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-todo-list'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./todo-list.component.html'</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> TodoListComponent &#123;</span><br><span class="line">  todos: Observable&lt;Todo[]&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private todoService: TodoService) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.todos = <span class="keyword">this</span>.todoService.getTodos();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addTodo(input: HTMLInputElement) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!input.value) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.todoService.addTodo(input.value);</span><br><span class="line"></span><br><span class="line">    input.value = <span class="string">''</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removeTodo(id: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.todoService.removeTodo(id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private todoService: TodoService) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.todos = <span class="keyword">this</span>.todoService.getTodos();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將  <code>TodoService</code> 依賴注入。</p>
<p>由 <code>TodoService.getTodos()</code> 回傳所有 <code>todos</code>， 此為 <code>Observable</code> 型別。</p>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">todos: Observable&lt;Todo[]&gt;;</span><br></pre></td></tr></table></figure>
<p>宣告 <code>todos</code> 為 <code>Observable</code> 型別，其泛型為 <code>Todo[]</code>。</p>
<blockquote>
<p>為什麼 <code>todos</code> 不是 <code>Todo[]</code> 型別，而是 <code>Observable&lt;Todo[]&gt;</code> 呢？因為 <code>TodoService.getTodos()</code>回傳的型別為 <code>Observable</code>。</p>
</blockquote>
<p>17 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">addTodo(input: HTMLInputElement) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!input.value) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.todoService.addTodo(input.value);</span><br><span class="line"></span><br><span class="line">  input.value = <span class="string">''</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Add</code> button 的 event handler。</p>
<p>呼叫 <code>TodoService</code> 的 <code>addTodo()</code>，並直接傳入欲新增的 todo。</p>
<blockquote>
<p>使用 Observable Data Service 時，就不必呼叫 <code>Ngrx</code> 的 <code>dispatch()</code> 與傳入 action 與 payload，直接呼叫 service 的 method 與傳入資料即可。</p>
</blockquote>
<p>27 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">removeTodo(id: <span class="built_in">number</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.todoService.removeTodo(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Remove</code> button 的 event handler。</p>
<p>呼叫 <code>TodoService</code> 的 <code>removeTodo()</code>，並直接傳入欲移除的 id。</p>
<h4 id="TodoDashboard">TodoDashboard</h4><p><strong>todo-dashboard.component.html</strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/TodoObservable/blob/master/src/app/components/todo-dashboard/todo-dashboard.component.html" target="_blank" rel="external">todo-dashboard.component.html</a></span></span></span></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span></span><br><span class="line">  Last Update: &#123;&#123; lastUpdate | async | date:'mediumTime'&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span></span><br><span class="line">  Total items: &#123;&#123; (todos | async ).length &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"clearTodos()"</span>&gt;</span>Delete All<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>顯示最後更新時間與 <code>Todo</code> 筆數。</p>
<p><code>lastUpdate</code> 與 <code>todos</code> 均為 <code>Observable</code>，需加上 <code>async</code> 將 <code>Observable</code> 來 subscribe 與 unsubscribe。</p>
<p>Component 包含了 <code>Clear All</code> button。</p>
<p><strong>todo-dashboard.component.ts</strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/TodoObservable/blob/master/src/app/components/todo-dashboard/todo-dashboard.component.ts" target="_blank" rel="external">todo-dashboard.component.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;TodoService&#125; from <span class="string">'../../services/todo/todo.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Todo&#125; from <span class="string">'../../models/todo'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Observable&#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-todo-dashboard'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./todo-dashboard.component.html'</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> TodoDashboardComponent &#123;</span><br><span class="line">  todos: Observable&lt;Todo[]&gt;;</span><br><span class="line">  lastUpdate: Observable&lt;<span class="built_in">Date</span>&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private todoService: TodoService) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.todos = <span class="keyword">this</span>.todoService.getTodos();</span><br><span class="line">    <span class="keyword">this</span>.lastUpdate = <span class="keyword">this</span>.todoService.getLastUpdate();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  clearTodos() &#123;</span><br><span class="line">    <span class="keyword">this</span>.todoService.clearTodos();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private todoService: TodoService) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.todos = <span class="keyword">this</span>.todoService.getTodos();</span><br><span class="line">  <span class="keyword">this</span>.lastUpdate = <span class="keyword">this</span>.todoService.getLastUpdate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將  <code>TodoService</code> 依賴注入。</p>
<p>由 <code>TodoService.getTodos()</code> 回傳所有 <code>todos</code>， 此為 <code>Observable</code> 型別。</p>
<p>由 <code>TodoService.getLastUpdate()</code> 回傳 <code>LastUpdate</code>， 此為 <code>Observable</code> 型別。</p>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">todos: Observable&lt;Todo[]&gt;;</span><br><span class="line">lastUpdate: Observable&lt;<span class="built_in">Date</span>&gt;;</span><br></pre></td></tr></table></figure>
<p>宣告 <code>todos</code> 為 <code>Observable</code> 型別，其泛型為 <code>Todo[]</code>。</p>
<p>宣告 <code>lastUpdate</code> 為 <code>Observable</code> 型別，其泛型為 <code>Date</code>。</p>
<p>19 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clearTodos() &#123;</span><br><span class="line">  <span class="keyword">this</span>.todoService.clearTodos();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Clear All</code> button 的 event handler。</p>
<p>呼叫 <code>TodoService</code> 的 <code>clearTodos()</code>。</p>
<h3 id="Services">Services</h3><h4 id="TodoService">TodoService</h4><p><strong>todo.service.ts</strong><span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>GitHub Commit : <a href="https://github.com/oomusou/TodoObservable/blob/master/src/app/services/todo/todo-state.ts" target="_blank" rel="external">todo.service.ts</a></span></span></span><br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Injectable&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Todo&#125; from <span class="string">'../../models/todo'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;BehaviorSubject&#125; from <span class="string">'rxjs/BehaviorSubject'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Observable&#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;INITIAL_TODO, TodoState&#125; from <span class="string">'./todo-state'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'rxjs/add/operator/pluck'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> TodoService &#123;</span><br><span class="line">  <span class="keyword">private</span> subject = <span class="keyword">new</span> BehaviorSubject&lt;TodoState&gt;(INITIAL_TODO_STATE);</span><br><span class="line"></span><br><span class="line">  getTodos(): Observable&lt;Todo[]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.subject.pluck(<span class="string">'todos'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getLastUpdate(): Observable&lt;<span class="built_in">Date</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.subject.pluck(<span class="string">'lastUpdate'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addTodo(title: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;todos&#125; = <span class="keyword">this</span>.subject.getValue();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.subject.next(&#123;</span><br><span class="line">      todos: [...todos, &#123;</span><br><span class="line">        id: todos.length + <span class="number">1</span>,</span><br><span class="line">        title: title</span><br><span class="line">      &#125;],</span><br><span class="line">      lastUpdate: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removeTodo(id: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;todos&#125; = <span class="keyword">this</span>.subject.getValue();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.subject.next(&#123;</span><br><span class="line">      todos: todos.filter(todo =&gt; todo.id !== id),</span><br><span class="line">      lastUpdate: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  clearTodos() &#123;</span><br><span class="line">    <span class="keyword">this</span>.subject.next(&#123;</span><br><span class="line">      todos: [],</span><br><span class="line">      lastUpdate: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>全部的 state 邏輯都在 <code>TodoService</code> 內。</p>
<p>第 8 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> TodoService &#123;</span><br></pre></td></tr></table></figure>
<p>使用 Angular 標準的 service。</p>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> subject = <span class="keyword">new</span> BehaviorSubject&lt;TodoState&gt;(INITIAL_TODO_STATE);</span><br></pre></td></tr></table></figure>
<p><code>subject</code> 為實際儲存 Observable state 之處，為 <code>BehaviorSubject</code> 型別，<code>TodoState</code> 包含 <code>Todo[]</code> 與  <code>LastUpdate</code>。</p>
<blockquote>
<p>什麼是 BehaviorSubject？</p>
</blockquote>
<p>根據 RxJS source code</p>
<p><strong>BehaviorSubject.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> BehaviorSubject&lt;T&gt; extends Subject&lt;T&gt; &#123;</span><br></pre></td></tr></table></figure>
<p><code>BehaviorSubject</code> 繼承於 <code>Subject</code>。</p>
<p><strong>Subject.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> Subject&lt;T&gt; extends Observable&lt;T&gt; <span class="keyword">implements</span> ISubscription &#123;</span><br></pre></td></tr></table></figure>
<p><code>Subject</code> 繼承於 <code>Observable</code>。</p>
<p>也就是 <code>Observable</code> 所有的特性，<code>Subject</code> 與 <code>BehaviorSubject</code> 都有，如 <code>subscribe()</code> 與 RxJS 的 operator 操作。</p>
<p><code>Subject</code> 與 <code>BehaviorSubject</code> 算是一種特殊的 <code>Observable</code>，提供一些原本 <code>Observable</code> 沒有的功能。</p>
<blockquote>
<p>Observable 與 Subject 的差異？</p>
</blockquote>
<p><code>Subject</code> 多提供了 <code>next()</code>，允許我們手動將值送進 <code>Observable</code>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> subject = <span class="keyword">new</span> Subject();</span><br><span class="line">subject.subscribe((value) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Subscription got '</span>, value);</span><br><span class="line">&#125;);</span><br><span class="line">subject.next(<span class="string">'Hello World'</span>);</span><br><span class="line"><span class="comment">// Subscription got Hello World</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Subject 與 BehaviorSubject 的差異？</p>
</blockquote>
<p>可提供初始值給 <code>BehaviorSubject</code>，使用端只要 <code>subscribe()</code> 就能收到初始值。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> subject = <span class="keyword">new</span> BehaviorSubject(<span class="string">'Hello World'</span>);</span><br><span class="line">subject.subscribe((value) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Subscription got '</span>, value);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Subscription got Hello World</span></span><br><span class="line">subject.next(<span class="string">'Hello Taiwan'</span>)</span><br><span class="line"><span class="comment">// Subscription got Hello Taiwan</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>Subject</code> 是在 <code>subscribe()</code> 之後，若將來的資料有變動，會得到通知並新資料。</li>
<li><code>BehaviorSubject</code> 是在 <code>subscribe()</code> 時，就能得到資料，因此可設定初始值。</li>
</ul>
<p>因為希望能自己手動更新 state，且有初始值，所以我們選擇使用 <code>BehaviorSubject</code>，而非 <code>Observable</code> 或 <code>Subject</code>。</p>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getTodos(): Observable&lt;Todo[]&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.subject.pluck(<span class="string">'todos'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回傳 <code>todos[]</code> 給使用端，型別為 <code>Observable&lt;Todo[]&gt;</code>。</p>
<blockquote>
<p>因為 <code>Subject</code> 是一種特殊的 <code>Observable</code>，所以也有 <code>pluck</code> operator，取出 <code>todos</code> 屬性值回傳。</p>
</blockquote>
<p>16 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getLastUpdate(): Observable&lt;<span class="built_in">Date</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.subject.pluck(<span class="string">'lastUpdate'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回傳 <code>lastUpdate</code> 給使用端，型別為 <code>Observable&lt;Date&gt;</code>。</p>
<blockquote>
<p>因為 <code>Subject</code> 是一種特殊的 <code>Observable</code>，所以也有 <code>pluck</code> operator，取出 <code>lastUpdate</code> 屬性值回傳。</p>
</blockquote>
<p>第 6 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'rxjs/add/operator/pluck'</span>;</span><br></pre></td></tr></table></figure>
<p>使用 <code>pluck</code> 時，需單獨 import 進來。</p>
<p>20 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">addTodo(title: <span class="built_in">string</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;todos&#125; = <span class="keyword">this</span>.subject.getValue();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.subject.next(&#123;</span><br><span class="line">    todos: [...todos, &#123;</span><br><span class="line">      id: todos.length + <span class="number">1</span>,</span><br><span class="line">      title: title</span><br><span class="line">    &#125;],</span><br><span class="line">    lastUpdate: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新增 todo 進 <code>BehaviorSubject</code>。</p>
<p>使用 <code>Subject.getValue()</code> 回傳目前 <code>BehaviorSubject</code> 內的 state。</p>
<p>使用 <code>Subject.next()</code> 寫入新的 state 進 <code>BehaviorSubject</code> 。</p>
<p>21 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;todos&#125; = <span class="keyword">this</span>.subject.getValue();</span><br></pre></td></tr></table></figure>
<p><code>Subject.getValue()</code> 會回傳 <code>TodoState</code> 型別</p>
<p><strong>todo-state.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> TodoState </span>&#123;</span><br><span class="line">  todos: Todo[];</span><br><span class="line">  lastUpdate: <span class="built_in">Date</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>內有 <code>todos</code> 與 <code>lastUpdate</code> 兩個屬性，可使用 TypeScript 2.1 的 object destruction 將物件的屬性直接拆成兩個變數。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;todos, lastUpdate&#125; = <span class="keyword">this</span>.subject.getValue();</span><br></pre></td></tr></table></figure>
<p>因為 <code>lastUpdate</code> 目前用不到，只想取 <code>todos</code> 即可，因此省略成</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;todos&#125; = <span class="keyword">this</span>.subject.getValue();</span><br></pre></td></tr></table></figure>
<p>32 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">removeTodo(id: <span class="built_in">number</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;todos&#125; = <span class="keyword">this</span>.subject.getValue();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.subject.next(&#123;</span><br><span class="line">    todos: todos.filter(todo =&gt; todo.id !== id),</span><br><span class="line">    lastUpdate: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>從 <code>BehaviorSubject</code> 移除 todo。</p>
<p>34 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">clearTodos() &#123;</span><br><span class="line">  <span class="keyword">this</span>.todos = [];</span><br><span class="line">  <span class="keyword">this</span>.updateSubject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>從 <code>BehaviorSubject</code> 移除全部 todo。</p>
<h4 id="TodoState">TodoState</h4><p><strong>todo-state.ts</strong><span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>GitHub Commit : <a href="https://github.com/oomusou/TodoObservable/blob/master/src/app/services/todo/todo.service.ts" target="_blank" rel="external">todo-state.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Todo&#125; from <span class="string">'../../models/todo'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> TodoState </span>&#123;</span><br><span class="line">  todos: Todo[];</span><br><span class="line">  lastUpdate: <span class="built_in">Date</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INITIAL_TODO_STATE: TodoState = &#123;todos: [], lastUpdate: <span class="literal">null</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>定義 state 型別。</p>
<p>第 3 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> TodoState </span>&#123;</span><br><span class="line">  todos: Todo[];</span><br><span class="line">  lastUpdate: <span class="built_in">Date</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定義 <code>TodoState</code> 與其 field。</p>
<p>其中 <code>todos</code> 為 <code>Todo</code> 型別的陣列。</p>
<p>第 8 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INITIAL_TODO_STATE: TodoState = &#123;todos: [], lastUpdate: <span class="literal">null</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>定義 <code>INITIAL_TODO_STATE</code> 常數，為 <code>TodoState</code> 的初始狀態。</p>
<h3 id="Models">Models</h3><h4 id="Todo">Todo</h4><p><strong>todo.ts</strong><span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>GitHub Commit : <a href="https://github.com/oomusou/TodoObservable/blob/master/src/app/models/todo.ts" target="_blank" rel="external">todo.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> Todo </span>&#123;</span><br><span class="line">  id: <span class="built_in">number</span>;</span><br><span class="line">  title: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定義 <code>Todo</code> 型別。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>對於 component 來說，無論使用了 <code>Ngrx/store</code> 或 Observable Data Service，都是使用 Observable，與 state 的維護方式完全解耦合。</li>
<li>使用了 <code>BehaviorSubject</code> 後，我們能手動透過 <code>next()</code> 維護新的 state，並能通知 component 自動更新，原本跨 component 維護 state 問題將獲得解決。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/TodoObservable" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://forum.angular.tw" target="_blank" rel="external">Angular User Group Taiwan</a>, <a href="https://forum.angular.tw/t/behavior-subject-observable/285" target="_blank" rel="external">請問 Behavior Subject 與 Observable 的差異？</a><br><a href="http://stackoverflow.com/" target="_blank" rel="external">stackoverflow</a>, <a href="http://stackoverflow.com/questions/39494058/angular-2-behavior-subject-vs-observable" target="_blank" rel="external">Angular 2 - Behavior Subject vs Observable?</a><br><a href="https://angular-university.io/" target="_blank" rel="external">Angular University</a>, <a href="http://blog.angular-university.io/how-to-build-angular2-apps-using-rxjs-observable-data-services-pitfalls-to-avoid/" target="_blank" rel="external">How to build Angular apps using Observable Data Services - Pitfalls to avoid</a><br><a href="http://jasonwatmore.com/" target="_blank" rel="external">Jason Watmore</a>, <a href="http://jasonwatmore.com/post/2016/12/01/angular-2-communicating-between-components-with-observable-subject" target="_blank" rel="external">Angular 2 - Communicating Between Components with Observable &amp; Subject</a></p>
]]></content>
    <summary type="html">
    <![CDATA[使用 RxJS 的 BehaviorSubject]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="RxJS" scheme="http://oomusou.io/tags/RxJS/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[迪米特法則]]></title>
    <link href="http://oomusou.io/oop/oop-demeter/"/>
    <id>http://oomusou.io/oop/oop-demeter/</id>
    <published>2017-04-20T12:23:43.000Z</published>
    <updated>2017-04-21T23:12:01.000Z</updated>
    <content type="html"><![CDATA[<p><strong>迪米特法則</strong>也稱為<strong>最小知識原則</strong>，是物件導向 <code>SOLID</code> 原則中的 <code>L</code> 其中之一 <code>LKP</code> ( Least Knowledge Principle)，是 1987 年 Ian Holland 在美國東北大學所提出，此法則應用在其 The Demeter Project 而得名，是物件導的基本原則。</p>
<a id="more"></a>
<h2 id="Motivation">Motivation</h2><hr>
<p>很多人沒有認清<strong>迪米特法則</strong>的本質，只要看到類似 Clean Code p. 110 書中提到的 <code>Train Wreck</code> 風格的程式碼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String outputDir = ctxt.getOptions().getScratchDir().getAbsolutePath();</span><br></pre></td></tr></table></figure>
<p>就認為違反的迪米特法則，真的是這樣嗎？</p>
<h2 id="定義">定義</h2><hr>
<blockquote>
<p>高階模組不應該知道低階模組的內部如何運作。</p>
<p>低階模組不應該<strong>暴露內部物件</strong>，不應該<strong>暴露實踐細節</strong>，應僅提供方法給高階模組使用。</p>
</blockquote>
<p>白話就是</p>
<blockquote>
<p>Controller 不應該知道 service 的內部如何運作。</p>
<p>Service 應該將內部所用的其它 service 封裝起來，提供 method 給 controller 使用，而非直接提供內部 service 給 controller 呼叫。</p>
</blockquote>
<h2 id="Train_Wreck">Train Wreck</h2><hr>
<p><strong>SMSService</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMSService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getMessage</span><span class="params">()</span>: <span class="title">string</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Message'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SMSService</code> 僅有一個 <code>getMessage()</code>。</p>
<p><strong>NotificationService</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotificationService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> SMSService */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$smsService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * NotificationService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> SMSService $smsService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SMSService <span class="variable">$smsService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;smsService = <span class="variable">$smsService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@return</span> SMSService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSMSService</span><span class="params">()</span>: <span class="title">SMSService</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;smsService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>NotificationService</code> 相依了 <code>SMSService</code>，直接使用 <code>getSMSService()</code> 將  <code>SMSService</code> 物件傳出去。</p>
<p><strong>PostController</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">NotificationService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">View</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> NotificationService */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$notificationService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostController constructor.</span><br><span class="line">     * <span class="doctag">@param</span> NotificationService $notificationService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(NotificationService <span class="variable">$notificationService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;notificationService = <span class="variable">$notificationService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 顯示所有簡訊</span><br><span class="line">     * <span class="doctag">@return</span> View</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">'message'</span>] = <span class="variable">$this</span>-&gt;notificationService-&gt;getSMSService()-&gt;getMessage();</span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'posts.index'</span>, <span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>getSMSService()</code> 傳回  <code>SMSService</code> 物件，導致 controller 必須寫出 <code>Train Wreck</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$this</span>-&gt;notificationService-&gt;getSMSService()-&gt;getMessage();</span><br></pre></td></tr></table></figure>
<p>這種寫法有幾個缺點 :</p>
<ul>
<li><code>PostController</code> 與 <code>NotificationService</code> 內部的 <code>SMSService</code> 強烈耦合，若想要換掉 <code>SMSService</code> 物件，則 <code>PostController</code> 必須跟著修改，也就是<strong>暴露內部物件</strong>。</li>
<li><code>PostController</code> 為了要顯示 message，竟然還必須知道 <code>NotificationService</code> 內部使用了 <code>SMSService</code> 物件，先使用 <code>getSMSService()</code> 才行，也就是<strong>暴露實踐細節</strong>。</li>
<li>違反了物件導向的<strong>封裝</strong>原則，<code>PostController</code> 竟然可以將手伸進去執行 <code>SMSService</code> 的方法。</li>
</ul>
<blockquote>
<p>簡單來說，<strong>迪米特法則</strong>就是物件導向<strong>封裝</strong>特性的具體實現。</p>
</blockquote>
<p>建議將以上程式碼重構成以下寫法</p>
<p><strong>NotificationService</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotificationService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> SMSService */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$smsService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * NotificationService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> SMSService $smsService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SMSService <span class="variable">$smsService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;smsService = <span class="variable">$smsService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getMessage</span><span class="params">()</span>: <span class="title">string</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;smsService-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>PostController</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">NotificationService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">View</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> NotificationService */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$notificationService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostController constructor.</span><br><span class="line">     * <span class="doctag">@param</span> NotificationService $notificationService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(NotificationService <span class="variable">$notificationService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;notificationService = <span class="variable">$notificationService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">'message'</span>] = <span class="variable">$this</span>-&gt;notificationService-&gt;getMessage();</span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'posts.index'</span>, <span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重構之後，<code>PostController</code> 不再出現 <code>Train Wreck</code> 。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$this</span>-&gt;notificationService-&gt;getMessage();</span><br></pre></td></tr></table></figure>
<ul>
<li><code>PostController</code> 完全不知道<code>NotificationService</code>的<strong>內部物件</strong>，若想要換掉 <code>SMSService</code> 物件，則 <code>PostController</code> 完全不用修改。</li>
<li><code>PostController</code> 為了要顯示 message，不必再知道<strong>實踐細節</strong>， 直接使用 <code>getMessage()</code> 就可以抓到資料。</li>
<li>符合了物件導向的<strong>封裝</strong>原則，<code>PostController</code> 無法將手伸進去執行 <code>SMSService</code> 的方法。</li>
</ul>
<blockquote>
<p>當 service 直接將內部使用的 service 傳出後，逼 controller 必須先了解其內部實踐細節，使得 controller 與 service 的內部其它 service 強烈耦合，這違反了物件導向<strong>封裝</strong>特性，也違反了<strong>迪米特法則</strong>。</p>
<p>違反<strong>迪米特法則</strong>，通常會寫出 <code>Train Wreck</code> ，因此可使用 <code>Train Wreck</code> 檢查是否違反<strong>迪米特法則</strong>。</p>
</blockquote>
<h2 id="最小知識原則">最小知識原則</h2><hr>
<p>物件導向 <code>SOLID</code> 原則的<strong>最小知識原則</strong> <code>LKP</code> (Least Knowledge Principle)，事實上與<strong>迪米特法則</strong>講的是同一件事情。</p>
<blockquote>
<p>一個物件應該對其他物件有最少的了解。</p>
</blockquote>
<p>白話就是</p>
<blockquote>
<p>Controller 應該以最簡單的方式使用 service。</p>
</blockquote>
<p>之前的 <code>PostController</code> ，因為違反了<strong>迪米特法則</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$this</span>-&gt;notificationService-&gt;getSMSService()-&gt;getMessage();</span><br></pre></td></tr></table></figure>
<p>因此必須知道<code>NotificationService</code>  與 <code>SMSService</code> 之後才能 <code>getMessage()</code>。</p>
<p>但重構之後</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$this</span>-&gt;notificationService-&gt;getMessage();</span><br></pre></td></tr></table></figure>
<p>只要知道 <code>NotificationService</code> 就可以 <code>getMessage()</code>了。</p>
<blockquote>
<p> 符合<strong>最小知識原則</strong>，自然符合<strong>迪米特法則</strong>。</p>
</blockquote>
<h2 id="再論_Train_Wreck">再論 Train Wreck</h2><hr>
<p>我們知道違法<strong>迪米特法則</strong>會寫出 <code>Train Wreck</code>，但寫出 <code>Train Wreck</code> 一定違反<strong>迪米特法則</strong>嗎？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String outputDir = ctxt.getOptions().getScratchDir().getAbsolutePath();</span><br></pre></td></tr></table></figure>
<p>Clean Code p.111 認為，要看 <code>getOptions()</code> 、<code>getScratchDir()</code> 與 <code>getAbolutePath()</code> 回傳的是 object 還是 data structure？</p>
<blockquote>
<p>這裡的 data structure 不是我們在學校念書時所謂的<strong>資料結構</strong>，如 linked list、tree 那些，而是指一個<strong>物件只有資料，沒有任何商業邏輯</strong>。</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class Student&#10;&#123;&#10;    public $id;&#10;    public $name;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>這種完全用 public field 的物件算 data structure。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> int */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$id</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(int <span class="variable">$id</span>, string <span class="variable">$name</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;id = <span class="variable">$id</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getId</span><span class="params">()</span> </span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;id;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;name;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>儘管多了 constructor 與 getter，它還是 data structure，因為沒有任何商業邏輯。</p>
<blockquote>
<p>如果回傳的只是一種無其它行為的 data structure，那它們在本質上必然會揭露內部的結構，所以<strong>迪米特法則</strong>在這種狀況下並不適用。</p>
<p>Clean Code p.111</p>
</blockquote>
<p>如前例回傳  <code>SMSService</code>， 因為包含商業邏輯，所以回傳算是 object，而非 data structure，只要包含商業邏輯，就會<strong>暴露實踐細節</strong>，而導致商業邏輯無法抽換，因此 controller 與 service 就必須解耦合，遵守<strong>迪米特法則</strong>。</p>
<blockquote>
<p><code>Train Wreck</code> 不見得違反<strong>迪米特原則</strong>，要看回傳的是 data structure 還是 object。</p>
</blockquote>
<h2 id="Fluent_Interface">Fluent Interface</h2><p>在 Laravel 的 Eloquent，我們會這樣寫</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$flights</span> = Flight::where(<span class="string">'active'</span>, <span class="number">1</span>)</span><br><span class="line">               -&gt;orderBy(<span class="string">'name'</span>, <span class="string">'desc'</span>)</span><br><span class="line">               -&gt;take(<span class="number">10</span>)</span><br><span class="line">               -&gt;get();</span><br></pre></td></tr></table></figure>
<p>這也是 <code>Train Wreck</code>，也違反<strong>迪米特法則</strong>嗎？</p>
<p><code>where()</code>、<code>orderBy()</code> 與 <code>take()</code> 這些，並沒有回傳其內部物件，而是傳回 <code>$this</code>，因此沒有<strong>暴露內部物件</strong>與<strong>暴露實踐細節</strong>的問題，也沒有與<strong>內部物件強烈耦合</strong>問題，因此 fluent interface 並沒有違反<strong>迪米特法則</strong>。</p>
<blockquote>
<p>並不是 <code>Train Wreck</code> 一定違反<strong>迪米特法則</strong>，關鍵在於有沒有<strong>暴露內部物件</strong>與<strong>暴露實踐細節</strong>，而不在於 <code>Train Wreck</code> 。</p>
</blockquote>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>違反<strong>迪米特法則</strong>會寫出 <code>Train Wreck</code>，但 <code>Train Wreck</code> 不一定會違反<strong>迪米特法則</strong>。</li>
<li><strong>迪米特法則</strong>重點在於強調物件導向的<strong>封裝</strong>特性，關鍵在於不該<strong>暴露內部物件</strong>，進而<strong>暴露實踐細節</strong>，導致使用端與內部物件強烈耦合而無法抽換商業邏輯。</li>
<li><strong>迪米特法則</strong>要求所有的動作都必須透過物件本身的方法操作，而不能傳出內部物件，讓使用端直接操作內部物件，而不在於是否使用 <code>Train Wreck</code> 。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p>Robert C. Martin, <a href="https://www.tenlong.com.tw/events/106" target="_blank" rel="external">無瑕的程式碼</a><br>良葛格, <a href="http://www.ithome.com.tw/voice/98670" target="_blank" rel="external">封裝與迪米特法則</a><br>Martin Fowler, <a href="https://www.martinfowler.com/bliki/FluentInterface.html" target="_blank" rel="external">Fluent Interface</a></p>
]]></content>
    <summary type="html">
    <![CDATA[並不是使用 Train Wreck 就違反迪米特法則]]>
    
    </summary>
    
      <category term="OOP" scheme="http://oomusou.io/tags/OOP/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Angular 也走 Redux 風 (使用 Ngrx)]]></title>
    <link href="http://oomusou.io/angular/angular-ngrx/"/>
    <id>http://oomusou.io/angular/angular-ngrx/</id>
    <published>2017-04-19T12:23:43.000Z</published>
    <updated>2017-04-24T13:41:07.000Z</updated>
    <content type="html"><![CDATA[<p>Redux 起源於 React 社群，算是一種 design pattern，適用於某些情境，也提供一些優點，Angular 也有 Redux 的實作，但 Angular 是否該使用 Redux 呢？</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>macOS 10.12.4<br>Angular CLI 1.0.0<br>Angular 4.0.1<br>ngrx/store 2.2.1</p>
<h2 id="為什麼會有_Redux?">為什麼會有 Redux?</h2><hr>
<p><img src="/images/angular/ngrx/ngrx004.png" alt="ngrx004"></p>
<p>Facebook 由於在界面上有多個 component 都可讀取 message，且又同時從 server 端下載 message，也就是當每個 component 的 message 被讀取後，必須更新 unread message count，但 Facebook 發現 unread message count 總是算不準，有解不完的 bug，因此提出了 Flux 架構。</p>
<p>Redux 靈感來自於 Flux 架構，在 Angular 目前有兩套實作，一套是 <a href="https://github.com/angular-redux/ng-redux" target="_blank" rel="external">Ng-redux</a>，另一套是 <a href="https://github.com/ngrx" target="_blank" rel="external">Ngrx</a>。</p>
<ul>
<li><code>Ng-redux</code> 核心仍使用 Redux，增加對 Angular 的支援。</li>
<li><code>Ngrx</code> 只有概念使用 Redux，核心完全使用 RxJS 重新實作。</li>
</ul>
<p>目前 <code>Ngrx</code> 在 GitHub 的星星數遠高於 <code>Ng-redux</code>，本文將以 <code>Ngrx</code> 討論。</p>
<blockquote>
<p>Flux 是一種概念，Redux 是 Flux 在 React 的實作，Ngrx 則是 Redux 在 Angular 的實作。</p>
</blockquote>
<h2 id="Ngrx_簡介">Ngrx 簡介</h2><hr>
<p><img src="/images/angular/ngrx/ngrx005.png" alt="ngrx005"></p>
<p>將 component 與 service 的資料統一放到 store，當 store 的資料有更新，將會自動更新到有 subscribe 的 component 與 service。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>本圖片來自於 <a href="https://github.com/btroncone" target="_blank" rel="external">Brain Troncone</a>, <a href="https://gist.github.com/btroncone/a6e4347326749f938510" target="_blank" rel="external">A Comprehensive Introduction to @ngrx/store</a></span></span></span></p>
<p><img src="/images/angular/ngrx/ngrx006.gif" alt="ngrx006"></p>
<p>在使用 <code>Ngrx</code> 之前，首先必須了解一些專有名詞。<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>本圖片來自於 <a href="https://www.pluralsight.com/guides/front-end-javascript/building-a-redux-application-with-angular-2-part-1" target="_blank" rel="external">Building a Redux application with Anguar 2 - Part 1</a></span></span></span></p>
<h3 id="View">View</h3><p>相當於 component，主要在顯示使用者介面。</p>
<h3 id="Action">Action</h3><p>當 component 有任何 event 時，會對 <code>Ngrx</code> 發出 action。</p>
<h3 id="Middleware">Middleware</h3><p>負責存取對 server 端的 API，本文暫不討論此部分。</p>
<h3 id="Dispatcher">Dispatcher</h3><p>負責接受 component 傳來的 action，並將 action 傳給 reducer。</p>
<h3 id="Store">Store</h3><p>可是為 <code>Ngrx</code> 在瀏覽器端的資料庫，各 component 的資料都可統一放在這裡。</p>
<h3 id="Reducer">Reducer</h3><p>根據 dispatcher 傳來的 action，決定該如何寫入 state。</p>
<p>當 state 有改變時，將通知有 subscribe 該 state 的 component 自動更新。</p>
<h3 id="State">State</h3><p>存放在 store 內的資料。</p>
<p><img src="/images/angular/ngrx/ngrx007.svg" alt="ngrx007"></p>
<p>有些東西 <code>Ngrx</code> 已經幫我們做了，真的要我們自己實作只有 4 個部份，且資料流為單向的 : Component -&gt; Action -&gt; Reducer -&gt; Store -&gt; Component。</p>
<h2 id="安裝_Ngrx">安裝 Ngrx</h2><hr>
<h3 id="Installation">Installation</h3><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject $ <span class="built_in">npm</span> install <span class="property">@ngrx</span>/core <span class="property">@ngrx</span>/store --save</span><br></pre></td></tr></table></figure>
<p>安裝 <code>@ngrx/core</code> 與 <code>@ngrx/store</code>。</p>
<h2 id="Counter_範例">Counter 範例</h2><hr>
<p><img src="/images/angular/ngrx/ngrx002.png" alt="ngrx002"></p>
<h3 id="AppModule">AppModule</h3><p><strong>app.module.ts</strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/CounterNgrx/blob/master/src/app/app.module.ts" target="_blank" rel="external">app.module.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;BrowserModule&#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NgModule&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;FormsModule&#125; from <span class="string">'@angular/forms'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;HttpModule&#125; from <span class="string">'@angular/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;AppComponent&#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;StoreModule&#125; from <span class="string">'@ngrx/store'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;counterReducer&#125; from <span class="string">'./stores/counter/counter.reducer'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule,</span><br><span class="line">    FormsModule,</span><br><span class="line">    HttpModule,</span><br><span class="line">    StoreModule.provideStore(counterReducer),</span><br><span class="line">  ],</span><br><span class="line">  providers: [],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">imports: [</span><br><span class="line">  BrowserModule,</span><br><span class="line">  FormsModule,</span><br><span class="line">  HttpModule,</span><br><span class="line">  StoreModule.provideStore(counterReducer),</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>須在 <code>AppModule</code> import <code>StoreModule.provideStore()</code>，並傳入 reducer。</p>
<h3 id="Component">Component</h3><p><strong>app.component.html</strong><span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/CounterNgrx/blob/master/src/app/app.component.html" target="_blank" rel="external">app.component.html</a></span></span></span></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span>Counter: &#123;&#123; counter | async &#125;&#125;<span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"increment()"</span>&gt;</span>Increment<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"decrement()"</span>&gt;</span>Decrement<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"reset()"</span>&gt;</span>Reset<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 <code>counter</code> 加上 <code>async</code> pipe，由 <code>async</code> 負責將 <code>ngrx/store</code> 來 subscribe 與 unsubscribe。</p>
<p>但這有個限制，<code>counter</code> 必須為宣告成 <code>Observable&lt;number&gt;</code> 型別。</p>
<p>Component 包含了 <code>Increment</code>、<code>Decrement</code> 與 <code>Reset</code> 3 個 button。</p>
<p><strong>app.component.ts</strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/CounterNgrx/blob/master/src/app/app.component.ts" target="_blank" rel="external">app.component.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;CounterState&#125; from <span class="string">'./stores/counter/counter.store'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Observable&#125; from <span class="string">'rxjs/observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Store&#125; from <span class="string">'@ngrx/store'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;DECREMENT, INCREMENT, RESET&#125; from <span class="string">'./stores/counter/counter.action'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;</span><br><span class="line">  counter: Observable&lt;<span class="built_in">number</span>&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private store: Store&lt;CounterState&gt;) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.counter = store.select(<span class="string">'counter'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  increment() &#123;</span><br><span class="line">    <span class="keyword">this</span>.store.dispatch(&#123;</span><br><span class="line">      <span class="keyword">type</span>: INCREMENT,</span><br><span class="line">      payload: &#123;</span><br><span class="line">        value: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  decrement() &#123;</span><br><span class="line">    <span class="keyword">this</span>.store.dispatch(&#123;</span><br><span class="line">      <span class="keyword">type</span>: DECREMENT,</span><br><span class="line">      payload: &#123;</span><br><span class="line">        value: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reset() &#123;</span><br><span class="line">    <span class="keyword">this</span>.store.dispatch(&#123;<span class="keyword">type</span>: RESET&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private store: Store&lt;CounterState&gt;) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.counter = store.select(<span class="string">'counter'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將  <code>ngrx/store</code>  的 <code>Store</code> 依賴注入，它是個泛型，需傳入自己的 state 型別。</p>
<p>由 store 的 <code>select()</code> 傳回 store 內的 <code>counter</code> field，此為 <code>Observable</code> 型別。</p>
<p>13 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">counter: Observable&lt;<span class="built_in">number</span>&gt;;</span><br></pre></td></tr></table></figure>
<p>宣告 <code>counter</code> 為 <code>Observable</code> 型別，其泛型為 <code>number</code>。</p>
<blockquote>
<p>為什麼 <code>counter</code> 不是 <code>number</code> 型別，而是 <code>Observable&lt;number&gt;</code> 呢？因為 <code>store.select()</code> 回傳的型別為 <code>Observable</code>。</p>
</blockquote>
<p>19 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">increment() &#123;</span><br><span class="line">  <span class="keyword">this</span>.store.dispatch(&#123;</span><br><span class="line">    <span class="keyword">type</span>: INCREMENT,</span><br><span class="line">    payload: &#123;</span><br><span class="line">      value: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Increment</code> button 的 event handler。</p>
<p>將 action 透過 store 的 <code>dispatch()</code> 傳入，action 物件包含 <code>type</code> 與 <code>payload</code> 兩個 field，<code>type</code> 為欲 dispatch 的 action，而 <code>payload</code> 則為欲透過 dispatch 傳入的資料，可自行決定其物件屬性，之後會由 reducer 根據 action 寫入 state。 </p>
<blockquote>
<p>可將 dispatch 概念上想成類似 event 的 emit。</p>
</blockquote>
<h3 id="Action-1">Action</h3><p><strong>counter.action.ts</strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/CounterNgrx/blob/master/src/app/stores/counter/counter.action.ts" target="_blank" rel="external">counter.action.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INCREMENT = <span class="string">'INCREMENT'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DECREMENT = <span class="string">'DECREMENT'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> RESET     = <span class="string">'RESET'</span>;</span><br></pre></td></tr></table></figure>
<p>定義 action 常數，將來 component 可用 <code>dispatch()</code> 發布 action， 然後 reducer 再根據 action 做 <code>switch</code> 判斷寫入 state。</p>
<h3 id="Reducer-1">Reducer</h3><p><strong>counter.reducer.ts</strong><span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>GitHub Commit : <a href="https://github.com/oomusou/CounterNgrx/blob/master/src/app/stores/counter/counter.reducer.ts" target="_blank" rel="external">counter.reducer.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;CounterState, INITIAL_COUNTER_STATE&#125; from <span class="string">'./counter.store'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;DECREMENT, INCREMENT, RESET&#125; from <span class="string">'./counter.action'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Action&#125; from <span class="string">'@ngrx/store'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">counterReducer</span>(<span class="params">state: CounterState = INITIAL_COUNTER_STATE, action: Action</span>): <span class="title">CounterState</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;<span class="keyword">type</span>, payload&#125; = action;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> INCREMENT:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, counter: state.counter + payload.value&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> DECREMENT:</span><br><span class="line">      <span class="keyword">return</span> &#123;...state, counter: state.counter - payload.value&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> RESET:</span><br><span class="line">      <span class="keyword">return</span> INITIAL_COUNTER_STATE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一個 state 會搭配一個 reducer，由 reducer 寫入 state。</p>
<p>第 5 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">counterReducer</span>(<span class="params">state: CounterState = INITIAL_COUNTER_STATE, action: Action</span>): <span class="title">CounterState</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p>Reducer 會以 state 與 action 為參數，並寫入 state。</p>
<ul>
<li>第 1 個參數為 <code>state</code>，可設定 reducer 一開始的預設 state，傳入目前的 state。</li>
<li>第 2 個參數為 <code>action</code>，傳入目前的 action。</li>
</ul>
<p>第 6 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="keyword">type</span>, payload&#125; = action;</span><br></pre></td></tr></table></figure>
<p>根據 ngrx 的 <code>dispatcher.d.ts</code> ，<code>Action</code> 的定義如下 :</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> Action </span>&#123;</span><br><span class="line">  <span class="keyword">type</span>: <span class="built_in">string</span>;</span><br><span class="line">  payload?: <span class="built_in">any</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Action</code> 的兩個 field 為 <code>type</code> 與 <code>payload</code>，因此我們可以使用 TypeScript 2.1 的 object destruction 將 <code>action</code> 分解成 <code>type</code> 與 <code>payload</code> 兩個變數。</p>
<p>第 8 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">  <span class="keyword">case</span> INCREMENT:</span><br><span class="line">    <span class="keyword">return</span> &#123;...state, counter: state.counter + payload.value&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> DECREMENT:</span><br><span class="line">    <span class="keyword">return</span> &#123;...state, counter: state.counter - payload.value&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> RESET:</span><br><span class="line">    <span class="keyword">return</span> INITIAL_COUNTER_STATE;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>典型的 Redux 風格，在 reducer 內會根據 action 的 type 做 <code>switch case</code>。</p>
<p>第 10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;...state, counter: state.counter + payload.value&#125;;</span><br></pre></td></tr></table></figure>
<p>Redux 為 FP (Functional Programming) 思維的產物，要求 reducer 必須為 pure function，因此必須回傳一個新的 state，而不是去修改原本的 state。</p>
<p>TypeScript 2.1 提供了 object spread，<code>…state</code> 會將整個物件的屬性加以展開，之後的參數為要修改的屬性值，<code>{}</code> 會將物件屬性加以合併，並回傳新的物件。</p>
<blockquote>
<p>傳統會使用 <code>Object.assign()</code> 的寫法，但寫法並不直覺，且因為其第二個參數需傳入物件，還必須多一層 <code>{}</code>，建議使用 object spread 寫法可讀性較高。</p>
</blockquote>
<h3 id="Store-1">Store</h3><p><strong>counter.store.ts</strong><span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>GitHub Commit : <a href="https://github.com/oomusou/CounterNgrx/blob/master/src/app/stores/counter/counter.store.ts" target="_blank" rel="external">counter.store.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> CounterState </span>&#123;</span><br><span class="line">  counter: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INITIAL_COUNTER_STATE: CounterState = &#123;</span><br><span class="line">  counter: <span class="number">0</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在 store 定義自己的 state 型別。</p>
<p>第 1 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> CounterState </span>&#123;</span><br><span class="line">  counter: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定義 <code>CounterState</code> 與其 field。</p>
<blockquote>
<p>使用 interface 即可，因為 state 型別主要是給 TypeScript 編譯檢查與 IntelliSense 使用，而 JavaScript 沒有 interface，故編譯後 interface 會消失，若 state 使用 class，將來編譯後還會存在 class。</p>
</blockquote>
<p>第 5 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INITIAL_COUNTER_STATE: CounterState = &#123;</span><br><span class="line">  counter: <span class="number">0</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>定義 <code>INITIAL_COUNTER_STATE</code> 常數，為 <code>CounterState</code> 的初始狀態。</p>
<h2 id="Todo_範例">Todo 範例</h2><hr>
<p><img src="/images/angular/ngrx/ngrx003.png" alt="ngrx003"></p>
<h3 id="AppModule-1">AppModule</h3><p><strong>app.module.ts</strong><span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>GitHub Commit : <a href="https://github.com/oomusou/TodoNgrx/blob/master/src/app/app.module.ts" target="_blank" rel="external">app.module.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;BrowserModule&#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NgModule&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;FormsModule&#125; from <span class="string">'@angular/forms'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;HttpModule&#125; from <span class="string">'@angular/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;AppComponent&#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;TodoListComponent&#125; from <span class="string">'./todo-list/todo-list.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;TodoDashboardComponent&#125; from <span class="string">'./todo-dashboard/todo-dashboard.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;StoreModule&#125; from <span class="string">'@ngrx/store'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;todoReducer&#125; from <span class="string">'./stores/todo/todo.reducer'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    TodoListComponent,</span><br><span class="line">    TodoDashboardComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule,</span><br><span class="line">    FormsModule,</span><br><span class="line">    HttpModule,</span><br><span class="line">    StoreModule.provideStore(todoReducer)</span><br><span class="line">  ],</span><br><span class="line">  providers: [],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">imports: [</span><br><span class="line">  BrowserModule,</span><br><span class="line">  FormsModule,</span><br><span class="line">  HttpModule,</span><br><span class="line">  StoreModule.provideStore(todoReducer)</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>須在 <code>AppModule</code> import <code>StoreModule.provideStore()</code>，並傳入 reducer。</p>
<h3 id="Component-1">Component</h3><h4 id="AppComponent">AppComponent</h4><p><strong>app.component.html</strong><span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>GitHub Commit : <a href="https://github.com/oomusou/TodoNgrx/blob/master/src/app/app.component.html" target="_blank" rel="external">app.component.html</a></span></span></span></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">h1</span>&gt;</span>Todo<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-todo-list</span>&gt;</span><span class="tag">&lt;/<span class="title">app-todo-list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">app-todo-dashboard</span>&gt;</span><span class="tag">&lt;/<span class="title">app-todo-dashboard</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>包含了 <code>TodoList</code> 與 <code>TodoDashboard</code> 兩個 component。</p>
<h4 id="TodoList">TodoList</h4><p><strong>todo-list.component.html</strong><span class="margin-note-marker"><sup>11</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">11</span>GitHub Commit : <a href="https://github.com/oomusou/TodoNgrx/blob/master/src/app/todo-list/todo-list.component.html" target="_blank" rel="external">todo-list.component.html</a></span></span></span></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> #<span class="attribute">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"addTodo(title)"</span>&gt;</span>Add<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">li</span> *<span class="attribute">ngFor</span>=<span class="value">"let todo of todos | async"</span>&gt;</span></span><br><span class="line">    &#123;&#123; todo.title &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"removeTodo(todo)"</span>&gt;</span>Remove<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>todos</code> 為 <code>Observable</code>，需加上 <code>async</code> 將 <code>ngrx/store</code> 來 subscribe 與 unsubscribe。</p>
<p>但這有個限制，<code>todos</code> 必須為宣告成 <code>Observable&lt;Todo[]&gt;</code> 型別。</p>
<p>Component 包含了<code>Add</code> 與 <code>Remove</code> 2 個 button。</p>
<p><strong>todo-list.component.ts</strong><span class="margin-note-marker"><sup>12</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">12</span>GitHub Commit : <a href="https://github.com/oomusou/TodoNgrx/blob/master/src/app/todo-list/todo-list.component.ts" target="_blank" rel="external">todo-list.component.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Observable&#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Todo, TodoState&#125; from <span class="string">'../stores/todo/todo.store'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Store&#125; from <span class="string">'@ngrx/store'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ADD_TODO, REMOVE_TODO&#125; from <span class="string">'../stores/todo/todo.action'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-todo-list'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./todo-list.component.html'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> TodoListComponent &#123;</span><br><span class="line">  todos: Observable&lt;Todo[]&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private store: Store&lt;TodoState&gt;) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.todos = store.select(<span class="string">'todos'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addTodo(input: HTMLInputElement) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!input.value) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.store.dispatch(&#123;</span><br><span class="line">      <span class="keyword">type</span>: ADD_TODO,</span><br><span class="line">      payload: &#123;</span><br><span class="line">        title: input.value</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    input.value = <span class="string">''</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removeTodo(todo: Todo) &#123;</span><br><span class="line">    <span class="keyword">this</span>.store.dispatch(&#123;</span><br><span class="line">      <span class="keyword">type</span>: REMOVE_TODO,</span><br><span class="line">      payload: &#123;</span><br><span class="line">        id: todo.id</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>14 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private store: Store&lt;TodoState&gt;) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.todos = store.select(<span class="string">'todos'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將  <code>ngrx/store</code>  的 <code>Store</code> 依賴注入，它是個泛型，需傳入自己的 state 型別。</p>
<p>由 store 的 <code>select()</code> 傳回 store 內的 <code>todos</code> field，此為 <code>Observable</code> 型別。</p>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">todos: Observable&lt;Todo[]&gt;;</span><br></pre></td></tr></table></figure>
<p>宣告 <code>todos</code> 為 <code>Observable</code> 型別，其泛型為 <code>Todo[]</code>。</p>
<blockquote>
<p>為什麼 <code>todos</code> 不是 <code>Todo[]</code> 型別，而是 <code>Observable&lt;Todo[]&gt;</code> 呢？因為 <code>store.select()</code> 回傳的型別為 <code>Observable</code>。</p>
</blockquote>
<p>18 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">addTodo(input: HTMLInputElement) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!input.value) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.store.dispatch(&#123;</span><br><span class="line">    <span class="keyword">type</span>: ADD_TODO,</span><br><span class="line">    payload: &#123;</span><br><span class="line">      title: input.value</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  input.value = <span class="string">''</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Add</code> button 的 event handler。</p>
<p>將 <code>ADD_TODO</code> action 透過 store 的 <code>dispatch()</code> 傳入，action 物件包含 <code>type</code> 與 <code>payload</code> 兩個 field，<code>type</code> 為 <code>ADD_TODO</code> action，而 <code>payload</code> 則為欲新增資料的 <code>title</code>，之後會由 reducer 根據目前 action 寫入 state。 </p>
<p>33 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">removeTodo(todo: Todo) &#123;</span><br><span class="line">  <span class="keyword">this</span>.store.dispatch(&#123;</span><br><span class="line">    <span class="keyword">type</span>: REMOVE_TODO,</span><br><span class="line">    payload: &#123;</span><br><span class="line">      id: todo.id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Remove</code> button 的 event handler。</p>
<p>將 <code>REMOVE_TODO</code> action 透過 store 的 <code>dispatch()</code> 傳入，action 物件包含 <code>type</code> 與 <code>payload</code> 兩個 field，<code>type</code> 為 <code>REMOVE_TODO</code> action，而 <code>payload</code> 則為欲移除資料的 <code>id</code>，之後會由 reducer 根據目前 action 寫入 state。 </p>
<h4 id="TodoDashboard">TodoDashboard</h4><p><strong>todo-dashboard.component.html</strong><span class="margin-note-marker"><sup>13</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">13</span>GitHub Commit : <a href="https://github.com/oomusou/TodoNgrx/blob/master/src/app/todo-dashboard/todo-dashboard.component.html" target="_blank" rel="external">todo-dashboard.component.html</a></span></span></span></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span></span><br><span class="line">  Last Update: &#123;&#123; lastUpdate | async | date:'mediumTime'&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span></span><br><span class="line">  Total items: &#123;&#123; (todos | async).length &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">button</span> (<span class="attribute">click</span>)=<span class="value">"clearTodos()"</span>&gt;</span>Clear All<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>顯示最後更新時間與 <code>Todo</code> 筆數。</p>
<p><code>lastUpdate</code> 與 <code>todos</code> 均為 <code>Observable</code>，需加上 <code>async</code> 將 <code>ngrx/store</code> 來 subscribe 與 unsubscribe。</p>
<p>Component 包含了 <code>Clear All</code> button。</p>
<p><strong>todo-dashboard.component.ts</strong><span class="margin-note-marker"><sup>14</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">14</span>GitHub Commit : <a href="https://github.com/oomusou/TodoNgrx/blob/master/src/app/todo-dashboard/todo-dashboard.component.ts" target="_blank" rel="external">todo-dashboard.component.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Observable&#125; from <span class="string">'rxjs/Observable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Todo, TodoState&#125; from <span class="string">'../stores/todo/todo.store'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Store&#125; from <span class="string">'@ngrx/store'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;CLEAR_TODOS&#125; from <span class="string">'../stores/todo/todo.action'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-todo-dashboard'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./todo-dashboard.component.html'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> TodoDashboardComponent &#123;</span><br><span class="line">  todos: Observable&lt;Todo[]&gt;;</span><br><span class="line">  lastUpdate: Observable&lt;<span class="built_in">Date</span>&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private store: Store&lt;TodoState&gt;) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.todos = store.select(<span class="string">'todos'</span>);</span><br><span class="line">    <span class="keyword">this</span>.lastUpdate = store.select(<span class="string">'lastUpdate'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  clearTodos() &#123;</span><br><span class="line">    <span class="keyword">this</span>.store.dispatch(&#123;</span><br><span class="line">      <span class="keyword">type</span>: CLEAR_TODOS</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>15 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(private store: Store&lt;TodoState&gt;) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.todos = store.select(<span class="string">'todos'</span>);</span><br><span class="line">  <span class="keyword">this</span>.lastUpdate = store.select(<span class="string">'lastUpdate'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將  <code>ngrx/store</code>  的 <code>Store</code> 依賴注入，它是個泛型，需傳入自己的 state 型別。</p>
<p>由 store 的 <code>select()</code> 傳回 store 內的 <code>todos</code> 與 <code>lastUpdate</code>field，皆為 <code>Observable</code> 型別。</p>
<p>12 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">todos: Observable&lt;Todo[]&gt;;</span><br><span class="line">lastUpdate: Observable&lt;<span class="built_in">Date</span>&gt;;</span><br></pre></td></tr></table></figure>
<p>宣告 <code>todos</code> 為 <code>Observable</code> 型別，其泛型為 <code>Todo[]</code>。</p>
<p>宣告 <code>lastUpdate</code> 為 <code>Observable</code> 型別，其泛型為 <code>Date</code>。</p>
<p>20 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">clearTodos() &#123;</span><br><span class="line">  <span class="keyword">this</span>.store.dispatch(&#123;</span><br><span class="line">    <span class="keyword">type</span>: CLEAR_TODOS</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Clear All</code> button 的 event handler。</p>
<p>將 <code>CLEAR_TODOS</code> action 透過 store 的 <code>dispatch()</code> 傳入，action 物件包含 <code>type</code> 與 <code>payload</code> 兩個 field，<code>type</code> 為 <code>REMOVE_TODO</code> action，因為沒有要傳入的資料，因此不需 <code>payload</code>，之後會由 reducer 根據目前 action 寫入 state。 。 </p>
<h3 id="Action-2">Action</h3><p><strong>todo.action.ts</strong><span class="margin-note-marker"><sup>15</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">15</span>GitHub Commit : <a href="https://github.com/oomusou/TodoNgrx/blob/master/src/app/stores/todo/todo.action.ts" target="_blank" rel="external">todo.action.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ADD_TODO    = <span class="string">'ADD_TODO'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> REMOVE_TODO = <span class="string">'REMOVE_TODO'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> CLEAR_TODOS = <span class="string">'CLEAR_TODOS'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DEFAULT     = <span class="string">'DEFAULT'</span>;</span><br></pre></td></tr></table></figure>
<p>在 action 定義自己的 action 常數。</p>
<p>實務上 action 常數會以 component 或 service 所要 dispatch 的 event 設計，以本範例而言，在 component 有 <code>Add</code>、<code>Remove</code> 與 <code>Delete All</code>  3 個 button，因此會配合 3 個 button 設計出 <code>ADD_TODO</code> 、<code>REMOVE_TODO</code> 與 <code>CLEAR_TODOS</code> 3 個 action。</p>
<h3 id="Reducer-2">Reducer</h3><p><strong>todo.reducer.ts</strong><span class="margin-note-marker"><sup>16</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">16</span>GitHub Commit : <a href="https://github.com/oomusou/TodoNgrx/blob/master/src/app/stores/todo/todo.reducer.ts" target="_blank" rel="external">todo.reducer.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;INITIAL_TODO_STATE, TodoState&#125; from <span class="string">'./todo.store'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ADD_TODO, CLEAR_TODOS, REMOVE_TODO&#125; from <span class="string">'./todo.action'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Action&#125; from <span class="string">'@ngrx/store'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">todoReducer</span>(<span class="params">state: TodoState = INITIAL_TODO_STATE, action: Action</span>): <span class="title">TodoState</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;<span class="keyword">type</span>, payload&#125; = action;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> ADD_TODO:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        todos: [...state.todos, &#123;</span><br><span class="line">          id: state.todos.length + <span class="number">1</span>,</span><br><span class="line">          title: payload.title</span><br><span class="line">        &#125;],</span><br><span class="line">        lastUpdate: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> REMOVE_TODO:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        todos: state.todos.filter(todo =&gt; todo.id !== payload.id),</span><br><span class="line">        lastUpdate: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> CLEAR_TODOS:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        todos: [],</span><br><span class="line">        lastUpdate: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 reducer 定義自己的寫入 state 邏輯。</p>
<p>第 9 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ADD_TODO:</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...state,</span><br><span class="line">    todos: [...state.todos, &#123;</span><br><span class="line">      id: state.todos.length + <span class="number">1</span>,</span><br><span class="line">      title: payload.title</span><br><span class="line">    &#125;],</span><br><span class="line">    lastUpdate: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>使用 object spread 方式傳回新物件。</p>
<p><code>todos</code> 為陣列，而 <code>ADD_TODO</code> 主要的目的就是將新的物件加到 <code>todos</code> 陣列，因此可使用 array spread 方式傳回新的陣列。</p>
<p>19 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> REMOVE_TODO:</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...state,</span><br><span class="line">    todos: state.todos.filter(todo =&gt; todo.id !== payload.id),</span><br><span class="line">    lastUpdate: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>一樣使用 object spread 方式傳回新的物件。</p>
<p><code>REMOVE_TODO</code> 主要為移除 <code>payload.id</code> 的 <code>Todo</code>，但因為 <code>Ngrx</code> 要求為 pure function，因此改用 <code>filter()</code> 過濾 <code>todo.id</code> 不為 <code>payload.id</code>。</p>
<p>26 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CLEAR_TODOS:</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...state,</span><br><span class="line">    todos: [],</span><br><span class="line">    lastUpdate: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>一樣使用 object spread 方式傳回新的物件。</p>
<p><code>CLEAR_TODOS</code> 為清除所有 <code>Todo</code>，但因為 <code>Ngrx</code> 要求為 pure function，因此傳回 <code>[]</code> 空陣列。</p>
<h3 id="Store-2">Store</h3><p><strong>todo.store.ts</strong><span class="margin-note-marker"><sup>17</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">17</span>GitHub Commit : <a href="https://github.com/oomusou/TodoNgrx/blob/master/src/app/stores/todo/todo.store.ts" target="_blank" rel="external">todo.store.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> Todo </span>&#123;</span><br><span class="line">  id: <span class="built_in">number</span>;</span><br><span class="line">  title: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> TodoState </span>&#123;</span><br><span class="line">  todos: Todo[];</span><br><span class="line">  lastUpdate: <span class="built_in">Date</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INITIAL_TODO_STATE: TodoState = &#123;</span><br><span class="line">  todos: [],</span><br><span class="line">  lastUpdate: <span class="literal">null</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在 store 定義自己的 state 型別。</p>
<p>第 6 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> TodoState </span>&#123;</span><br><span class="line">  todos: Todo[];</span><br><span class="line">  lastUpdate: <span class="built_in">Date</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定義 <code>TodoState</code> 與其 field。</p>
<p>其中 <code>todos</code> 為 <code>Todo</code> 型別的陣列。</p>
<p>第 1 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> Todo </span>&#123;</span><br><span class="line">  id: <span class="built_in">number</span>;</span><br><span class="line">  title: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定義 <code>Todo</code> 型別。</p>
<p>11 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INITIAL_TODO_STATE: TodoState = &#123;</span><br><span class="line">  todos: [],</span><br><span class="line">  lastUpdate: <span class="literal">null</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>定義 <code>INITIAL_TODO_STATE</code> 常數，為 <code>TodoState</code> 的初始狀態。</p>
<h2 id="Ngrx_DevTools">Ngrx DevTools</h2><hr>
<p><code>Ngrx</code> 所提供的開發者工具，讓我們可以針對 <code>Ngrx</code> 的 store 與 action 做 debug。</p>
<h3 id="Installation-1">Installation</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/MyProject $ npm <span class="operator"><span class="keyword">install</span> @ngrx/<span class="keyword">store</span>-devtools <span class="comment">--save</span></span></span><br></pre></td></tr></table></figure>
<p>安裝 <code>@ngrx/store-devtools</code>。</p>
<p><img src="/images/angular/ngrx/ngrx000.png" alt="ngrx000"></p>
<p>安裝 <code>Redux DevTools</code> 到 Chrome。</p>
<h3 id="AppModule-2">AppModule</h3><p><strong>app.module.ts</strong><span class="margin-note-marker"><sup>18</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">18</span>GitHub Commit : <a href="https://github.com/oomusou/TodoNgrx/blob/master/src/app/app.module.ts" target="_blank" rel="external">app.module.ts</a></span></span></span></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;BrowserModule&#125; from <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NgModule&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;FormsModule&#125; from <span class="string">'@angular/forms'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;HttpModule&#125; from <span class="string">'@angular/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;AppComponent&#125; from <span class="string">'./app.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;TodoListComponent&#125; from <span class="string">'./todo-list/todo-list.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;TodoDashboardComponent&#125; from <span class="string">'./todo-dashboard/todo-dashboard.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;StoreModule&#125; from <span class="string">'@ngrx/store'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;todoReducer&#125; from <span class="string">'./stores/todo/todo.reducer'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;StoreDevtoolsModule&#125; from <span class="string">'@ngrx/store-devtools'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent,</span><br><span class="line">    TodoListComponent,</span><br><span class="line">    TodoDashboardComponent</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule,</span><br><span class="line">    FormsModule,</span><br><span class="line">    HttpModule,</span><br><span class="line">    StoreModule.provideStore(todoReducer),</span><br><span class="line">    StoreDevtoolsModule.instrumentOnlyWithExtension(),</span><br><span class="line">  ],</span><br><span class="line">  providers: [],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>19 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">imports: [</span><br><span class="line">  BrowserModule,</span><br><span class="line">  FormsModule,</span><br><span class="line">  HttpModule,</span><br><span class="line">  StoreModule.provideStore(todoReducer),</span><br><span class="line">  StoreDevtoolsModule.instrumentOnlyWithExtension(),</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>須在 <code>AppModule</code> import <code>StoreDevtoolsModule.instrumentOnlyWithExtension()</code>。</p>
<p><img src="/images/angular/ngrx/ngrx001.png" alt="ngrx001"></p>
<p>可在 Chrome 使用 Ngrx DevTools 對 state 與 action 做 debug，並可使用 time-traveling 的方式一個 action 一個 action 的執行。</p>
<h2 id="Ngrx_的特色">Ngrx 的特色</h2><hr>
<ul>
<li>將所有 state 統一放在單一 store 內。</li>
<li>所有寫入 state 的邏輯都統一放在單一 reducer 內，且必須為 pure function。</li>
<li>Component 不寫邏輯，只負責 dispatch 適當的 action。</li>
<li>當 state 變更，component 會自動更新。</li>
</ul>
<h2 id="Ngrx_的優點">Ngrx 的優點</h2><hr>
<ul>
<li>單向的資料流程，程式碼較易理解與 debug。</li>
<li>將 state 的變更邏輯統一寫在 reducer 內，而非分散在各 component，較容易維護。</li>
<li>由於 reducer 為 pure function，很容易寫單元測試。</li>
<li>資料邏輯與 framework 解耦合，action/reducer/store 獨立於 framework，將來要移植到其他 framework 很方便。</li>
<li>有 Ngrx DevTools 方便做 time-traveling 方式的 debug。</li>
<li>可將使用者行為錄製下來。</li>
</ul>
<h2 id="Ngrx_的缺點">Ngrx 的缺點</h2><hr>
<ul>
<li>為 FP 思維產物，若只熟 OOP 較難以掌握。</li>
<li>維護的人須事先有 Redux 觀念，否則無法維護，學習門檻較高。</li>
<li>Reducer 需寫成 pure function，難度較高。</li>
<li>有點 over design 味道。</li>
</ul>
<h2 id="什麼時候該使用_Ngrx?">什麼時候該使用 Ngrx?</h2><hr>
<ul>
<li>當多個 component 需使用共用資料，且各 component 的操作會影像其他 component 的結果。</li>
<li>資料可能同時被多個 component 修改，甚至同時被 server API 修改。</li>
<li>需要實作 undo/redo 功能。</li>
</ul>
<blockquote>
<p>You’ll know when you need Flux. If you aren’t sure if you need it, you don’t need it.</p>
</blockquote>
<p>套句 <a href="https://github.com/petehunt/react-howto" target="_blank" rel="external">React How-to</a> 的名言，當你需要 <code>Ngrx</code> 的時候再使用 <code>Ngrx</code>，若你不確定，就不要使用，避免因誤用而 over design。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li><code>Ngrx</code> 有一點 over design，相當於 command 模式與 Observable 模式的合體。</li>
<li><code>Ngrx</code> 就跟所有的 design pattern 一樣，都會使設計複雜化，並不是所有應用都適合使用 <code>Ngrx</code>，必須看需求用在刀口上。</li>
<li><code>RxJS</code> 出來之後，<code>Ngrx</code> 的寫法重要性不若以往，簡單的應用直接在 service 使用 <code>RxJS</code> 即可。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/" target="_blank" rel="external">GitHub</a> 上找到 <a href="https://github.com/oomusou/CounterNgrx" target="_blank" rel="external">CounterNgrx</a> 與 <a href="https://github.com/oomusou/TodoNgrx" target="_blank" rel="external">TodoNgrx</a>。</p>
<h2 id="Reference">Reference</h2><hr>
<p><a href="https://github.com/ngrx" target="_blank" rel="external">ngrx</a>, <a href="https://github.com/ngrx/store" target="_blank" rel="external">ngrx/store</a><br><a href="http://programmingwithmosh.com" target="_blank" rel="external">Mosh Hamedani</a>, <a href="https://www.udemy.com/angular2-advanced/" target="_blank" rel="external">Build Enterprise Applications with Angular 2</a><br><a href="https://angular-university.io" target="_blank" rel="external">Angular University</a>, <a href="http://blog.angular-university.io/angular-ngrx-store-and-effects-crash-course/" target="_blank" rel="external">Angular Ngrx Crash Course Part 1: Ngrx Store - Learn It By Understanding The Original Facebook Counter Bug</a><br><a href="https://angular-university.io" target="_blank" rel="external">Angular University</a>, <a href="http://blog.angular-university.io/angular-2-redux-ngrx-rxjs/" target="_blank" rel="external">Angular Service Layers: Redux, RxJs and Ngrx Store - When to Use a Store And Why ?</a><br><a href="https://www.pluralsight.com/guides/author/Kaizeras" target="_blank" rel="external">Hristo Georgiev</a>, <a href="https://www.pluralsight.com/guides/front-end-javascript/building-a-redux-application-with-angular-2-part-1" target="_blank" rel="external">Building a Redux application with Anguar 2 - Part 1</a><br><a href="https://www.pluralsight.com/guides/author/Kaizeras" target="_blank" rel="external">Hristo Georgiev</a>, <a href="https://www.pluralsight.com/guides/front-end-javascript/building-a-redux-application-with-angular-2-part-2" target="_blank" rel="external">Building a Redux application with Anguar 2 - Part 2</a><br><a href="https://github.com/btroncone" target="_blank" rel="external">Brain Troncone</a>, <a href="https://gist.github.com/btroncone/a6e4347326749f938510" target="_blank" rel="external">A Comprehensive Introduction to @ngrx/store</a><br><a href="https://egghead.io" target="_blank" rel="external">egghead.io</a>, <a href="https://egghead.io/courses/building-a-time-machine-with-angular-2-and-rxjs" target="_blank" rel="external">Build Redux Style Application with Angular 2, RxJS, and ngrx/store</a><br><a href="https://hackernoon.com/@MichalMajewski" target="_blank" rel="external">Michal Majewski</a>, <a href="https://hackernoon.com/@MichalMajewski" target="_blank" rel="external">What I have learned using ngrx/Redux with Angular 2</a><br><a href="https://medium.com/@dan_abramov" target="_blank" rel="external">Dan Abramov</a>, <a href="https://medium.com/@dan_abramov/you-might-not-need-redux-be46360cf367" target="_blank" rel="external">You Might Not Need Redux</a><br><a href="https://github.com/petehunt" target="_blank" rel="external">Pete Hunt</a>,  <a href="https://github.com/petehunt/react-howto" target="_blank" rel="external">React How-to</a></p>
]]></content>
    <summary type="html">
    <![CDATA[使用 Redux 風格開發 Angular]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
      <category term="RxJS" scheme="http://oomusou.io/tags/RxJS/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何在 PhpStorm 繪製 UML?]]></title>
    <link href="http://oomusou.io/phpstorm/phpstorm-uml/"/>
    <id>http://oomusou.io/phpstorm/phpstorm-uml/</id>
    <published>2017-04-18T12:23:43.000Z</published>
    <updated>2017-04-18T14:10:42.000Z</updated>
    <content type="html"><![CDATA[<p>PlantUML 讓我們可以使用文字檔的方式描述 UML，且可以直接在 PhpStorm 內使用，非常方便。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>macOS 10.12.4<br>PhpStorm 2017.1.2<br>Graphviz 2.40.1<br>PlantUML Integration Plugin 2.5.0</p>
<h2 id="安裝_Graphviz">安裝 Graphviz</h2><hr>
<p>我們必須透過 Graphviz 顯示 <code>puml</code> 格式檔案，因此必須先安裝 Graphviz。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">brew </span>update</span><br><span class="line">$ <span class="keyword">brew </span>install graphviz</span><br></pre></td></tr></table></figure>
<p>透過 Homebrew 安裝 Graphviz。</p>
<h2 id="安裝_PlantUML_Plugin">安裝 PlantUML Plugin</h2><hr>
<p>為了在 PhpStorm 直接編輯與預覽 <code>puml</code> 格式檔案，須先安裝 PlantUML Integration Plugin。</p>
<p><img src="/images/phpstorm/phpstorm-uml/uml01.png" alt="uml01"></p>
<p><strong><em>PhpStorm -&gt; Preferences -&gt; Plugins</em></strong></p>
<p>按 <code>Browse repositories…</code>。</p>
<p><img src="/images/phpstorm/phpstorm-uml/uml02.png" alt="uml02"></p>
<p>輸入 <code>PlantUML</code>，選擇 <code>PlantUML Integration</code>，按 <code>Install</code> 安裝。</p>
<p><img src="/images/phpstorm/phpstorm-uml/uml03.png" alt="uml03"></p>
<p>安裝完需按 <code>Restart PhpStorm</code> 重新啟動。</p>
<p><img src="/images/phpstorm/phpstorm-uml/uml04.png" alt="uml04"></p>
<p>按熱鍵 Command + N，若出現 <code>UML Activity</code> 、<code>UML Class</code> 等圖，則表示安裝成功。</p>
<p><img src="/images/phpstorm/phpstorm-uml/uml05.png" alt="uml05"></p>
<p>能在 PhpStorm 順利顯示 <code>puml</code> 格式的 UML 檔案。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>由於 <code>puml</code> 格式基本上為文字檔，所以可以透過 Git 做版控管理。</li>
<li>為了 code review 方便，可將 <code>puml</code> 格式匯出成 <code>svg</code> 格式，放大縮小不會失真。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p><a href="http://plantuml.com" target="_blank" rel="external">PlantUML in a nutshell</a><br><a href="http://macappstore.org/graphviz/" target="_blank" rel="external">Install graphviz on Mac OSX</a></p>
]]></content>
    <summary type="html">
    <![CDATA[以類似 Markdown 的方式繪製 UML]]>
    
    </summary>
    
      <category term="PhpStorm" scheme="http://oomusou.io/tags/PhpStorm/"/>
    
      <category term="UML" scheme="http://oomusou.io/tags/UML/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何在 PhpStorm 使用 Refactoring (重構)?]]></title>
    <link href="http://oomusou.io/phpstorm/phpstorm-refactoring/"/>
    <id>http://oomusou.io/phpstorm/phpstorm-refactoring/</id>
    <published>2017-04-17T12:23:43.000Z</published>
    <updated>2017-04-18T15:39:52.000Z</updated>
    <content type="html"><![CDATA[<p>PhpStorm 最強悍的就是 Refactoring，這也是文字編輯器無法達到的，善用 Refactoring 將可大幅增加 code review 之後重構 PHP 的速度。</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>PhpStorm 2017.1.2</p>
<h2 id="Extraction">Extraction</h2><hr>
<h3 id="Extract_Method">Extract Method</h3><p>最需要被重構的程式碼，首推 <code>Long Method</code>，一旦一個 method 的程式碼的行數過多，就會難以閱讀、難以維護、難以單元測試、也違反物件導向的<code>單一職責原則</code>，建議使用 <code>Extract Method</code> 將 <code>Long Method</code> 拆成多個小 method。</p>
<p>何時該使用 <code>Extract Method</code> 呢？根據 Martin Fowler 在<code>重構</code>這本書的建議 :</p>
<blockquote>
<ol>
<li>當一段程式碼需要被重複使用時，就該獨立抽成 method。</li>
<li>當一段程式碼需要寫註解才能讓人理解時，就該獨立抽成 method。</li>
<li>當一段程式碼抽成 method 後，<strong>語意</strong>更清楚 ，就該獨立抽成 method。</li>
</ol>
</blockquote>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtractMethod</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printOwing</span><span class="params">(string <span class="variable">$name</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;printBanner();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// print details</span></span><br><span class="line">        <span class="keyword">print</span>(<span class="string">"name:  "</span> . <span class="variable">$name</span>);</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">"amount "</span> . <span class="variable">$this</span>-&gt;getOutstanding());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtractMethod</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printOwing</span><span class="params">(string <span class="variable">$name</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;printBanner();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// print details</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;printDetails(<span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> string $name</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">printDetails</span><span class="params">(string <span class="variable">$name</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">"name:  "</span> . <span class="variable">$name</span>);</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">"amount "</span> . <span class="variable">$this</span>-&gt;getOutstanding());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor000.png" alt="refactor000"></p>
<p>選擇要重構成 method 的程式碼，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Method</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor001.png" alt="refactor001"></p>
<p>輸入欲建立的 method 名稱，並選擇 <code>public</code>、<code>protected</code> 或 <code>private</code>，一般來說重構出來的 method 選 <code>private</code> 。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor002.png" alt="refactor002"></p>
<p>PhpStorm 會自動幫我們將所選的程式碼抽成 <code>printDetails()</code>，連參數、型別與 PHPDoc 都會幫我們加上。</p>
<h3 id="Extract_Field">Extract Field</h3><p>實務上有些在 method 內的 local 變數，原本只有單一 method 使用，若有其他 method 也使用相同變數時，建議使用 <code>Extract Field</code> 將此變數重構成 field。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtractField</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print1</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="string">'Hello World'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print2</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="string">'Hello World'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtractField</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span> = <span class="string">'Hello World'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print1</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print2</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor003.png" alt="refactor003"></p>
<p>將滑鼠游標放在變數名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Field</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor004.png" alt="refactor004"></p>
<p>可選擇要將<strong>單一變數</strong>或者將<strong>整個 expression</strong> 重構成 field，這裡選擇 <code>$name</code> 即可，因為我們想將 <code>$name</code> 變數重構成 field。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor005.png" alt="refactor005"></p>
<p>輸入欲建立的 field 名稱，並選擇 <code>public</code>、<code>protected</code> 或 <code>private</code>，為了實現物件導向資料<strong>封裝</strong>，建議重構出來的 field 選 <code>private</code> 。</p>
<p>在 <code>Initialize in</code> 選擇 field 初始化的方式，若是 PHP 原生型別，如 <code>int</code> / <code>string</code>，則選擇 <code>Field declaration</code>，若是物件，則必須選擇 <code>Class constructor</code>。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor006.png" alt="refactor006"></p>
<p>PhpStorm 會自動幫我們將變數重構成 field，並將原來引用變數之處重構成引用 field。</p>
<h3 id="Extract_Variable">Extract Variable</h3><p>實務上有些原本在 method 內的固定值，想要變成變數，建議使用 <code>Extract Variable</code> 將固定值重構成變數。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtractVariable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Calculate</span><span class="params">(int <span class="variable">$i</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="variable">$i</span> &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="variable">$i</span> = <span class="variable">$i</span> + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$i</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">DisplaySum</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$this</span>-&gt;Calculate(<span class="variable">$a</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"The final result is "</span> . <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtractVariable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Calculate</span><span class="params">(int <span class="variable">$i</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$c</span> = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="variable">$i</span> &lt; <span class="variable">$c</span>) &#123;</span><br><span class="line">            <span class="variable">$i</span> = <span class="variable">$i</span> + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$i</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">DisplaySum</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$this</span>-&gt;Calculate(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"The final result is "</span> . <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor013.png" alt="refactor013"></p>
<p>將滑鼠游標放在 <code>10</code> 上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Variable</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor014.png" alt="refactor014"></p>
<p>可以將<strong>固定值</strong>或 <strong>expression</strong> 抽成變數，這裡選擇 <code>10</code> 將固定值重構成變數。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor015.png" alt="refactor015"></p>
<p>輸入欲建立的變數名稱。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor016.png" alt="refactor016"></p>
<p>PhpStorm 會自動幫我們加上重構過的變數，並將原有的值都以變數取代。</p>
<h3 id="Extract_Parameter">Extract Parameter</h3><p>實務上有些原本在 method 內的固定值，想要變成參數可由外部帶入，建議使用 <code>Extract Parameter</code> 將固定值重構成參數。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtractParameter</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Calculate</span><span class="params">(int <span class="variable">$i</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="variable">$i</span> &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="variable">$i</span> = <span class="variable">$i</span> + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$i</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">DisplaySum</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$this</span>-&gt;Calculate(<span class="variable">$a</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"The final result is "</span> . <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtractParameter</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Calculate</span><span class="params">(int <span class="variable">$i</span>, int <span class="variable">$c</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="variable">$i</span> &lt; <span class="variable">$c</span>) &#123;</span><br><span class="line">            <span class="variable">$i</span> = <span class="variable">$i</span> + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$i</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">DisplaySum</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$this</span>-&gt;Calculate(<span class="variable">$a</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"The final result is "</span> . <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor010.png" alt="refactor010"></p>
<p>將滑鼠游標放在固定值上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Parameter</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor011.png" alt="refactor011"></p>
<p>輸入欲建立的 parameter 名稱。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor012.png" alt="refactor012"></p>
<p>PhpStorm 會自動幫我們重構成參數，將原有的固定值都以參數取代，並在 method 呼叫 的地方重構成原來的值。</p>
<h3 id="Extract_Constant">Extract Constant</h3><p>實務上不建議將<strong>字串</strong>或<strong>數字</strong>直接 hardcode 在程式碼中 :</p>
<ul>
<li>日後難以閱讀與維護</li>
<li>若字串與數字需要變動，需要改很多地方</li>
</ul>
<p>建議將這類 Magic Number 使用 <code>Extract Constant</code> 重構成 constant。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtractConstant</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">potentialEnergy</span><span class="params">(int <span class="variable">$mass</span>, int <span class="variable">$height</span>)</span>: <span class="title">float</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$mass</span> * <span class="variable">$height</span> * <span class="number">9.81</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtractConstant</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> GRAVITATIONAL_CONSTANT = <span class="number">9.81</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">potentialEnergy</span><span class="params">(int <span class="variable">$mass</span>, int <span class="variable">$height</span>)</span>: <span class="title">float</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$mass</span> * <span class="variable">$height</span> * <span class="keyword">self</span>::GRAVITATIONAL_CONSTANT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor007.png" alt="refactor007"></p>
<p>將滑鼠游標放在數值上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Constant</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor008.png" alt="refactor008"></p>
<p>輸入欲建立的 constant 名稱。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor009.png" alt="refactor009"></p>
<p>PhpStorm 會自動幫我們重構成 <code>const</code>，並將原有的值都以 constant 取代。</p>
<h3 id="Extract_Interface">Extract Interface</h3><p>為了讓 class 實現不同的角色，且讓 class 與 class 之間的耦合降低，讓物件不要直接相依某個物件，而是僅相依於 interface，建議使用 <code>Extract Interface</code> 重構出 interface。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMSService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printMessage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'Print Message'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span><span class="params">()</span> : <span class="title">string</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Send Message'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> SMSService */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$SMSService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> SMSService $SMSService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SMSService <span class="variable">$SMSService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;SMSService = <span class="variable">$SMSService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;SMSService-&gt;sendMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Sendable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span><span class="params">()</span>: <span class="title">string</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Printable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printMessage</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMSService</span> <span class="keyword">implements</span> <span class="title">Sendable</span>, <span class="title">Printable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printMessage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'Print Message'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span><span class="params">()</span> : <span class="title">string</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Send Message'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Sendable */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$SMSService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> ISendable $SMSService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Sendable <span class="variable">$SMSService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;SMSService = <span class="variable">$SMSService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showPost</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;SMSService-&gt;sendMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor017.png" alt="refactor017"></p>
<p>欲從 class 抽出 interface，將滑鼠游標放在 class 名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Interface</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor018.png" alt="refactor018"></p>
<p>輸入欲建立的 interface 名稱，選擇欲抽出的 method。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor019.png" alt="refactor019"></p>
<p>PhpStorm 會幫我們重構出 interface。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor020.png" alt="refactor020"></p>
<p>原 class 也會自動加上 <code>implements</code> interface。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor021.png" alt="refactor021"></p>
<p>繼續抽出第 2 個 interface，將滑鼠游標放在 class 名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Interface</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor022.png" alt="refactor022"></p>
<p>輸入欲建立的 interface 名稱，選擇欲抽出的 method。</p>
<p>並勾選 <code>Replace class references with interface where possible</code>，PhpStorm 會自動搜尋所有使用 class 的地方，以 interface 取代。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor023.png" alt="refactor023"></p>
<p>重構前的預覽，PhpStorm 告知即將對以下檔案進行重構，按 <code>Do Refactor</code> 繼續。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor024.png" alt="refactor024"></p>
<p>PhpStorm 會幫我們產生 interface。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor025.png" alt="refactor025"></p>
<p>原 class 也會自動加上 <code>implements</code> interface。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor026.png" alt="refactor026"></p>
<p>原來 constructor 的參數型別，也從 class 變成 interface，field 的型別宣告也變成了 interface。</p>
<p>如此 <code>PostService</code> 與 <code>SMSService</code> 的相依僅限於 <code>Sendable</code> interface，大大降低 <code>PostService</code> 與 <code>SMService</code> 之間的耦合，也就是<code>設計模式</code>一書所說的：</p>
<blockquote>
<p>根據 interface 寫程式，不要根據 class 寫程式</p>
</blockquote>
<p>白話就是</p>
<blockquote>
<p>若要降低物件之間的耦合程度，讓物件之間方便抽換與組合，就讓物件與物件之間僅相依於 interface，而不要直接相依於 class</p>
</blockquote>
<p>更白話就是</p>
<blockquote>
<p>黑貓白貓，能抓老鼠的就是好貓</p>
<p>黑貓白貓就是 class，能抓老鼠就是 interface</p>
</blockquote>
<h2 id="Rename">Rename</h2><hr>
<p>實務上常會遇到 variable 名稱、method 名稱、class 名稱…的命名不當，導致程式碼難以閱讀，在 code review 後須加以重構，PhpStorm 支援 <code>Rename Class</code>、 <code>Rename Method</code>, <code>Rename Field</code>、 <code>Rename Variable</code>、 <code>Rename Parameter</code>，以下僅對最常用的 <code>Rename Variable</code> 、<code>Rename Method</code>、<code>Change Signature</code>、<code>Rename Class</code> 加以介紹。</p>
<h3 id="Rename_Variable">Rename Variable</h3><p>當遇到命名不當的變數名稱時，建議使用 <code>Rename Variable</code> 將變數名稱加以重構。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenameVariable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="string">'Sam'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$address</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenameVariable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="string">'Sam'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor027.png" alt="refactor027"></p>
<p>將滑鼠游標放在變數名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Rename</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor028.png" alt="refactor028"></p>
<p>從 <code>$address</code> 重構成 <code>$name</code> 之後，PhpStorm 會將所有原本使用 <code>$address</code> 變數的地方都重構成使用 <code>$name</code>。</p>
<h3 id="Rename_Method">Rename Method</h3><p>當遇到命名不當的 method 名稱時，建議使用 <code>Rename Method</code> 將 method 名稱加以重構。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenameMethod</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;printOutline();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printOutline</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'Detail'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenameMethod</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;printDetail();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printDetail</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'Detail'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor029.png" alt="refactor029"></p>
<p>將滑鼠游標放在 method 名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Rename</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor030.png" alt="refactor030"></p>
<p>將 <code>printOutline()</code> 重構成 <code>printDetail()</code>，PhpStorm 會即時顯示修改後的結果。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor031.png" alt="refactor031"></p>
<p>重構前的預覽，PhpStorm 告知即將對以下檔案進行重構，按 <code>Do Refactor</code> 繼續。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor032.png" alt="refactor032"></p>
<p>除了原來的 method 名稱變更外，PhpStorm 會將所有引用該 method 的地方加以修改。</p>
<h3 id="Change_Signature">Change Signature</h3><p>實務上因需求改變，可能必須增加參數，也可能必須刪除參數，建議使用 <code>Change Signature</code> 來重構參數。</p>
<h4 id="Change_Method_Signature">Change Method Signature</h4><p>修改一般 method 的參數。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeSignature</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$this</span>-&gt;sum(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sum</span><span class="params">(int <span class="variable">$num1</span>, int <span class="variable">$num2</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$num1</span> + <span class="variable">$num2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeSignature</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$this</span>-&gt;sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sum</span><span class="params">(int <span class="variable">$num1</span>, int <span class="variable">$num2</span>, int <span class="variable">$num3</span> = <span class="number">0</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$num1</span> + <span class="variable">$num2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor033.png" alt="refactor033"></p>
<p>將滑鼠游標放在 method 名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Change Signature</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor034.png" alt="refactor034"></p>
<p>按 <code>+</code> 新增參數，Default 則為其他 mehtod 呼叫參數時，所提供的預設值。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor035.png" alt="refactor035"></p>
<p> PhpStorm 除了在 method 增加參數外，其他呼叫 method 的地方都會加上預設值。</p>
<h4 id="Change_Constructor_Signature">Change Constructor Signature</h4><p>修改 constructor 的參數。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeConstructorSignature</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> PostService */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * ChangeConstructorSignature constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostService $postService</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostService <span class="variable">$postService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postService = <span class="variable">$postService</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeConstructorSignature</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> PostService */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$postService</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> SMSService */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$SMSService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * ChangeConstructorSignature constructor.</span><br><span class="line">     * <span class="doctag">@param</span> PostService $postService</span><br><span class="line">     * <span class="doctag">@param</span> SMSService $SMSService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PostService <span class="variable">$postService</span>, SMSService <span class="variable">$SMSService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;postService = <span class="variable">$postService</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;SMSService = <span class="variable">$SMSService</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor036.png" alt="refactor036"></p>
<p>將滑鼠游標放在 <code>__construct()</code> 上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Change Signature</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor037.png" alt="refactor037"></p>
<p>若是對 constructor 使用 <code>Change Signature</code>，會出現 <code>Create and initialize class properties</code>，預設會打勾。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor038.png" alt="refactor038"></p>
<p>PhpStorm 除了自動幫我們在 constructor 加上參數外，還會對 field 加以初始化。</p>
<h3 id="Rename_Class">Rename Class</h3><p>當遇到命名不當的 class 名稱時，建議使用 <code>Rename Class</code> 將 class 名稱加以重構。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenameClass</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'Hello World'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> RenameClass();</span><br><span class="line"><span class="variable">$obj</span>-&gt;print();</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRenameClass</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'Hello World'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> MyRenameClass();</span><br><span class="line"><span class="variable">$obj</span>-&gt;print();</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor039.png" alt="refactor039"></p>
<p>將滑鼠游標放在 class 名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Rename</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor040.png" alt="refactor040"></p>
<p>直接修改 class 名稱，PhpStorm 會即時顯示修改後的結果。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor041.png" alt="refactor041"></p>
<p>重構前的預覽，PhpStorm 告知即將對以下檔案進行重構，按 <code>OK</code> 繼續。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor042.png" alt="refactor042"></p>
<p>class 名稱重構後，PhpStorm 將所有原本 new 之處都改用新的 class 名稱。</p>
<p>除此之外，檔案名稱也從重構成新的名稱。</p>
<h2 id="Movement">Movement</h2><hr>
<h3 id="Move_Static_Member">Move Static Member</h3><p>實務上因需求改變，原本的 field 與 method 可能不再適合目前的 class，建議使用 <code>Move Static Member</code> 搬移 field 與 method 到適當的 class。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoveStaticMember1</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="variable">$var1</span> = <span class="string">'Hello World'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="keyword">self</span>::<span class="variable">$var1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoveStaticMember2</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoveStaticMember0</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        MoveStaticMember1::print();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoveStaticMember1</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoveStaticMember2</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="variable">$var1</span> = <span class="string">'Hello World'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="keyword">self</span>::<span class="variable">$var1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoveStaticMember0</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        MoveStaticMember2::print();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor043.png" alt="refactor043"></p>
<p>將滑鼠游標放在 <code>$var1</code> 或 <code>print()</code> 上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Move</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor044.png" alt="refactor044"></p>
<p>選擇要重構的 member，並指定要重構到的新 class。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor045.png" alt="refactor045"></p>
<p> 原 class 已經無任何 member。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor046.png" alt="refactor046"></p>
<p>所有的 member 都已經重構到新 class。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor047.png" alt="refactor047"></p>
<p>原來使用舊 class 之處已經重構成新 class。</p>
<blockquote>
<p>目前 PhpStorm 僅支援對 static member 的重構到其他 class，對於一般的 field / const / method，則必須手動重構。</p>
</blockquote>
<h3 id="Move_Class">Move Class</h3><p>實務上因需求改變，原本在某一 namespace 下的 class，可能不再適合目前的 namespace，建議使用 <code>Move Class</code> 將 class 重構到適當的 namespace。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Sendable */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$SMSService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Sendable $SMSService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Sendable <span class="variable">$SMSService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;SMSService = <span class="variable">$SMSService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;SMSService-&gt;sendMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">PostService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">SMSService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostServiceIntegrationTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> PostService */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$target</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::setUp();</span><br><span class="line">        <span class="variable">$SMSService</span> = <span class="keyword">new</span> SMSService();</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = <span class="keyword">new</span> PostService(<span class="variable">$SMSService</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 顯示正確簡訊<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;showMessage();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="string">'Send Message'</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Sendable */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$SMSService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Sendable $SMSService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Sendable <span class="variable">$SMSService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;SMSService = <span class="variable">$SMSService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;SMSService-&gt;sendMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Post</span>\<span class="title">PostService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">SMSService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostServiceIntegrationTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> PostService */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$target</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::setUp();</span><br><span class="line">        <span class="variable">$SMSService</span> = <span class="keyword">new</span> SMSService();</span><br><span class="line">        <span class="variable">$this</span>-&gt;target = <span class="keyword">new</span> PostService(<span class="variable">$SMSService</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 顯示正確簡訊<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$this</span>-&gt;target-&gt;showMessage();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="string">'Send Message'</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor048.png" alt="refactor048"></p>
<p>將滑鼠游標放在 class 名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Move</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor049.png" alt="refactor049"></p>
<p>在 <code>Move Class PostService to namespace</code> 填入新的 namespace 完整路徑，可以是既有 namespace，也可以是新的 namespace，若是新的 namespace，PhpStorm 會自動幫你建立目錄。</p>
<p>要勾選 <code>Search in comments and strings</code> 與 <code>Search for text occurences</code>，PhpStorm 會一併將有用到此 class 的地方一起修改。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor050.png" alt="refactor050"></p>
<p>重構前的預覽，PhpStorm 告知即將對以下檔案進行重構，按 <code>Do Refactor</code> 繼續。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor051.png" alt="refactor051"></p>
<p>PhpStorm 會幫我們建立新的子目錄，且 namespace 也做了修改。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor052.png" alt="refactor052"></p>
<p>使用到 class 的地方，<code>use</code> 也跟會自動修改。</p>
<h3 id="Move_Namespace">Move Namespace</h3><p>實務上因需求改變，原本在某一 namespace 下的所有 class，可能不再適合目前的 namespace，建議使用 <code>Move Namespace</code> 將所有 class 重構到適當的 namespace。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMSService</span> <span class="keyword">implements</span> <span class="title">Printable</span>, <span class="title">Sendable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printMessage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'Print Message'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span><span class="params">()</span> : <span class="title">string</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Send Message'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Libs</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMSService</span> <span class="keyword">implements</span> <span class="title">Printable</span>, <span class="title">Sendable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printMessage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'Print Message'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span><span class="params">()</span> : <span class="title">string</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Send Message'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor053.png" alt="refactor053"></p>
<p>將滑鼠游標放在 namespace 名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Move</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor054.png" alt="refactor054"></p>
<p>在 <code>Move Namespace</code> 填入新的 namespace 完整路徑，可以是既有 namespace，也可以是新的 namespace，若是新的 namespace，PhpStorm 會自動幫你建立目錄。</p>
<p>要勾選 <code>Search in comments and strings</code> 與 <code>Search for text occurences</code>，PhpStorm 會一併將有用到原 namespace 的地方一起修改。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor055.png" alt="refactor055"></p>
<p>PhpStorm 會列出所有即將重構的 class。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor056.png" alt="refactor056"></p>
<p>重構前的預覽，PhpStorm 告知即將對以下檔案進行重構，按 <code>Do Refactor</code> 繼續。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor057.png" alt="refactor057"></p>
<p>PhpStorm 幫我們將原來 <code>Services</code> 目錄下的 class 都重構到 <code>Libs</code> 目錄，且 namespace 也做了修改。</p>
<h2 id="Inheritance">Inheritance</h2><hr>
<h3 id="Pull_Members_Up">Pull Members Up</h3><p>若 class 之間有共用的邏輯，建議使用 <code>Pull Members Up</code> 重構到 super class，讓邏輯不再重複，符合 DRY 原則。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Sendable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span> <span class="keyword">extends</span> <span class="title">AbstractPostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Sendable */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$SMSService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Sendable $SMSService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Sendable <span class="variable">$SMSService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;SMSService = <span class="variable">$SMSService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;SMSService-&gt;sendMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Sendable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span> <span class="keyword">extends</span> <span class="title">AbstractPostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Sendable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbstractPostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Sendable */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$SMSService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Sendable $SMSService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Sendable <span class="variable">$SMSService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;SMSService = <span class="variable">$SMSService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;SMSService-&gt;sendMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor058.png" alt="refactor058"></p>
<p>將滑鼠游標放在欲 pull up 的 member 名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Pull Members Up</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor059.png" alt="refactor059"></p>
<p>選擇要 pull up 的 member，若是 <code>private</code>，PhpStorm 會升格成 <code>protected</code>。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor060.png" alt="refactor060"></p>
<p>原 class 內所有 member 都被 pull up。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor061.png" alt="refactor061"></p>
<p>所有 member 都 pull up 到 super class 了。</p>
<h3 id="Push_Members_Down">Push Members Down</h3><p>實務上因需求改變，原本共用的邏輯可能不再共用，建議使用 <code>Pull Members Down</code> 將 member 從 super class 降回 sub class。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Sendable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbstractPostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Sendable */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$SMSService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Sendable $SMSService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Sendable <span class="variable">$SMSService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;SMSService = <span class="variable">$SMSService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;SMSService-&gt;sendMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Sendable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span> <span class="keyword">extends</span> <span class="title">AbstractPostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Sendable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostService</span> <span class="keyword">extends</span> <span class="title">AbstractPostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Sendable */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$SMSService</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * PostService constructor.</span><br><span class="line">     * <span class="doctag">@param</span> Sendable $SMSService</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Sendable <span class="variable">$SMSService</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;SMSService = <span class="variable">$SMSService</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$this</span>-&gt;SMSService-&gt;sendMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Post</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Sendable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbstractPostService</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor062.png" alt="refactor062"></p>
<p>將滑鼠游標放在欲 pull down 的 member 名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Push Members Down</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor063.png" alt="refactor063"></p>
<p>選擇要 push down 的 member，若是 <code>__</code> 的 magic method，PhpStorm 會提出警告。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor064.png" alt="refactor064"></p>
<p>原 class 內所有 member 都被 push down。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor065.png" alt="refactor065"></p>
<p>所有 member 都 push down 到 sub class 了。</p>
<h2 id="Others">Others</h2><hr>
<h3 id="If_Else_to_Switch">If Else to Switch</h3><p>由於 <code>if else</code> 較容易思考，所以很容易寫出 <code>if else</code> 的程式碼，PhpStorm 可以幫我們重構成可讀性較高的 <code>switch</code>。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> string $type</span><br><span class="line">     * <span class="doctag">@param</span> int $days</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculatePrice</span><span class="params">(string <span class="variable">$type</span>, int <span class="variable">$days</span>)</span>: <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$type</span> == <span class="string">'Regular'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="variable">$days</span> - <span class="number">7</span>) * <span class="number">10</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="variable">$type</span> == <span class="string">'NewRelease'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="variable">$days</span> - <span class="number">3</span>) * <span class="number">30</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="variable">$type</span> == <span class="string">'Children'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="variable">$days</span> - <span class="number">7</span>) * <span class="number">10</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> (<span class="variable">$days</span> - <span class="number">7</span>) * <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> string $type</span><br><span class="line">     * <span class="doctag">@param</span> int $days</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculatePrice</span><span class="params">(string <span class="variable">$type</span>, int <span class="variable">$days</span>)</span>: <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Regular'</span>:</span><br><span class="line">                <span class="keyword">return</span> (<span class="variable">$days</span> - <span class="number">7</span>) * <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'NewRelease'</span>:</span><br><span class="line">                <span class="keyword">return</span> (<span class="variable">$days</span> - <span class="number">3</span>) * <span class="number">30</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Children'</span>:</span><br><span class="line">                <span class="keyword">return</span> (<span class="variable">$days</span> - <span class="number">7</span>) * <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> (<span class="variable">$days</span> - <span class="number">7</span>) * <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor066.png" alt="refactor066"></p>
<p>將滑鼠游標放在 <code>if</code> 之前，按熱鍵選擇 <code>Replace if with switch</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Alt + enter</p>
<p><strong>macOS</strong> : option + return</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor067.png" alt="refactor067"></p>
<p>PhpStorm 會幫我們將 <code>if else</code> 重構成 <code>switch</code>。</p>
<h3 id="Inline">Inline</h3><p>大部分的狀況， <code>Extract Variable</code> 會讓程式碼可讀性更高，也更好維護，若發現因此造成程式碼更為複雜，或者多餘，建議使用 <code>Inline Variable</code> 重構刪除變數。</p>
<p><strong><em>重構前</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InlineVariable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="string">'Sam'</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>重構後</em></strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InlineVariable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">'Sam'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor068.png" alt="refactor068"></p>
<p>將滑鼠游標放在欲 inline 的 variable 名稱上，按熱鍵跳出 <code>Refactor This</code>  選單，選擇 <code>Inline</code>。</p>
<blockquote>
<p><strong>Windows</strong> : Ctrl + Alt + Shift + T</p>
<p><strong>macOS</strong> : control + T</p>
</blockquote>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor069.png" alt="refactor069"></p>
<p>PhpStorm 會列出它所找到該 inline 的變數個數，按 <code>OK</code> 繼續。</p>
<p><img src="/images/phpstorm/phpstorm-refactoring/refactor070.png" alt="refactor070"></p>
<p>PhpStorm 會自動幫我們將變數刪除，直接使用值取代變數。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>所有的重構動作若不滿意，都可以取消重構，此外，每個重構步驟都該搭配 git 做版控，確保重構失敗後可以正確還原。</li>
<li>認為重構很花時間的人，是因為沒有善用工具，若能善用 PhpStorm 的重構功能，就能大幅節省重構所花的時間，減少技術債。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52Refactoring_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<p>Martin Fowler, <a href="https://www.tenlong.com.tw/items/9861547533?item_id=45657" target="_blank" rel="external">Refactoring: Improving The Design of Existing Code</a><br>GoF, <a href="https://www.tenlong.com.tw/products/9789572054116" target="_blank" rel="external">Design Pattern</a></p>
]]></content>
    <summary type="html">
    <![CDATA[使用 PhpStorm 強大的重構功能]]>
    
    </summary>
    
      <category term="PhpStorm" scheme="http://oomusou.io/tags/PhpStorm/"/>
    
      <category term="Refactoring" scheme="http://oomusou.io/tags/Refactoring/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[深入探討 Angular 的 DI 與 Provider]]></title>
    <link href="http://oomusou.io/angular/angular-di/"/>
    <id>http://oomusou.io/angular/angular-di/</id>
    <published>2017-03-08T12:23:43.000Z</published>
    <updated>2017-04-16T12:02:30.000Z</updated>
    <content type="html"><![CDATA[<p>DI (Dependency Injection) 對於很多前端開發者是個陌生的名詞，畢竟以前沒有 DI 時，也沒有什麼東西寫不出來，為什麼 Angular 要全面提供 DI 與 provider 呢？</p>
<a id="more"></a>
<h2 id="Version">Version</h2><hr>
<p>Angular CLI 1.0.0-rc.0<br>Angular 2.4.9<br>WebStorm 2016.3.3</p>
<h2 id="為什麼需要_DI?">為什麼需要 DI?</h2><hr>
<p>我們先來建立兩個簡單的 service，來觀察有用 DI 與沒用 DI 的差異。</p>
<h3 id="無_DI_版本">無 DI 版本</h3><p><strong>NotificationService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;SMSService&#125; from <span class="string">'./sms.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> NotificationService &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> smsService : SMSService;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.smsService = <span class="keyword">new</span> SMSService();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  showMessage() : <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.smsService.sendMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>NotificationService</code> 的 <code>showMessage()</code> 需要使用到 <code>SMSService</code> 的 <code>sendMessage()</code>，因此我們在 constructor 內建立 <code>SMSService</code>  。</p>
<p><strong>SMSService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> SMSService &#123;</span><br><span class="line">  </span><br><span class="line">  printMessage(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Print Message'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sendMessage(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Send Message'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SMSService</code> 提供了 <code>printMessage()</code> 與 <code>sendMessage()</code> 兩個 method。</p>
<p><strong>AppComponent</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component, OnInit&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NotificationService&#125; from <span class="string">'./notification.service'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> notificationService: NotificationService;</span><br><span class="line"></span><br><span class="line">  title = <span class="string">'app works!'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.notificationService = <span class="keyword">new</span> NotificationService();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.title = <span class="keyword">this</span>.notificationService.showMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AppComponent</code> 因為需要用到 <code>NotificationService</code>，所以也在 constructor 內建立 <code>notificationService</code> 。</p>
<p>目前看起來沒什麼問題，程式也能正常執行，大家之前也都是這樣寫程式。</p>
<p>但是在 <code>NotificationService</code> 使用 new <code>SMSService()</code> 這種寫法有 3 大缺點：<strong><em>Brittle、Inflexible、Hard to Test</em></strong>。</p>
<h4 id="Brittle">Brittle</h4><p>由於我們是在 <code>NotificationService</code> 內去 new <code>SMSService</code>，而 new 是透過 constructor 去建立 service，若今天 <code>SMSService</code> 的 constructor 參數增加或減少，勢必 <code>NotificationService</code> 也必須跟著修改，如 <code>this.smsService = new SMSService(theNewParameter)</code>。</p>
<blockquote>
<p>一個 service 會因為其相依 service 的 constructor 參數修改，而連帶必須跟著修改，因此說其為 <strong><em>Brittle</em></strong>。</p>
</blockquote>
<h4 id="Inflexible">Inflexible</h4><p>由於我們是在 <code>NotificationService</code> 內去 new <code>SMSService</code>，若將來需求改變，想要更換其他簡訊服務商，如原本為 AWS 簡訊服務，想換成 Azure 簡訊服務，目前無法做到，因為 <code>NotificationService</code> 已經直接在內部與 <code>SMSService</code> 耦合在一起，無法由外部更換。</p>
<blockquote>
<p>在一個  service 內直接去 new 其他 service，就類似主機板將記憶體直接焊死 on board，想要擴充都無法擴充，因此說其為 <strong><em>Inflexible</em></strong>。</p>
</blockquote>
<h4 id="Hard_to_Test">Hard to Test</h4><p>當我們想對 <code>NotificationService</code> 做單元測試時，由於 <code>NotificationService</code> 相依了 <code>SMSService</code>，因此 <code>SMSService</code> 的所有行為將會影響 <code>NotificationService</code>，如 <code>SMSServce</code> 可能是非同步，可能每次都要收費，但這些都不是我們對 <code>NotificationService</code> 單元測試想做的，因此希望對 <code>SMSService</code> 加以隔離，單純測試 <code>NotificationService</code> 的行為。</p>
<p>儘管我們建立了 <code>假SMSService</code> 想取代 <code>真SMSService</code>，但因為 <code>SMSService</code> 被 <code>NotificationService</code> 建立在內部，我們沒有任何管道由外部將 <code>假SMSService</code>傳入，進而取代<code>真SMSService</code>。</p>
<blockquote>
<p>在一個 service 內直接去 new 其他 service，在單元測試時會無法在外部以假 service 取代，因此說其為 <strong>Hard to Test</strong>。</p>
</blockquote>
<h3 id="有_DI_版本">有 DI 版本</h3><p>我們該怎麼使 <code>NotificationService</code>  <strong><em>Robut、Flexible 與 Testable</em></strong> 呢?</p>
<p>其實很簡單，只要將 new 改成用 contructor 參數，這就是 DI 了。</p>
<p><strong>NotificationService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;SMSService&#125; from <span class="string">'./sms.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> NotificationService &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> smsService : SMSService;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(smsService: SMSService) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.smsService = smsService;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  showMessage() : <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.smsService.sendMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 7 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>(smsService: SMSService) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.smsService = smsService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>從 new 改成用 constructor 參數。</p>
<p><strong>AppComponent</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component, OnInit&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NotificationService&#125; from <span class="string">'./notification.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;SMSService&#125; from <span class="string">'./sms.service'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> notificationService: notificationService;</span><br><span class="line"></span><br><span class="line">  title = <span class="string">'app works!'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.notificationService = <span class="keyword">new</span> NotificationService(<span class="keyword">new</span> SMSService)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.title = <span class="keyword">this</span>.notificationService.showMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>16 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.notificationService = <span class="keyword">new</span> NotificationService(<span class="keyword">new</span> SMSService)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為改用 DI，所以在 new <code>NotificationService</code> 時，就必須將 <code>SMSService</code> 帶入。</p>
<p>當使用 DI 後，<code>NotificationService</code> 與 <code>SMSService</code> 就解耦合了，<code>NotificatonService</code> 不再由內部直接相依 service，而是由外部傳入的 service 所決定，這就是物件導向的<strong>依賴反轉原則</strong>。</p>
<blockquote>
<p>依賴反轉原則</p>
<p>抽象不要依賴細節，細節要依賴抽象。</p>
<p>高階模組不應該依賴低階模組，低階模組應該由高階模組決定其依賴。</p>
</blockquote>
<p> <code>NotificationService</code> 使用 DI 這種寫法有 3 大優點：<strong><em>Robust、Flexible、Testable</em></strong>。</p>
<h4 id="Robust">Robust</h4><p>若 <code>SMSService</code> 的 constructor 新增了參數 :</p>
<p><strong>SMSService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> SMSService &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> logService: LogService;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(logService: LogService) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.logService = logService;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>constructor 增加了 <code>logService: LogService</code> 參數。</p>
<p><strong>AppComponent</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> notificatoinService: NotificationService;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.notificationService = <span class="keyword">new</span> NotificationService(<span class="keyword">new</span> SMSService(<span class="keyword">new</span> LogService));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AppComponent</code> 新增加 <code>new LogService</code>。</p>
<p>但 <code>NotificationService</code> 完全不用做任何修改。</p>
<blockquote>
<p>將來無論相依 service 怎麼修改，原 service 都不用修改，因此說其為 <strong><em>Robust</em></strong>。</p>
</blockquote>
<h4 id="Flexible">Flexible</h4><p>若原本為 AWS 簡訊服務，想要換成 Azure 簡訊服務。</p>
<p><strong>AzureSMSService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> AzureSMSService extends SMSService &#123;</span><br><span class="line"></span><br><span class="line">  printMessage(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Print Azure Message'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sendMessage(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Send Azure Message'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新增 <code>AzureSMSService</code> ，並繼承原本的 <code>SMSService</code>，將原本的 <code>printMessage()</code> 與 <code>sendMessage()</code> 加以 override，換成 Azure 簡訊服務。</p>
<p><strong>AppComponent</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> notificationService: NotificationService;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.notificationService = <span class="keyword">new</span> NotificationService(<span class="keyword">new</span> AzureSMSService);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為物件導向的<strong>里氏替換原則</strong>，<code>AppComponent</code> 可改注入 <code>AzureSMSService</code>。</p>
<blockquote>
<p>里氏替換原則</p>
<p>所有的父類別都可以由子類別代替，但子類別不一定能用父類別代替。</p>
</blockquote>
<p><code>NotificationService</code> 完全不用做任何修改。</p>
<blockquote>
<p>將來若有新的需求，只要新增 service 注入即可，原 service 都不用修改，因此說其為 <strong><em>Flexible</em></strong>。</p>
</blockquote>
<h4 id="Testable">Testable</h4><p>若要對 <code>NotificationService</code> 做單元測試，可建立 <code>假SMSService</code> 取代原來的 <code>真SMSService</code>。</p>
<p><strong>MockSMSService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> MockSMSService extends SMSService &#123;</span><br><span class="line"></span><br><span class="line">  printMessage(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Print Mock Message'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sendMessage(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Send Mock Message'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>建立假的 <code>MockSMSService</code>，並繼承原本的 <code>SMSService</code>，將原本的 <code>printMessage()</code> 與 <code>sendMessage()</code> 加以 override，換成假的簡訊服務。</p>
<p><strong>NotificationServiceTest</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> notificationService = <span class="keyword">new</span> NotificationService(<span class="keyword">new</span> MockSMSService());</span><br></pre></td></tr></table></figure>
<p>單元測試時，因為物件導向的<strong>里氏替換原則</strong>，可使用 <code>MockService</code> 取代 <code>SMSService</code>，如此就能完全隔離原本 <code>SMSService</code> ，只執行我們的假 service 的所有功能。</p>
<!-- > Service 單元測試時，只要建立其相依 service 的假 service，並加以注入，如此就能隔離原本相依 service 的所有功能，因此說其為 ***Testable***。 -->
<p>我們來對 DI 做個小結：</p>
<blockquote>
<p>DI 只是一種程式風格，將相依 service 改由外界透過 constructor 注入，而不是在內部自己用 new 產生。</p>
</blockquote>
<h2 id="DI_搭配工廠模式">DI 搭配工廠模式</h2><hr>
<p>DI 雖然對於 service 本身很有利，無論其相依的 service 如何修改，service 本身都不用修改，也就是物件導向的<strong>開放封閉原則</strong>，但對於使用 service 的 component 卻很辛苦。</p>
<blockquote>
<p>開放封閉原則</p>
<p>對於擴展是開放的，對於修改是封閉的。</p>
</blockquote>
<p><strong>AppComponent</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> notificationService: NotificationService;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.notificationService = <span class="keyword">new</span> NotificationService(<span class="keyword">new</span> SMSService);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Component 必須使用 <code>new NotificationService(new SMSService)</code> 這種巢狀的方式才能建立 service，若相依 service 有更多層，則 new 的寫法將相當恐怖。</p>
<p>若使用設計模式的<strong>工廠模式</strong>，則狀況會好一點。</p>
<p><strong>NotificationServiceFactory</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;NotificationService&#125; from <span class="string">'./notification.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;SMSService&#125; from <span class="string">'./sms.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> NotificationServiceFactory &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> createNotificationService(): NotificationService &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NotificationService(<span class="keyword">this</span>.createSMSService());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> createSMSService() : SMSService &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SMSService();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>建立一個 <code>NotificationServiceFactory</code> 專門負責建立各 service。</p>
<p>其中包含建立 <code>NotificationService</code> 與 <code>SMSService</code>。</p>
<p><strong>AppComponent</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component, OnInit&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NotificationService&#125; from <span class="string">'./notification.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NotificationServiceFactory&#125; from <span class="string">'./notification-service-factory'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> notificationService: NotificationService;</span><br><span class="line"></span><br><span class="line">  title = <span class="string">'app works!'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.notificationService = NotificationServiceFactory.createNotificationService();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.title = <span class="keyword">this</span>.notificationService.showMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>16 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor"><span class="keyword">constructor</span>() </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.notificationService = NotificationServiceFactory.createNotificationService();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原本在 constructor 的 new 改用 <code>NotificationServiceFactory</code> 取代，最少日後其他 component 要建立 <code>NotificationService</code> 都改用 <code>NotificationServiceFactory</code>，不用再使用很恐怖的 new。</p>
<p>不過這樣寫法仍有些問題。</p>
<p>若 <code>NotificationService</code> 所依賴的 service 很多，或依賴的 service 層數很深，則 <code>NotificationServiceFactory</code> 的 method 數量將會爆炸，所以<strong>工廠模式</strong>也不算最完美的解決方案。</p>
<h2 id="Angular_的_Provider">Angular 的 Provider</h2><hr>
<p>Angular 提供了 Provider，專門替我們建立 service，解決<strong>工廠模式</strong>所面臨的問題。</p>
<p><img src="/images/angular/di/di000.svg" alt="di000"></p>
<p>原本我們透過<strong>工廠模式</strong>自己處理 service 的 DI，現在改由 Angular 的 provider 接手。</p>
<p><strong>NotificationService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Injectable&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;SMSService&#125; from <span class="string">'./sms.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> NotificationService &#123;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private smsService: SMSService) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  showMessage() : <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.smsService.sendMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>NotificationService</code> 相依 <code>SMSService</code> 部分，全部改由 DI 方式。</li>
<li>加上  <code>@Injectable()</code> decorator，記得要加上 <code>()</code>。</li>
<li>加上 <code>import {Injectable} from &#39;@angular/core&#39;;</code></li>
</ul>
<p>constructor 參數直接加上 <code>private</code>，TypeScript 會展開成為</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> NotificationService &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> smsService: SMSService;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(smsService: SMSService) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.smsService = smsService;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這算是 TypeScript  的  syntax sugar，讓我們不用宣告 private field 與寫 field 的 initialization code，讓程式碼更加乾淨。</p>
<p><strong>AppComponent</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component, OnInit&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NotificationService&#125; from <span class="string">'./notification.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;SMSService&#125; from <span class="string">'./sms.service'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>],</span><br><span class="line">  providers: [</span><br><span class="line">    &#123;provide: NotificationService, useClass: NotificationService&#125;,</span><br><span class="line">    &#123;provide: SMSService, useClass: SMSService&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit&#123;</span><br><span class="line"></span><br><span class="line">  title = <span class="string">'app works!'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private notificationService: NotificationService) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.title = <span class="keyword">this</span>.notificationService.showMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AppComponent</code> 相依 <code>NotificationService</code> 部分，全部改由 DI 方式。</p>
<p>除此之外，要在 component 的 decorator 加上 <code>providers</code>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  &#123;provide: NotificationService, useClass: NotificationService&#125;,</span><br><span class="line">  &#123;provide: SMSService, useClass: SMSService&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>Provider 的目的，在於 DI 時，幫我們自動注入 service，但是 Angular 要怎麼知道該注入什麼 service 呢？這裏沒有黑魔法，我們要實際告訴 Angular 一個 mapping table，讓 provider 在自動注入時有所依據，<code>providers</code> 的陣列，就是 provider 所仰賴的 mapping table。</p>
<p>有幾個 service，就要提供幾筆 mapping 資料，這裡我們有  <code>NotificationService</code> 與 <code>SMSService</code>，所以 <code>providers</code> 就有兩筆資料。</p>
<p>以 <code>NotificationService</code> 為例，我們希望 provider 幫我們：</p>
<ul>
<li>當遇到型別為 <code>NotificationService</code>時，請注入<code>NotiticationService</code> 這個 service。</li>
<li><code>provide</code> 為 service 宣告的型別，<code>useClass</code> 則為 service 要實際注入的型別。</li>
</ul>
<p>大部分狀況下，若沒有使用 interface 或 abstract class，<code>provide</code> 與 <code>useClass</code> 會相同，也就是直接注入該型別的 service。</p>
<p>此時可簡寫為</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  NotificationService,</span><br><span class="line">  SMSService</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>Angular 會自動展開成</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  &#123;provide: NotificationService, useClass: NotificationService&#125;,</span><br><span class="line">  &#123;provide: SMSService, useClass: SMSService&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>當改用 provider 後，無論有相依的 service 個數有多少，相依的 service 層數有多深，我們不用為很多層的 new 傷腦筋，也不用為<strong>工廠模式</strong>的爆炸傷腦筋，只要記住一件事情：</p>
<blockquote>
<p>有用到幾個 service，就在 providers 註冊幾個 provider。</p>
</blockquote>
<p>剩下就交給 Angular 的 provider 幫我們 DI 了。</p>
<h2 id="Provider_搭配_Interface">Provider 搭配 Interface</h2><hr>
<p>為了讓 service 實現不同的角色，且讓 service 與 service 之間的耦合降低，讓 service 不要直接相依某個 service，而是僅相依於 interface，實務上需要讓  provider 根據 interface 注入 service。</p>
<p><strong><em>重構前</em></strong></p>
<p><strong>SMSService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Injectable&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> SMSService &#123;</span><br><span class="line"></span><br><span class="line">  printMessage(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Print Message'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sendMessage(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Send Message'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>NotificationService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Injectable&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;SMSService&#125; from <span class="string">'./sms.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> NotificationService &#123;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private smsService: SMSService) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  showMessage() : <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.smsService.sendMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>NotificationService</code> 中，<code>showMessage()</code> 只使用了 <code>SMSService</code> 的 <code>sendMessage()</code>，卻需要相依整個 <code>SMSService</code>，若能讓 <code>NotificationService</code> 與 <code>SMSService</code> 之間的相依僅限於 <code>ISendable</code> interface，將大大降低 <code>NotificationService</code> 與 <code>SMSService</code> 之間的耦合，也就是物件導向的<strong>介面隔離原則</strong>。</p>
<blockquote>
<p>介面隔離原則</p>
<p>用戶端程式碼不應該依賴它用不到的介面。</p>
</blockquote>
<p><strong><em>重構後</em></strong></p>
<p><strong>IPrintable</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> IPrintable </span>&#123;</span><br><span class="line">  printMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定義 <code>IPrintable</code> interface，其中只有 <code>printMessage()</code>。</p>
<p><strong>ISendable</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="interface"><span class="keyword">interface</span> ISendable </span>&#123;</span><br><span class="line">  sendMessage(): <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定義 <code>ISendable</code> interface，其中只有 <code>sendMessage()</code>。</p>
<p><strong>SMSService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Injectable&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;IPrintable&#125; from <span class="string">"./iprintable"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ISendable&#125; from <span class="string">"./isendable"</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> SMSService <span class="keyword">implements</span> IPrintable, ISendable &#123;</span><br><span class="line"></span><br><span class="line">  printMessage(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Print Message'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sendMessage(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Send Message'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SMSService</code> 去 implement <code>IPrintable</code> 與 <code>ISendable</code>。</p>
<p><strong>NotificationService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Injectable&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ISendable&#125; from <span class="string">'./isendable'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> NotificationService &#123;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private smsService: ISendable) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  showMessage() : <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.smsService.sendMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因為 <code>NotificationService</code> 事實上只需要 <code>SMSService</code> 的 <code>sendMessage()</code>，因此只需相依 <code>ISendable</code> interface 即可，不需去相依 <code>SMSService</code> 整個 service，如此 <code>NotificationService</code> 與 <code>SMSService</code> 的耦合將降低到只有 <code>ISendable</code> interface 而已。</p>
<p>但 <code>AppComponent</code> 的 provider 該怎麼寫呢？</p>
<p><strong>AppComponent</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component, OnInit&#125; from <span class="string">"@angular/core"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NotificationService&#125; from <span class="string">"./notification.service"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;SMSService&#125; from <span class="string">"./sms.service"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ISendable&#125; from <span class="string">"./isendable"</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>],</span><br><span class="line">  providers: [</span><br><span class="line">    NotificationService,</span><br><span class="line">    &#123;provide: ISendable, useClass: SMSService&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  title = <span class="string">'app works!'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private notificationService: NotificationService) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.title = <span class="keyword">this</span>.notificationService.showMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>10 行</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">providers: [</span><br><span class="line">  NotificationService,</span><br><span class="line">  &#123;provide: ISendable, useClass: SMSService&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>原來的 <code>NotificationService</code> 不變，但 <code>SMSService</code> 需改成 <code>{provide: ISendable, useClass: SMSService}</code>，告訴 Angular 當遇到 <code>ISendable</code> interface 時，請注入 <code>SMSService</code> 。</p>
<p>當 <code>NotificationService</code> 與 <code>SMSService</code> 的相依僅限於 <code>ISendable</code> interface 時，大大降低 <code>NotificationService</code> 與 <code>SMService</code> 之間的耦合，也就是<strong>設計模式</strong>一書所說的：</p>
<blockquote>
<p>根據 interface 寫程式，不要根據 class 寫程式。</p>
</blockquote>
<p>白話就是</p>
<blockquote>
<p>若要降低 service 之間的耦合程度，讓 service 之間方便抽換與組合，就讓 service 與 service 之間僅相依於 interface，而不要直接相依於 service。</p>
</blockquote>
<p>更白話就是</p>
<blockquote>
<p>黑貓白貓，能抓老鼠的就是好貓。</p>
<p>黑貓白貓就是 service，能抓老鼠就是 interface。</p>
</blockquote>
<p>不過最後實際存檔時，卻出現編譯錯誤。</p>
<p><img src="/images/angular/di/di001.png" alt="di001"></p>
<p>Angular CLI 編譯時抱怨找不到 <code>ISendable</code> interface。</p>
<p>在 Angular 官網的 <a href="https://angular.io/docs/ts/latest/guide/dependency-injection.html" target="_blank" rel="external">Angular/Guide/Dependency Injection</a> 一文中特別強調 :</p>
<blockquote>
<p>TypeScript interfaces aren’t valid tokens.</p>
<p>That seems strange if we’re used to dependency injection in strongly typed languages, where an interface is the preferred dependency lookup key.</p>
<p>It’s not Angular’s fault. An interface is a TypeScript design-time artifact. JavaScript doesn’t have interfaces. The TypeScript interface disappears from the generated JavaScript. There is no interface type information left for Angular to find at runtime.</p>
</blockquote>
<p>這並不是 Angular 或 TypeScript 的錯，因為 JavaScript 本來就沒 interface，interface 為 TypeScript 所擴充，因此編譯後會找不到 interface。</p>
<p>既然 interface 不能用，我們只能用些小技巧。</p>
<p><strong>IPrintable</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> IPrintable &#123;</span><br><span class="line">  abstract printMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ISenable</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> ISendable &#123;</span><br><span class="line">  abstract sendMessage(): <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將 interface 全改成 abstract class。</p>
<p>存檔後 provider 就正常了。</p>
<p>這並不是什奇技淫巧，在我們天天在用的 <code>OnInit</code>，在 Angular 內部事實上就是個 abstract class。</p>
<p><a href="https://github.com/angular/angular/blob/2.4.8/modules/%40angular/core/src/metadata/lifecycle_hooks.ts#L52-L69" target="_blank" rel="external">lifycycle_hooks.ts</a></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> abstract <span class="keyword">class</span> OnInit &#123; abstract ngOnInit(): <span class="built_in">void</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>因為 JavaScript 沒有 interface，我們只能拿 abstract class 當 interface 用。</p>
<h2 id="Provider_搭配_useFactory">Provider 搭配 useFactory</h2><hr>
<p>因需求改變，原本使用的是 AWS 簡訊服務，但需求端想改用 Azure 簡訊服務，且希望原來 AWS 簡訊服務暫時留著，由設定檔決定要使用 AWS 或 Azure，因為日後有可能又會從 Azure 改成 AWS。</p>
<p><strong>AWSSMSService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Injectable&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;IPrintable&#125; from <span class="string">'./iprintable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ISendable&#125; from <span class="string">'./isendable'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AWSSMSService <span class="keyword">implements</span> IPrintable, ISendable &#123;</span><br><span class="line">  </span><br><span class="line">  printMessage(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Print AWS Message'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sendMessage(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Send AWS Message'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先將原本的 <code>SMSService</code> 重構成 <code>AWSSMSService</code>。</p>
<p><strong>AzureSMSService</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Injectable&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;IPrintable&#125; from <span class="string">'./iprintable'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ISendable&#125; from <span class="string">'./isendable'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AzureSMSService <span class="keyword">implements</span> IPrintable, ISendable &#123;</span><br><span class="line"></span><br><span class="line">  printMessage() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Print Azure Message'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sendMessage(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Send Azure Message'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>建立 <code>AzureSMSService</code>，一樣 implement <code>IPrintable</code> 與 <code>ISendable</code> interface。</p>
<p><strong>environments.ts</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;AzureSMSService&#125; from <span class="string">"../app/azure-sms.service"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;AWSSMSService&#125; from <span class="string">"../app/aws-sms.service"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> environment = &#123;</span><br><span class="line">  production: <span class="literal">false</span>,</span><br><span class="line">  SMSService: AzureSMSService,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在 <code>environment.ts</code> 增加 <code>SMSService</code> 設定，可在此設定要使用 <code>AzureSMSService</code> 或 <code>AWSSMSService</code>。</p>
<blockquote>
<p>一般我們會在設定檔使用字串做設定，因為 provider 主要就是用來建立 service，所以可以直接在設定檔內使用 service 的 class，就不必靠 reflection 由字串建立 service，且還可受到 TypeScript 強型別的編譯保護。</p>
</blockquote>
<p><strong>SMSServiceProvider</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;ISendable&#125; from <span class="string">"./isendable"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;environment&#125; from <span class="string">"../environments/environment"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> SMSServiceProvider = &#123;</span><br><span class="line">  provide: Sendable,</span><br><span class="line">  useFactory: () =&gt; <span class="keyword">new</span> (environment.SMSService)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>為了將來其他 componet 要共用此 provider 方便，特別獨立出 <code>SMSServiceProvider</code>。</p>
<p>使用 <code>useFactory</code>，依 <code>environment.SMSService</code> 的設定 new 出 <code>AzureSMSService</code> 或  <code>AWSSMSService</code>。</p>
<p><strong>AppComponent</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component, OnInit&#125; from <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;NotificationService&#125; from <span class="string">'./notification.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;SMSServiceProvider&#125; from <span class="string">'./smsservice-provider'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'app-root'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>],</span><br><span class="line">  providers: [</span><br><span class="line">    NotificationService,</span><br><span class="line">    SMSServiceProvider,</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  title = <span class="string">'app works!'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="constructor"><span class="keyword">constructor</span>(private notificationService: NotificationService) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.title = <span class="keyword">this</span>.notificationService.showMessage();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>providers</code> 改成使用 <code>SMSServiceProvider</code>。</p>
<p>如此之後，儘管有新增新的 <code>SMSService</code>，只要也 implement <code>IPrintable</code> 與 <code>ISendable</code> interface，並在 <code>environments.ts</code> 設定新的 <code>SMSService</code> 即可，<code>NotificattionService</code>、 <code>AppComponent</code> 與 <code>SMSServiceProvider</code> 都不用修改，達成物件導向的<strong>開放封閉原則</strong>。</p>
<h2 id="重構_Service">重構 Service</h2><hr>
<p>目前全部的 service 都在 app 目錄下有點亂，透過 WebStorm，我們可以將所有 service 加以重構，完全不用人工修改任何程式碼。</p>
<p><img src="/images/angular/di/di002.png" alt="di002"></p>
<p>重構前，所有 service 都在 <code>app</code> 目錄下。</p>
<p><img src="/images/angular/di/di003.png" alt="di003"></p>
<p>重構之後井井有條：</p>
<ul>
<li><code>NotificationService</code> 放在 <code>app/services/notification</code> 目錄下。</li>
<li><code>AWSSMSService</code> 、<code>AzureSMSService</code> 與 <code>SMSServiceProvider</code> 放在 <code>app/services/sms</code> 目錄下。</li>
<li><code>IPrintable</code> 與 <code>ISenable</code> 放在 <code>app/services/interfaces</code> 目錄下。</li>
</ul>
<p>WebStorm 會幫我們修改所有的 import 路徑，完全不用我們操心。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>DI 雖然好用，但要搭配 provider 才能發揮全部威力，達成物件導向的終極目標：<strong>開放封閉原則</strong>。</li>
<li>Angular 提供完整的 DI + provider，讓我們在後端的開發經驗能繼續在前端使用。</li>
</ul>
<h2 id="Reference">Reference</h2><hr>
<p>Google, <a href="https://angular.io/docs/ts/latest/guide/dependency-injection.html" target="_blank" rel="external">Angular/Guide/Dependency Injection</a><br>Google, <a href="https://angular.io/docs/ts/latest/cookbook/dependency-injection.html" target="_blank" rel="external">Angular/Cookbook/Dependency Injection</a></p>
]]></content>
    <summary type="html">
    <![CDATA[讓前端也能使用後端常用的開發技巧]]>
    
    </summary>
    
      <category term="Angular" scheme="http://oomusou.io/tags/Angular/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何在 TDD 使用「重構九式」?]]></title>
    <link href="http://oomusou.io/refactor/refactor-in-action/"/>
    <id>http://oomusou.io/refactor/refactor-in-action/</id>
    <published>2016-11-27T12:23:43.000Z</published>
    <updated>2017-04-18T15:39:37.000Z</updated>
    <content type="html"><![CDATA[<p>TDD 不僅是先寫測試而已，當第一個 <span class="label label-success">綠燈</span> 之後，剩下的半壁江山就是拼<strong>重構</strong>功力，重構的書多半來自於 Java，因此有些 PHP 獨門的重構技巧在 Java 書上是看不到的，也因為編程思維的持續演進，重構也有了新的面貌，本文整理出自己在實務上，天天必用的 9 個適用於 PHP 重構的 SOP。</p>
<a id="more"></a>
<h2 id="Motivation">Motivation</h2><hr>
<p>對於很多人來說，使用 imperative 方式寫程式不難，只要將所想的演算法以程式表達即可，也會使用 procedure 方式實現 DRY，但若要長出 <code>class</code>、<code>interface</code>、<code>abstract class</code> 則有難度，更遑論 <code>closure</code> 與 <code>trait</code>，事實上這些東西，都不是<strong>設計</strong>出來的，而是<strong>重構</strong>出來的，也就是 TDD 第一個 <span class="label label-success">綠燈</span> 之後，透過重構慢慢長出 <code>class</code>、<code>interface</code>、<code>abstract class</code>、<code>closure</code> 與 <code>trait</code>。</p>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.8<br>Laravel 5.3.24</p>
<h2 id="實際案例">實際案例</h2><hr>
<p>假設我們想要計算運費，目前有<strong>黑貓</strong>、<strong>新竹客運</strong>與<strong>郵局</strong>三家可以選擇，每家針對不同的<strong>重量</strong>有其相對應的計算公式，而我們希望能寫出<strong>高內聚、低耦合</strong>，符合 <strong>SOLID</strong> 原則的程式碼，方便日後維護。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>此範例並非我原創，靈感來自於 Joey Chen 的 <a href="https://dotblogs.com.tw/hatelove/2012/12/11/learning-tdd-in-30-days-day9-refactoring-introduction-and-how-to-find-refactoring-target" target="_blank" rel="external">30天快速上手TDD : Refactoring Legacy Code 簡介</a>之範例，因為此範例非常容易懂，而且很適合介紹重構。</span></span></span></p>
<table>
<thead>
<tr>
<th style="text-align:left">貨運商</th>
<th style="text-align:left">計費規則</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">黑貓</td>
<td style="text-align:left">基本運費 <code>100</code> 元，每公斤加收 <code>10</code> 元</td>
</tr>
<tr>
<td style="text-align:left">新竹貨運</td>
<td style="text-align:left">基本運費 <code>80</code> 元，每公斤加收 <code>15</code> 元</td>
</tr>
<tr>
<td style="text-align:left">郵局</td>
<td style="text-align:left">基本運費 <code>60</code> 元，每公斤加收 <code>20</code> 元</td>
</tr>
</tbody>
</table>
<h2 id="測試案例">測試案例</h2><hr>
<p>根據以上規則，我們可定出以下測試案例 :</p>
<table>
<thead>
<tr>
<th style="text-align:left">重量</th>
<th style="text-align:left">運費</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">[1, 2, 3]</td>
<td style="text-align:left">360 元</td>
</tr>
<tr>
<td style="text-align:left">[1, 2, 3]</td>
<td style="text-align:left">330 元</td>
</tr>
<tr>
<td style="text-align:left">[1, 2, 3]</td>
<td style="text-align:left">300 元</td>
</tr>
</tbody>
</table>
<h2 id="單元測試">單元測試</h2><hr>
<p><strong>ShippingServiceTest.php</strong><span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/7aa22622f57b13eb58cf659c2e7f89910c6c1461" target="_blank" rel="external">單元測試 : 黑貓、新竹、郵局測試案例</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓<span class="title">_</span>當重量為1<span class="title">_2_3</span>時<span class="title">_</span>費用為360<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> ShippingService $target */</span></span><br><span class="line">        <span class="variable">$target</span> = App::make(ShippingService::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$weights</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;calculateFee(<span class="variable">$weights</span>, <span class="string">'BlackCat'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">360</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 新竹<span class="title">_</span>當重量為1<span class="title">_2_3</span>時<span class="title">_</span>費用為330<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> ShippingService $target */</span></span><br><span class="line">        <span class="variable">$target</span> = App::make(ShippingService::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$weights</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;calculateFee(<span class="variable">$weights</span>, <span class="string">'Hsinchu'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">330</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 郵局<span class="title">_</span>當重量為1<span class="title">_2_3</span>時<span class="title">_</span>費用為300<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> ShippingService $target */</span></span><br><span class="line">        <span class="variable">$target</span> = App::make(ShippingService::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$weights</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$target</span>-&gt;calculateFee(<span class="variable">$weights</span>, <span class="string">'PostOffice'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">300</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將 3 個測試案例都先寫好測試。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  根據 Uncle Bob 的 The Three Rule of TDD，我們應該一個測試寫完，綠燈後才能寫下一個測試，這樣才能避免 over design，本文重點是重構，而不是 TDD，所以先將 3 個測試先寫好方便講解，實務上應該遵照 The Three Rule of TDD 方式進行。</div>
<h2 id="使用_if_else">使用 if else</h2><hr>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/6a2c6c45e9cfd590633c9a06a9db06a979ba1141" target="_blank" rel="external">if else 計算運費</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> string $companyName</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, string <span class="variable">$companyName</span>)</span>: <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$amount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$companyName</span> == <span class="string">'BlackCat'</span>) &#123;</span><br><span class="line">            <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="variable">$companyName</span> == <span class="string">'Hsinchu'</span>) &#123;</span><br><span class="line">            <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">80</span> + <span class="variable">$weight</span> * <span class="number">15</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$companyName</span> == <span class="string">'PostOffice'</span>) &#123;</span><br><span class="line">            <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">60</span> + <span class="variable">$weight</span> * <span class="number">20</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一開始先求 <span class="label label-success">綠燈</span> 就好，因此我們很無腦的只使用 <code>if else</code> 與 <code>foreach()</code> 就完成了。</p>
<p>但這樣只是功能完成而已，所有高低階邏輯全寫在一起，程式碼不容易閱讀，將來也不好維護。</p>
<p><img src="/images/refactor/refactor-in-action/action000.png" alt=""></p>
<p>雖然是很爛的寫法，但仍然有 <span class="label label-success">綠燈</span>。</p>
<h2 id="使用_switch">使用 switch</h2><hr>
<p><img src="/images/refactor/refactor-in-action/action010.png" alt=""></p>
<p>改用 <code>switch</code> 寫法會比 <code>if else</code> 可讀性高些，PhpStorm 也提供工具可以直接將 <code>if else</code> 轉成 <code>switch</code>，按熱鍵 &#8997; + &#8617;，選擇 <code>Replace if with switch</code>。</p>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/c6bac6e69c5da414daed040ca2c286fc3d466063" target="_blank" rel="external">switch 計算運費</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> string $companyName</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, string <span class="variable">$companyName</span>)</span>: <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$amount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$companyName</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'BlackCat'</span>:</span><br><span class="line">                <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                    <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Hsinchu'</span>:</span><br><span class="line">                <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                    <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">80</span> + <span class="variable">$weight</span> * <span class="number">15</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PostOffice'</span>:</span><br><span class="line">                <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                    <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">60</span> + <span class="variable">$weight</span> * <span class="number">20</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                    <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不過由 <code>if else</code> 變成 <code>switch</code> 並不算重構，只是讓程式碼稍微好閱讀些而已。</p>
<p><img src="/images/refactor/refactor-in-action/action001.png" alt=""></p>
<p>馬上跑測試，得到 <span class="label label-success">綠燈</span>，確定程式沒改壞。</p>
<h2 id="第一式_:_Extract_Method">第一式 : Extract Method</h2><hr>
<p>所有的重構，都是從 <code>Extract Method</code> 開始，當我們發現程式碼中有以下特徵 : </p>
<ol>
<li>當一段程式碼需要<strong>寫註解</strong>特別解釋時。</li>
<li>在 <code>if else</code> 內有一段邏輯時。</li>
<li>在 <code>switch case</code> 內有一段邏輯時。</li>
</ol>
<p>就可以開始使用重構第一式 : <code>Extract Method</code>，將一段程式碼重構成 <code>method</code> 。</p>
<p><strong>ShippingService.php</strong><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> string $companyName</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, string <span class="variable">$companyName</span>)</span>: <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$amount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$companyName</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'BlackCat'</span>:</span><br><span class="line">                <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                    <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Hsinchu'</span>:</span><br><span class="line">                <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                    <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">80</span> + <span class="variable">$weight</span> * <span class="number">15</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PostOffice'</span>:</span><br><span class="line">                <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                    <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">60</span> + <span class="variable">$weight</span> * <span class="number">20</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">                    <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每個 <code>switch case</code> 內都有一段<strong>計算運費</strong>邏輯，為了程式碼的可讀性與可維護性，我們應該將每個 <code>switch case</code> 內的程式碼加以 <code>Extract Method</code>。</p>
<p><img src="/images/refactor/refactor-in-action/action011.png" alt=""></p>
<p>PhpStorm 內建支援 <code>Extract Method</code>，先選擇要抽取的程式碼，按熱鍵 &#8963; + T，選擇 <code>Method</code>，PhpStorm 就會自動幫你將那段程式碼 extract 成新的 <code>method</code>。</p>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/a8b5872eb489f121d17e49d4ff2cac660db8d56b" target="_blank" rel="external">重構 1 式 : Extract Method</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> string $companyName</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, string <span class="variable">$companyName</span>)</span>: <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$amount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$companyName</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'BlackCat'</span>:</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$this</span>-&gt;blackCatCalculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Hsinchu'</span>:</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$this</span>-&gt;hsinchuCalculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PostOffice'</span>:</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$this</span>-&gt;postCalculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$this</span>-&gt;blackCatCalculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">blackCatCalculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hsinchuCalculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">80</span> + <span class="variable">$weight</span> * <span class="number">15</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">postCalculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">60</span> + <span class="variable">$weight</span> * <span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 <code>method</code> 命名方面，建議依照 <code>名詞 + 動詞</code> 的方式命名。</p>
<p>經過 <code>Extract Method</code> 後，最少原來一大坨的 <code>calculateFee()</code> 已經清爽多了，且可讀性也變高了，我們可以直接由 <code>method</code> 名稱，得知那段程式碼的意義，而不再是一段冷冰冰的 <code>foreach()</code> 迴圈而已。</p>
<p><img src="/images/refactor/refactor-in-action/action002.png" alt=""></p>
<p>重構之後馬上跑測試，務必要全部測試案例都 <span class="label label-success">綠燈</span>，確認沒有重構失敗。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  Extract Method 讓我們將原本一段很長的程式碼，依照其功能先拆成較小的 method，可增加程式碼的可讀性與可維護性。</div>
<h2 id="第二式_:_Extract_Class">第二式 : Extract Class</h2><hr>
<p>只有 <code>Extract Method</code> 還是不夠的，物件導向程式碼最大的特點就是 <code>class</code>，我們要將更相關的 <code>method</code> 放在同一個 <code>class</code>，達到<strong>高內聚</strong>的目標。</p>
<p>在重構第一式 <code>Extract Method</code> 時，我們特別以<strong>名詞 + 動詞</strong>的方式替 <code>method</code> 命名，其中若<strong>名詞</strong>相同，則表示這些 <code>mehtod</code> 的內聚性很高，適合將這些 <code>method</code> 再透過重構第二式 : <code>Extract Class</code> 重構到新的 <code>class</code> 內。</p>
<p><strong>ShippingService.php</strong><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">blackCatCalculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hsinchuCalculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">80</span> + <span class="variable">$weight</span> * <span class="number">15</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">postCalculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">60</span> + <span class="variable">$weight</span> * <span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 <code>ShippingService</code> 透過 <code>Extract Method</code> 所產生的 <code>blackCatCalculateFee()</code>、<code>hsinchuCalculateFee()</code> 與 <code>postCalculateFee()</code>，我們發現<strong>名詞</strong>均不同，所以將這些 method 再拆分在不同的 class 內。</p>
<p><strong>BlackCat.php</strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/a724b603159d67785688192dd23d0cb6851e76dd#diff-d579d2515aa8883f19295d0c447879bc" target="_blank" rel="external">重構 2 式 : Extract Class 之 BlackCat</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/BlackCat.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackCat</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將名詞部分的 <code>blackCat</code> 重構成 <code>BlackCat</code> class，動詞部分的 <code>calculateFee()</code> 重構成 <code>BlackCat</code> 的 method。</p>
<p><strong>Hsinchu.php</strong><span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/a724b603159d67785688192dd23d0cb6851e76dd#diff-cb0416a426a3bc3d1f17a46b73e1f33d" target="_blank" rel="external">重構 2 式 : Extract Class 之 Hsinchu</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/Hsinchu.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hsinchu</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">80</span> + <span class="variable">$weight</span> * <span class="number">15</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將名詞部分的 <code>hshinchu</code> 重構成 <code>Hsinchu</code> class，動詞部分的 <code>calculateFee()</code> 重構成 <code>Hsinchu</code> 的 method。</p>
<p><strong>Post.php</strong><span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/a724b603159d67785688192dd23d0cb6851e76dd#diff-2f1eb31bf97a19fd7ab93396e5c24be5" target="_blank" rel="external">重構 2 式 : Extract Class 之 Post</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/Post.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">60</span> + <span class="variable">$weight</span> * <span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將名詞部分的 <code>post</code> 重構成 <code>Post</code> class，動詞部分的 <code>calculateFee()</code> 重構成 <code>Post</code> 的 method。</p>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/a724b603159d67785688192dd23d0cb6851e76dd#diff-f5a5e92e47f06ee2e5a8bf84d5f19590" target="_blank" rel="external">重構 2 式 : Extract Class 之 ShippingService</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> string $companyName</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, string <span class="variable">$companyName</span>)</span>: <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$amount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$companyName</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'BlackCat'</span>:</span><br><span class="line">                <span class="variable">$blackCat</span> = <span class="keyword">new</span> BlackCat();</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$blackCat</span>-&gt;calculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Hsinchu'</span>:</span><br><span class="line">                <span class="variable">$hsinchu</span> = <span class="keyword">new</span> Hsinchu();</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$hsinchu</span>-&gt;calculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PostOffice'</span>:</span><br><span class="line">                <span class="variable">$post</span> = <span class="keyword">new</span> Post();</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$post</span>-&gt;calculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="variable">$blackCat</span> = <span class="keyword">new</span> BlackCat();</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$blackCat</span>-&gt;calculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>原來 extract 出來的 <code>method</code>，現在已經重構到各自 <code>class</code> 內，因此要使用時，必須先透過 <code>new</code> 將物件建立起來，才能呼叫 <code>calculateFee()</code>。</p>
<p><img src="/images/refactor/refactor-in-action/action003.png" alt=""></p>
<p>重構之後馬上跑測試，務必要全部測試案例都 <span class="label label-success">綠燈</span>，確認沒有重構失敗。 </p>
<div class="alert alert-info"><i class="fa fa-info"></i>  Extract Class 讓我們將更相關的 method 放在同一個 class 內，達到高內聚的目標，可增加程式碼的可讀性與可維護性，也更容易重複使用。</div>
<h2 id="第三式_:_Extract_Superclass">第三式 : Extract Superclass</h2><hr>
<p>當 <code>Extract Class</code> 之後，雖然已經長出 <code>class</code>，但實務上會發現，<code>method</code> 內仍然有些程式碼是重複的，根據 DRY 原則，我們不希望有程式碼重複，這會造成日後維護上的困難，因為每次修改就得修改好幾份程式碼，還可能忘記修改其中一份，而造成邏輯上的不一致。</p>
<p>對付 <code>method</code> 內重複的程式碼，就必須使用重構第三式 : <code>Extract Superclass</code>，將重複的程式碼重構到 <code>abstract class</code>。</p>
<p><strong>BlackCat.php</strong><br><figure class="highlight php"><figcaption><span>app/Services/BlackCat.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackCat</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我們發現在 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 3 個 <code>class</code> 的 <code>calculateFee()</code> 內，都有 <code>$weight = collect($weightArray)</code>，我們可以使用 <code>Extract Superclass</code> 將這段程式碼重構到 <code>abstract class</code> 內。</p>
<p><strong>AbstractLogistics.php</strong><span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/82be134f7a5c4488d1b4a4f0515eeb29534a9bad#diff-42a8335  084e3f202eb755166d3bc824f" target="_blank" rel="external">重構 3 式 : Extract Super Class 之 AbstractLogistics</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/AbstractLogistics.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLogistics</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">arrayToCollection</span><span class="params">(array <span class="variable">$weightArray</span>)</span>: <span class="title">Collection</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$weights</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將 <code>$weight = collect($weightArray)</code> 部分重構到 <code>AbstractLogistics</code> 的 <code>arrayToCollection()</code>。</p>
<p><strong>BlackCat.php</strong><span class="margin-note-marker"><sup>11</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">11</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/82be134f7a5c4488d1b4a4f0515eeb29534a9bad#diff-d579d2515aa8883f19295d0c447879bc" target="_blank" rel="external">重構 3 式 : Extract Super Class 之 BlackCat</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/BlackCat.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackCat</span> <span class="keyword">extends</span> <span class="title">AbstractLogistics</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = <span class="variable">$this</span>-&gt;arrayToCollection(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>BlackCat</code> 改繼承於 <code>AbstractLogistics</code>。</p>
<p>因為 <code>$weight = collect($weightArray)</code> 已經搬到 <code>AbstractLogistics</code>，所以 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 都要改成 <code>$weights = $this-&gt;arrayToCollection($weightArray);</code>，如此重複的邏輯就統一都只存在於 <code>AbstractLogistics</code>，符合 DRY 原則。</p>
<p><img src="/images/refactor/refactor-in-action/action004.png" alt=""></p>
<p>重構之後馬上跑測試，務必要全部測試案例都 <span class="label label-success">綠燈</span>，確認沒有重構失敗。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  Extract Super Class 讓我們將 class 內重複的部分抽出來，放到 abstract class 的 protected method 內，如此繼承的 class 就可共用此 method，避免程式碼重複。</div>
<h2 id="第四式_:_Extract_Closure">第四式 : Extract Closure</h2><hr>
<p>雖然我們可以將重複的程式碼透過 <code>Extract Superclass</code> 重構到 <code>abstract class</code>，但有時候會遇到一種程式碼，並不是整塊重複，而是外層重複，內層卻不重複。</p>
<p>對於 <code>method</code> 內有一段外層重複，內層卻不重複的程式碼，就必須使用重構第四式 : <code>Extract Closure</code>，將重複的的程式碼重構到 <code>abstract class</code>，不重複的部分重構到 <code>closure</code>。</p>
<p><strong>BlackCat.php</strong><br><figure class="highlight php"><figcaption><span>app/Services/BlackCat.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackCat</span> <span class="keyword">extends</span> <span class="title">AbstractLogistics</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = <span class="variable">$this</span>-&gt;arrayToCollection(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我們在 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 的 <code>calculateFee()</code> 都可發現，<code>foreach()</code> 與 <code>return</code> 是重複的，偏偏只有中間的 <code>$amount = $amount + (100 + $weight * 10);</code> 不重複，這也是各家計算運費演算法的關鍵。</p>
<p>為了符合 DRY 原則，我們應該將 <code>foreach()</code> 與 <code>return</code> 部分使用 <code>Extract Super Class</code> 重構到 <code>abstract class</code>，但偏偏中間的 <code>$amount = $amount + (100 + $weight * 10);</code> 不同，我們可以使用 <code>Extract Closure</code> 將不同的部分重構成 <code>closure</code>。</p>
<p><strong>AbstractLogistics.php</strong><span class="margin-note-marker"><sup>12</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">12</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/c6071d37752b79c66d3c46d374696d196a131d4d#diff-42a8335084e3f202eb755166d3bc824f" target="_blank" rel="external">重構 4 式 : Extract Closure 之 AbstractLogistics</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/AbstractLogistics.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLogistics</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@param</span> Collection $weights</span><br><span class="line">     * <span class="doctag">@param</span> callable $closure</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loopWeights</span><span class="params">(int <span class="variable">$amount</span>, Collection <span class="variable">$weights</span>, callable <span class="variable">$closure</span>)</span>: <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + <span class="variable">$closure</span>(<span class="variable">$weight</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將整個 <code>foreach()</code> 與 <code>return</code> 都重構到 <code>AbstractLogistics</code> 的 <code>loopWeights()</code> 內，但我們清楚 <code>$amount = $amount + (100 + $weight * 10);</code> 是不重複的，必須使用 <code>closure</code> 代替，且因為 <code>closure</code> 必須使用到 <code>$weight</code> 變數，還必須將 <code>$weight</code> 傳入 <code>closure</code>。</p>
<p>所以新重構的 <code>loopWeights()</code> 除了有 <code>int $amount</code> 與 <code>Collection $weights</code> 參數外，還要多一個 <code>callable $closure</code> 傳進來。</p>
<p><strong>BlackCat.php</strong><span class="margin-note-marker"><sup>13</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">13</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/c6071d37752b79c66d3c46d374696d196a131d4d#diff-d579d2515aa8883f19295d0c447879bc" target="_blank" rel="external">重構 4 式 : Extract Closure 之 BlackCat</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/BlackCat.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackCat</span> <span class="keyword">extends</span> <span class="title">AbstractLogistics</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = <span class="variable">$this</span>-&gt;arrayToCollection(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$amount</span> = <span class="variable">$this</span>-&gt;loopWeights(<span class="variable">$amount</span>, <span class="variable">$weights</span>, <span class="function"><span class="keyword">function</span> <span class="params">(int <span class="variable">$weight</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重複的 <code>foreach()</code> 與 <code>return</code> 已經重構到 <code>AbstractLogistics</code> 的 <code>loopWeights()</code>，<code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 不同的計算邏輯就以 <code>closure</code> 的方式傳入 <code>loopWeights()</code>。</p>
<p><img src="/images/refactor/refactor-in-action/action005.png" alt=""></p>
<p>重構之後馬上跑測試，務必要全部測試案例都 <span class="label label-success">綠燈</span>，確認沒有重構失敗。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  Extract Closure 讓我們將 class 內重複的部分抽出來，放到 abstract class 的 protected method 內，不重複的部分則放在各 class， 以 closure 的方式傳入 abstract class，如此就可確保程式碼符合 DRY 原則，且各 class 也保有不重複部分。</div>
<h2 id="第五式_:_Extract_Interface">第五式 : Extract Interface</h2><hr>
<p>當使用 <code>Extract Superclass</code> 與 <code>Extract Closure</code> 之後，基本上已經沒有重複的程式碼，也就是已經符合 DRY 原則。</p>
<p>在 <code>名詞 + 動詞</code> 的 <code>method</code> 名稱部分，<code>名詞</code>不同已經使用 <code>Extract Class</code> 解決，剩下的是相同的<code>動詞</code>，也就是我們發現在 3 個 <code>class</code> 都有相同的 <code>method</code>。</p>
<p>既然 3 個 <code>class</code> 的 <code>method</code> 都相同，我們就可以使用重構第五式 : <code>Extract Interface</code>，以用更宏觀的角度，將這 3 個 <code>class</code> <strong>抽象化</strong>成一個<strong>相同</strong>的 <code>interface</code>。</p>
<p><strong>BlackCat.php</strong><br><figure class="highlight php"><figcaption><span>app/Services/BlackCat.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackCat</span> <span class="keyword">extends</span> <span class="title">AbstractLogistics</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = <span class="variable">$this</span>-&gt;arrayToCollection(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$amount</span> = <span class="variable">$this</span>-&gt;loopWeights(<span class="variable">$amount</span>, <span class="variable">$weights</span>, <span class="function"><span class="keyword">function</span> <span class="params">(int <span class="variable">$weight</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>既然 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 都有 <code>calculateFee()</code>，我們可以使用 <code>Extract Interface</code> 將 <code>calculateFee()</code> 抽成 <code>interface</code>，將 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 抽象化成 <code>LogisticsInterface</code>。</p>
<p><strong>LogisticsInterface.php</strong><span class="margin-note-marker"><sup>15</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">15</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/5f3b9ba391d95a443d38c246227c7db523206405#diff-8306901f34a7e9b0d27d03dfd45162af" target="_blank" rel="external">重構 5 式 : Extract Interface 之 LogisticsInterface</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/LogisticsInterface.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">LogisticsInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>建立新的 <code>LogisticsInterface</code>，定義其 <code>method</code> 為 <code>calculateFee()</code>。</p>
<p><strong>AbstractLogistics.php</strong><span class="margin-note-marker"><sup>16</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">16</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/5f3b9ba391d95a443d38c246227c7db523206405#diff-42a8335084e3f202eb755166d3bc824f" target="_blank" rel="external">重構 5 式 : Extract Interface 之 AbstractLogistics</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/AbstractLogistics.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLogistics</span> <span class="keyword">implements</span> <span class="title">LogisticsInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>abstract class</code> 當然要遵守 <code>interface</code>。</p>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>16</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">16</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/5f3b9ba391d95a443d38c246227c7db523206405#diff-f5a5e92e47f06ee2e5a8bf84d5f19590" target="_blank" rel="external">重構 5 式 : Extract Interface 之 ShippingService</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/AbstractLogistics.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> string $companyName</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, string <span class="variable">$companyName</span>)</span>: <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$amount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$companyName</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'BlackCat'</span>:</span><br><span class="line">                <span class="variable">$logistics</span> = <span class="keyword">new</span> BlackCat();</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'Hsinchu'</span>:</span><br><span class="line">                <span class="variable">$logistics</span> = <span class="keyword">new</span> Hsinchu();</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'PostOffice'</span>:</span><br><span class="line">                <span class="variable">$logistics</span> = <span class="keyword">new</span> Post();</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="variable">$logistics</span> = <span class="keyword">new</span> BlackCat();</span><br><span class="line">                <span class="variable">$amount</span> = <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>既然 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 都抽象化成 <code>LogisticsInterface</code>，無論是 new <code>BlackCat</code>、<code>Hsinchu</code> 或 <code>Post</code>，抽象化看起來都是同一個 <code>$logistics</code> 物件，這就是物件導向的<strong>多型</strong>，同一個物件，卻可能來自於相同 <code>interface</code> 的不同 <code>class</code>。</p>
<p><img src="/images/refactor/refactor-in-action/action006.png" alt=""></p>
<p>重構之後馬上跑測試，務必要全部測試案例都 <span class="label label-success">綠燈</span>，確認沒有重構失敗。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  Extract Interface 讓我們將相同 method 的 class，抽象化成相同 interface 的物件，儘管將來需求改變，但只要 interface 不變，程式碼就不用修改，方便將來維護。</div>
<h2 id="第六式_:_Dependency_Injection">第六式 : Dependency Injection</h2><hr>
<p>經過 <code>Extract Interface</code> 之後，我們已經將 3 個 <code>class</code> 抽象化成相同 <code>interface</code>，理論上我們只需依賴 <code>interface</code> 即可，但程式碼中卻還使用 <code>switch case</code>，並實際去 new 3 個 <code>class</code>，也就是還實際依賴這 3 個 <code>class</code>。</p>
<p>實際依賴這 3 個 <code>class</code> 目前沒什麼大問題，但只要將來有新的 <code>class</code>，儘管也實踐相同 <code>interface</code>，卻仍要繼續修改 <code>swich case</code> 去 new 新的 <code>class</code>，這將造成維護上的負擔。理想是將來無論新增任何 <code>class</code>，都不須修改程式碼，這就必須使用重構第六式 : <code>Dependency Injection</code>，將 <code>switch case</code> 拿掉，由 Service Container 幫我們注入 <code>LogisticsInterface</code> 物件，而不是與特定 <code>class</code>耦合，達到<strong>低耦合</strong>的目標。</p>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>17</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">17</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/0ce3069cc50fe22d6e121aa00bb78183e10f14a4#diff-f5a5e92e47f06ee2e5a8bf84d5f19590" target="_blank" rel="external">重構 6 式 : Dependency Injection 之 ShippingService</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> LogisticsInterface $logistics</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, LogisticsInterface <span class="variable">$logistics</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$amount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因為不在需要由 <code>switch case</code> 判斷 <code>$companyName</code>，因此將參數 <code>$companyName</code> 從 <code>calculateFee()</code> 移除。</p>
<p>新增 <code>LogisticsInterface $logistics</code> 參數，由 Service Container 幫我們將所依賴的 <code>$logistics</code> 物件注入。</p>
<p>由於 <code>$logistics</code> 已經抽象化為 <code>LogisticsInterface</code>，所以根本不需要任何 <code>switch case</code> 判斷，因此將來若有新的 <code>class</code> 也不用擔心，一定不需修改 <code>calculateFee()</code>。</p>
<p><strong>ShippingServiceTest.php</strong><span class="margin-note-marker"><sup>18</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">18</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/0ce3069cc50fe22d6e121aa00bb78183e10f14a4#diff-7f0bd9973ba9075fe67417d92b296620" target="_blank" rel="external">重構 6 式 : Dependency Injection 之 ShippingServiceTest</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">BlackCat</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Hsinchu</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">LogisticsInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Post</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓<span class="title">_</span>當重量為1<span class="title">_2_3</span>時<span class="title">_</span>費用為360<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        App::bind(LogisticsInterface::class, BlackCat::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$weights</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">        <span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">            <span class="string">'weightArray'</span> =&gt; <span class="variable">$weights</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">360</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 接實踐 <code>LogisticsInterface</code>，Service Container 怎麼知道要注入哪一個物件呢?</p>
<p>必須在 <code>ShippingService</code> 建立之前，先使用 <code>App::bind()</code> 告訴 Service Container，<code>LogisticsInterface</code> 須與哪一個 <code>class</code> 綁定，若要綁定 <code>BlackCat</code>，就是 <code>App::bind(LogisticsInterface::class, BlackCat::class);</code>。</p>
<p>實務上 <code>App::bind()</code> 要寫哪裡呢?</p>
<ol>
<li>寫在整合測試。</li>
<li>若要動態切換 <code>class</code> : 寫在 Controller。</li>
<li>若一開始就決定 <code>class</code> : 寫在 Service Provider。</li>
</ol>
<p><img src="/images/refactor/refactor-in-action/action007.png" alt=""></p>
<p>重構之後馬上跑測試，務必要全部測試案例都 <span class="label label-success">綠燈</span>，確認沒有重構失敗。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  Dependency Injection 讓我們由外部注入內部所需相依的物件，因此 method 就不必再根據條件去判斷該相依哪一個物件，也因為不用判斷，因此將來若有新的相依物件，也不需修改程式碼，方便日後維護。</div>
<h2 id="第七式_:_Extract_Trait">第七式 : Extract Trait</h2><hr>
<p>重構一到六式，都是教我們的都是以<strong>垂直</strong>方式將 <code>method</code> 抽取到 <code>class</code>、<code>abstract class</code>、<code>interface</code>，也就是其都有<strong>垂直</strong>的關係，但某些 <code>method</code>，並沒有垂直的關係，反而是跨 <code>class</code> 的<strong>水平</strong>關係。</p>
<p>對於這種<strong>水平</strong>關係的 <code>method</code>，就必須使用重構第七式 : <code>Extract Trait</code>，將 <code>method</code> 重構到 <code>trait</code>。</p>
<p><strong>LogTrait.php</strong><span class="margin-note-marker"><sup>19</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">19</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/6368f9029123319026e7cc79375863cbadba8989#diff-d8f8691de3be79d81a11ebaf4ca3346a" target="_blank" rel="external">重構 7 式 : Extract Trait 之 LogTrait</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/LogTrait.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Log</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> LogTrait</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">writeLog</span><span class="params">(int <span class="variable">$amount</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        Log::info(<span class="string">'Amount : '</span> . <span class="variable">$amount</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我們在寫好 <code>ShippingService</code> 之後，被要求在 <code>calculateFee()</code> 加上 <code>writeLog()</code> 功能。</p>
<p><code>writeLog()</code> 這種功能，要放在 <code>class</code> 或 <code>abstract class</code> 都很怪，因為他根本與 <code>ShippingService</code> 無關，反而是每個 class 都會有 <code>writeLog()</code> 的需求，像這種<strong>水平</strong>關係，我們可以使用 <code>Extract Trait</code> 將 <code>writeLog()</code> 重構到 <code>LogTrait</code>。</p>
<p><strong>AbstractLogistics.php</strong><span class="margin-note-marker"><sup>20</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">20</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/6368f9029123319026e7cc79375863cbadba8989#diff-42a8335084e3f202eb755166d3bc824f" target="_blank" rel="external">重構 7 式 : Extract Trait 之 AbstractLogistics</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/AbstractLogistics.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLogistics</span> <span class="keyword">implements</span> <span class="title">LogisticsInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">LogTrait</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@param</span> Collection $weights</span><br><span class="line">     * <span class="doctag">@param</span> callable $closure</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loopWeights</span><span class="params">(int <span class="variable">$amount</span>, Collection <span class="variable">$weights</span>, callable <span class="variable">$closure</span>)</span>: <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + <span class="variable">$closure</span>(<span class="variable">$weight</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$this</span>-&gt;writeLog(<span class="variable">$amount</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重構成 <code>LogTrait</code> 後，只要去 <code>use LogTrait</code>，我們的 <code>class</code> 內會有 <code>writeLog()</code>。</p>
<p>但 <code>$this-&gt;writeLog()</code> 要寫在哪裡呢? 當然也可以寫在每個 <code>class</code> 內的 <code>calculateFee()</code> 內，但這就違反 DRY 了，比較理想的方式是寫在 <code>abstract class</code> 的 <code>loopWeights()</code> 內，這樣 <code>$this-&gt;writeLog()</code> 就只有一份，符合 DRY 原則。</p>
<p><img src="/images/refactor/refactor-in-action/action008.png" alt=""></p>
<p>重構之後馬上跑測試，務必要全部測試案例都 <span class="label label-success">綠燈</span>，確認沒有重構失敗。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  Extrait Trait 讓我們不用特別將不相關的 method 重構到 class 與 abstract class 內，所有水平關係的 method，都適合重構到 trait，然後跨 class 重複使用。</div>
<h2 id="第八式_:_Refactor_to_Pattern">第八式 : Refactor to Pattern</h2><hr>
<p>當程式碼重構到第七式，基本上已經符合了物件導向的 <strong>SOLID</strong> 原則，也達到<strong>高內聚、低耦合</strong>目標，算是不錯的程式碼，兼具容易閱讀、容易維護的優點。</p>
<p><strong>單一職責原則 Single Responsibility Principle</strong><br><div class="alert alert-info"><i class="fa fa-info"></i>  應該且僅有一個原因引起類別的變更</div></p>
<p>原本所有的<strong>計算運費</strong>邏輯都包在 <code>ShippingService</code> 的 <code>calculateFee()</code> 內，只要任何一個廠商的運費修改，都必須修改 <code>ShippingService</code>，因此違反單一職責原則，透過 <code>Extract Method</code> 與 <code>Extract Class</code>，現在已經將黑貓的計算運費邏輯包在 <code>BlackCat</code> 的 <code>calculateFee()</code>，新竹貨運的計算運費邏輯包在 <code>Hsinchu</code> 的 <code>calculateFee()</code>，而郵局的計算運費邏輯也包在 <code>Post</code> 的 <code>calculateFee()</code>，每個廠商的運費修改，都不會影響到其他 <code>class</code>，符合<strong>單一職責原則</strong>的要求。</p>
<p><strong>開放封閉原則 Open Closed Principle</strong><br><div class="alert alert-info"><i class="fa fa-info"></i>  對於擴展是開放的，對於修改是封閉的</div></p>
<p>將 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 透過 <code>Extract Interface</code> 抽象化成 <code>LogisticsInterface</code>，對於 <code>ShippingServie</code> 來說，不再直接相依 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 三個 class，僅相依於 <code>LogisticsInterface</code>，將來若有新的需求，只需新建立 <code>class</code> 實踐 <code>LogisticsInterface</code> 即可，也就是<strong>對擴展是開放的</strong>，但因為 <code>ShippingService</code> 僅相依於 <code>LogisticsInterface</code>，不相依於任何 <code>class</code>，就算將來有新建立的 <code>class</code>，也不需修改 <code>ShippingService</code>，所以<strong>對修改是封閉</strong>的，符合<strong>開放封閉原則</strong>的要求。</p>
<p><strong>里式替換原則 Liskov Substitution Principle</strong><br><div class="alert alert-info"><i class="fa fa-info"></i>  所有參照基礎類別的地方，必須可以透明地使用衍生類別的物件代替，而不需要任何改變</div></p>
<p>我們將 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 程式碼重複的地方，透過 <code>Extract Super Class</code> 與 <code>Extract Closure</code> 重構到 <code>AbstractLogistics</code> 這個 <code>abstract class</code>，為了確保所有繼承於 <code>AbstractLogistics</code> 的 <code>class</code> 都能被替換，我們特別要求 <code>AbstractLogistics</code> 實現 <code>LogisticsInterface</code>，確保所有使用 <code>abstract class</code> 物件，都可以透明地使用其衍生 <code>class</code> 所代替，符合<strong>里氏替換原則</strong>的要求。</p>
<p><strong>介面隔離原則 Interface Segregation Principle</strong><br><div class="alert alert-info"><i class="fa fa-info"></i>  用戶端程式碼不應該依賴它用不到的介面</div></p>
<p>因為 <code>LogisticsInterface</code> 只有 <code>calculateFee()</code> 單一 <code>method</code>，因此看不到<strong>介面隔離原則</strong>，實務上當 <code>interface</code> 有多個 <code>method</code>，而你發現 <code>class</code> 對於 <code>interface</code> 有空實作時，或者使用者根本沒用到 <code>interface</code> 所提供的所有 <code>method</code>，就表示 <code>interface</code> 應該再細化，再切成更小的 <code>interface</code>。</p>
<p>事實上，介面隔離原則就是另一個角度的單一職責原則，單一職責是以<strong>責任</strong>的角度來看 <code>class</code>，而介面隔離原則是以<strong>需求</strong>的角度看 <code>interface</code>，所以兩者並不衝突，符合單一職責的 <code>class</code> 仍然會實現多個 <code>interface</code>，符合<strong>介面隔離原則</strong>的要求。</p>
<p><strong>依賴反轉原則 Dependency Inversion Principle</strong><br><div class="alert alert-info"><i class="fa fa-info"></i>  高階模組不該依賴低階模組，兩者都應該依賴其抽象</div></p>
<p>在透過 <code>Dependency Injection</code> 之前，我們是直接在 <code>ShippingService</code> 直接去 new <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code>，也就是高階模組的 <code>ShippingService</code> 直接依賴於低階模組的 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code>，這就違反了<strong>高階模組不該依賴低階模組</strong>，既然已經透過 <code>Extract Interface</code> 抽象化出 <code>LogisticsInterface</code>，我們就可以透過 <code>Dependency Injection</code>，由高階模組自行注入所依賴的低階模組，此時高階模組 <code>ShippingService</code> 只依賴於 <code>LogisticsInterface</code>，而低階模組 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 也只依賴於 <code>LogisticsInterface</code>，也就是<strong>兩者都應該依賴其抽象</strong>，符合<strong>依賴反轉原則</strong>的要求。</p>
<p><strong>高內聚 High Cohesion</strong><br><div class="alert alert-info"><i class="fa fa-info"></i>  應該將功能高度相關的 method 放在同一個 class 與 interface 內，這樣才方便閱讀、方便維護、方便重複使用。</div></p>
<p><strong>單一職責原則</strong>、<strong>介面隔離原則</strong>講的就是<strong>高內聚</strong>，<code>Extract Method</code>、<code>Extract Class</code>、<code>Extract Trait</code> 則是實現<strong>高內聚</strong>的具體方法，讓我們將功能高度相關的 <code>method</code> 放在同一個 <code>class</code> 與 <code>interface</code> 內。</p>
<p><strong>低耦合 Low Coupling</strong><br><div class="alert alert-info"><i class="fa fa-info"></i>  class 與 class 間的耦合應該盡量減少，避免因為 class 的修改，而導致其他 class 也必須隨之修改。</div></p>
<p><strong>開放封閉原則</strong>、<strong>里氏替換原則</strong>、<strong>依賴反轉原則</strong>講的就是<strong>低耦合</strong>，<code>Extract Interface</code>、<code>Dependency Injection</code>、<code>Replace Interface with Closure</code> 則是實現<strong>低耦合</strong>的具體方法，讓我們將原本 <code>class</code> 與 <code>class</code> 之間的耦合，變成只與 <code>interface</code> 或 <code>closure</code> 的耦合，由於耦合變少變小，因此將來所做的任何修改，影響將降到最低。</p>
<p><strong>設計模式 Design Pattern</strong><br>若重構到這個階段，突然靈機一動想到在這個情境下，某個 Design Pattern 更適合，則可以繼續重構，基本上，Design Pattern 就是前人所留下來破解某個劍招的精妙劍法，只要用的時機對，就會非常的巧，但不必刻意的追求一定要用什麼 Design Pattern 才算好的物件導向，就如<strong>獨孤九劍</strong>一樣，隨機應變，用得到是緣份，用不到也沒關係，因為重構到第七式，已經符合了 <strong>SOLID</strong> 原則了。</p>
<p>以本例而言，事實上就是 <strong>Strategy Pattern</strong>，但若你完全不知道 Strategy Pattern 也沒關係，只要從重構一式打到重構七式，就會自然長出 Strategy Pattern 了。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  Refactor to Pattern 讓我們可以重構出更精妙的程式碼，但不必強求，隨緣使用即可。</div>
<h2 id="第九式_:_Replace_Interface_with_Closure">第九式 : Replace Interface with Closure</h2><hr>
<p>物件導向為人詬病的，就是 <code>interface</code> 滿天飛，與檔案數目爆炸，但函數式編程思維加入後，一切有了變化。</p>
<p>若我們的 <code>interface</code> 只有一個 <code>method</code>，或經由 <strong>ISP</strong> 介面隔離原則切成很多小小的 interface 後，就可使用重構第九式 : <code>Replace Interface with Closure</code>，將 <code>interface</code> 拿掉，改用 <code>closure</code>。</p>
<p><strong>LogisticsInterface.php</strong><br><figure class="highlight php"><figcaption><span>app/Services/LogisticsInterface.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">LogisticsInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>)</span> : <span class="title">int</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>LogisticsInterface</code> 只有單一的 <code>calculateFee()</code> 而已，我們可以嘗試將 <code>interface</code> 拿掉。</p>
<p><strong>Logistics.php</strong><span class="margin-note-marker"><sup>21</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">21</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/a3c0f64c7c088a831c448c2f8f0947d22afdb82a#diff-f5a5e92e47f06ee2e5a8bf84d5f19590" target="_blank" rel="external">重構 9 式 : Replace Interface to Closure 之 Logistics</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/Logistics.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logistics</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">LogTrait</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@return</span> Collection</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">arrayToCollection</span><span class="params">(array <span class="variable">$weightArray</span>)</span>: <span class="title">Collection</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = collect(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$weights</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> int $amount</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> callable $closure</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, int <span class="variable">$amount</span>, callable <span class="variable">$closure</span>)</span>: <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$weights</span> = <span class="variable">$this</span>-&gt;arrayToCollection(<span class="variable">$weightArray</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$weights</span> <span class="keyword">as</span> <span class="variable">$weight</span>) &#123;</span><br><span class="line">            <span class="variable">$amount</span> = <span class="variable">$amount</span> + <span class="variable">$closure</span>(<span class="variable">$weight</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$this</span>-&gt;writeLog(<span class="variable">$amount</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$amount</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>建立新的 <code>Logistics</code>，事實上就是將 <code>AbstractLogistics</code> 的程式碼全部搬過來，因為既然沒有 <code>interface</code>，那 <code>abstract class</code>也不需要了。</p>
<p><strong>ShippingService.php</strong><span class="margin-note-marker"><sup>21</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">21</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/a3c0f64c7c088a831c448c2f8f0947d22afdb82a#diff-f5a5e92e47f06ee2e5a8bf84d5f19590" target="_blank" rel="external">重構 9 式 : Replace Interface to Closure 之 ShippingService</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> array $weightArray</span><br><span class="line">     * <span class="doctag">@param</span> callable $closure</span><br><span class="line">     * <span class="doctag">@param</span> Logistics $logistics</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(array <span class="variable">$weightArray</span>, callable <span class="variable">$closure</span>, Logistics <span class="variable">$logistics</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$amount</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weightArray</span>, <span class="variable">$amount</span>, <span class="variable">$closure</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>原本 <code>calculateFee()</code> 的最後一個參數是依賴注入進 <code>LogisticsInterface</code> 物件，為了要將 <code>interface</code> 拿掉，我們只注入 <code>Logistics</code> 即可。</p>
<p>也因為 <code>LogisticsInterface</code> 已經拿掉，所以 <code>BlackCat</code>、<code>Hsinchu</code> 與 <code>Post</code> 也順便拿掉，也就是說，原本需要 <code>interface</code> 與 <code>class</code> 封裝計算運費邏輯，現在完全退化到只需 <code>closure</code> 即可。</p>
<p><strong>ShippingServiceTest.php</strong><span class="margin-note-marker"><sup>22</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">22</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53Refactor9_demo/commit/a3c0f64c7c088a831c448c2f8f0947d22afdb82a#diff-7f0bd9973ba9075fe67417d92b296620" target="_blank" rel="external">重構 9 式 : Replace Interface to Closure 之 ShippingServiceTest</a></span></span></span><br><figure class="highlight php"><figcaption><span>app/Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓<span class="title">_</span>當重量為1<span class="title">_2_3</span>時<span class="title">_</span>費用為360<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$weights</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">        <span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">            <span class="string">'weightArray'</span> =&gt; <span class="variable">$weights</span>,</span><br><span class="line">            <span class="string">'closure'</span>     =&gt; <span class="function"><span class="keyword">function</span> <span class="params">(int <span class="variable">$weight</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> (<span class="number">100</span> + <span class="variable">$weight</span> * <span class="number">10</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">360</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>原本我們必須在 <code>arrange</code> 使用 <code>App::bind(LogisticsInterface::class, BlackCat::class);</code>，但目前沒有 <code>LogisticsInterface</code> 與 <code>BlackCat</code>，所以 <code>App::bind()</code> 也不需要了。</p>
<p>原本計算運費邏輯是封裝在 <code>BlackCat</code> 內，但因為現在已經沒有 <code>BlackCat</code>，改用 <code>closure</code>，所以必須在測試提供 <code>closure</code>。</p>
<p><img src="/images/refactor/refactor-in-action/action009.png" alt=""></p>
<p>重構之後馬上跑測試，務必要全部測試案例都 <span class="label label-success">綠燈</span>，確認沒有重構失敗。</p>
<p>我們也發現檔案只剩下 <code>ShippingService</code>、<code>Logistics</code> 與 <code>LogTrait</code> 而已，其他檔案都因為 <code>Replace Interface with Closure</code> 而重構刪除了。</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  Replace Interface with Closure 讓我們適時的將不必要的 interface 以 closure 取代，將可解決原來物件導向 interface 滿天飛與檔案數目爆炸的問題，但也不是每個 interface 都要重構成 closure，必須自己依照實際情形加以判斷，沒有最佳解，只有最適解。</div>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>基本上重構<strong>第一式</strong>到<strong>第七式</strong>，我每次 TDD 重構都會打一遍，讓自己的程式碼符合 <strong>SOLID</strong> 原則與實現<strong>高內聚、低耦合</strong>，但<strong>第八式</strong>與<strong>第九式</strong>則不一定，會視實際狀況隨機應變。</li>
<li><code>Replace Interface with Closure</code> 的出現，讓物件導向有了不同的實作方式，事實上很多設計模式，如 <code>Strategy Pattern</code>、<code>Command Pattern</code>、<code>Chain of Responsibility Pattern</code> ….等，都可使用 <code>closure</code> 方式實作，但也不是所有的 <code>interface</code> 都要重構成 <code>closure</code>，但最少是個方法，可依實際需求決定是否重構。</li>
<li>重構有很多方法，主要是針對 legacy code，若使用 TDD 方式，因為測試先寫，已經考慮了<strong>可測試性</strong>，基本上程式碼的體質已經不差，只要再加上<strong>重構九式</strong>的輔助，寫出符合 <strong>SOLID</strong> 原則與<strong>高內聚、低耦合</strong>的程式碼將不再是遙不可及的事情。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel53Refactor9_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<p>Martin Fowler, <a href="https://www.amazon.com/Refactoring-Improving-Design-Existing-Code/dp/0201485672" target="_blank" rel="external">Refactoring : Improving The Design of Existing Code</a><br>范綱, <a href="https://www.tenlong.com.tw/items/9864340468?item_id=1007025" target="_blank" rel="external">大話重構</a><br>Joey Chen, <a href="https://dotblogs.com.tw/hatelove/2013/01/11/learning-tdd-in-30-days-catalog-and-reference" target="_blank" rel="external">30 天快速上手 TDD</a><br>大澤木小鐵, <a href="http://slides.com/jaceju/design-patterns-by-examples/" target="_blank" rel="external">從實例學習設計模式 (使用 PHP)</a></p>
]]></content>
    <summary type="html">
    <![CDATA[歸納自己天天使用的重構步驟]]>
    
    </summary>
    
      <category term="FP" scheme="http://oomusou.io/tags/FP/"/>
    
      <category term="OOP" scheme="http://oomusou.io/tags/OOP/"/>
    
      <category term="Refactoring" scheme="http://oomusou.io/tags/Refactoring/"/>
    
      <category term="TDD" scheme="http://oomusou.io/tags/TDD/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 Forever 搭配 Laravel Queue 寄送 Email?]]></title>
    <link href="http://oomusou.io/laravel/laravel-email-queue-forever/"/>
    <id>http://oomusou.io/laravel/laravel-email-queue-forever/</id>
    <published>2016-11-25T12:23:43.000Z</published>
    <updated>2016-11-28T05:42:02.000Z</updated>
    <content type="html"><![CDATA[<p>傳統寄送 email 是採用同步的方式，也就是當你寄出一封信，必須等 email server 回應後，才可以繼續後續的程式動作，因此使用者會有明顯的等待時間；若能搭配 queue 機制，寄送 email 後，馬上以非同步的方式回到原來程式繼續執行，會有另外一個 process 去消耗 queue，負責寄送 email。</p>
<a id="more"></a>
<h2 id="Motivation">Motivation</h2><hr>
<p>Laravel 的 <code>Mail::send()</code> 是以同步方式寄送 email，會有明顯的等待時間；而 <code>Mail:queue()</code> 則是以非同步的方式寄送 email，速度非常快，不過必須搭配 queue 以及其他配套機制。</p>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.8<br>Laravel 5.2.45</p>
<h2 id="實際案例">實際案例</h2><hr>
<p>先以 <code>Mail::send()</code> 透過 Gmail 寄送信件，然後再改用 <code>Mail::queue()</code> 方式寄送信件。</p>
<h2 id="單元測試_:_由_Sync_寄信">單元測試 : 由 Sync 寄信</h2><hr>
<p><strong> MailServiceTest.php </strong><span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52QueueForever/commit/ce521d9a1e19880a95d2b93b519a32cdbee18aa8" target="_blank" rel="external">單元測試 : 由 sync 寄送信件</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/MailServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">MailService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MailServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 由<span class="title">Sync</span>寄送信件<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        App::call(MailService::class . <span class="string">'@mailBySync'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertTrue(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>這裡沒做任何測試，只是透過 PHPUnit 啟動 sync 方式寄送信件。 </p>
<h2 id="設定使用_Gmail_寄信">設定使用 Gmail 寄信</h2><hr>
<p><strong> .env </strong><span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52QueueForever/commit/b1ceabb5988b5cf1b1a92141aec90cd279107e98" target="_blank" rel="external">設定使用 Gmail 寄信</a></span></span></span><br><figure class="highlight php"><figcaption><span>.env</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">APP_ENV=local</span><br><span class="line">APP_DEBUG=<span class="keyword">true</span></span><br><span class="line">APP_KEY=base64:PABSMLELX37jW2jJdwm9Fk6LvUWupulQXAWDZcfA7xE=</span><br><span class="line">APP_URL=http:<span class="comment">//localhost</span></span><br><span class="line"></span><br><span class="line">DB_CONNECTION=sqlite</span><br><span class="line">DB_HOST=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">DB_PORT=<span class="number">3306</span></span><br><span class="line"><span class="comment">#DB_DATABASE=homestead</span></span><br><span class="line">DB_USERNAME=homestead</span><br><span class="line">DB_PASSWORD=secret</span><br><span class="line"></span><br><span class="line">CACHE_DRIVER=file</span><br><span class="line">SESSION_DRIVER=file</span><br><span class="line">QUEUE_DRIVER=sync</span><br><span class="line"></span><br><span class="line">REDIS_HOST=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">REDIS_PASSWORD=<span class="keyword">null</span></span><br><span class="line">REDIS_PORT=<span class="number">6379</span></span><br><span class="line"></span><br><span class="line">MAIL_DRIVER=smtp</span><br><span class="line">MAIL_HOST=smtp.gmail.com</span><br><span class="line">MAIL_PORT=<span class="number">587</span></span><br><span class="line">MAIL_USERNAME=[your gmail address]</span><br><span class="line">MAIL_PASSWORD=[your password]</span><br><span class="line">MAIL_ENCRYPTION=tls</span><br></pre></td></tr></table></figure></p>
<p>21 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MAIL_DRIVER=smtp</span><br><span class="line">MAIL_HOST=smtp.gmail.com</span><br><span class="line">MAIL_PORT=<span class="number">587</span></span><br><span class="line">MAIL_USERNAME=[your gmail address]</span><br><span class="line">MAIL_PASSWORD=[your password]</span><br><span class="line">MAIL_ENCRYPTION=tls</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong> MAIL_HOST </strong> : 設定為 <code>smtp.gmail.com</code>。</li>
<li><strong> MAIL_PORT </strong> : 設定為 <code>587</code>。</li>
<li><strong> MAIL_USERNAME </strong> : 設定你的 Gmail 帳號，如 <code>example@gmail.com</code>。</li>
<li><strong> MAIL_PASSWORD </strong> : 設定你的 Gmail 密碼。</li>
<li><strong> MAIL_ENCRYPTION </strong> : 設定為 <code>tls</code>。</li>
</ul>
<h2 id="由_Sync_寄信">由 Sync 寄信</h2><hr>
<p><strong> MailService.php </strong><span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52QueueForever/commit/b8bbd243b04d78d57c1307193e07bdb832728817" target="_blank" rel="external">由 sync 寄送信件</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/MailService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Mail</span>\<span class="title">Message</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mail</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MailService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mailBySync</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        Mail::send(<span class="string">'welcome'</span>, [], <span class="function"><span class="keyword">function</span> <span class="params">(Message <span class="variable">$message</span>)</span> </span>&#123;</span><br><span class="line">            <span class="variable">$message</span>-&gt;sender(<span class="string">'oomusou@gmail.com'</span>);</span><br><span class="line">            <span class="variable">$message</span>-&gt;subject(<span class="string">'Laravel 5.2 mail by Sync'</span>);</span><br><span class="line">            <span class="variable">$message</span>-&gt;to(<span class="string">'oomusou@gmail.com'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>Mail::send()</code> 寄送信件。</p>
<ul>
<li>第 1 個參數為 blade 檔案名稱。</li>
<li>第 2 個參數為要傳給 blade 的陣列，若不傳任何資料，也要傳一個空陣列。</li>
<li>第 3 個參數為 closure，主要是 Laravel 希望你將 <code>Message</code> 物件資料填滿。</li>
</ul>
<p>實際執行會發現，<code>Mail::send()</code> 會需要等 1 到 2 秒才會執行完，因為是同步，要等 smtp server 回應後才會繼續執行。</p>
<h2 id="單元測試_:_由_Queue_寄信">單元測試 : 由 Queue 寄信</h2><hr>
<p><strong> MailServiceTest.php </strong><span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52QueueForever/commit/35b2742d6a3edfb8b60d34b41c6a9f249cb3aaa6" target="_blank" rel="external">單元測試 : 由 queue 寄送信件</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/MailServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">MailService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MailServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 由<span class="title">queue</span>寄送信件<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        App::call(MailService::class . <span class="string">'@mailByQueue'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;assertTrue(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>這裡沒做任何測試，只是透過 PHPUnit 啟動 queue 方式寄送信件。 </p>
<h2 id="設定本機環境使用_Queue">設定本機環境使用 Queue</h2><hr>
<p><strong> .env </strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52QueueForever/commit/f6655a2592eb140e68e8a727464c81b1ad22c37a" target="_blank" rel="external">設定本機環境使用 queue</a></span></span></span><br><figure class="highlight php"><figcaption><span>.env</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">APP_ENV=local</span><br><span class="line">APP_DEBUG=<span class="keyword">true</span></span><br><span class="line">APP_KEY=base64:PABSMLELX37jW2jJdwm9Fk6LvUWupulQXAWDZcfA7xE=</span><br><span class="line">APP_URL=http:<span class="comment">//localhost</span></span><br><span class="line"></span><br><span class="line">DB_CONNECTION=sqlite</span><br><span class="line">DB_HOST=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">DB_PORT=<span class="number">3306</span></span><br><span class="line"><span class="comment">#DB_DATABASE=homestead</span></span><br><span class="line">DB_USERNAME=homestead</span><br><span class="line">DB_PASSWORD=secret</span><br><span class="line"></span><br><span class="line">CACHE_DRIVER=file</span><br><span class="line">SESSION_DRIVER=file</span><br><span class="line"><span class="comment">#QUEUE_DRIVER=sync</span></span><br><span class="line">QUEUE_DRIVER=database</span><br><span class="line"></span><br><span class="line">REDIS_HOST=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">REDIS_PASSWORD=<span class="keyword">null</span></span><br><span class="line">REDIS_PORT=<span class="number">6379</span></span><br><span class="line"></span><br><span class="line">MAIL_DRIVER=smtp</span><br><span class="line">MAIL_HOST=smtp.gmail.com</span><br><span class="line">MAIL_PORT=<span class="number">587</span></span><br><span class="line">MAIL_USERNAME=[your gmail address]</span><br><span class="line">MAIL_PASSWORD=[your password]</span><br><span class="line">MAIL_ENCRYPTION=tls</span><br></pre></td></tr></table></figure></p>
<p>15 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#QUEUE_DRIVER=sync</span></span><br><span class="line">QUEUE_DRIVER=database</span><br></pre></td></tr></table></figure></p>
<p><code>QUEUE_DRIVER</code> 由 <code>sync</code> 改成 <code>database</code>。</p>
<h2 id="設定測試環境使用_Queue">設定測試環境使用 Queue</h2><hr>
<p><strong> phpunit.xml </strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52QueueForever/commit/9402ace92066c9ca89147c234ac2005ac53ae339" target="_blank" rel="external">設定測試環境使用 queue</a></span></span></span><br><figure class="highlight xml"><figcaption><span>phpunit.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">phpunit</span> <span class="attribute">backupGlobals</span>=<span class="value">"false"</span></span><br><span class="line">         <span class="attribute">backupStaticAttributes</span>=<span class="value">"false"</span></span><br><span class="line">         <span class="attribute">bootstrap</span>=<span class="value">"bootstrap/autoload.php"</span></span><br><span class="line">         <span class="attribute">colors</span>=<span class="value">"true"</span></span><br><span class="line">         <span class="attribute">convertErrorsToExceptions</span>=<span class="value">"true"</span></span><br><span class="line">         <span class="attribute">convertNoticesToExceptions</span>=<span class="value">"true"</span></span><br><span class="line">         <span class="attribute">convertWarningsToExceptions</span>=<span class="value">"true"</span></span><br><span class="line">         <span class="attribute">processIsolation</span>=<span class="value">"false"</span></span><br><span class="line">         <span class="attribute">stopOnFailure</span>=<span class="value">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">testsuites</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">testsuite</span> <span class="attribute">name</span>=<span class="value">"Application Test Suite"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">directory</span> <span class="attribute">suffix</span>=<span class="value">"Test.php"</span>&gt;</span>./tests<span class="tag">&lt;/<span class="title">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">testsuite</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">testsuites</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">whitelist</span> <span class="attribute">processUncoveredFilesFromWhitelist</span>=<span class="value">"true"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">directory</span> <span class="attribute">suffix</span>=<span class="value">".php"</span>&gt;</span>./app<span class="tag">&lt;/<span class="title">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">file</span>&gt;</span>./app/Http/routes.php<span class="tag">&lt;/<span class="title">file</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">exclude</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">whitelist</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">php</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"APP_ENV"</span> <span class="attribute">value</span>=<span class="value">"testing"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"QUEUE_DRIVER"</span> <span class="attribute">value</span>=<span class="value">"database"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"DB_CONNECTION"</span> <span class="attribute">value</span>=<span class="value">"sqlite"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">php</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">phpunit</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>24 行<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">php</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"APP_ENV"</span> <span class="attribute">value</span>=<span class="value">"testing"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"QUEUE_DRIVER"</span> <span class="attribute">value</span>=<span class="value">"database"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">env</span> <span class="attribute">name</span>=<span class="value">"DB_CONNECTION"</span> <span class="attribute">value</span>=<span class="value">"sqlite"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">php</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>將 <code>CACHE_DRIVER</code> 與 <code>SESSION_DRIVER</code> 部分刪除。</li>
<li>將 <code>QUEUE_DRIVER</code> 改成 <code>database</code>。</li>
<li>將 <code>DB_CONNECTION</code> 改成 <code>sqlite</code>。</li>
</ul>
<p><code>CACHE_DRIVER</code> 與 <code>SESSION_DRIVER</code> 必須刪除，否則無法再測試環境使用非同步方式寄送 email。</p>
<p>儘管我們之前已經在 <code>.env</code> 的 <code>QUEUE_DRIVER</code> 改成 <code>database</code>，但 <code>phpunit.xml</code> 的 <code>QUEUE_DRIVER</code> 的 <code>sync</code> 設定會覆蓋掉 <code>.env</code> 的設定，所以這邊也要改成 <code>database</code>。</p>
<p>不能如一般單元測試的 <code>DB_CONNECTION</code> 設定成 <code>sqlite_testing</code>，也就是將資料庫設定成 <code>:memory:</code>，因為這種方式是使用 SQLite in Memory，只要測試一執行完，SQLite in Memory 就會被刪除，因此無法被 Forever 使用，因而無法使用非同步方式寄送 email。</p>
<h2 id="建立_jobs_table">建立 jobs table</h2><hr>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/MyProject$ php artisan queue:table&#10;oomusou@mac:~/MyProject$ php artisan migrate</span><br></pre></td></tr></table></figure>
<p>目前是將 queue 建立在資料庫，因此須建立 <code>jobs</code> table。<span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52QueueForever/commit/70868c78471097febf2e5ea0a2dbbc5aa16ede0d" target="_blank" rel="external">建立 jobs table</a></span></span></span></p>
<h2 id="安裝_Forever">安裝 Forever</h2><hr>
<p>在 Laravel 的 <a href="https://laravel.com/docs/5.2/queues#supervisor-configuration" target="_blank" rel="external">Queues</a> 文件中，是建議大家使用 <code>Supervisor</code>，它會讓 <code>php artisan queue:listen</code> 在背景執行，持續地消耗 queue，不過 <code>Supervisor</code> 是 Linux 的程式，無法在 Windows 與 macOS 執行，因此對於開發並不方便。</p>
<p>這裡介紹的是由 Node.js 開發的 <a href="https://github.com/foreverjs/forever" target="_blank" rel="external">Forever</a>，功能與 <code>Supervisor</code> 完全一樣，但因為由 Node.js 所開發，在 Windows、 macOS 與 Linux 都可執行，只要能能成功安裝 Node.js 即可。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/$ npm install -g forever</span><br></pre></td></tr></table></figure>
<p>將 <code>forever</code> 全域安裝。</p>
<h2 id="啟動_Forever">啟動 Forever</h2><hr>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oomusou@mac:~/$ forever start -l /Users/oomusou/Code/Laravel/Laravel52QueueForever/forever.log -c php artisan queue:work</span><br></pre></td></tr></table></figure>
<ul>
<li><strong> start </strong> : 使用 forever 啟動其他服務。</li>
<li><strong> -l </strong> : 指定 log 位置， <code>Forever</code> 預設將 log 放在 <code>~/.forever</code> 目錄下，且每次啟動為亂數，若你想將 log 指定在特定目錄，並使用特定檔名，則必須使用 <code>-l</code>，且必須使用完整路徑。 </li>
<li><strong> -c </strong> : 要啟動的 CLI 命令，使用 <code>php artisan queue:work</code> 執行 queue worker。</li>
</ul>
<h2 id="由_Queue_寄信">由 Queue 寄信</h2><hr>
<p><strong> MailService.php </strong><span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel52QueueForever/commit/b8bbd243b04d78d57c1307193e07bdb832728817" target="_blank" rel="external">由 queue 寄送信件</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/MailService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Mail</span>\<span class="title">Message</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mail</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MailService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mailByQueue</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        Mail::queue(<span class="string">'welcome'</span>, [], <span class="function"><span class="keyword">function</span> <span class="params">(Message <span class="variable">$message</span>)</span> </span>&#123;</span><br><span class="line">            <span class="variable">$message</span>-&gt;sender(<span class="string">'oomusou@gmail.com'</span>);</span><br><span class="line">            <span class="variable">$message</span>-&gt;subject(<span class="string">'Laravel 5.2 mail by Queue'</span>);</span><br><span class="line">            <span class="variable">$message</span>-&gt;to(<span class="string">'oomusou@gmail.com'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>Mail::queue()</code> 寄送信件，其他參數與 <code>Mail::send()</code> 完全相同。</p>
<p>實際執行發現，<code>Mail::queue()</code> 會馬上執行完，不會有任何等待，因為是非同步，不用等 smtp server 回應就可繼續執行。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>由同步改成非同步方式寄信，在程式方面，只要將 <code>Mail::send()</code> 改成 <code>Mail::queue()</code> 即可。</li>
<li>Laravel 支援多種 queue，本文使用最簡單的資料庫方式。</li>
<li><code>Forever</code> 為 Node.js 所開發，在 Windows、macOS 與 Linux 都可使用，非常方便。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel52QueueForever" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<p>Taylor Otwell, <a href="https://laravel.com/docs/5.2/mail" target="_blank" rel="external">Mail</a><br>Taylor Otwell, <a href="https://laravel.com/docs/5.2/queues" target="_blank" rel="external">Queues</a><br>foreverjs, <a href="https://github.com/foreverjs/forever" target="_blank" rel="external">forever</a></p>
]]></content>
    <summary type="html">
    <![CDATA[以非同步的方式寄送 Email 加快執行速度]]>
    
    </summary>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 PHPUnit 測試 private 與 protected method?]]></title>
    <link href="http://oomusou.io/phpunit/phpunit-test-private/"/>
    <id>http://oomusou.io/phpunit/phpunit-test-private/</id>
    <published>2016-11-20T12:23:43.000Z</published>
    <updated>2016-11-21T00:53:00.000Z</updated>
    <content type="html"><![CDATA[<p>剛開始學習寫測試時，最多人的疑問就是該如何測試 <code>private</code> 與 <code>protected</code> method? 理論上不該去測試 <code>private</code> 與 <code>protected</code>，本文會介紹一個 PHP 邪惡的技巧來完成測試，但建議除非萬不得已，不要使用此方法。</p>
<a id="more"></a>
<h2 id="Motivation">Motivation</h2><hr>
<p>在 PHPConf 第二天的 workshop，我曾經舉手問 PHPUnit 的原作者 Sabastian Bergmann：<code>How to test private and protected method?</code>，Sabastian 的回答也很鏗鏘有力：<code>You can&#39;t</code>，實務上我也真的沒測試過 <code>private</code> 與  <code>protected</code> method，不過藉此機會理解為什麼不該測試 <code>private</code> 與 <code>protected</code> 也是不錯的。</p>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.8<br>Laravel 5.3.10<br>PHPUnit 5.5.5</p>
<h2 id="為什麼不該測試_private_與_protected?">為什麼不該測試 private 與 protected?</h2><hr>
<ol>
<li><p>測試案例是來自於需求，<code>public</code> 才是來自於需求，而 <code>private</code> 與 <code>protected</code> 則是來自於<strong>重構</strong>，所以不應該特別去測試，而應該由 <code>public</code> 的測試案例自然去測試 <code>private</code> 與 <code>protected</code>。</p>
</li>
<li><p>若特別去測試 <code>private</code> 與 <code>protected</code>，則 coverage 將沒有意義，可以特別只針對 <code>private</code> 與 <code>protected</code> 寫測試，而達成 coverage 為 <code>100%</code>，正確方法應該根據需求只測試 <code>public</code>，若有些 <code>private</code> 與 <code>protected</code> 因而沒測試到，則有兩種可能：一個是測試案例不足，導致 <code>private</code> 與 <code>protected</code> 沒測到，另一個則是目前根本無此需求，沒測到的 <code>private</code> 與 <code>protected</code> 就是 over design。</p>
</li>
<li><p>根據物件導向的<strong>封裝</strong>特性，<code>public</code> 會根據 interface 而穩定，但 <code>private</code> 與 <code>protected</code> 則會隨著日後<strong>重構</strong>而變化，若直接針對 <code>private</code> 與 <code>protected</code> 寫測試，則日後只要一重構，就必須修改測試，則將影響測試程式的<strong>健狀性</strong>，測試應該隨著<strong>需求</strong>改變而修改，不該隨著程式碼<strong>重構</strong>而修改。</p>
</li>
</ol>
<h2 id="實際案例">實際案例</h2><hr>
<p>若真的萬不得已，需要對 <code>private</code> 與 <code>protected</code> 做測試時，以下介紹一個簡單的方式。</p>
<p><strong> ShippingService.php </strong><span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53PHPUnitPrivateTest_demo/commit/17f65cac2469d1d6af871cebde10a3b9d01bb80f" target="_blank" rel="external">新增 ShippingService</a></span></span></span><br><figure class="highlight php"><figcaption><span>Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(int <span class="variable">$weight</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span> * <span class="variable">$weight</span> + <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>若 <code>calculateFee()</code> 為 <code>private</code>，我們該怎麼為這段程式補上測試呢?</p>
<p><strong> 單元測試 ShippingServiceTest.php </strong><span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53PHPUnitPrivateTest_demo/commit/89bdc1540df918a362a4acf3dedbc523fd174add" target="_blank" rel="external">單元測試 : ShippingService 使用 Closure::call()</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">BlackCat</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">LogisticsInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 當重量為1<span class="title">kg</span>時費用為110元<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$target</span> = App::make(ShippingService::class);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$__calculateFee</span> = <span class="function"><span class="keyword">function</span> <span class="params">(int <span class="variable">$weight</span>)</span> : <span class="title">int</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$this</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$actual</span> = <span class="variable">$__calculateFee</span>-&gt;call(<span class="variable">$target</span>, <span class="variable">$weight</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>13 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$target</span> = App::make(ShippingService::class);</span><br></pre></td></tr></table></figure></p>
<p>建立 <code>$target</code> 測試物件，在本範例寫 <code>$target = new ShippingService()</code> 亦可，不過若在 class 內有使用到依賴注入，則必須使用 <code>App::make()</code>， 此時 Laravel 的 service container 會自動注入相對應的物件，實務上在寫測試時，建議使用 <code>App::make()</code> 取代 <code>new</code>。</p>
<p>15 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$__calculateFee</span> = <span class="function"><span class="keyword">function</span> <span class="params">(int <span class="variable">$weight</span>)</span> : <span class="title">int</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$this</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>因為 <code>calculateFee()</code> 為 <code>private</code>，我們無法測試，因此特別建立一個 <code>$__calculateFee</code> closure，由 closure 內部去呼叫 <code>private</code> 的 <code>calculateFee()</code>。</p>
<p>20 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$actual</span> = <span class="variable">$__calculateFee</span>-&gt;call(<span class="variable">$target</span>, <span class="variable">$weight</span>);</span><br></pre></td></tr></table></figure></p>
<p>在 PHP 7，<code>Closure</code> 物件新提供了 <code>call()</code>，可以讓我們直接將一個物件動態綁定到 closure 的 <code>$this</code>。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>關於 PHP 7 的 <code>Closure::call()</code>，詳細請參考 <a href="http://php.net/manual/en/closure.call.php" target="_blank" rel="external">Closure::call</a></span></span></span></p>
<p>closure 內的 <code>$this</code>，就會如同 JavaScript 的 <code>this</code> 一樣，自動指向被綁定的物件，如此我們就可以由自己建立的 closure，透過 <code>this</code> 去存取 <code>private</code> method。</p>
<p><code>call()</code> 的第一個參數為要綁定的物件，之後的參數為要傳給 closure 的參數。<span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>事實上這就是 PHP 5.4 所提供的 <code>bindTo()</code>，只是 PHP 7 的 <code>Closure::bind()</code> 可讀性更高，若想了解 <code>bindTo()</code>，詳細請參考 <a href="/php/php-bindTo/">深入探討 bindTo()</a></span></span></span></p>
<p>24 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line"><span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br></pre></td></tr></table></figure></p>
<p>測試結果是否如預期。</p>
<p><img src="/images/phpunit/phpunit-test-private/private000.png" alt=""></p>
<p>實際跑單元測試，會得到 <span class="label label-success">綠燈</span>。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>非到萬不得已，不應該直接測試 <code>private</code> 與 <code>protected</code>，不要為了測試而測試。</li>
<li>本文以 <code>private</code> 為範例，也可以套用在 <code>protected</code>，一樣使用 <code>Closure::call()</code> 的方式。</li>
<li><code>Closure::call()</code> 違反物件導向封裝原則，實務上不建議使用，除非真的萬不得已。</li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel53PHPUnitPrivateTest_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<p>PHP, <a href="http://php.net/manual/en/closure.call.php" target="_blank" rel="external">Closure::call</a></p>
]]></content>
    <summary type="html">
    <![CDATA[使用 Closure::call() 測試 private 與 protected method]]>
    
    </summary>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
      <category term="PHPUnit" scheme="http://oomusou.io/tags/PHPUnit/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何使用 PHPUnit mock Closure?]]></title>
    <link href="http://oomusou.io/phpunit/phpunit-closure-mock/"/>
    <id>http://oomusou.io/phpunit/phpunit-closure-mock/</id>
    <published>2016-11-19T12:23:43.000Z</published>
    <updated>2016-11-20T02:52:57.000Z</updated>
    <content type="html"><![CDATA[<p>若有需求需要抽換，物件導向編程教我們的是開 interface 達成解耦合，然後使用依賴注入，最後達成依賴反轉目標，隨著函數式編程越來越流行，函數式編程教我們將 closure 當成參數傳進函式，一樣可以解耦合與依賴反轉，尤其對於只使用一次的需求特別有效，不用在另外開 interface 與 class，但在單元測試則面臨挑戰，我們該如何 mock closure 呢？</p>
<a id="more"></a>
<h2 id="Motivation">Motivation</h2><hr>
<p>在 PHPConf 第二天的 workshop，我曾經舉手問 PHPUnit 的原作者 Sabastian Bergmann：<code>How to mock closure?</code>，Sabastian 的回答也很鏗鏘有力：<code>You can&#39;t</code>，在這篇 PHPUnit 的 <a href="https://github.com/sebastianbergmann/phpunit-mock-objects/issues/257" target="_blank" rel="external">Closure mock Issue</a>，也有人建議 PHPUnit 支援 mock closure，不過 Sabastian 的回答是</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  I might accept a pull request that implements this but I won't implement it myself.</div>
<p>不過實務上，仍有 mock closure 的需求，如 closure 內包含外部 API 或別人的 package，為了單元測試，能不 mock closure 嗎? 顯然不可能，除非你不使用 closure 寫法，而改用傳統物件導向的 interface 方式。</p>
<h2 id="Version">Version</h2><hr>
<p>PHP 7.0.8<br>Laravel 5.3.10<br>PHPUnit 5.5.5</p>
<h2 id="實際案例">實際案例</h2><hr>
<p>假設目前有 3 家貨運公司，每家公司的計費方式不同，使用者可以動態選擇不同的貨運公司。<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>完整重構過程請參考 <a href="/tdd/tdd-di/">深入探討依賴注入</a>，本文只從 method injection 繼續重構成 closure。</span></span></span></p>
<h2 id="Method_Injection">Method Injection</h2><hr>
<p><strong> 單元測試 ShippingServiceTest.php </strong><span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53PHPUnitMockClosure_demo/commit/9bfce794d885ece5547b475b547e232aeda6bac9" target="_blank" rel="external">單元測試 : ShippingService 使用 interface</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">BlackCat</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">LogisticsInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓單元測試<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$mock</span> = <span class="variable">$this</span>-&gt;createMock(BlackCat::class);</span><br><span class="line">        <span class="variable">$mock</span>-&gt;expects(<span class="variable">$this</span>-&gt;once())</span><br><span class="line">            -&gt;method(<span class="string">'calculateFee'</span>)</span><br><span class="line">            -&gt;withAnyParameters()</span><br><span class="line">            -&gt;willReturn(<span class="number">110</span>);</span><br><span class="line"></span><br><span class="line">        App::instance(LogisticsInterface::class, <span class="variable">$mock</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">            <span class="string">'weight'</span> =&gt; <span class="variable">$weight</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>13 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$mock</span> = <span class="variable">$this</span>-&gt;createMock(BlackCat::class);</span><br></pre></td></tr></table></figure></p>
<p>PHPUnit 直接使用 <code>createMock()</code> 建立 mock 物件。</p>
<p>14 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$mock</span>-&gt;expects(<span class="variable">$this</span>-&gt;once())</span><br><span class="line">    -&gt;method(<span class="string">'calculateFee'</span>)</span><br><span class="line">    -&gt;withAnyParameters()</span><br><span class="line">    -&gt;willReturn(<span class="number">110</span>);</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>expects()</code> : 設定預期該 mock 的 method 要執行幾次，<code>$this-&gt;once()</code> 為只執行一次。</li>
<li><code>method()</code> : 設定要 mock 的 method 名稱。</li>
<li><code>withAnyParameters()</code> : 不考慮 method 的任何參數。</li>
<li><code>willReturn()</code> : 設定該 mock 的 method 的回傳值。</li>
</ul>
<p>19 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">App::instance(LogisticsInterface::class, <span class="variable">$mock</span>);</span><br></pre></td></tr></table></figure></p>
<p>告訴 Laravel 的 service container，當遇到 <code>LogisticsInterface</code> 的依賴注入時，一律改注入成剛剛由 PHPUnit 所建立的 mock。</p>
<p>22 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">    <span class="string">'weight'</span> =&gt; <span class="variable">$weight</span>,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>實際測試 <code>ShippingService</code> 的 <code>calculateFee()</code>。</p>
<p>由於 <code>calculateFee()</code> 使用了 method injection，所以必須改用 Laravel service container 所提供的 <code>App::call()</code> 執行，才會啟動 method injection，自動注入剛剛建立的 mock。</p>
<p>第一個參數要傳進 class 的完整名稱，加上 <code>@</code> 與 method 名稱。</p>
<p>第二個參數為陣列，傳進其他參數，其中 key 為 參數名稱，value 為要傳進參數的變數。<span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>關於 <code>App::call()</code>，詳細請參考<a href="/tdd/tdd-di/#Method_Injection">深入探討依賴注入之 Method Injection</a>。</span></span></span></p>
<p>28 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line"><span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br></pre></td></tr></table></figure></p>
<p>實際測試結果是否為 <code>110</code>。</p>
<p><strong> ShippingService.php </strong><span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53PHPUnitMockClosure_demo/commit/6eb814f4aeeca9a58a52db55c5465861e78569b8" target="_blank" rel="external">建立 ShippingService 使用 interface</a></span></span></span><br><figure class="highlight php"><figcaption><span>Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@param</span> LogisticsInterface $logistics</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(int <span class="variable">$weight</span>, LogisticsInterface <span class="variable">$logistics</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$logistics</span>-&gt;calculateFee(<span class="variable">$weight</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 method injection 由 <code>LogisticsInterface</code> 注入 <code>$logistics</code>。</p>
<p>由於 <code>LogisticsInterface</code> 有定義 <code>calculateFee()</code>，因此我們可以在 <code>$logistics</code> 物件使用 <code>calculateFee()</code>。</p>
<p><strong> LogisticsInterface.php </strong><span class="margin-note-marker"><sup>5</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">5</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53PHPUnitMockClosure_demo/commit/24aa08e727caa463edaad771ea221687ad9ee22f" target="_blank" rel="external">建立 LogisticsInterface</a></span></span></span><br><figure class="highlight php"><figcaption><span>Services/LogisticsInterface.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">LogisticsInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(int <span class="variable">$weight</span>)</span> : <span class="title">int</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>定義 <code>LogisticsInterface</code> 有 <code>calculateFee()</code>。</p>
<p><strong> BlackCat.php </strong><span class="margin-note-marker"><sup>6</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">6</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53PHPUnitMockClosure_demo/commit/c25e20315b873a9fe139e2ef9114516f20b09f9e" target="_blank" rel="external">建立 BlackCat 實現 LogisticsInterface</a></span></span></span><br><figure class="highlight php"><figcaption><span>Services/BlackCat.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackCat</span> <span class="keyword">implements</span> <span class="title">LogisticsInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(int <span class="variable">$weight</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span> * <span class="variable">$weight</span> + <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>BlackCat</code> 必須實現 <code>LogisticsInterface</code> 所定義的 <code>calculateFee()</code>，將實際的計算運費演算法在此實現。</p>
<p><img src="/images/phpunit/phpunit-closure-mock/closure000.png" alt=""></p>
<p>實際跑單元測試，會得到第 1 個 <span class="label label-success">綠燈</span>。</p>
<p><strong> 整合測試 ShippingServiceTest.php </strong><span class="margin-note-marker"><sup>7</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">7</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53PHPUnitMockClosure_demo/commit/ffabd0f165734227fce1e39996869d128739a055" target="_blank" rel="external">整合測試 : ShippingService 使用 interface</a></span></span></span><br><figure class="highlight php"><figcaption><span>tests/Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">BlackCat</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">LogisticsInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓整合測試<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        App::bind(LogisticsInterface::class, BlackCat::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">            <span class="string">'weight'</span> =&gt; <span class="variable">$weight</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>12 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** arrange */</span></span><br><span class="line">App::bind(LogisticsInterface::class, BlackCat::class);</span><br></pre></td></tr></table></figure></p>
<p>整合測試就不再 mock 了，而是實際由 <code>App::bind()</code> 告訴 Laravel service container，當遇到 <code>LogisticsInterface</code> 時，要依賴注入 <code>BlackCat</code> 物件。</p>
<p>15 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** act */</span></span><br><span class="line"><span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">    <span class="string">'weight'</span> =&gt; <span class="variable">$weight</span>,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>一樣使用 <code>App::call()</code> 呼叫 <code>ShippingService</code> 的 <code>calculateFee()</code>，因為使用了 method injection。</p>
<p><img src="/images/phpunit/phpunit-closure-mock/closure001.png" alt=""></p>
<p>實際跑整合測試，會得到第 2 個 <span class="label label-success">綠燈</span>。</p>
<h2 id="重構成_Closure">重構成 Closure</h2><hr>
<p>若<strong>計算運費</strong>的邏輯在整個專案只使用一次，為此大費周章建立 interface 與 class， 或許殺雞用牛刀了，對於這種只使用一次的需求，函數式編程就特別有效，我們可以再繼續將 interface 重構成 closure。</p>
<p><strong> ShippingService.php </strong><span class="margin-note-marker"><sup>8</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">8</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53PHPUnitMockClosure_demo/commit/fb691e1027ee6f5e1025bbf8f4c80c2cbd1fce18" target="_blank" rel="external">重構 ShippingService 使用 closure</a></span></span></span><br><figure class="highlight php"><figcaption><span>Services/ShippingService.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingService</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 計算運費</span><br><span class="line">     * <span class="doctag">@param</span> int $weight</span><br><span class="line">     * <span class="doctag">@param</span> callable $logistics</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateFee</span><span class="params">(int <span class="variable">$weight</span>, callable <span class="variable">$logistics</span>)</span> : <span class="title">int</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$logistics</span>(<span class="variable">$weight</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>將 <code>$logistics</code> 的 type hint 從原本的 <code>LogisticsInterface</code> 改成 <code>callable</code>，因為我們要重構成 closure 方式。<span class="margin-note-marker"><sup>9</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">9</span>關於 <code>callable</code>，詳細請參考 <a href="http://localhost:4000/php/php-closure/" target="_blank" rel="external">如何使用 Closure?</a></span></span></span></p>
<p>既然 <code>$logistics</code> 為 closure，我們就可以直接以 <code>$logistics($weight)</code> 的方式執行了。</p>
<p><strong> 單元測試 ShippingServiceTest.php </strong><span class="margin-note-marker"><sup>10</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">10</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53PHPUnitMockClosure_demo/commit/9a1347a16940686651b8333d3fad1a0a0a1ea9e7" target="_blank" rel="external">單元測試 : ShippingService 使用 closure</a></span></span></span><br><figure class="highlight php"><figcaption><span>Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓單元測試<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line">        <span class="variable">$mock</span> = <span class="variable">$this</span>-&gt;createPartialMock(stdClass::class, [<span class="string">'__invoke'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$mock</span>-&gt;expects(<span class="variable">$this</span>-&gt;once())</span><br><span class="line">            -&gt;method(<span class="string">'__invoke'</span>)</span><br><span class="line">            -&gt;withAnyParameters()</span><br><span class="line">            -&gt;willReturn(<span class="number">110</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">            <span class="string">'weight'</span>    =&gt; <span class="variable">$weight</span>,</span><br><span class="line">            <span class="string">'logistics'</span> =&gt; <span class="variable">$mock</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>11 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$mock</span> = <span class="variable">$this</span>-&gt;createPartialMock(stdClass::class, [<span class="string">'__invoke'</span>]);</span><br></pre></td></tr></table></figure></p>
<p>這一行有 3 個重點 :</p>
<ol>
<li>為什麼要 mock <code>__invoke</code>?</li>
<li>為什麼是 <code>stdClass</code> ?</li>
<li>什麼是 Partial Mock?</li>
</ol>
<p><strong> 為什麼要 mock <code>__invoke</code>? </strong><br><figure class="highlight php"><figcaption><span>PHP</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$anonyFunc</span> = <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$name</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello '</span> . <span class="variable">$name</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$anonyFunc</span>(<span class="string">"Josh"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Result:</span></span><br><span class="line"><span class="comment">// Hello Josh</span></span><br></pre></td></tr></table></figure></p>
<p>將 anoymous function 指定給 <code>anonyFunc</code> 變數，但實際上 <code>anonyFunc</code> 為 <code>Closure</code> 物件，它看起來像函式，卻是個物件，與函式相同語法，可接受參數，也可回傳參數，但是卻沒有函式名稱。</p>
<p>但事實上在 PHP 底層，這個 anonymous function 是實作在 <code>Closure</code> 物件的 <code>__invoke()</code> 這個 magic method，因此我們也可以這樣寫</p>
<figure class="highlight php"><figcaption><span>PHP</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$anonyFunc</span> = <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$name</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">return</span> <span class="string">'Hello '</span> . <span class="variable">$name</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$anonyFunc</span>-&gt;__invoke(<span class="string">"Josh"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Result:</span></span><br><span class="line"><span class="comment">// Hello Josh</span></span><br></pre></td></tr></table></figure>
<p>執行結果完全一樣。</p>
<p>實務上我們不會去使用 <code>__invoke()</code>，但 PHP 底層卻是靠 <code>__invoke()</code> 去實作 anonymous function。<span class="margin-note-marker"><sup>11</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">11</span>關於 <code>__invoke()</code>，詳細請參考 <a href="http://localhost:4000/php/php-closure/" target="_blank" rel="external">如何使用 Closure?</a></span></span></span></p>
<p>但因為我們現在是要去 mock closure，因此就相當於要去 mock <code>__invoke()</code>。</p>
<p><strong> 為什麼是 <code>stdClass</code>? </strong></p>
<p>我們知道 anonymous function 底層是 <code>Closure</code> 物件，理論上要去 mock <code>Closure</code> class，但令人沮喪的是，<code>Closure</code> 在 PHP 內部已經被宣告成 <code>final</code>，因此無從 mock。</p>
<blockquote><p>The predefined final class Closure was introduced in PHP 5.3.0. It is used for representing anonymous functions.</p>
<footer><strong>PHP </strong><cite><a href="http://php.net/manual/en/reserved.classes.php" target="_blank" rel="external">Closure</a></cite></footer></blockquote>
<p>別忘了 PHP 的 Duck Type 特性 :</p>
<div class="alert alert-info"><i class="fa fa-info"></i>  當看到一隻鳥走起來像鴨子、游泳起來像鴨子、叫起來也像鴨子，那麼這隻鳥就可以被稱為鴨子。</div>
<p>既然如此，我們就可以對 <code>stdClass</code> 動刀，讓他加上 <code>__invoke()</code>，並對 <code>__invoke()</code> 加以 mock，讓他看起來像 <code>Closure</code>。</p>
<p><strong> 什麼是 Partial Mock? </strong></p>
<p>一般我們只會使用普通 Mock，但有兩個地方可能會用到 Partial Mock :</p>
<ol>
<li>當你不想 mock 一個 class 所有 method，只想 mock 其中一兩個 method 時。</li>
<li>當你想 mock 一個無中生有的 method 時。</li>
</ol>
<p><code>stdClass</code> 並沒有任何 method，且 <code>__invoke()</code> 本應屬於 <code>Closure</code>，對於 <code>stdClass</code> 是無中生有的，因此我們必須使用 Partial Mock 才能將 <code>__invoke()</code> 加在 <code>stdClass</code> 上。</p>
<p>13 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$mock</span>-&gt;expects(<span class="variable">$this</span>-&gt;once())</span><br><span class="line">    -&gt;method(<span class="string">'__invoke'</span>)</span><br><span class="line">    -&gt;withAnyParameters()</span><br><span class="line">    -&gt;willReturn(<span class="number">110</span>);</span><br></pre></td></tr></table></figure></p>
<p>接下來則跟普通 mock 方式一樣，可以發現我們是直接對 <code>__invoke()</code> 做 mock。</p>
<p>19 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">   <span class="string">'weight'</span>    =&gt; <span class="variable">$weight</span>,</span><br><span class="line">   <span class="string">'logistics'</span> =&gt; <span class="variable">$mock</span>,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>將 mock 物件透過 <code>App::call()</code> 傳入。</p>
<p><img src="/images/phpunit/phpunit-closure-mock/closure002.png" alt=""></p>
<p>實際跑單元測試，會得到第 3 個 <span class="label label-success">綠燈</span>。</p>
<p><strong> 整合測試 ShippingServiceTest.php </strong><span class="margin-note-marker"><sup>12</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">12</span>GitHub Commit : <a href="https://github.com/oomusou/Laravel53PHPUnitMockClosure_demo/commit/1303628c3c07cce3cf53572c7ddc1d2b3729bc15" target="_blank" rel="external">整合測試 : ShippingService 使用 closure</a></span></span></span><br><figure class="highlight php"><figcaption><span>Services/ShippingServiceTest.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">ShippingService</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShippingServiceTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@test</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> 黑貓整合測試<span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/** arrange */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** act */</span></span><br><span class="line">        <span class="variable">$weight</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">            <span class="string">'weight'</span>    =&gt; <span class="variable">$weight</span>,</span><br><span class="line">            <span class="string">'logistics'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">(int <span class="variable">$weight</span>)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">100</span> * <span class="variable">$weight</span> + <span class="number">10</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** assert */</span></span><br><span class="line">        <span class="variable">$expected</span> = <span class="number">110</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;assertEquals(<span class="variable">$expected</span>, <span class="variable">$actual</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>14 行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$actual</span> = App::call(ShippingService::class . <span class="string">'@calculateFee'</span>, [</span><br><span class="line">    <span class="string">'weight'</span>    =&gt; <span class="variable">$weight</span>,</span><br><span class="line">    <span class="string">'logistics'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">(int <span class="variable">$weight</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span> * <span class="variable">$weight</span> + <span class="number">10</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>整合測試與單元測試的差異就是不 mock，因此我們直接將 closure 傳入。</p>
<p><img src="/images/phpunit/phpunit-closure-mock/closure003.png" alt=""></p>
<p>實際跑整合測試，會得到第 4 個 <span class="label label-success">綠燈</span>。</p>
<h2 id="Conclusion">Conclusion</h2><hr>
<ul>
<li>Mock closure 並非是炫技，實務上經常用到，尤其當你從物件導向編程，慢慢趨向函數式編程時，常常會重構成 closure，Taylor Otwell 在 Laravel 內部也大量使用 closure，只要使用到 closure，就可能面臨在單元測試時隔離 closure 的需求，透過本文的方式，你將可輕鬆的將 closure 加以 mock。<span class="margin-note-marker"><sup>13</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">13</span>關於 closure 實務上的應用，詳細請參考 <a href="/php/php-closure-practice/">實務上如何活用 Closure?</a></span></span></span></li>
</ul>
<h2 id="Sample_Code">Sample Code</h2><hr>
<p>完整的範例可以在我的 <a href="https://github.com/oomusou/Laravel53PHPUnitMockClosure_demo" target="_blank" rel="external">GitHub</a> 上找到。</p>
<h2 id="Reference">Reference</h2><hr>
<p>PHPUnit, <a href="https://github.com/sebastianbergmann/phpunit-mock-objects/issues/257" target="_blank" rel="external">Closure mock Issue</a><br>Sabastian Bergmann, <a href="https://thephp.cc/dates/2016/10/phpconf-taiwan/lately-in-phpunit" target="_blank" rel="external">PHPConf Taiwan 2016 Lately in PHP(Unit)</a><br>大澤木小鐵, <a href="http://jaceju.net/2015-11-09-php-closure-testing/" target="_blank" rel="external">在 PHPUnit 中測試需要 closure 的函式</a></p>
]]></content>
    <summary type="html">
    <![CDATA[為了隔離測試，實務上還是有 mock closure 的需求，不過 PHPUnit 目前無法直接 mock closure]]>
    
    </summary>
    
      <category term="Laravel" scheme="http://oomusou.io/tags/Laravel/"/>
    
      <category term="PHPUnit" scheme="http://oomusou.io/tags/PHPUnit/"/>
    
  </entry>
  
</feed>
